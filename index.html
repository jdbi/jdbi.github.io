<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Jdbi 3 Developer Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<link rel="icon" type="image/png" href="/images/favicon.png"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css" />
</head>
<body class="book toc2 toc-left">
<a class="github-fork-ribbon" href="https://github.com/jdbi/jdbi" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>
<div id="header">
<h1>Jdbi 3 Developer Guide</h1>
<div class="details">
<span id="revnumber">version 3.41.3-SNAPSHOT,</span>
<span id="revdate">09/25/2023 12:30 -0700</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_development_documentation_3_41_3_snapshot">Development documentation (3.41.3-SNAPSHOT)</a>
<ul class="sectlevel2">
<li><a href="#_release_documentation">Release documentation</a></li>
</ul>
</li>
<li><a href="#_introduction_to_jdbi_3">1. Introduction to Jdbi 3</a>
<ul class="sectlevel2">
<li><a href="#_quick_links">1.1. Quick Links</a></li>
<li><a href="#_getting_involved">1.2. Getting involved</a></li>
<li><a href="#_jdbi_v2_legacy_version">1.3. JDBI v2 (legacy version)</a></li>
</ul>
</li>
<li><a href="#_using_jdbi_in_your_projects">2. Using Jdbi in your projects</a>
<ul class="sectlevel2">
<li><a href="#_license_dependencies_and_availability">2.1. License, Dependencies and availability</a></li>
<li><a href="#_jvm_version_compatibility">2.2. JVM version compatibility</a></li>
<li><a href="#_getting_started">2.3. Getting started</a>
<ul class="sectlevel3">
<li><a href="#_jdbi_modules_overview">2.3.1. Jdbi modules overview</a></li>
<li><a href="#_external_modules">2.3.2. External modules</a></li>
<li><a href="#_build_tools">2.3.3. Build tools</a></li>
<li><a href="#_alpha_and_beta_annotations">2.3.4. @Alpha and @Beta Annotations</a></li>
<li><a href="#_internal_packages">2.3.5. Internal packages</a></li>
<li><a href="#_mixing_jdbi_component_versions">2.3.6. Mixing Jdbi component versions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_api_overview">3. API Overview</a>
<ul class="sectlevel2">
<li><a href="#_fluent_api">3.1. Fluent API</a></li>
<li><a href="#_declarative_api">3.2. Declarative API</a></li>
</ul>
</li>
<li><a href="#_core_api_concepts">4. Core API concepts</a>
<ul class="sectlevel2">
<li><a href="#_the_jdbi_class">4.1. The Jdbi class</a></li>
<li><a href="#_handle">4.2. Handle</a>
<ul class="sectlevel3">
<li><a href="#_obtaining_a_managed_handle">4.2.1. Obtaining a managed handle</a></li>
<li><a href="#_managing_the_handle_lifecycle_manually">4.2.2. Managing the Handle lifecycle manually</a></li>
</ul>
</li>
<li><a href="#_statement_types">4.3. Statement types</a>
<ul class="sectlevel3">
<li><a href="#_queries">4.3.1. Queries</a></li>
<li><a href="#_updates">4.3.2. Updates</a></li>
<li><a href="#_batches">4.3.3. Batches</a></li>
<li><a href="#_prepared_batches">4.3.4. Prepared Batches</a></li>
<li><a href="#_stored_procedure_calls">4.3.5. Stored Procedure Calls</a></li>
<li><a href="#_scripts">4.3.6. Scripts</a></li>
<li><a href="#_metadata">4.3.7. Metadata</a></li>
</ul>
</li>
<li><a href="#_usage_in_asynchronous_applications">4.4. Usage in asynchronous applications</a></li>
</ul>
</li>
<li><a href="#_resource_management">5. Resource Management</a>
<ul class="sectlevel2">
<li><a href="#_automatic_resource_management">5.1. Automatic resource management</a></li>
<li><a href="#_handle_resource_management">5.2. Handle resource management</a></li>
<li><a href="#statement-resource-management">5.3. Statement resource management</a>
<ul class="sectlevel3">
<li><a href="#_explicit_statement_resource_management">5.3.1. Explicit statement resource management</a></li>
<li><a href="#_implicit_statement_resource_cleanup">5.3.2. Implicit statement resource cleanup</a></li>
<li><a href="#resources-with-streams-iterators">5.3.3. Resources with Streams and Iterators</a></li>
<li><a href="#_attaching_statements_to_the_handle_lifecycle">5.3.4. Attaching statements to the handle lifecycle</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_arguments">6. Arguments</a>
<ul class="sectlevel2">
<li><a href="#_positional_arguments">6.1. Positional Arguments</a></li>
<li><a href="#_named_arguments">6.2. Named Arguments</a></li>
<li><a href="#_supported_argument_types">6.3. Supported Argument Types</a></li>
<li><a href="#_binding_arguments">6.4. Binding Arguments</a></li>
<li><a href="#_argument_annotations">6.5. Argument Annotations</a></li>
<li><a href="#_custom_arguments">6.6. Custom Arguments</a>
<ul class="sectlevel3">
<li><a href="#_using_the_argument_interface">6.6.1. Using the Argument interface</a></li>
<li><a href="#_using_the_argumentfactory_interface">6.6.2. Using the ArgumentFactory interface</a></li>
<li><a href="#_using_prepared_arguments_for_batches">6.6.3. Using Prepared Arguments for batches</a></li>
<li><a href="#_the_arguments_registry">6.6.4. The Arguments Registry</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_mappers">7. Mappers</a>
<ul class="sectlevel2">
<li><a href="#_row_mappers">7.1. Row Mappers</a>
<ul class="sectlevel3">
<li><a href="#_rowmappers_registry">7.1.1. RowMappers registry</a></li>
<li><a href="#_rowmapperfactory">7.1.2. RowMapperFactory</a></li>
</ul>
</li>
<li><a href="#_column_mappers">7.2. Column Mappers</a>
<ul class="sectlevel3">
<li><a href="#_columnmappers_registry">7.2.1. ColumnMappers registry</a></li>
<li><a href="#_columnmapperfactory">7.2.2. ColumnMapperFactory</a></li>
</ul>
</li>
<li><a href="#_primitive_mapping">7.3. Primitive Mapping</a></li>
<li><a href="#_immutables_mapping">7.4. Immutables Mapping</a></li>
<li><a href="#_freebuilder_mapping">7.5. Freebuilder Mapping</a></li>
<li><a href="#_reflection_mappers_for_beans_and_pojos">7.6. Reflection Mappers for Beans and POJOs</a>
<ul class="sectlevel3">
<li><a href="#_supported_property_annotations">7.6.1. Supported property annotations</a></li>
<li><a href="#_constructormapper">7.6.2. ConstructorMapper</a></li>
<li><a href="#_beanmapper">7.6.3. BeanMapper</a></li>
<li><a href="#_fieldmapper">7.6.4. FieldMapper</a></li>
</ul>
</li>
<li><a href="#mapentry-mapping">7.7. Map.Entry Mapping</a></li>
</ul>
</li>
<li><a href="#_codecs">8. Codecs</a>
<ul class="sectlevel2">
<li><a href="#_resolving_types">8.1. Resolving Types</a></li>
</ul>
</li>
<li><a href="#_results">9. Results</a>
<ul class="sectlevel2">
<li><a href="#_resultbearing">9.1. ResultBearing</a>
<ul class="sectlevel3">
<li><a href="#_mapping_result_types_with_latent_operations">9.1.1. Mapping result types with latent operations</a></li>
</ul>
</li>
<li><a href="#_resultiterable">9.2. ResultIterable</a>
<ul class="sectlevel3">
<li><a href="#_finding_a_single_result">9.2.1. Finding a Single Result</a></li>
<li><a href="#_stream">9.2.2. Stream</a></li>
<li><a href="#_list">9.2.3. List</a></li>
<li><a href="#_collectors">9.2.4. Collectors</a></li>
<li><a href="#_reduction">9.2.5. Reduction</a></li>
<li><a href="#_resultsetscanner">9.2.6. ResultSetScanner</a></li>
</ul>
</li>
<li><a href="#_joins">9.3. Joins</a>
<ul class="sectlevel3">
<li><a href="#_resultbearing_reducerows">9.3.1. ResultBearing.reduceRows()</a></li>
<li><a href="#_resultbearing_reduceresultset">9.3.2. ResultBearing.reduceResultSet()</a></li>
<li><a href="#_joinrowmapper">9.3.3. JoinRowMapper</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_transactions">10. Transactions</a>
<ul class="sectlevel2">
<li><a href="#_managed_transactions">10.1. Managed Transactions</a></li>
<li><a href="#_unmanaged_transactions">10.2. Unmanaged Transactions</a></li>
<li><a href="#_serializable_transactions">10.3. Serializable Transactions</a></li>
</ul>
</li>
<li><a href="#_configuration">11. Configuration</a>
<ul class="sectlevel2">
<li><a href="#_core_settings">11.1. core settings</a></li>
<li><a href="#_sqlobject_configuration_settings">11.2. SQLObject configuration settings</a></li>
<li><a href="#_other_configuration_settings">11.3. other configuration settings</a></li>
</ul>
</li>
<li><a href="#_sql_arrays">12. SQL Arrays</a>
<ul class="sectlevel2">
<li><a href="#_registering_array_types">12.1. Registering array types</a></li>
<li><a href="#_binding_custom_array_types">12.2. Binding custom array types</a></li>
<li><a href="#_mapping_array_types">12.3. Mapping array types</a></li>
</ul>
</li>
<li><a href="#sql-objects">13. SQL Objects</a>
<ul class="sectlevel2">
<li><a href="#_sql_method_annotations">13.1. SQL Method annotations</a>
<ul class="sectlevel3">
<li><a href="#_sqlquery">13.1.1. @SqlQuery</a></li>
<li><a href="#_sqlupdate">13.1.2. @SqlUpdate</a></li>
<li><a href="#_sqlbatch">13.1.3. @SqlBatch</a></li>
<li><a href="#_sqlcall">13.1.4. @SqlCall</a></li>
<li><a href="#_sqlscript">13.1.5. @SqlScript</a></li>
</ul>
</li>
<li><a href="#_using_sql_objects">13.2. Using SQL Objects</a>
<ul class="sectlevel3">
<li><a href="#_interface_default_methods">13.2.1. Interface default methods</a></li>
</ul>
</li>
<li><a href="#_sql_object_method_arguments">13.3. SQL Object method arguments</a>
<ul class="sectlevel3">
<li><a href="#_mapping_arguments_to_positional_parameters">13.3.1. Mapping arguments to positional parameters</a></li>
<li><a href="#mapping-arguments">13.3.2. Mapping arguments to named parameters</a></li>
<li><a href="#_mapping_arguments_to_java_parameter_names">13.3.3. Mapping arguments to Java parameter names</a></li>
<li><a href="#_consumer_arguments">13.3.4. Consumer arguments</a></li>
<li><a href="#_mapping_arguments_to_defined_attributes">13.3.5. Mapping arguments to defined attributes</a></li>
</ul>
</li>
<li><a href="#_sql_object_method_return_values">13.4. SQL Object method return values</a>
<ul class="sectlevel3">
<li><a href="#using-steams-and-iterators">13.4.1. Using Streams and Iterators</a></li>
</ul>
</li>
<li><a href="#sqlobject-mapper-annotations">13.5. SQL Object mapper annotations</a>
<ul class="sectlevel3">
<li><a href="#_registerrowmapper">13.5.1. @RegisterRowMapper</a></li>
<li><a href="#_registerrowmapperfactory">13.5.2. @RegisterRowMapperFactory</a></li>
<li><a href="#_registercolumnmapper">13.5.3. @RegisterColumnMapper</a></li>
<li><a href="#_registercolumnmapperfactory">13.5.4. @RegisterColumnMapperFactory</a></li>
<li><a href="#_registerbeanmapper">13.5.5. @RegisterBeanMapper</a></li>
<li><a href="#_registerconstructormapper">13.5.6. @RegisterConstructorMapper</a></li>
<li><a href="#_registerfieldmapper">13.5.7. @RegisterFieldMapper</a></li>
</ul>
</li>
<li><a href="#_other_sql_object_annotations">13.6. Other SQL Object annotations</a>
<ul class="sectlevel3">
<li><a href="#sqlupdate-getgeneratedkeys">13.6.1. @GetGeneratedKeys</a></li>
<li><a href="#sqllocator">13.6.2. @SqlLocator</a></li>
<li><a href="#_createsqlobject">13.6.3. @CreateSqlObject</a></li>
<li><a href="#_timestamped">13.6.4. @Timestamped</a></li>
<li><a href="#_singlevalue">13.6.5. @SingleValue</a></li>
<li><a href="#_annotations_for_mapkv_results">13.6.6. Annotations for Map&lt;K,V&gt; Results</a></li>
<li><a href="#_userowreducer">13.6.7. @UseRowReducer</a></li>
<li><a href="#_registercollector_and_registercollectorfactory">13.6.8. @RegisterCollector and @RegisterCollectorFactory</a></li>
<li><a href="#_other_sql_object_annotations_2">13.6.9. Other SQL Object annotations</a></li>
<li><a href="#_annotations_and_inheritance">13.6.10. Annotations and Inheritance</a></li>
</ul>
</li>
<li><a href="#_combining_sql_object_and_the_core_api">13.7. Combining SQL Object and the core API</a>
<ul class="sectlevel3">
<li><a href="#_using_default_methods_with_the_sqlobject_mixin">13.7.1. Using default Methods with the <code>SqlObject</code> mixin</a></li>
</ul>
</li>
<li><a href="#_sql_object_transactions">13.8. SQL Object Transactions</a>
<ul class="sectlevel3">
<li><a href="#_executing_multiple_sql_operations_in_a_single_transaction">13.8.1. Executing multiple SQL operations in a single transaction</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_miscellaneous">14. Miscellaneous</a>
<ul class="sectlevel2">
<li><a href="#_generated_keys">14.1. Generated Keys</a></li>
<li><a href="#_qualified_types">14.2. Qualified Types</a></li>
<li><a href="#query-templating">14.3. Query Templating</a>
<ul class="sectlevel3">
<li><a href="#_classpathsqllocator">14.3.1. ClasspathSqlLocator</a></li>
</ul>
</li>
<li><a href="#_statement_caching">14.4. Statement caching</a>
<ul class="sectlevel3">
<li><a href="#_using_custom_cache_instances">14.4.1. Using custom cache instances</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_testing">15. Testing</a>
<ul class="sectlevel2">
<li><a href="#_junit_4">15.1. JUnit 4</a></li>
<li><a href="#_junit_5">15.2. JUnit 5</a>
<ul class="sectlevel3">
<li><a href="#_testing_with_h2">15.2.1. Testing with H2</a></li>
<li><a href="#_testing_with_postgres">15.2.2. Testing with Postgres</a></li>
</ul>
</li>
<li><a href="#_using_testcontainers">15.3. Using Testcontainers</a>
<ul class="sectlevel3">
<li><a href="#_providing_custom_database_information">15.3.1. Providing custom database information</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_third_party_integration">16. Third-Party Integration</a>
<ul class="sectlevel2">
<li><a href="#google-guava">16.1. Google Guava</a></li>
<li><a href="#_h2_database">16.2. H2 Database</a></li>
<li><a href="#jdbi3-json">16.3. JSON</a>
<ul class="sectlevel3">
<li><a href="#_jackson_2">16.3.1. Jackson 2</a></li>
<li><a href="#_gson_2">16.3.2. Gson 2</a></li>
<li><a href="#_moshi">16.3.3. Moshi</a></li>
<li><a href="#_operation">16.3.4. Operation</a></li>
<li><a href="#_usage">16.3.5. Usage</a></li>
</ul>
</li>
<li><a href="#_immutables">16.4. Immutables</a></li>
<li><a href="#_freebuilder">16.5. Freebuilder</a></li>
<li><a href="#_jodatime">16.6. JodaTime</a></li>
<li><a href="#_google_guice">16.7. Google Guice</a>
<ul class="sectlevel3">
<li><a href="#_jsr_330_vs_jee_9_annotations">16.7.1. JSR 330 vs. JEE 9+ annotations</a></li>
<li><a href="#_definition_modules">16.7.2. Definition modules</a></li>
<li><a href="#_using_guice_injection_in_jdbi_classes">16.7.3. Using Guice injection in Jdbi classes</a></li>
<li><a href="#_jdbi_customization_using_guice">16.7.4. Jdbi customization using Guice</a></li>
<li><a href="#_element_configuration_modules">16.7.5. Element configuration modules</a></li>
<li><a href="#_advanced_topics">16.7.6. Advanced Topics</a></li>
</ul>
</li>
<li><a href="#_jpa">16.8. JPA</a></li>
<li><a href="#_kotlin">16.9. Kotlin</a>
<ul class="sectlevel3">
<li><a href="#_resultset_mapping">16.9.1. ResultSet Mapping</a></li>
<li><a href="#_sqlobject">16.9.2. SqlObject</a></li>
<li><a href="#_jackson_json_processing">16.9.3. Jackson JSON Processing</a></li>
</ul>
</li>
<li><a href="#_lombok">16.10. Lombok</a></li>
<li><a href="#_oracle_12">16.11. Oracle 12</a></li>
<li><a href="#_postgresql">16.12. PostgreSQL</a>
<ul class="sectlevel3">
<li><a href="#postgres-hstore">16.12.1. hstore</a></li>
<li><a href="#postgres-getgeneratedkeys">16.12.2. @GetGeneratedKeys Annotation</a></li>
<li><a href="#_large_objects">16.12.3. Large Objects</a></li>
</ul>
</li>
<li><a href="#_spring_5">16.13. Spring 5</a>
<ul class="sectlevel3">
<li><a href="#_installing_plugins">16.13.1. Installing Plugins</a></li>
<li><a href="#_global_attributes">16.13.2. Global Attributes</a></li>
</ul>
</li>
<li><a href="#_sqlite">16.14. SQLite</a></li>
<li><a href="#stringtemplate4">16.15. StringTemplate 4</a></li>
<li><a href="#_vavr">16.16. Vavr</a></li>
</ul>
</li>
<li><a href="#_cookbook">17. Cookbook</a>
<ul class="sectlevel2">
<li><a href="#_simple_dependency_injection">17.1. Simple Dependency Injection</a></li>
<li><a href="#_like_clauses_with_parameters">17.2. LIKE clauses with Parameters</a></li>
</ul>
</li>
<li><a href="#extension-framework">18. The Extension Framework</a>
<ul class="sectlevel2">
<li><a href="#_using_jdbi_extensions">18.1. Using Jdbi extensions</a>
<ul class="sectlevel3">
<li><a href="#_on_demand_extensions">18.1.1. On-demand extensions</a></li>
<li><a href="#extension-handle-lifecycle">18.1.2. Handle lifecycle for extensions</a></li>
</ul>
</li>
<li><a href="#_how_an_extension_works">18.2. How an extension works</a></li>
<li><a href="#_extension_framework_sdk">18.3. Extension framework SDK</a>
<ul class="sectlevel3">
<li><a href="#_extension_configuration">18.3.1. Extension configuration</a></li>
<li><a href="#_the_extension_factory">18.3.2. The Extension factory</a></li>
<li><a href="#_extension_handlers_and_their_factories">18.3.3. Extension handlers and their factories</a></li>
<li><a href="#_extension_handler_customizers">18.3.4. Extension handler customizers</a></li>
<li><a href="#_config_customizers_and_their_factories">18.3.5. Config customizers and their factories</a></li>
</ul>
</li>
<li><a href="#extension-framework-annotations">18.4. Annotations</a>
<ul class="sectlevel3">
<li><a href="#_extension_handler_annotation">18.4.1. Extension handler annotation</a></li>
<li><a href="#_extension_handler_customizer_annotation">18.4.2. Extension handler customizer annotation</a></li>
<li><a href="#_extension_handler_configurer_annotation">18.4.3. Extension handler configurer annotation</a></li>
</ul>
</li>
<li><a href="#_extension_metadata">18.5. Extension metadata</a></li>
</ul>
</li>
<li><a href="#_advanced_topics_2">19. Advanced Topics</a>
<ul class="sectlevel2">
<li><a href="#_high_availability">19.1. High Availability</a></li>
<li><a href="#compiling_with_parameter_names">19.2. Compiling with Parameter Names</a>
<ul class="sectlevel3">
<li><a href="#_maven_setup">19.2.1. Maven Setup</a></li>
<li><a href="#_intellij_idea_setup">19.2.2. IntelliJ IDEA setup</a></li>
<li><a href="#_eclipse_setup">19.2.3. Eclipse Setup</a></li>
</ul>
</li>
<li><a href="#_working_with_generic_types">19.3. Working with Generic Types</a>
<ul class="sectlevel3">
<li><a href="#_generictype">19.3.1. GenericType</a></li>
<li><a href="#_the_generictypes_helper">19.3.2. The GenericTypes helper</a></li>
</ul>
</li>
<li><a href="#_namedargumentfinder">19.4. NamedArgumentFinder</a></li>
<li><a href="#_jdbiconfig">19.5. JdbiConfig</a>
<ul class="sectlevel3">
<li><a href="#_creating_a_custom_jdbiconfig_type">19.5.1. Creating a custom JdbiConfig type</a></li>
</ul>
</li>
<li><a href="#_jdbiplugin">19.6. JdbiPlugin</a></li>
<li><a href="#_statementcontext">19.7. StatementContext</a></li>
<li><a href="#_templateengine">19.8. TemplateEngine</a></li>
<li><a href="#_sqlparser">19.9. SqlParser</a></li>
<li><a href="#_sqllogger">19.10. SqlLogger</a></li>
<li><a href="#_resultproducer">19.11. ResultProducer</a></li>
<li><a href="#generator">19.12. Jdbi SQL object code generator</a></li>
<li><a href="#_handlecallbackdecorator">19.13. HandleCallbackDecorator</a></li>
</ul>
</li>
<li><a href="#_appendix">20. Appendix</a>
<ul class="sectlevel2">
<li><a href="#_best_practices">20.1. Best Practices</a></li>
<li><a href="#_api_reference">20.2. API Reference</a></li>
<li><a href="#_related_projects">20.3. Related Projects</a></li>
<li><a href="#_upgrading_from_v2_to_v3">20.4. Upgrading from v2 to v3</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/logo.svg" alt="Jdbi logo">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_development_documentation_3_41_3_snapshot"><a class="anchor" href="#_development_documentation_3_41_3_snapshot"></a><a class="link" href="#_development_documentation_3_41_3_snapshot">Development documentation (3.41.3-SNAPSHOT)</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is the documentation for the current development state of Jdbi. All information in here reflects the current state of development on the <code>master</code> branch and is subject to change until it has been released as a numbered version.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://jdbi.org/">Permalink to this document</a></p>
</li>
<li>
<p><a href="https://jdbi.org/apidocs/" target="_blank" rel="noopener">Jdbi Javadoc (API Docs)</a></p>
</li>
<li>
<p><a href="https://github.com/jdbi/jdbi/blob/master/RELEASE_NOTES.md" target="_blank" rel="noopener">Current release notes</a></p>
</li>
<li>
<p><a href="https://github.com/jdbi/jdbi/" target="_blank" rel="noopener">Development source tree</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_release_documentation"><a class="anchor" href="#_release_documentation"></a><a class="link" href="#_release_documentation">Release documentation</a></h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://jdbi.org/releases/3.41.1" target="_blank" rel="noopener">Release 3.41.2 - 2023-09-21</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.41.1" target="_blank" rel="noopener">Release 3.41.1 - 2023-09-08</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.41.0" target="_blank" rel="noopener">Release 3.41.0 - 2023-08-15</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.40.0" target="_blank" rel="noopener">Release 3.40.0 - 2023-08-02</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.39.1" target="_blank" rel="noopener">Release 3.39.1 - 2023-07-17</a> - <strong>This is the last release of Jdbi to support Java 8!</strong></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.39.0" target="_blank" rel="noopener">Release 3.39.0 - 2023-07-17</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.38.3" target="_blank" rel="noopener">Release 3.38.3 - 2023-06-05</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.38.2" target="_blank" rel="noopener">Release 3.38.2 - 2023-05-04</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.38.1" target="_blank" rel="noopener">Release 3.38.1 - 2023-05-02</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.38.0" target="_blank" rel="noopener">Release 3.38.0 - 2023-04-25</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.37.1" target="_blank" rel="noopener">Release 3.37.1 - 2023-02-08</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.37.0" target="_blank" rel="noopener">Release 3.37.0 - 2023-02-03</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.36.0" target="_blank" rel="noopener">Release 3.36.0 - 2022-12-31</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.35.0" target="_blank" rel="noopener">Release 3.35.0 - 2022-12-03</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.34.0" target="_blank" rel="noopener">Release 3.34.0 - 2022-10-05</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.33.0" target="_blank" rel="noopener">Release 3.33.0 - 2022-09-28</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.32.0" target="_blank" rel="noopener">Release 3.32.0 - 2022-07-25</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.31.0" target="_blank" rel="noopener">Release 3.31.0 - 2022-07-17</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.30.0" target="_blank" rel="noopener">Release 3.30.0 - 2022-06-02</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.29.0" target="_blank" rel="noopener">Release 3.29.0 - 2022-05-21</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.28.0" target="_blank" rel="noopener">Release 3.28.0 - 2022-03-08</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.27.2" target="_blank" rel="noopener">Release 3.27.2 - 2022-02-18</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.27.1" target="_blank" rel="noopener">Release 3.27.1 - 2022-01-25</a></p>
</li>
<li>
<p><a href="https://jdbi.org/releases/3.27.0" target="_blank" rel="noopener">Release 3.27.0 - 2022-01-06</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction_to_jdbi_3"><a class="anchor" href="#_introduction_to_jdbi_3"></a><a class="link" href="#_introduction_to_jdbi_3">1. Introduction to Jdbi 3</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Jdbi provides convenient, idiomatic, access to relational data in Java.</strong> Jdbi 3 is the third major release, which introduces enhanced support for modern Java, countless refinements to the design and implementation, and enhanced support for modular development through plugins and extensions.</p>
</div>
<div class="paragraph">
<p><strong>Jdbi is built on top of JDBC.</strong> If your data source has a JDBC driver, you can use it with Jdbi. It improves JDBC&#8217;s low-level interface, providing a more natural API that is easy to bind to your domain data types.</p>
</div>
<div class="paragraph">
<p><strong>Jdbi is not an ORM.</strong> It is a convenience library to make Java database operations simpler and more pleasant to program than raw JDBC. While there is some ORM-like functionality, Jdbi goes to great length to ensure that there is no hidden magic that makes it hard to understand what is going on.</p>
</div>
<div class="paragraph">
<p><strong>Jdbi does not hide SQL away.</strong> One of the design principles of Jdbi is that SQL is the native language of the database, and it is unnecessary to wrap it into code, deconstruct it, or hide it away. Being able to express a query in raw SQL makes it possible for programmers and data engineers to speak the same language and not fight translation layers.</p>
</div>
<div class="paragraph">
<p><strong>Jdbi does not aim to provide a complete database management framework.</strong> It provides the building blocks that allow constructing the mapping between data and objects as appropriate for your application and the necessary primitives to execute SQL code against your database.</p>
</div>
<div class="sect2">
<h3 id="_quick_links"><a class="anchor" href="#_quick_links"></a><a class="link" href="#_quick_links">1.1. Quick Links</a></h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://jdbi.org/apidocs/" target="_blank" rel="noopener">Jdbi Javadoc (API Docs)</a></p>
</li>
<li>
<p><a href="https://github.com/jdbi/jdbi/blob/master/examples/README.md" target="_blank" rel="noopener">Jdbi sample code</a></p>
</li>
<li>
<p><a href="https://github.com/jdbi/jdbi" target="_blank" rel="noopener">GitHub Jdbi repository</a></p>
</li>
<li>
<p><a href="https://github.com/jdbi/jdbi/discussions" target="_blank" rel="noopener">Discussion groups for Jdbi</a></p>
</li>
<li>
<p><a href="https://groups.google.com/group/jdbi" target="_blank" rel="noopener">Mailing list</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/tagged/jdbi" target="_blank" rel="noopener">Stack Overflow</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_getting_involved"><a class="anchor" href="#_getting_involved"></a><a class="link" href="#_getting_involved">1.2. Getting involved</a></h3>
<div class="paragraph">
<p>Jdbi uses <a href="https://github.com/jdbi/jdbi" target="_blank" rel="noopener">GitHub</a> as the central development hub. <a href="https://github.com/jdbi/jdbi/issues" target="_blank" rel="noopener">Issues</a>, <a href="https://github.com/jdbi/jdbi/pulls" target="_blank" rel="noopener">Pull Requests</a> and <a href="https://github.com/jdbi/jdbi/discussions" target="_blank" rel="noopener">Discussions</a> all happen here.</p>
</div>
<div class="paragraph">
<p>Please see our <a href="https://github.com/jdbi/jdbi/blob/master/CONTRIBUTING.md" target="_blank" rel="noopener">Contribution guide</a> for more information on how to contribute to Jdbi.</p>
</div>
</div>
<div class="sect2">
<h3 id="_jdbi_v2_legacy_version"><a class="anchor" href="#_jdbi_v2_legacy_version"></a><a class="link" href="#_jdbi_v2_legacy_version">1.3. JDBI v2 (legacy version)</a></h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<strong>JDBI v2 is no longer under active development!</strong>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="/jdbi2/" target="_blank" rel="noopener">Jdbi v2 documentation</a></p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Already using Jdbi v2? See <a href="#_upgrading_from_v2_to_v3">Upgrading from v2 to v3</a>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_jdbi_in_your_projects"><a class="anchor" href="#_using_jdbi_in_your_projects"></a><a class="link" href="#_using_jdbi_in_your_projects">2. Using Jdbi in your projects</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_license_dependencies_and_availability"><a class="anchor" href="#_license_dependencies_and_availability"></a><a class="link" href="#_license_dependencies_and_availability">2.1. License, Dependencies and availability</a></h3>
<div class="paragraph">
<p>Jdbi is licensed under the commercial friendly <a href="https://www.apache.org/licenses/LICENSE-2.0.html" target="_blank" rel="noopener">Apache 2.0</a> license.</p>
</div>
<div class="paragraph">
<p>The core Jdbi module which offers programmatic access uses only <a href="https://slf4j.org/" target="_blank" rel="noopener">slf4j</a> and <a href="https://github.com/leangen/geantyref" target="_blank" rel="noopener">geantryref</a> as hard dependencies.</p>
</div>
<div class="paragraph">
<p>All Jdbi modules are available through <a href="https://search.maven.org" target="_blank" rel="noopener">Maven Central</a>. Jdbi also offers a BOM (Bill of materials) module for easy dependency management.</p>
</div>
</div>
<div class="sect2">
<h3 id="_jvm_version_compatibility"><a class="anchor" href="#_jvm_version_compatibility"></a><a class="link" href="#_jvm_version_compatibility">2.2. JVM version compatibility</a></h3>
<div class="paragraph">
<p>Jdbi runs on all Java versions 11 or later. All releases are built with the latest LTS version of Java using Java 11 bytecode compatibility.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Jdbi ended support for Java 8 with version 3.39. There are occasional backports of security relevant things or major bugs but as of version 3.40.0, JDK 11+ is required.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_getting_started"><a class="anchor" href="#_getting_started"></a><a class="link" href="#_getting_started">2.3. Getting started</a></h3>
<div class="paragraph">
<p>Jdbi has a flexible plugin architecture, which makes it easy to fold in support for your favorite libraries (Guava, JodaTime, Spring, Vavr) or database vendors (Oracle, Postgres, H2).</p>
</div>
<div class="paragraph">
<p>Jdbi is not an ORM. There is no session cache, change tracking, "open session in view", or cajoling the library to understand your schema.</p>
</div>
<div class="paragraph">
<p>Jdbi provides straightforward mapping between SQL and data accessible through a JDBC driver. You bring your own SQL, and Jdbi executes it.</p>
</div>
<div class="paragraph">
<p>Jdbi provides several other modules, which enhance the core API with additional
features.</p>
</div>
<div class="sect3">
<h4 id="_jdbi_modules_overview"><a class="anchor" href="#_jdbi_modules_overview"></a><a class="link" href="#_jdbi_modules_overview">2.3.1. Jdbi modules overview</a></h4>
<div class="paragraph">
<p>Jdbi consists of a large number of modules. Not all are required when writing database code. This is a quick overview of the existing modules and their function:</p>
</div>
<div class="sect4">
<h5 id="_common_modules"><a class="anchor" href="#_common_modules"></a><a class="link" href="#_common_modules">Common modules</a></h5>
<div class="dlist glossary">
<dl>
<dt>jdbi3-core</dt>
<dd>
<p>The core Jdbi library. Required by all other components.</p>
</dd>
<dt>jdbi3-sqlobject</dt>
<dd>
<p>SQL Object extension for declarative database access.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_testing_support"><a class="anchor" href="#_testing_support"></a><a class="link" href="#_testing_support">Testing support</a></h5>
<div class="dlist glossary">
<dl>
<dt>jdbi3-testing</dt>
<dd>
<p>Testing framework support. Currently, only supports JUnit4 and JUnit5.</p>
</dd>
<dt>jdbi3-testcontainers</dt>
<dd>
<p>Support for arbitrary databases running in <a href="https://testcontainers.org/" target="_blank" rel="noopener">Testcontainers</a>. Currently, only supports JUnit 5.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_external_data_types_and_libraries"><a class="anchor" href="#_external_data_types_and_libraries"></a><a class="link" href="#_external_data_types_and_libraries">External data types and libraries</a></h5>
<div class="paragraph">
<p>The core module contains support for the <a href="https://immutables.github.io/" target="_blank" rel="noopener">Immutables</a> and <a href="https://github.com/inferred/FreeBuilder" target="_blank" rel="noopener">Freebuilder</a> libraries.</p>
</div>
<div class="dlist glossary">
<dl>
<dt>jdbi3-guava</dt>
<dd>
<p>Support for <a href="https://guava.dev/" target="_blank" rel="noopener">Google Guava</a> collection and Optional types.</p>
</dd>
<dt>jdbi3-jodatime2</dt>
<dd>
<p>Support for <a href="https://www.joda.org/joda-time/" target="_blank" rel="noopener">JodaTime v2</a> data types.</p>
</dd>
<dt>jdbi3-vavr</dt>
<dd>
<p>Support for <a href="https://www.vavr.io/" target="_blank" rel="noopener">Vavr</a> Tuples, Collections and Value arguments.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_json_mapping"><a class="anchor" href="#_json_mapping"></a><a class="link" href="#_json_mapping">JSON Mapping</a></h5>
<div class="paragraph">
<p>Support for various JSON libraries to map data from the database onto JSON types and vice versa.</p>
</div>
<div class="dlist glossary">
<dl>
<dt>jdbi3-jackson2</dt>
<dd>
<p>Support for <a href="https://github.com/FasterXML/jackson" target="_blank" rel="noopener">Jackson v2</a>.</p>
</dd>
<dt>jdbi3-gson</dt>
<dd>
<p>Support for <a href="https://github.com/google/gson" target="_blank" rel="noopener">Google Gson</a>.</p>
</dd>
<dt>jdbi3-moshi</dt>
<dd>
<p>Support for <a href="https://github.com/square/moshi" target="_blank" rel="noopener">Square Moshi</a>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_frameworks"><a class="anchor" href="#_frameworks"></a><a class="link" href="#_frameworks">Frameworks</a></h5>
<div class="dlist glossary">
<dl>
<dt>jdbi3-guice</dt>
<dd>
<p>Support dependency injection and modules with <a href="https://github.com/google/guice" target="_blank" rel="noopener">Google Guice</a>.</p>
</dd>
<dt>jdbi3-spring5</dt>
<dd>
<p>Provides a <a href="https://spring.io/" target="_blank" rel="noopener">Spring Framework</a> factory bean to set up Jdbi singleton.</p>
</dd>
<dt>jdbi3-jpa</dt>
<dd>
<p>Some support for <a href="https://www.oracle.com/java/technologies/persistence-jsp.html" target="_blank" rel="noopener">JPA</a> annotations.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_database_specific_types_and_functions"><a class="anchor" href="#_database_specific_types_and_functions"></a><a class="link" href="#_database_specific_types_and_functions">Database specific types and functions</a></h5>
<div class="paragraph">
<p>While Jdbi supports <em>any</em> data source that has a <code>JDBC</code> driver "out of the box", its support is limited to the standard JDBC types and mappings. Some databases have additional data types and mappings, and support is added using the following modules:</p>
</div>
<div class="dlist glossary">
<dl>
<dt>jdbi3-postgres</dt>
<dd>
<p>Support for <a href="https://www.postgresql.org/" target="_blank" rel="noopener">Postgres</a> data types.</p>
</dd>
<dt>jdbi3-sqlite</dt>
<dd>
<p>Support for <a href="https://www.sqlite.org/index.html" target="_blank" rel="noopener">sqlite</a> data types.</p>
</dd>
<dt>jdbi3-oracle12</dt>
<dd>
<p>Support Oracle returning DML statements.</p>
</dd>
<dt>jdbi3-postgis</dt>
<dd>
<p>Support for <a href="https://postgis.net/" target="_blank" rel="noopener">PostGIS</a> types.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
While Oracle support is considered part of Jdbi, the actual library is developed and shipped as a separate component for historic reasons.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_sql_rendering"><a class="anchor" href="#_sql_rendering"></a><a class="link" href="#_sql_rendering">SQL rendering</a></h5>
<div class="paragraph">
<p>SQL statements can be rendered before they are sent to the database driver. Unless explicitly configured, Jdbi uses a simple render engine that replaces <code>&lt;&#8230;&#8203;&gt;</code> placeholders. It is possible to replace this engine with other template engines.</p>
</div>
<div class="dlist glossary">
<dl>
<dt>jdbi3-stringtemplate4</dt>
<dd>
<p>Use the <a href="https://www.stringtemplate.org/" target="_blank" rel="noopener">StringTemplate 4</a> template engine to render SQL statements.</p>
</dd>
<dt>jdbi3-commons-text</dt>
<dd>
<p>Use <a href="https://commons.apache.org/proper/commons-text/" target="_blank" rel="noopener">Apache Commons Text</a> to render SQL statements.</p>
</dd>
<dt>jdbi3-freemarker</dt>
<dd>
<p>Use <a href="https://freemarker.apache.org/" target="_blank" rel="noopener">Apache Freemarker</a> to render SQL statements.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_cache_support"><a class="anchor" href="#_cache_support"></a><a class="link" href="#_cache_support">Cache support</a></h5>
<div class="dlist glossary">
<dl>
<dt>jdbi3-caffeine-cache</dt>
<dd>
<p>Use the <a href="https://github.com/ben-manes/caffeine" target="_blank" rel="noopener">Caffeine</a> caching library for SQL template and parse caching.</p>
</dd>
<dt>jdbi3-noop-cache</dt>
<dd>
<p>Turn off SQL template and parse caching for testing and debugging.</p>
</dd>
<dt>jdbi3-guava-cache</dt>
<dd>
<p>Use the <a href="https://github.com/google/guava/wiki/CachesExplained" target="_blank" rel="noopener">Guava Cache</a> caching library for SQL template and parse caching.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The guava caching module is considered experimental.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_additional_language_support"><a class="anchor" href="#_additional_language_support"></a><a class="link" href="#_additional_language_support">Additional Language support</a></h5>
<div class="paragraph">
<p>Jdbi can be used from any language and technology running on the JVM that can use Java code (Kotlin, Scala, Clojure, JRuby etc).</p>
</div>
<div class="paragraph">
<p>While Java is a first class citizen (and will be for the foreseeable future), we provide modules for some languages that allow more idiomatic access to Jdbi functionality.</p>
</div>
<div class="dlist glossary">
<dl>
<dt>jdbi3-kotlin</dt>
<dd>
<p>Automatically map Kotlin data classes.</p>
</dd>
<dt>jdbi3-kotlin-sqlobject</dt>
<dd>
<p>Kotlin support for the SQL Object extension.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_external_modules"><a class="anchor" href="#_external_modules"></a><a class="link" href="#_external_modules">2.3.2. External modules</a></h4>
<div class="paragraph">
<p>The following modules are maintained outside the main Jdbi tree:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 14.2857%;">
<col style="width: 42.8572%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Module</th>
<th class="tableblock halign-center valign-top">Source</th>
<th class="tableblock halign-center valign-top">Javadoc</th>
<th class="tableblock halign-center valign-top">Site</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jdbi3-oracle12</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://github.com/jdbi/jdbi3-oracle12/" target="_blank" rel="noopener">Github</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://jdbi.org/modules/jdbi3-oracle12/apidocs/" target="_blank" rel="noopener">Javadoc</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://jdbi.org/modules/jdbi3-oracle12/" target="_blank" rel="noopener">Site</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Support for Oracle 12 and beyond.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jdbi3-guava-cache</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://github.com/jdbi/jdbi3-guava-cache/" target="_blank" rel="noopener">Github</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://jdbi.org/modules/jdbi3-guava-cache/apidocs/" target="_blank" rel="noopener">Javadoc</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://jdbi.org/modules/jdbi3-guava-cache/" target="_blank" rel="noopener">Site</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Experimental support for the Guava cache library.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The additional modules are usually released in sync with the main release. If any of the links above for a release version do not resolve, it may be possible that a release was omitted by accident. In that case, please file an issue on the <a href="https://github.com/jdbi/jdbi/issues" target="_blank" rel="noopener">Bug Tracker</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_build_tools"><a class="anchor" href="#_build_tools"></a><a class="link" href="#_build_tools">2.3.3. Build tools</a></h4>
<div class="paragraph">
<p>All Jdbi modules are available through <a href="https://search.maven.org" target="_blank" rel="noopener">Maven Central</a>, so any project that uses a dependency management tool (Apache Maven, Gradle, sbt, leiningen, Apache Ivy etc.) can access these.</p>
</div>
<div class="paragraph">
<p>For Apache Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>jdbi3-core<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>3.41.3-SNAPSHOT<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For Gradle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
    implementation(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jdbi:jdbi3-core:3.41.3-SNAPSHOT</span><span class="delimiter">&quot;</span></span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using multiple Jdbi modules, it is important that all modules use the same version. There is no guarantee that mixing versions will work.</p>
</div>
<div class="paragraph">
<p>Jdbi offers a BOM (Bill of Materials) that can be used to provide a consistent version for all Jdbi components.</p>
</div>
<div class="paragraph">
<p>For Apache Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
    <span class="tag">&lt;dependencies&gt;</span>
        <span class="tag">&lt;dependency&gt;</span>
            <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
            <span class="tag">&lt;artifactId&gt;</span>jdbi3-bom<span class="tag">&lt;/artifactId&gt;</span>
            <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
            <span class="tag">&lt;version&gt;</span>3.41.3-SNAPSHOT<span class="tag">&lt;/version&gt;</span>
            <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
        <span class="tag">&lt;/dependency&gt;</span>
    <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>adds the Jdbi BOM module into the <code>dependencyManagement</code> section.</p>
</div>
<div class="paragraph">
<p>Jdbi components in use are declared in the <code>&lt;dependencies&gt;</code> section <strong>without a version</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>jdbi3-core<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For Gradle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
    <span class="comment">// Load bill of materials (BOM) for Jdbi.</span>
    implementation(platform(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jdbi:jdbi3-bom:3.41.3-SNAPSHOT</span><span class="delimiter">&quot;</span></span>))
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>adds the BOM as dependency constraints to Gradle.</p>
</div>
<div class="paragraph">
<p>Jdbi components are declared without versions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
    implementation(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jdbi:jdbi3-core</span><span class="delimiter">&quot;</span></span>)
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_alpha_and_beta_annotations"><a class="anchor" href="#_alpha_and_beta_annotations"></a><a class="link" href="#_alpha_and_beta_annotations">2.3.4. @Alpha and @Beta Annotations</a></h4>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/meta/Alpha.html" target="_blank" rel="noopener">@Alpha</a> and <a href="./apidocs/org/jdbi/v3/meta/Beta.html" target="_blank" rel="noopener">@Beta</a> annotations mark APIs as unstable. Each of these annotations signifies that a public API (public class, method or field) is subject to incompatible changes, or even removal, in a future release. Any API bearing these annotations is exempt from any compatibility guarantees.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Alpha</code>&#8201;&#8212;&#8201;Alpha APIs are intended as early preview of features that might eventually get promoted.</p>
</li>
<li>
<p><code>Beta</code>&#8201;&#8212;&#8201;It is generally safe for applications to depend on beta APIs, at the cost of some extra work during upgrades. However, libraries (which get included on an application classpath) should not depend on Beta APIs as the classpath is outside the control of the library.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that the presence of this annotation implies nothing about the quality or performance of the API in question, only the fact that it is not "API-frozen."</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Add <code>Alpha</code> and <code>Beta</code> to your IDE&#8217;s "unstable API usage" blacklist.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_internal_packages"><a class="anchor" href="#_internal_packages"></a><a class="link" href="#_internal_packages">2.3.5. Internal packages</a></h4>
<div class="paragraph">
<p>Any class in a package that is marked as <code>internal</code> (contains the word "internal") is not a part of the public API and may change in a backwards incompatible way. These classes and interfaces may be used across the Jdbi code base and can change (or be removed) without deprecation or announcement.</p>
</div>
</div>
<div class="sect3">
<h4 id="_mixing_jdbi_component_versions"><a class="anchor" href="#_mixing_jdbi_component_versions"></a><a class="link" href="#_mixing_jdbi_component_versions">2.3.6. Mixing Jdbi component versions</a></h4>
<div class="paragraph">
<p>There is no guarantee that Jdbi components of different versions (e.g. <code>jdbi3-core</code> version 1.2.3 and <code>jdbi-sqlobject</code> version 1.3.1) work together. Jdbi versioning is the <strong>public API</strong> exposed to consumers. All Jdbi components used in a project or service should use the same version. See the section on <a href="#_build_tools">Build tools</a> on how to use the BOM module to provide consistent versions for all components.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_api_overview"><a class="anchor" href="#_api_overview"></a><a class="link" href="#_api_overview">3. API Overview</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jdbi&#8217;s API comes in two flavors:</p>
</div>
<div class="sect2">
<h3 id="_fluent_api"><a class="anchor" href="#_fluent_api"></a><a class="link" href="#_fluent_api">3.1. Fluent API</a></h3>
<div class="paragraph">
<p>The Core API provides a fluent, imperative interface. Use Builder style objects to wire up your SQL to rich Java data types.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Jdbi jdbi = Jdbi.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:test</span><span class="delimiter">&quot;</span></span>); <span class="comment">// (H2 in-memory database)</span>

<span class="predefined-type">List</span>&lt;User&gt; users = jdbi.withHandle(handle -&gt; {
    handle.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE TABLE </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> (id INTEGER PRIMARY KEY, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content"> VARCHAR)</span><span class="delimiter">&quot;</span></span>);

    <span class="comment">// Inline positional parameters</span>
    handle.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> (id, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content">) VALUES (?, ?)</span><span class="delimiter">&quot;</span></span>, <span class="integer">0</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>);

    <span class="comment">// Positional parameters</span>
    handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> (id, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content">) VALUES (?, ?)</span><span class="delimiter">&quot;</span></span>)
            .bind(<span class="integer">0</span>, <span class="integer">1</span>) <span class="comment">// 0-based parameter indexes</span>
            .bind(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>)
            .execute();

    <span class="comment">// Named parameters</span>
    handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> (id, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content">) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
            .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">2</span>)
            .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Clarice</span><span class="delimiter">&quot;</span></span>)
            .execute();

    <span class="comment">// Named parameters from bean properties</span>
    handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> (id, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content">) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
            .bindBean(<span class="keyword">new</span> User(<span class="integer">3</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">David</span><span class="delimiter">&quot;</span></span>))
            .execute();

    <span class="comment">// Easy mapping to any type</span>
    <span class="keyword">return</span> handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> ORDER BY </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>)
            .mapToBean(User.class)
            .list();
});

assertThat(users).containsExactly(
        <span class="keyword">new</span> User(<span class="integer">0</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>),
        <span class="keyword">new</span> User(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>),
        <span class="keyword">new</span> User(<span class="integer">2</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Clarice</span><span class="delimiter">&quot;</span></span>),
        <span class="keyword">new</span> User(<span class="integer">3</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">David</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>See the <a href="#_core_api_concepts">chapter introducing the core API</a> for details about Jdbi&#8217;s fluent API.</p>
</div>
</div>
<div class="sect2">
<h3 id="_declarative_api"><a class="anchor" href="#_declarative_api"></a><a class="link" href="#_declarative_api">3.2. Declarative API</a></h3>
<div class="paragraph">
<p>The <a href="#sql-objects">SQL Object extension</a> is an additional module, which provides a declarative API.</p>
</div>
<div class="paragraph">
<p>Define the SQL to execute and the shape of the results by creating  an annotated Java interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Declare the API using annotations on a Java interface</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE TABLE </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> (id INTEGER PRIMARY KEY, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content"> VARCHAR)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> createTable();

    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> (id, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content">) VALUES (?, ?)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> insertPositional(<span class="type">int</span> id, <span class="predefined-type">String</span> name);

    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> (id, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content">) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> insertNamed(<span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="type">int</span> id, <span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> name);

    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> (id, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content">) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> insertBean(<span class="annotation">@BindBean</span> User user);

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> ORDER BY </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@RegisterBeanMapper</span>(User.class)
    <span class="predefined-type">List</span>&lt;User&gt; listUsers();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then attach the interface to a Jdbi instance and execute the methods on the resuling class to execute the SQL queries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Jdbi jdbi = Jdbi.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:test</span><span class="delimiter">&quot;</span></span>);
jdbi.installPlugin(<span class="keyword">new</span> SqlObjectPlugin());

<span class="comment">// Jdbi implements your interface based on annotations</span>
<span class="predefined-type">List</span>&lt;User&gt; userNames = jdbi.withExtension(UserDao.class, dao -&gt; {
    dao.createTable();

    dao.insertPositional(<span class="integer">0</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>);
    dao.insertPositional(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>);
    dao.insertNamed(<span class="integer">2</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Clarice</span><span class="delimiter">&quot;</span></span>);
    dao.insertBean(<span class="keyword">new</span> User(<span class="integer">3</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">David</span><span class="delimiter">&quot;</span></span>));

    <span class="keyword">return</span> dao.listUsers();
});

assertThat(userNames).containsExactly(
        <span class="keyword">new</span> User(<span class="integer">0</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>),
        <span class="keyword">new</span> User(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>),
        <span class="keyword">new</span> User(<span class="integer">2</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Clarice</span><span class="delimiter">&quot;</span></span>),
        <span class="keyword">new</span> User(<span class="integer">3</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">David</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>See the <a href="#sql-objects">chapter on SQL objects</a> for more details about the declarative API. The declarative API uses the <a href="#_core_api_concepts">fluent API</a> "under the hood" and the two styles can be mixed.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_core_api_concepts"><a class="anchor" href="#_core_api_concepts"></a><a class="link" href="#_core_api_concepts">4. Core API concepts</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_the_jdbi_class"><a class="anchor" href="#_the_jdbi_class"></a><a class="link" href="#_the_jdbi_class">4.1. The Jdbi class</a></h3>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> class is the main entry point into the library.</p>
</div>
<div class="paragraph">
<p>Each <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance maintains a set of configuration settings and wraps a JDBC <a href="https://docs.oracle.com/javase/8/docs/api/javax/sql/DataSource.html" target="_blank" rel="noopener">DataSource</a>.</p>
</div>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instances are thread-safe and do not own any database resources.</p>
</div>
<div class="paragraph">
<p>There are a few ways to create a <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>use a JDBC URL:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// H2 in-memory database</span>
Jdbi jdbi = Jdbi.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:test</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>directly use a <code>DataSource</code> object which was created outside Jdbi.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">DataSource</span> ds = ...
Jdbi jdbi = Jdbi.create(ds);</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>from a custom class that implements <a href="./apidocs/org/jdbi/v3/core/ConnectionFactory.html" target="_blank" rel="noopener">ConnectionFactory</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This allows for custom implementations of connection providers such as HA failover, proxy solutions etc.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>from a single <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/Connection.html" target="_blank" rel="noopener">JDBC Connection</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Please note that there is no magic. Any Handle or operation will use this one connection provided. If the connection is thread-safe, then multiple threads accessing the database will work properly, if the connection object is not thread-safe, then Jdbi will not be able to do anything about it.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Production code rarely provides a connection object directly to a <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance. It is useful for testing and debugging.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Applications create a single, shared <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance per data source, and set up any common configuration there.  See <a href="#_configuration">Configuration</a> for more details.</p>
</div>
<div class="paragraph">
<p>Jdbi does not provide connection pooling or other <a href="#_high_availability">High Availability</a> features, but it can be combined with other software that does.</p>
</div>
</div>
<div class="sect2">
<h3 id="_handle"><a class="anchor" href="#_handle"></a><a class="link" href="#_handle">4.2. Handle</a></h3>
<div class="paragraph">
<p>A <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> wraps an active <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/Connection.html" target="_blank" rel="noopener">database connection</a>.</p>
</div>
<div class="paragraph">
<p>Handle instances are created by a <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance to provide a database connection e.g. for a single HTTP request or event callback). Handles are intended to be short-lived and must be closed to release the database connection and possible other resources.</p>
</div>
<div class="paragraph">
<p>A <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> is used to prepare and run SQL statements against the database, and manage database transactions. It provides  access to fluent statement APIs that can bind arguments, execute the statement,
and then map any results into Java objects.</p>
</div>
<div class="paragraph">
<p>A <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> inherits configuration from the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> at the time it is created. See <a href="#_configuration">Configuration</a> for more details.</p>
</div>
<div class="paragraph">
<p>Handles and all attached query objects such as <a href="./apidocs/org/jdbi/v3/core/statement/Batch.html" target="_blank" rel="noopener">Batch</a>, <a href="./apidocs/org/jdbi/v3/core/statement/Call.html" target="_blank" rel="noopener">Call</a>, <a href="./apidocs/org/jdbi/v3/core/statement/Query.html" target="_blank" rel="noopener">Query</a>, <a href="./apidocs/org/jdbi/v3/core/statement/Script.html" target="_blank" rel="noopener">Script</a> and <a href="./apidocs/org/jdbi/v3/core/statement/Update.html" target="_blank" rel="noopener">Update</a> should be used by a single thread and are <strong>not thread-safe</strong>.</p>
</div>
<div class="paragraph">
<p>They may be used by multiple threads as long as there is coordination that only one thread at a time is accessing them. Managing Handles and query objects across threads is error-prone and should be avoided.</p>
</div>
<div class="sect3">
<h4 id="_obtaining_a_managed_handle"><a class="anchor" href="#_obtaining_a_managed_handle"></a><a class="link" href="#_obtaining_a_managed_handle">4.2.1. Obtaining a managed handle</a></h4>
<div class="paragraph">
<p>The most convenient way to get access to a handle is by using the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withHandle(org.jdbi.v3.core.HandleCallback)" target="_blank" rel="noopener">withHandle</a> or <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useHandle(org.jdbi.v3.core.HandleConsumer)" target="_blank" rel="noopener">useHandle</a> methods on the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> class. These methods use callbacks and provide a fully managed handle that is correctly closed and all related resources are released. <code>withHandle</code> allows the callback to return a result while <code>useHandle</code> is just executing operations that do not need to return any value.</p>
</div>
<div class="paragraph">
<p>Providing a return value from a query using the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withHandle(org.jdbi.v3.core.HandleCallback)" target="_blank" rel="noopener">Jdbi#withHandle()</a> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; names = jdbi.withHandle(handle -&gt;
    handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">select name from contacts</span><span class="delimiter">&quot;</span></span>)
          .mapTo(<span class="predefined-type">String</span>.class)
          .list());
assertThat(names).contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Executing an operation using the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useHandle(org.jdbi.v3.core.HandleConsumer)" target="_blank" rel="noopener">Jdbi#useHandle()</a> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.useHandle(handle -&gt; {
    handle.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">create table contacts (id int primary key, name varchar(100))</span><span class="delimiter">&quot;</span></span>);
    handle.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">insert into contacts (id, name) values (?, ?)</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>);
    handle.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">insert into contacts (id, name) values (?, ?)</span><span class="delimiter">&quot;</span></span>, <span class="integer">2</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>);
});</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You may notice the "consumer" vs "callback" naming pattern in a few  places in Jdbi. Callbacks return a value, and are coupled to <code>with-</code> methods. Consumers do not return a value, and are coupled to <code>use-</code> methods.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_managing_the_handle_lifecycle_manually"><a class="anchor" href="#_managing_the_handle_lifecycle_manually"></a><a class="link" href="#_managing_the_handle_lifecycle_manually">4.2.2. Managing the Handle lifecycle manually</a></h4>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#open()" target="_blank" rel="noopener">Jdbi#open()</a> method returns an unmanaged handle.</p>
</div>
<div class="paragraph">
<p>The Java <em>try-with-resources</em> construct can be used to manage the lifecycle of the handle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (Handle handle = jdbi.open()) {
    result = handle.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">insert into contacts (id, name) values (?, ?)</span><span class="delimiter">&quot;</span></span>, <span class="integer">3</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Chuck</span><span class="delimiter">&quot;</span></span>);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An unmanaged handle must be used when a stateful object should be passed to the calling code. Stateful objects are iterators and streams that do not collect data ahead of time in memory but provide a data stream from the database through the <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/Connection.html" target="_blank" rel="noopener">JDBC Connection</a> to the calling code. Using a callback does not work here because the connection would be closed before the calling code can consume the data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (Handle handle = jdbi.open()) {
    <span class="predefined-type">Iterator</span>&lt;<span class="predefined-type">String</span>&gt; names = handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">select name from contacts where id = 1</span><span class="delimiter">&quot;</span></span>)
            .mapTo(<span class="predefined-type">String</span>.class)
            .iterator();
    assertThat(names).hasNext();
    <span class="predefined-type">String</span> name = names.next();
    assertThat(name).isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>);
    assertThat(names).isExhausted();
}</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
When using <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#open()" target="_blank" rel="noopener">Jdbi#open()</a>, you should consider using <em>try-with-resource</em> or a <em>try-finally</em> block to ensure the handle is closed and the database connection is released. Failing to release the handle will leak connections. It is recommended to use a managed handle whenever possible.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_statement_types"><a class="anchor" href="#_statement_types"></a><a class="link" href="#_statement_types">4.3. Statement types</a></h3>
<div class="paragraph">
<p>Any database operation within Jdbi uses a statement. Multiple types of statements exist:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./apidocs/org/jdbi/v3/core/statement/Query.html" target="_blank" rel="noopener">Query</a> - SQL statements that return results, e.g. a <code>SELECT</code> or any statement with a <code>RETURNING</code> clause. See <a href="./apidocs/org/jdbi/v3/core/Handle.html#createQuery(java.lang.CharSequence)" target="_blank" rel="noopener">createQuery</a></p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/core/statement/Update.html" target="_blank" rel="noopener">Update</a> - SQL statements that return no value such as <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code> or a DDL operation. See <a href="./apidocs/org/jdbi/v3/core/Handle.html#createUpdate(java.lang.CharSequence)" target="_blank" rel="noopener">createUpdate</a></p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/core/statement/Batch.html" target="_blank" rel="noopener">Batch</a> - a set of operations that are executed as a batch. See <a href="./apidocs/org/jdbi/v3/core/Handle.html#createBatch()" target="_blank" rel="noopener">createBatch</a></p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/core/statement/Call.html" target="_blank" rel="noopener">Call</a> - execute a stored procedure. See <a href="./apidocs/org/jdbi/v3/core/Handle.html#createCall(java.lang.CharSequence)" target="_blank" rel="noopener">createCall</a></p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/core/statement/Script.html" target="_blank" rel="noopener">Script</a> - a SQL script containing multiple statements separated by <code>;</code> that is executed as a batch. See <a href="./apidocs/org/jdbi/v3/core/Handle.html#createScript(java.lang.CharSequence)" target="_blank" rel="noopener">createScript</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_queries"><a class="anchor" href="#_queries"></a><a class="link" href="#_queries">4.3.1. Queries</a></h4>
<div class="paragraph">
<p>A <a href="./apidocs/org/jdbi/v3/core/statement/Query.html" target="_blank" rel="noopener">Query</a> is a
<a href="./apidocs/org/jdbi/v3/core/result/ResultBearing.html" target="_blank" rel="noopener">result-bearing</a> SQL statement
that returns a result set from the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;&gt; users =
    handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content"> FROM </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> ORDER BY id ASC</span><span class="delimiter">&quot;</span></span>)
        .mapToMap()
        .list();

assertThat(users).containsExactly(
        map(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>),
        map(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">2</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are many different methods to collect results from a query.</p>
</div>
<div class="paragraph">
<p>Use the <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#one()" target="_blank" rel="noopener">ResultIterable#one()</a> method returns when you expect the result to contain exactly one row. This method returns
<code>null</code> only if the returned row maps to <code>null</code> and throws an exception if the result has zero or multiple rows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> name = handle.select(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT name FROM users WHERE id = ?</span><span class="delimiter">&quot;</span></span>, <span class="integer">3</span>)
    .mapTo(<span class="predefined-type">String</span>.class)
    .one();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#findOne()" target="_blank" rel="noopener">ResultIterable#findOne()</a> method when you expect the result to contain zero or one row. Returns
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html#empty--" target="_blank" rel="noopener">Optional.empty()</a> if there are no rows, or one row that maps to <code>null</code> and throws  an exception if the result has multiple rows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Optional&lt;<span class="predefined-type">String</span>&gt; name = handle.select(...)
    .mapTo(<span class="predefined-type">String</span>.class)
    .findOne();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#first()" target="_blank" rel="noopener">ResultIterable#first()</a> method when you expect the result to contain at least one row. Returns
<code>null</code> if the first row maps to <code>null</code>. and throws an exception if the result has  zero rows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> name = handle.select(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT name FROM users WHERE id = ?</span><span class="delimiter">&quot;</span></span>, <span class="integer">3</span>)
    .mapTo(<span class="predefined-type">String</span>.class)
    .first();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#findFirst()" target="_blank" rel="noopener">ResultIterable#findFirst()</a> method when the result may contain any number of rows. Returns
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html#empty--" target="_blank" rel="noopener">Optional.empty()</a> if there are no rows, or the first row maps to <code>null</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Optional&lt;<span class="predefined-type">String</span>&gt; name = handle.select(...)
    .mapTo(<span class="predefined-type">String</span>.class)
    .findFirst();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple result rows can be returned in a list or a set:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; names = <span class="local-variable">this</span>.handle
        .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT title FROM films WHERE genre = :genre ORDER BY title</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Action</span><span class="delimiter">&quot;</span></span>)
        .mapTo(<span class="predefined-type">String</span>.class)
        .list();

<span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; names = handle
        .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT title FROM films WHERE genre = :genre ORDER BY title</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Action</span><span class="delimiter">&quot;</span></span>)
        .mapTo(<span class="predefined-type">String</span>.class)
        .set();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#list()" target="_blank" rel="noopener">ResultIterable#list()</a> and Use the <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#set()" target="_blank" rel="noopener">ResultIterable#set()</a> methods use the default implementations from the collections framework.</p>
</div>
<div class="paragraph">
<p>For more control over the set and list types, use the <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#collectIntoList()" target="_blank" rel="noopener">ResultIterable#collectIntoList()</a> and <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#collectIntoSet()" target="_blank" rel="noopener">ResultIterable#collectIntoSet()</a> methods which use the <a href="./apidocs/org/jdbi/v3/core/collector/JdbiCollectors.html" target="_blank" rel="noopener">JdbiCollectors</a> configuration object to retrieve the collection types for <a href="https://docs.oracle.com/javase/8/docs/api/java/util/List.html" target="_blank" rel="noopener">List</a> and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Set.html" target="_blank" rel="noopener">Set</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; names = handle
        .registerCollector(<span class="predefined-type">List</span>.class, Collectors.toCollection(<span class="predefined-type">LinkedList</span>::<span class="keyword">new</span>))
        .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT title FROM films WHERE genre = :genre ORDER BY title</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Action</span><span class="delimiter">&quot;</span></span>)
        .mapTo(<span class="predefined-type">String</span>.class)
        .collectIntoList();

<span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; names = handle
        .registerCollector(<span class="predefined-type">Set</span>.class, Collectors.toCollection(<span class="predefined-type">LinkedHashSet</span>::<span class="keyword">new</span>))
        .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT title FROM films WHERE genre = :genre ORDER BY title</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Action</span><span class="delimiter">&quot;</span></span>)
        .mapTo(<span class="predefined-type">String</span>.class)
        .collectIntoSet();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The  <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#collectInto(java.lang.reflect.Type)" target="_blank" rel="noopener">ResultIterable#collectInto()</a> methods allows specifying a container type directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; names = handle
        .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT title FROM films WHERE genre = :genre ORDER BY title</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Action</span><span class="delimiter">&quot;</span></span>)
        .mapTo(<span class="predefined-type">String</span>.class)
        .collectInto(<span class="predefined-type">List</span>.class); <i class="conum" data-value="1"></i><b>(1)</b>

<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; names = handle
        .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT title FROM films WHERE genre = :genre ORDER BY title</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Action</span><span class="delimiter">&quot;</span></span>)
        .mapTo(<span class="predefined-type">String</span>.class)
        .collectInto(GenericTypes.parameterizeClass(<span class="predefined-type">List</span>.class, <span class="predefined-type">String</span>.class)); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>collect into a raw collection type</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>collect into a parameterized generic type</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For other collections, use <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#collect(java.util.stream.Collector)" target="_blank" rel="noopener">ResultIterable#collect()</a> with a
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html" target="_blank" rel="noopener">collector</a> or <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#toCollection(java.util.function.Supplier)" target="_blank" rel="noopener">ResultIterable#toCollection()</a> with a collection supplier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; names = handle
        .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT title FROM films WHERE genre = :genre ORDER BY title</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Action</span><span class="delimiter">&quot;</span></span>)
        .mapTo(<span class="predefined-type">String</span>.class)
        .collect(Collectors.toSet());

<span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; names = handle
        .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT title FROM films WHERE genre = :genre ORDER BY title</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Action</span><span class="delimiter">&quot;</span></span>)
        .mapTo(<span class="predefined-type">String</span>.class)
        .toCollection(() -&gt; <span class="keyword">new</span> <span class="predefined-type">LinkedHashSet</span>&lt;&gt;());</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#collectToMap(java.util.function.Function,java.util.function.Function)" target="_blank" rel="noopener">ResultIterable#collectToMap()</a> method allows collecting results directly into a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html" target="_blank" rel="noopener">Map</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>&gt; names = handle
        .registerRowMapper(Movie.class, ConstructorMapper.of(Movie.class))
        .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM films WHERE genre = :genre ORDER BY title</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Action</span><span class="delimiter">&quot;</span></span>)
        .mapTo(Movie.class)
        .collectToMap(Movie::id, Movie::title);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also stream results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; names = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
handle.createQuery(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT title FROM films WHERE genre = :genre ORDER BY title</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Action</span><span class="delimiter">&quot;</span></span>)
        .mapTo(<span class="predefined-type">String</span>.class)
        .useStream(stream -&gt; stream.forEach(names::add)); <i class="conum" data-value="1"></i><b>(1)</b>

<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; names = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
<span class="keyword">try</span> (Stream&lt;<span class="predefined-type">String</span>&gt; stream = handle.createQuery(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT title FROM films WHERE genre = :genre ORDER BY title</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">genre</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Action</span><span class="delimiter">&quot;</span></span>)
        .mapTo(<span class="predefined-type">String</span>.class)
        .stream()) { <i class="conum" data-value="2"></i><b>(2)</b>

    stream.forEach(names::add);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#useStream(org.jdbi.v3.core.result.StreamConsumer)" target="_blank" rel="noopener">ResultIterable#useStream()</a> and <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#withStream(org.jdbi.v3.core.result.StreamCallback)" target="_blank" rel="noopener">ResultIterable#withStream()</a> provide a callback with a managed stream object.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#stream()" target="_blank" rel="noopener">ResultIterable#stream()</a> provides a stream that must be managed by user code</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Equivalent methods for iterators exist as well.</p>
</div>
<div class="paragraph">
<p>Thus far, all examples have shown a <code>String</code> result type. Of course, you can
map to many other data types such as an integer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">int</span> releaseDate = handle
        .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT release_year FROM films WHERE title = :title</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">The Dark Knight</span><span class="delimiter">&quot;</span></span>)
        .mapTo(<span class="predefined-type">Integer</span>.class)
        .one();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or a complex, custom type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Movie movie = handle
        .registerRowMapper(Movie.class, ConstructorMapper.of(Movie.class))
        .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM films WHERE id = :id</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>)
        .mapTo(Movie.class)
        .one();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_updates"><a class="anchor" href="#_updates"></a><a class="link" href="#_updates">4.3.2. Updates</a></h4>
<div class="paragraph">
<p>Updates are operations that return an integer number of rows modified, such
as a database <strong>INSERT</strong>, <strong>UPDATE</strong>, or <strong>DELETE</strong>.</p>
</div>
<div class="paragraph">
<p>You can execute a simple update with <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a>'s <code>int execute(String sql, Object&#8230;&#8203; args)</code>
method which binds simple positional parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">count = handle.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> (id, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content">) VALUES(?, ?)</span><span class="delimiter">&quot;</span></span>, <span class="integer">4</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>);
assertThat(count).isOne();</code></pre>
</div>
</div>
<div class="paragraph">
<p>To further customize, use <code>createUpdate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">int</span> count = handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> (id, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content">) VALUES(:id, :name)</span><span class="delimiter">&quot;</span></span>)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">3</span>)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Charlie</span><span class="delimiter">&quot;</span></span>)
    .execute();
assertThat(count).isOne();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Updates may return <a href="#_generated_keys">Generated Keys</a> instead of a result count.</p>
</div>
</div>
<div class="sect3">
<h4 id="_batches"><a class="anchor" href="#_batches"></a><a class="link" href="#_batches">4.3.3. Batches</a></h4>
<div class="paragraph">
<p>A <strong>Batch</strong> sends many commands to the server in bulk.</p>
</div>
<div class="paragraph">
<p>After opening the batch, repeated add statements, and invoke <strong>add</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Batch batch = handle.createBatch();

batch.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO fruit VALUES(0, 'apple')</span><span class="delimiter">&quot;</span></span>);
batch.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO fruit VALUES(1, 'banana')</span><span class="delimiter">&quot;</span></span>);

<span class="type">int</span><span class="type">[]</span> rowsModified = batch.execute();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The statements are sent to the database in bulk, but each statement is executed separately.
There are no parameters.  Each statement returns a modification count, as with an Update, and
those counts are then returned in an <code>int[]</code> array.  In common cases all elements will be <code>1</code>.</p>
</div>
<div class="paragraph">
<p>Some database drivers might return special values in conditions where modification counts are not available.
See the
<a href="https://docs.oracle.com/javase/8/docs/api/java/sql/Statement.html#executeBatch--" target="_blank" rel="noopener">executeBatch</a> documentation for details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_prepared_batches"><a class="anchor" href="#_prepared_batches"></a><a class="link" href="#_prepared_batches">4.3.4. Prepared Batches</a></h4>
<div class="paragraph">
<p>A <strong>PreparedBatch</strong> sends one statement to the server with many argument sets.
The statement is executed repeatedly, once for each batch of arguments that is <strong>add</strong>-ed to it.</p>
</div>
<div class="paragraph">
<p>The result is again a <code>int[]</code> of modified row count.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">PreparedBatch batch = handle.prepareBatch(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> (id, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content">) VALUES(:id, :name)</span><span class="delimiter">&quot;</span></span>);
<span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">100</span>; i &lt; <span class="integer">5000</span>; i++) {
    batch.bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, i).bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">User:</span><span class="delimiter">&quot;</span></span> + i).add();
}
<span class="type">int</span><span class="type">[]</span> counts = batch.execute();</code></pre>
</div>
</div>
<div class="paragraph">
<p>SqlObject also supports batch inserts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> testSqlObjectBatch() {
    BasketOfFruit basket = handle.attach(BasketOfFruit.class);

    <span class="type">int</span><span class="type">[]</span> rowsModified = basket.fillBasket(<span class="predefined-type">Arrays</span>.asList(
            <span class="keyword">new</span> Fruit(<span class="integer">0</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">apple</span><span class="delimiter">&quot;</span></span>),
            <span class="keyword">new</span> Fruit(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">banana</span><span class="delimiter">&quot;</span></span>)));

    assertThat(rowsModified).containsExactly(<span class="integer">1</span>, <span class="integer">1</span>);
    assertThat(basket.countFruit()).isEqualTo(<span class="integer">2</span>);
}

<span class="directive">public</span> <span class="type">interface</span> <span class="class">BasketOfFruit</span> {
    <span class="annotation">@SqlBatch</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO fruit VALUES(:id, :name)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">int</span><span class="type">[]</span> fillBasket(<span class="annotation">@BindBean</span> <span class="predefined-type">Collection</span>&lt;Fruit&gt; fruits);

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT count(1) FROM fruit</span><span class="delimiter">&quot;</span></span>)
    <span class="type">int</span> countFruit();
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Batching dramatically increases efficiency over repeated single statement execution, but
many databases don&#8217;t handle extremely large batches well either.  Test with your database
configuration, but often extremely large data sets should be divided
and committed in pieces - or risk bringing your database to its knees.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_exception_rewriting"><a class="anchor" href="#_exception_rewriting"></a><a class="link" href="#_exception_rewriting">Exception Rewriting</a></h5>
<div class="paragraph">
<p>The JDBC SQLException class is very old and predates more modern exception
facilities like Throwable&#8217;s suppressed exceptions. When a batch fails, there
may be multiple failures to report, which could not be represented by the base
Exception types of the day.</p>
</div>
<div class="paragraph">
<p>So SQLException has a bespoke
<a href="https://docs.oracle.com/javase/8/docs/api/java/sql/SQLException.html#getNextException--" target="_blank" rel="noopener">getNextException</a>
chain to represent the causes of a batch failure. Unfortunately, by default
most logging libraries do not print these exceptions out, pushing their
handling into your code. It is very common to forget to handle this situation
and end up with logs that say nothing other than</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="asciidoc">java.sql.BatchUpdateException: Batch entry 1 INSERT INTO something (id, name) VALUES (0, '') was aborted. Call getNextException to see the cause.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Jdbi will rewrite such exceptions into "suppressed exceptions" so that your logs are more helpful:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="asciidoc">java.sql.BatchUpdateException: Batch entry 1 INSERT INTO something (id, name) VALUES (0, 'Keith') was aborted. Call getNextException to see the cause.
Suppressed: org.postgresql.util.PSQLException: ERROR: duplicate key value violates unique constraint &quot;something_pkey&quot;
  Detail: Key (id)=(0) already exists.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_stored_procedure_calls"><a class="anchor" href="#_stored_procedure_calls"></a><a class="link" href="#_stored_procedure_calls">4.3.5. Stored Procedure Calls</a></h4>
<div class="paragraph">
<p>A <strong>Call</strong> invokes a database stored procedure.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s assume an existing stored procedure as an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">FUNCTION</span> <span class="class">add</span>(a <span class="keyword">IN</span> <span class="predefined-type">INT</span>, b <span class="keyword">IN</span> <span class="predefined-type">INT</span>, <span class="predefined">sum</span> OUT <span class="predefined-type">INT</span>) <span class="keyword">AS</span> <span class="error">$</span><span class="error">$</span>
<span class="class">BEGIN</span>
  <span class="predefined">sum</span> := a + b;
<span class="keyword">END</span>;
<span class="error">$</span><span class="error">$</span> LANGUAGE plpgsql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s how to call a stored procedure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">OutParameters result = handle
    .createCall(<span class="string"><span class="delimiter">&quot;</span><span class="content">{:sum = call add(:a, :b)}</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span>, <span class="integer">13</span>) <i class="conum" data-value="2"></i><b>(2)</b>
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">b</span><span class="delimiter">&quot;</span></span>, <span class="integer">9</span>) <i class="conum" data-value="2"></i><b>(2)</b>
        .registerOutParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">sum</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Types</span>.INTEGER)  <i class="conum" data-value="3"></i><b>(3)</b> <i class="conum" data-value="4"></i><b>(4)</b>
        .invoke(); <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call <code>Handle.createCall()</code> with the SQL statement. Note that JDBC has a
peculiar SQL format when calling stored procedures, which we must follow.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Bind input parameters to the procedure call.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Register out parameters, the values that will be returned from the stored
procedure call. This tells JDBC what data type to expect for each out
parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Out parameters may be registered by name (as shown in the example) or by
zero-based index, if the SQL is using positional parameters. Multiple output
parameters may be registered, depending on the output of the stored
procedure itself.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Finally, call <code>invoke()</code> to execute the procedure.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Invoking the stored procedure returns an
<a href="./apidocs/org/jdbi/v3/core/statement/OutParameters.html" target="_blank" rel="noopener">OutParameters</a> object, which
contains the value(s) returned from the stored procedure call.</p>
</div>
<div class="paragraph">
<p>Now we can extract the result(s) from <a href="./apidocs/org/jdbi/v3/core/statement/OutParameters.html" target="_blank" rel="noopener">OutParameters</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">int</span> sum = result.getInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">sum</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is possible to return open cursors as a result-like object by declaring it
as <code>Types.REF_CURSOR</code> and then inspecting it via <code>OutParameters.getRowSet()</code>.
Usually this must be done in a transaction, and the results must be consumed
before closing the statement by processing it using the <code>Call.invoke(Consumer)</code>
or <code>Call.invoke(Function)</code> callback style.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Due to design constraints within JDBC, the parameter data types available
through <a href="./apidocs/org/jdbi/v3/core/statement/OutParameters.html" target="_blank" rel="noopener">OutParameters</a> is limited to those types supported directly by JDBC.
This cannot be expanded through e.g. mapper registration.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_scripts"><a class="anchor" href="#_scripts"></a><a class="link" href="#_scripts">4.3.6. Scripts</a></h4>
<div class="paragraph">
<p>A <strong>Script</strong> parses a String into semicolon terminated statements. The statements
can be executed in a single <strong>Batch</strong> or individually.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (Script script = handle.createScript(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> VALUES(3, 'Charlie');</span><span class="delimiter">&quot;</span></span>
        + <span class="string"><span class="delimiter">&quot;</span><span class="content">UPDATE </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> SET </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content">='Bobby Tables' WHERE id=2;</span><span class="delimiter">&quot;</span></span>)) {
    <span class="type">int</span><span class="type">[]</span> results = script.execute();

    assertThat(results).containsExactly(<span class="integer">1</span>, <span class="integer">1</span>);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_metadata"><a class="anchor" href="#_metadata"></a><a class="link" href="#_metadata">4.3.7. Metadata</a></h4>
<div class="paragraph">
<p>Jdbi allows access to the Database Metadata through <code>queryMetadata</code> methods on the <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a>.</p>
</div>
<div class="paragraph">
<p>Simple values can be queried directly using a method reference:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> url = h.queryMetadata(<span class="predefined-type">DatabaseMetaData</span>::getURL);
<span class="type">boolean</span> supportsTransactions = h.queryMetadata(<span class="predefined-type">DatabaseMetaData</span>::supportsTransactions);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Many methods on the <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/DatabaseMetaData.html" target="_blank" rel="noopener">DatabaseMetaData</a> return a <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" target="_blank" rel="noopener">ResultSet</a>. These can be used with the <code>queryMetadata</code> method that returns a <a href="#_resultbearing">ResultBearing</a>.</p>
</div>
<div class="paragraph">
<p>All Jdbi <a href="#_row_mappers">Row Mappers</a> and <a href="#_column_mappers">Column Mappers</a> are available to map these results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; catalogNames = h.queryMetadata(<span class="predefined-type">DatabaseMetaData</span>::getCatalogs)
            .mapTo(<span class="predefined-type">String</span>.class)
            .list();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_usage_in_asynchronous_applications"><a class="anchor" href="#_usage_in_asynchronous_applications"></a><a class="link" href="#_usage_in_asynchronous_applications">4.4. Usage in asynchronous applications</a></h3>
<div class="paragraph">
<p>Calling Jdbc and by extension Jdbi is inherently a blocking operation.
In asynchronous applications
(where results are returned as a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletionStage.html" target="_blank" rel="noopener">CompletionStage</a>
or a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html" target="_blank" rel="noopener">CompletableFuture</a>)
it is very important never to block on threads that the caller doesn&#8217;t control. For this, there is the
<a href="./apidocs/org/jdbi/v3/core/async/JdbiExecutor.html" target="_blank" rel="noopener">JdbiExcecutor</a> class that wraps around a <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance
and makes sure calls are made on a specific thread pool.</p>
</div>
<div class="paragraph">
<p>To create a <a href="./apidocs/org/jdbi/v3/core/async/JdbiExecutor.html" target="_blank" rel="noopener">JdbiExcecutor</a> instance, we first need to create
a <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance (see <a href="#_the_jdbi_class">The Jdbi class</a>). Then pass that instance into
<a href="./apidocs/org/jdbi/v3/core/async/JdbiExecutor.html#create(org.jdbi.v3.core.Jdbi,java.util.concurrent.Executor)" target="_blank" rel="noopener">JdbiExecutor.create()</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Executor</span> executor = <span class="predefined-type">Executors</span>.newFixedThreadPool(<span class="integer">8</span>);
JdbiExecutor jdbiExecutor = JdbiExecutor.create(h2Extension.getJdbi(), executor);</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is important to size the executor to the specific implementation.
See <a href="./apidocs/org/jdbi/v3/core/async/JdbiExecutor.html#create(org.jdbi.v3.core.Jdbi,java.util.concurrent.Executor)" target="_blank" rel="noopener">here</a> for some hints.</p>
</div>
<div class="paragraph">
<p>To use the <code>jdbiExecutor</code>, we make similar calls to <a href="./apidocs/org/jdbi/v3/core/async/JdbiExecutor.html" target="_blank" rel="noopener">JdbiExcecutor</a>
as we do to <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CompletionStage&lt;<span class="predefined-type">Void</span>&gt; futureResult = jdbiExecutor.useHandle(handle -&gt; {
    handle.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">insert into contacts (id, name) values (?, ?)</span><span class="delimiter">&quot;</span></span>, <span class="integer">3</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Erin</span><span class="delimiter">&quot;</span></span>);
});

<span class="comment">// wait for stage to complete (don't do this in production code!)</span>
futureResult.toCompletableFuture().join();
assertThat(h2Extension.getSharedHandle().createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">select name from contacts where id = 3</span><span class="delimiter">&quot;</span></span>)
    .mapTo(<span class="predefined-type">String</span>.class)
    .list()).contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Erin</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CompletionStage&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt;&gt; futureResult = jdbiExecutor.withHandle(handle -&gt; {
    <span class="keyword">return</span> handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">select name from contacts where id = 1</span><span class="delimiter">&quot;</span></span>)
        .mapTo(<span class="predefined-type">String</span>.class)
        .list();
});

assertThat(futureResult)
    .succeedsWithin(<span class="predefined-type">Duration</span>.ofSeconds(<span class="integer">10</span>))
    .asList()
    .contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CompletionStage&lt;<span class="predefined-type">String</span>&gt; futureResult =
    jdbiExecutor.withExtension(SomethingDao.class, dao -&gt; dao.getName(<span class="integer">1</span>));

assertThat(futureResult)
    .succeedsWithin(<span class="predefined-type">Duration</span>.ofSeconds(<span class="integer">10</span>))
    .isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note, since the handle closes as soon as the callback returns, you cannot return
an iterator, since iteration will call upon the (now closed) handle</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CompletionStage&lt;<span class="predefined-type">Iterator</span>&lt;<span class="predefined-type">String</span>&gt;&gt; futureResult = jdbiExecutor.withHandle(handle -&gt; {
    <span class="keyword">return</span> handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">select name from contacts where id = 1</span><span class="delimiter">&quot;</span></span>)
        .mapTo(<span class="predefined-type">String</span>.class)
        .iterator();
});

<span class="comment">// wait for stage to complete (don't do this in production code!)</span>
<span class="predefined-type">Iterator</span>&lt;<span class="predefined-type">String</span>&gt; result = futureResult.toCompletableFuture().join();
<span class="comment">// result.hasNext() fails because the handle is already closed at this point</span>
assertThatException().isThrownBy(() -&gt; result.hasNext());</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_resource_management"><a class="anchor" href="#_resource_management"></a><a class="link" href="#_resource_management">5. Resource Management</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>JDBC operations involve stateful objects: <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/Connection.html" target="_blank" rel="noopener">Connection</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/PreparedStatement.html" target="_blank" rel="noopener">PreparedStatement</a> and <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" target="_blank" rel="noopener">ResultSet</a> are the most common ones. Jdbi understands the lifecycle of these objects and can often fully manage them.</p>
</div>
<div class="paragraph">
<p>Within Jdbi, two types of stateful objects exist that need to be managed: <a href="#_handle">Handle</a> objects and all <a href="#_statement_types">Statement objects</a>.</p>
</div>
<div class="paragraph">
<p>Manual resource management for Jdbi objects uses the standard Java <em>try-with-resources</em> construct:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (Handle handle = jdbi.open();
    <span class="predefined-type">Query</span> query = handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * from users</span><span class="delimiter">&quot;</span></span>)) {
    <span class="predefined-type">List</span>&lt;User&gt; users = query.mapTo(User.class).list();
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_automatic_resource_management"><a class="anchor" href="#_automatic_resource_management"></a><a class="link" href="#_automatic_resource_management">5.1. Automatic resource management</a></h3>
<div class="paragraph">
<p>Jdbi can manage and release resources automatically, so that <em>try-with-resources</em> blocks are often not needed.</p>
</div>
<div class="paragraph">
<p>Automatic resource management is only available with the SQL Object API and the Extension API. In these situations, Jdbi can manage all resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>with methods on a SQL object that was created with <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#onDemand(java.lang.Class)" target="_blank" rel="noopener">Jdbi#onDemand()</a>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">UserDao userDao = jdbi.onDemand(UserDao.class);
User user = userDao.getUser(id);

<span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users WHERE id = :id</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@UseRowMapper</span>(UserMapper.class)
    User getUser(<span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="type">int</span> id);
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>with the Jdbi <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withExtension-java.lang.Class-org.jdbi.v3.core.extension.ExtensionCallback-" target="_blank" rel="noopener">withExtension</a> and <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useExtension-java.lang.Class-org.jdbi.v3.core.extension.ExtensionConsumer-" target="_blank" rel="noopener">useExtension</a> callbacks:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">User user = jdbi.withExtension(UserDao.class, dao -&gt; dao.getUser(id));

<span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users WHERE id = :id</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@UseRowMapper</span>(UserMapper.class)
    User getUser(<span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="type">int</span> id);
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_handle_resource_management"><a class="anchor" href="#_handle_resource_management"></a><a class="link" href="#_handle_resource_management">5.2. Handle resource management</a></h3>
<div class="paragraph">
<p>Any time a handle is explicitly opened, it must be managed by the calling code. A <em>try-with-resources</em> block is the best way to do this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (Handle handle = jdbi.open()) {
    <span class="comment">// handle operations here</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Closing the handle releases the connection that is managed by the handle. Handle resource management is only necessary when using the various <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#open()" target="_blank" rel="noopener">Jdbi#open()</a> methods on the Jdbi object. Any handle that is passed in through a callback (<a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withHandle(org.jdbi.v3.core.HandleCallback)" target="_blank" rel="noopener">Jdbi#withHandle()</a>, <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useHandle(org.jdbi.v3.core.HandleConsumer)" target="_blank" rel="noopener">Jdbi#useHandle()</a>, <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#inTransaction(org.jdbi.v3.core.HandleCallback)" target="_blank" rel="noopener">Jdbi#inTransaction()</a>, <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useTransaction(org.jdbi.v3.core.HandleConsumer)" target="_blank" rel="noopener">Jdbi#useTransaction()</a>) is managed through Jdbi:</p>
</div>
<div class="paragraph">
<p>Jdbi is still able to manage statement resources even if the handle is managed manually:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (Handle handle = jdbi.open()) { <i class="conum" data-value="1"></i><b>(1)</b>
    UserDao dao = handle.attach(UserDao.class);
    User user = userDao.getUser(id);
}

User user = jdbi.withHandle(handle -&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
    UserDao dao = handle.attach(UserDao.class);
    <span class="keyword">return</span> userDao.getUser(id);
});

<span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users WHERE id = :id</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@UseRowMapper</span>(UserMapper.class)
    User getUser(<span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="type">int</span> id);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><a href="./apidocs/org/jdbi/v3/core/Jdbi.html#open()" target="_blank" rel="noopener">Jdbi.open()</a> creates a new Handle that must be managed through a <em>try-with-resources</em> block.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withHandle(org.jdbi.v3.core.HandleCallback)" target="_blank" rel="noopener">jdbi.withHandle()</a> passes a managed Handle to the callback and does not require management.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="statement-resource-management"><a class="anchor" href="#statement-resource-management"></a><a class="link" href="#statement-resource-management">5.3. Statement resource management</a></h3>
<div class="paragraph">
<p>All statement types may use resources that need to be released. There are multiple ways to do; each has its advantages and drawbacks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_explicit_statement_resource_management">Explicit statement resource management</a> uses code to manage and release resources</p>
</li>
<li>
<p><a href="#_implicit_statement_resource_cleanup">Implicit statement resource cleanup</a> relies on the Jdbi framework to release the resources when necessary</p>
</li>
<li>
<p><a href="#_attaching_statements_to_the_handle_lifecycle">Attaching statements to the handle lifecycle</a> delegates to the Handle lifecycle</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_explicit_statement_resource_management"><a class="anchor" href="#_explicit_statement_resource_management"></a><a class="link" href="#_explicit_statement_resource_management">5.3.1. Explicit statement resource management</a></h4>
<div class="paragraph">
<p>All <a href="#_statement_types">SQL statement types</a> implement the <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html" target="_blank" rel="noopener">AutoCloseable</a> interface and can be used in a <em>try-with-resources</em> block. This is the recommended way to manually manage statements, and it ensures that all resources are properly released when they are no longer needed. The <em>try-with-resources</em> pattern ensures that the <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html#close--" target="_blank" rel="noopener">close()</a> method on the SQL statement is called which releases the resources.</p>
</div>
<div class="paragraph">
<p>Create, execute and release 100,000 update statements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (Handle handle = jdbi.open()) {
    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">100</span>_000; i++) {
        <span class="keyword">try</span> (Update update = handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)) {
            update.bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, i)
                  .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">user_</span><span class="delimiter">&quot;</span></span> + i)
                  .execute();
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is not necessary to use a <em>try-with-resources</em> block, the close() method can be called manually as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (Handle handle = jdbi.open()) {
    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">100</span>_000; i++) {
        Update update = handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">try</span> {
            update.bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, i)
                  .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">user_</span><span class="delimiter">&quot;</span></span> + i)
                  .execute();
        } <span class="keyword">finally</span> {
            update.close();
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Explicit statement resource management, while a bit more involved ensures that all resources are always correctly released, especially when there are exceptions thrown during statement execution. While many examples and demo code omit managing the <a href="#_statement_types">statement types</a>, it is strongly recommended to do so.</p>
</div>
</div>
<div class="sect3">
<h4 id="_implicit_statement_resource_cleanup"><a class="anchor" href="#_implicit_statement_resource_cleanup"></a><a class="link" href="#_implicit_statement_resource_cleanup">5.3.2. Implicit statement resource cleanup</a></h4>
<div class="paragraph">
<p>If possible, Jdbi will help with resource management through implicit resource cleanup.</p>
</div>
<div class="paragraph">
<p>If a SQL statement operation succeeds  and <strong>all data returned by the database was consumed</strong>, then Jdbi will release the allocated resources even if the statement is used without a <em>try-with-resources</em> block.</p>
</div>
<div class="paragraph">
<p>All terminal operations on the <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html" target="_blank" rel="noopener">ResultIterable</a> interface, except for the <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#stream()" target="_blank" rel="noopener">stream()</a> and <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#stream()#iterator()" target="_blank" rel="noopener">iterator()</a> methods, consume all data from the database, even if they return only a subset (e.g. <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#findOne()" target="_blank" rel="noopener">findOne()</a>). The same applies for operations such as Update or Batch.</p>
</div>
<div class="paragraph">
<p>For all other operations, the resources will be released if the operation succeeds and does not throw an exception.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (Handle handle = jdbi.open()) {
    <span class="predefined-type">List</span>&lt;User&gt; users = handle
        .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * from users</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
        .mapTo(User.class) <i class="conum" data-value="2"></i><b>(2)</b>
        .list(); <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>creates a <a href="./apidocs/org/jdbi/v3/core/statement/Query.html" target="_blank" rel="noopener">Query</a> object</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>returns an object implementing <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html" target="_blank" rel="noopener">ResultIterable</a></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>is a terminal operation that consumes all the data from the database</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As long as no exception is thrown, this example above will release all resources allocated by the <a href="./apidocs/org/jdbi/v3/core/statement/Query.html" target="_blank" rel="noopener">Query</a> object, even though it is not managed.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This code that works well as long as nothing goes awry! If an unmanaged SQL statement operation fails halfway through (e.g. with a connection timeout or a database problem), then <strong>resources will not be cleanup up by Jdbi</strong>. This may lead to resource leaks that are difficult to find or reproduce. Some JDBC drivers will also clean up resources that they hand out (such as <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/PreparedStatement.html" target="_blank" rel="noopener">JDBC statements </a> or <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" target="_blank" rel="noopener">ResultSet</a> objects) when a connection is closed. In these situations, resources may be released eventually when the handle is closed (which also closes the JDBC connection). This is highly driver dependent and should not be relied upon.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="resources-with-streams-iterators"><a class="anchor" href="#resources-with-streams-iterators"></a><a class="link" href="#resources-with-streams-iterators">5.3.3. Resources with Streams and Iterators</a></h4>
<div class="paragraph">
<p>Most methods on objects that implement <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html" target="_blank" rel="noopener">ResultIterable</a> are terminal. They consume all data returned by the database and will release statement resources at the end. All of these methods may buffer results in memory, something that is not acceptable for very large data sets or when data needs to be streamed.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Just using an iterator or stream may not be enough to actually stream data without buffering it in memory. Often the JDBC driver might still buffer data. See the documentation for your database on how to ensure that the driver does not buffer all the results in memory.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For these use cases, Jdbi offers the <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#stream()" target="_blank" rel="noopener">stream()</a> and <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#iterator()" target="_blank" rel="noopener">iterator()</a> methods, which return lazy-loading objects that return data from the database row by row. These objects are stateful and must be managed.</p>
</div>
<div class="paragraph">
<p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html" target="_blank" rel="noopener">stream</a> and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Iterator.html" target="_blank" rel="noopener">iterator</a> objects provided by Jdbi will release all their resources when the data stream from the database is exhausted or when an instance is explicitly closed. Standard Java <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html" target="_blank" rel="noopener">Streams</a> support the <em>try-with-resources</em> pattern directly; the <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#iterator()" target="_blank" rel="noopener">iterator()</a> method returns a <a href="./apidocs/org/jdbi/v3/core/result/ResultIterator.html" target="_blank" rel="noopener">ResultIterator</a> object which extends <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html" target="_blank" rel="noopener">AutoCloseable</a>.</p>
</div>
<div class="paragraph">
<p>When using a stream or iterator, <strong>either</strong> the statement <strong>or</strong> the result object <strong>must</strong> be managed. Calling <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html#close--" target="_blank" rel="noopener">close()</a> on either the statement or the stream/iterator will terminate the operation and release all resources.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// managing resources through the query SQL statement</span>
<span class="keyword">try</span> (Handle handle = jdbi.open()) {
    <span class="keyword">try</span> (<span class="predefined-type">Query</span> query = handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * from users</span><span class="delimiter">&quot;</span></span>)) { <i class="conum" data-value="1"></i><b>(1)</b>
        Stream&lt;User&gt; users = query.mapTo(User.class).stream();
        <span class="comment">// consume the stream</span>
    }
}

<span class="comment">// managing resources through the stream</span>
<span class="keyword">try</span> (Handle handle = jdbi.open()) {
    <span class="keyword">try</span> (Stream&lt;User&gt; users = handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * from users</span><span class="delimiter">&quot;</span></span>)
        .mapTo(User.class)
        .stream()) { <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="comment">// consume the stream</span>
        }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>use a <em>try-with-resources</em> block with the <a href="#_queries">Query</a> object releases the resources and closes the stream when the block is left</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>use a <em>try-with-resources</em> block with the stream releases the resources and closes the stream when the block is left</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The same pattern applies to a result iterator.</p>
</div>
<div class="paragraph">
<p>Streams and iterators are cursor-type "live" objects. They require an active statement and result set. Any operation that closes and releases these resources will cause future operations on the stream or iterator to fail.</p>
</div>
<div class="paragraph">
<p>The following code <strong>does not work</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Stream&lt;User&gt; userStream = jdbi.withHandle(handle -&gt;
    handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * from users</span><span class="delimiter">&quot;</span></span>)
        .mapTo(User.class)
        .stream();  <i class="conum" data-value="1"></i><b>(1)</b>
    });  <i class="conum" data-value="2"></i><b>(2)</b>

Optional&lt;User&gt; user = stream.findFirst(); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates a stream object backed by the open result set of the query</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>leaving the callback closes the handle and releases all resources including the result set</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>throws an exception because the result set has already been closed</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This can be avoided by using one of the callback methods that ResultIterable offers: <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#withIterator(org.jdbi.v3.core.result.IteratorCallback)" target="_blank" rel="noopener">withIterator()</a>, <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#useIterator(org.jdbi.v3.core.result.IteratorConsumer)" target="_blank" rel="noopener">useIterator()</a>, <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#withStream(org.jdbi.v3.core.result.StreamCallback)" target="_blank" rel="noopener">withStream()</a>, <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.htmll#useStream(org.jdbi.v3.core.result.StreamConsumer)" target="_blank" rel="noopener">useStream()</a>. Each of these methods manages the iterator / stream through Jdbi and allow consumption of its contents within a callback:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (Handle handle = jdbi.open()) {
    <span class="keyword">try</span> (<span class="predefined-type">Query</span> query = handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * from users</span><span class="delimiter">&quot;</span></span>)) {
        query.mapTo(User.class).useIterator(it -&gt; {
            <span class="comment">// consume the iterator contents</span>
        });
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>While it is not strictly necessary to execute the query in a <em>try-with-resources</em> block because the <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#useIterator(org.jdbi.v3.core.result.IteratorConsumer)" target="_blank" rel="noopener">useIterator()</a> method will close the iterator and release all resources from the query, it is good practice and guards against possible errors that may happen between the creation of the query and the callback execution.</p>
</div>
<div class="paragraph">
<p>Using a jdbi callback allows fully automated resource management:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.useHandle(handle -&gt; {
    handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * from users</span><span class="delimiter">&quot;</span></span>)
        .mapTo(User.class)
        .useIterator(it -&gt; {
            <span class="comment">// consume the iterator contents</span>
        });
    });</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_attaching_statements_to_the_handle_lifecycle"><a class="anchor" href="#_attaching_statements_to_the_handle_lifecycle"></a><a class="link" href="#_attaching_statements_to_the_handle_lifecycle">5.3.4. Attaching statements to the handle lifecycle</a></h4>
<div class="paragraph">
<p>An elegant way to manage resources is attaching the statement to the handle lifecycle. Calling the <a href="./apidocs/org/jdbi/v3/core/statement/SqlStatement.html#attachToHandleForCleanup()" target="_blank" rel="noopener">attachToHandleForCleanup()</a> method, which is available on <a href="#_statement_types">SQL statements</a>, associates the statement with the handle. When the handle is closed, all attached statements that have not been cleaned up yet, will also be released.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Optional&lt;User&gt; user = handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users WHERE id = :id</span><span class="delimiter">&quot;</span></span>)
        .attachToHandleForCleanup() <i class="conum" data-value="1"></i><b>(1)</b>
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, id)
        .mapTo(User.class)
        .stream()
        .findAny();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>By attaching the statement to the handle, all resources are now managed by Jdbi and released even if the operation throws an exception.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This works best for short-lived handles with a few statement operations. As the resources may not be released until the handle is closed, executing a large number of SQL statements that all may need cleaning up could lead to resource exhaustion. When in doubt, prefer the <em>try-with-resources</em> construct over attaching a SQL statements to the handle.</p>
</div>
<div class="paragraph">
<p>It is possible to attach all created statements by default to a handle by calling <a href="./apidocs/org/jdbi/v3/core/statement/SqlStatements.html#setAttachAllStatementsForCleanup(boolean)" target="_blank" rel="noopener">setAttachAllStatementsForCleanup(true)</a> on the SqlStatements config object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.getConfig(SqlStatements.class)
    .setAttachAllStatementsForCleanup(<span class="predefined-constant">true</span>);

<span class="keyword">try</span> (Handle handle = jdbi.open()) {
    Optional&lt;User&gt; user = handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users WHERE id = :id</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, id)
        .mapTo(User.class)
        .stream()
        .findAny();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This setting can be controlled either per Jdbi object or per Handle.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (Handle handle = jdbi.open()) {
    handle.getConfig(SqlStatements.class)
        .setAttachAllStatementsForCleanup(<span class="predefined-constant">true</span>);

    Optional&lt;User&gt; user = handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users WHERE id = :id</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, id)
        .mapTo(User.class)
        .stream()
        .findAny();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a special case, any method on the Jdbi object that takes a callback (<a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withHandle(org.jdbi.v3.core.HandleCallback)" target="_blank" rel="noopener">withHandle</a>, <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useHandle(org.jdbi.v3.core.HandleConsumer)" target="_blank" rel="noopener">useHandle</a>, <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#inTransaction(org.jdbi.v3.core.HandleCallback)" target="_blank" rel="noopener">inTransaction</a>, <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useTransaction(org.jdbi.v3.core.HandleConsumer)" target="_blank" rel="noopener">useTransaction</a>) attaches statements created in the callback by default to the handle passed into the callback. These handles are fully managed and will be closed when the callback exits.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">User user = jdbi.withHandle(handle -&gt;
    handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users WHERE id = :id</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, id)
        .mapTo(User.class)
        .one());</code></pre>
</div>
</div>
<div class="paragraph">
<p>This behavior can be controlled through the <a href="./apidocs/org/jdbi/v3/core/statement/SqlStatements.html#setAttachCallbackStatementsForCleanup(boolean)" target="_blank" rel="noopener">setAttachCallbackStatementsForCleanup()</a> method.
If a callback executes a huge number of statements, it may be preferable to manage resources manually:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.useHandle(handle -&gt; {
    handle.getConfig(SqlStatements.class).setAttachCallbackStatementsForCleanup(<span class="predefined-constant">false</span>); <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; <span class="integer">100</span>_000; i++) {
        <span class="keyword">try</span> (Update update = handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)) {
            update.bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, i)
                  .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">user_</span><span class="delimiter">&quot;</span></span> + i)
                  .execute();
        }
    }
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Turn off automatic attachment of statements to the handle because the callback creates a large number of statements. Modifying this value only changes the setting for the current handle; it does not affect the global setting associated with the Jdbi object that created the handle.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
While the <code>attachAllStatementsForCleanup</code> setting affects all statements created <strong>outside</strong> a Jdbi callback (<a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withHandle(org.jdbi.v3.core.HandleCallback)" target="_blank" rel="noopener">withHandle</a>, <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useHandle(org.jdbi.v3.core.HandleConsumer)" target="_blank" rel="noopener">useHandle</a>, <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#inTransaction(org.jdbi.v3.core.HandleCallback)" target="_blank" rel="noopener">inTransaction</a>, <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useTransaction(org.jdbi.v3.core.HandleConsumer)" target="_blank" rel="noopener">useTransaction</a>), <strong>inside</strong> these callbacks, the behavior is controlled by the <code>attachCallbackStatementsForCleanup</code> setting.
The default value for the <code>attachAllStatementsForCleanup</code> is <code>false</code> while the default value for <code>attachCallbackStatementsForCleanup</code> is <code>true</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_arguments"><a class="anchor" href="#_arguments"></a><a class="link" href="#_arguments">6. Arguments</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Arguments are Jdbi&#8217;s representation of JDBC statement parameters (the <code>?</code> in <code>SELECT * FROM Foo WHERE bar = ?</code>).</p>
</div>
<div class="paragraph">
<p>To set a parameter <code>?</code> on a JDBC <code>PreparedStatement</code>, you would <code>ps.setString(1, "Baz")</code>.
With Jdbi, when you bind the string <code>"Baz"</code>, it will search through all registered <em>ArgumentFactory</em> instances
until it finds one that is willing to convert the String into an <em>Argument</em>.
The argument is responsible for setting the String for the placeholder exactly as <code>setString</code> does.</p>
</div>
<div class="paragraph">
<p>Arguments can perform more advanced bindings than simple JDBC supports:
a BigDecimal could be bound as a SQL decimal, a java.time.Year as a SQL int,
or a complex object could be serialized to a byte array and bound as a SQL blob.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The use of Jdbi arguments is limited to JDBC prepared statement parameters.
Notably, arguments usually cannot be used to change the structure of a query
(for example the table or column name, <code>SELECT</code> or <code>INSERT</code>, etc.)
nor may they be interpolated into string literals.
See <a href="#query-templating">Query Templating</a> and <a href="#_templateengine">TemplateEngine</a> for more information.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_positional_arguments"><a class="anchor" href="#_positional_arguments"></a><a class="link" href="#_positional_arguments">6.1. Positional Arguments</a></h3>
<div class="paragraph">
<p>When a SQL statement uses <code>?</code> tokens, Jdbi can bind a values to parameters
at the corresponding index (0-based):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">insert into contacts (id, name) values (?, ?)</span><span class="delimiter">&quot;</span></span>)
      .bind(<span class="integer">0</span>, <span class="integer">3</span>)
      .bind(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Chuck</span><span class="delimiter">&quot;</span></span>)
      .execute();

<span class="predefined-type">String</span> name = handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">select name from contacts where id = ?</span><span class="delimiter">&quot;</span></span>)
                    .bind(<span class="integer">0</span>, <span class="integer">3</span>)
                    .mapTo(<span class="predefined-type">String</span>.class)
                    .one();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_named_arguments"><a class="anchor" href="#_named_arguments"></a><a class="link" href="#_named_arguments">6.2. Named Arguments</a></h3>
<div class="paragraph">
<p>When a SQL statement uses colon-prefixed tokens like <code>:name</code>, Jdbi can bind
parameters by name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">insert into contacts (id, name) values (:id, :name)</span><span class="delimiter">&quot;</span></span>)
      .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">3</span>)
      .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Chuck</span><span class="delimiter">&quot;</span></span>)
      .execute();

<span class="predefined-type">String</span> name = handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">select name from contacts where id = :id</span><span class="delimiter">&quot;</span></span>)
                    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">3</span>)
                    .mapTo(<span class="predefined-type">String</span>.class)
                    .one();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Names can contain alphanumeric characters, dot and dash (<code>.</code> and <code>-</code>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, Jbdi uses the see the <a href="./apidocs/org/jdbi/v3/core/statement/ColonPrefixSqlParser.html" target="_blank" rel="noopener">ColonPrefixSqlParser</a> that understands
the  <code>:foo</code> syntax. This can be changed if the colon is problematic in the SQL dialect used. Jdbi includes support for an alternate <code>#foo</code> syntax out-of-the-box using the <a href="./apidocs/org/jdbi/v3/core/statement/HashPrefixSqlParser.html" target="_blank" rel="noopener">HashPrefixSqlParser</a>. It is also possible to create custom parsers for named arguments.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Mixing named and positional arguments is not allowed, as it would become confusing very quickly.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_supported_argument_types"><a class="anchor" href="#_supported_argument_types"></a><a class="link" href="#_supported_argument_types">6.3. Supported Argument Types</a></h3>
<div class="paragraph">
<p>Out of the box, Jdbi supports the following types as SQL statement arguments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Primitives: <code>boolean</code>, <code>byte</code>, <code>short</code>, <code>int</code>, <code>long</code>, <code>char</code>, <code>float</code>, and
<code>double</code></p>
</li>
<li>
<p>java.lang: <code>Boolean</code>, <code>Byte</code>, <code>Short</code>, <code>Integer</code>, <code>Long</code>, <code>Character</code>,
<code>Float</code>, <code>Double</code>, <code>String</code>, and <code>Enum</code> (stored as the enum value&#8217;s name by default)</p>
</li>
<li>
<p>java.math: <code>BigDecimal</code></p>
</li>
<li>
<p>java.net: <code>Inet4Address</code>, <code>Inet6Address</code>, <code>URL</code>, and <code>URI</code></p>
</li>
<li>
<p>java.sql: <code>Blob</code>, <code>Clob</code>, <code>Date</code>, <code>Time</code>, and <code>Timestamp</code></p>
</li>
<li>
<p>java.time: <code>Instant</code>, <code>LocalDate</code>, <code>LocalDateTime</code>, <code>LocalTime</code>,
<code>OffsetDateTime</code>, <code>ZonedDateTime</code>, and <code>ZoneId</code></p>
</li>
<li>
<p>java.util: <code>Date</code>, <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html" target="_blank" rel="noopener">Optional</a> (around any other supported type), and <code>UUID</code></p>
</li>
<li>
<p><code>java.util.Collection</code> and Java arrays (stored as SQL arrays).
Some additional setup may be required depending on the type of array element.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also configure Jdbi to support additional argument types.
More on that later.</p>
</div>
</div>
<div class="sect2">
<h3 id="_binding_arguments"><a class="anchor" href="#_binding_arguments"></a><a class="link" href="#_binding_arguments">6.4. Binding Arguments</a></h3>
<div class="paragraph">
<p>Arguments to SQL statement can be bound in a few different ways.</p>
</div>
<div class="paragraph">
<p>You can bind individual arguments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO contacts (id, name) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>)
    .execute();</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can bind multiple arguments at once from the entries of a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html" target="_blank" rel="noopener">Map</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; contact = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;&gt;();
contact.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">2</span>)
contact.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>);

handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO contacts (id, name) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
    .bindMap(contact)
    .execute();</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can bind multiple values at once, from either a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/List.html" target="_blank" rel="noopener">List&lt;T&gt;</a> or a vararg:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; keys = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;<span class="predefined-type">String</span>&gt;()
keys.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">user_name</span><span class="delimiter">&quot;</span></span>);
keys.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">street</span><span class="delimiter">&quot;</span></span>);

handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT value FROM items WHERE kind in (&lt;listOfKinds&gt;)</span><span class="delimiter">&quot;</span></span>)
    .bindList(<span class="string"><span class="delimiter">&quot;</span><span class="content">listOfKinds</span><span class="delimiter">&quot;</span></span>, keys)
    .mapTo(<span class="predefined-type">String</span>.class)
    .list();

<span class="comment">// or, using the 'vararg' definition</span>
handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT value FROM items WHERE kind in (&lt;varargListOfKinds&gt;)</span><span class="delimiter">&quot;</span></span>)
    .bindList(<span class="string"><span class="delimiter">&quot;</span><span class="content">varargListOfKinds</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">user_name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">docs</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">street</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">library</span><span class="delimiter">&quot;</span></span>)
    .mapTo(<span class="predefined-type">String</span>.class)
    .list();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using <code>bindList</code> requires writing your SQL with an attribute, not a binding,
despite the fact that your values are bound. The attribute is a placeholder that will be
safely rendered to a comma-separated list of binding placeholders.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can bind multiple arguments from properties of a Java Bean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Contact contact = <span class="keyword">new</span> Contact();
contact.setId(<span class="integer">3</span>);
contact.setName(<span class="string"><span class="delimiter">&quot;</span><span class="content">Cindy</span><span class="delimiter">&quot;</span></span>);

handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO contacts (id, name) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
    .bindBean(contact)
    .execute();</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also bind an Object&#8217;s public fields:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Object</span> contact = <span class="keyword">new</span> <span class="predefined-type">Object</span>() {
    <span class="directive">public</span> <span class="type">int</span> id = <span class="integer">0</span>;
    <span class="directive">public</span> <span class="predefined-type">String</span> name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Cindy</span><span class="delimiter">&quot;</span></span>;
};

handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO contacts (id, name) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
    .bindFields(contact)
    .execute();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can bind public, parameter-less methods of an Object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Object</span> contact = <span class="keyword">new</span> <span class="predefined-type">Object</span>() {
    <span class="directive">public</span> <span class="type">int</span> theId() {
        <span class="keyword">return</span> <span class="integer">0</span>;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> theName() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Cindy</span><span class="delimiter">&quot;</span></span>;
    }
};

handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO contacts (id, name) VALUES (:theId, :theName)</span><span class="delimiter">&quot;</span></span>)
    .bindMethods(contact)
    .execute();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Optionally, you can qualify each bound bean/object with a prefix. This can help
remove ambiguity in situations where two or more bound beans have similar
property names:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Folder folder = <span class="keyword">new</span> Folder(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Important Documents</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Document</span> document =
    <span class="keyword">new</span> <span class="predefined-type">Document</span>(<span class="integer">100</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">memo.txt</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Business business business. Numbers.</span><span class="delimiter">&quot;</span></span>);

handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO documents (id, folder_id, name, contents) </span><span class="delimiter">&quot;</span></span> +
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">VALUES (:d.id, :f.id, :d.name, :d.contents)</span><span class="delimiter">&quot;</span></span>)
    .bindBean(<span class="string"><span class="delimiter">&quot;</span><span class="content">f</span><span class="delimiter">&quot;</span></span>, folder)
    .bindMethods(<span class="string"><span class="delimiter">&quot;</span><span class="content">f</span><span class="delimiter">&quot;</span></span>, folder)
    .bindFields(<span class="string"><span class="delimiter">&quot;</span><span class="content">d</span><span class="delimiter">&quot;</span></span>, document)
    .execute();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>bindBean()</code>, <code>bindFields()</code>, and <code>bindMethods()</code> may be used to bind nested
properties, e.g. <code>:user.address.street</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<code>bindMap()</code> does not bind nested properties&#8212;&#8203;map keys are expected to exactly
match the bound parameter name.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The authors recommend checking out <a href="#_immutables">Immutables</a> support for an advanced way
to easily bind and map value types.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_argument_annotations"><a class="anchor" href="#_argument_annotations"></a><a class="link" href="#_argument_annotations">6.5. Argument Annotations</a></h3>
<div class="ulist">
<ul>
<li>
<p><code>@JdbiProperty(bind=false)</code> allows configuring whether a discovered property is bound as an argument. Turn the <code>bind</code> annotation value off, and the property discovery mechanism will ignore it.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_custom_arguments"><a class="anchor" href="#_custom_arguments"></a><a class="link" href="#_custom_arguments">6.6. Custom Arguments</a></h3>
<div class="paragraph">
<p>Occasionally your data model will use data types not natively supported by
Jdbi (see <a href="#_supported_argument_types">Supported Argument Types</a>).</p>
</div>
<div class="paragraph">
<p>Fortunately, Jdbi can be configured to bind custom data types as arguments,
by implementing a few simple interfaces.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Core JDBC features are generally well-supported by all database vendors.
However, more advanced usages like array support or geometry types tend to
quickly become vendor-specific.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_using_the_argument_interface"><a class="anchor" href="#_using_the_argument_interface"></a><a class="link" href="#_using_the_argument_interface">6.6.1. Using the Argument interface</a></h4>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/argument/Argument.html" target="_blank" rel="noopener">Argument</a> interface wraps a
single value into a binding.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">static</span> <span class="type">class</span> <span class="class">UUIDArgument</span> <span class="directive">implements</span> Argument {
    <span class="directive">private</span> <span class="predefined-type">UUID</span> uuid;

    UUIDArgument(<span class="predefined-type">UUID</span> uuid) {
        <span class="local-variable">this</span>.uuid = uuid;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> apply(<span class="type">int</span> position, <span class="predefined-type">PreparedStatement</span> statement, StatementContext ctx) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        statement.setString(position, uuid.toString()); <i class="conum" data-value="1"></i><b>(1)</b>
    }
}

<span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> uuidArgument() {
    <span class="predefined-type">UUID</span> u = <span class="predefined-type">UUID</span>.randomUUID();
    assertThat(handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT CAST(:uuid AS VARCHAR)</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">uuid</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> UUIDArgument(u))
        .mapTo(<span class="predefined-type">String</span>.class)
        .one()).isEqualTo(u.toString());
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Since Argument usually directly calls into JDBC directly, it is given the
<strong>one-based index</strong> (as expected by JDBC) when it is applied.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here we use an <strong>Argument</strong> to directly bind a UUID. In this particular case,
the most obvious approach is to send the UUID to the database as a String. If
your JDBC driver supports custom types directly or efficient binary transfers,
you can leverage them easily here.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_argumentfactory_interface"><a class="anchor" href="#_using_the_argumentfactory_interface"></a><a class="link" href="#_using_the_argumentfactory_interface">6.6.2. Using the ArgumentFactory interface</a></h4>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/argument/ArgumentFactory.html" target="_blank" rel="noopener">ArgumentFactory</a>
interface provides <a href="#_using_the_argument_interface">Argument interface</a> instances for any data type it knows about. By implementing and registering an argument factory, it is possible to bind custom data types without having to explicitly wrap them in objects implementing the <a href="./apidocs/org/jdbi/v3/core/argument/Argument.html" target="_blank" rel="noopener">Argument</a> interface.</p>
</div>
<div class="paragraph">
<p>Jdbi provides an <a href="./apidocs/org/jdbi/v3/core/argument/AbstractArgumentFactory.html" target="_blank" rel="noopener">AbstractArgumentFactory</a> class which simplifies implementing
the <a href="./apidocs/org/jdbi/v3/core/argument/ArgumentFactory.html" target="_blank" rel="noopener">ArgumentFactory</a> contract:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">static</span> <span class="type">class</span> <span class="class">UUIDArgumentFactory</span> <span class="directive">extends</span> AbstractArgumentFactory&lt;<span class="predefined-type">UUID</span>&gt; {
    UUIDArgumentFactory() {
        <span class="local-variable">super</span>(<span class="predefined-type">Types</span>.VARCHAR); <i class="conum" data-value="1"></i><b>(1)</b>
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> Argument build(<span class="predefined-type">UUID</span> value, ConfigRegistry config) {
        <span class="keyword">return</span> (position, statement, ctx) -&gt; statement.setString(position, value.toString()); <i class="conum" data-value="2"></i><b>(2)</b>
    }
}

<span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> uuidArgumentFactory() {
    <span class="predefined-type">UUID</span> u = <span class="predefined-type">UUID</span>.randomUUID();
    handle.registerArgument(<span class="keyword">new</span> UUIDArgumentFactory());
    assertThat(handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT CAST(:uuid AS VARCHAR)</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">uuid</span><span class="delimiter">&quot;</span></span>, u)
        .mapTo(<span class="predefined-type">String</span>.class)
        .one()).isEqualTo(u.toString());
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The JDBC <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/Types.html" target="_blank" rel="noopener">SQL type constant</a> to use when
 binding UUIDs. Jdbi needs this in order to bind UUID values of <code>null</code>. See
<a href="https://docs.oracle.com/javase/8/docs/api/java/sql/PreparedStatement.html#setNull-int-int-" target="_blank" rel="noopener">PreparedStatement.setNull(int,int)</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Since <code>Argument</code> is a functional interface, it can be implemented as a lambda expression.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_using_prepared_arguments_for_batches"><a class="anchor" href="#_using_prepared_arguments_for_batches"></a><a class="link" href="#_using_prepared_arguments_for_batches">6.6.3. Using Prepared Arguments for batches</a></h4>
<div class="paragraph">
<p>Traditional argument factories decide to bind based on both the type and actual value of the binding.
This is very flexible but when binding a large <code>PreparedBatch</code> it incurs a serious performance penalty
as the entire chain of argument factories must be consulted for each batch of arguments added.
To address this issue, implement <code>ArgumentFactory.Preparable</code> which promises to handle all values
of a given <code>Type</code>.  Most built in argument factories now implement the Preparable interface.</p>
</div>
<div class="paragraph">
<p>Preparable argument factories are consulted before traditional argument factories. If you&#8217;d prefer
to keep the old behavior, you may disable this feature with <code>getConfig(Arguments.class).setPreparedArgumentsEnabled(false)</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_arguments_registry"><a class="anchor" href="#_the_arguments_registry"></a><a class="link" href="#_the_arguments_registry">6.6.4. The Arguments Registry</a></h4>
<div class="paragraph">
<p>When you register an <code>ArgumentFactory</code>, the registration is stored in an
<a href="./apidocs/org/jdbi/v3/core/argument/Arguments.html" target="_blank" rel="noopener">Arguments</a> instance held by Jdbi.
<code>Arguments</code> is a configuration class, which stores all registered argument
factories (including the factories for built-in arguments).</p>
</div>
<div class="paragraph">
<p>Under the hood, when you bind arguments to a statement, Jdbi consults the
<code>Arguments</code> config object and searches for an <code>ArgumentFactory</code> which knows how
to convert a bound object into an <code>Argument</code>.</p>
</div>
<div class="paragraph">
<p>Later, when the statement is executed, each <code>Argument</code> located during binding
is applied to the JDBC
<a href="https://docs.oracle.com/javase/8/docs/api/java/sql/PreparedStatement.html" target="_blank" rel="noopener">PreparedStatement</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Occasionally, two or more argument factories will support arguments of the same
data type. When this happens, the last-registered factory wins. Preparable argument factories
always take precedence over base argument factories. This means that
you can override the way any data type is bound, including the data types
supported out of the box.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mappers"><a class="anchor" href="#_mappers"></a><a class="link" href="#_mappers">7. Mappers</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jdbi makes use of mappers to convert result data into Java objects. There are
two types of mappers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_row_mappers">Row Mappers</a>, which map a full row of result set data.</p>
</li>
<li>
<p><a href="#_column_mappers">Column Mappers</a>, which map a single column of a result set row.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_row_mappers"><a class="anchor" href="#_row_mappers"></a><a class="link" href="#_row_mappers">7.1. Row Mappers</a></h3>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper</a> is a functional
interface, which maps the current row of a JDBC
<a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" target="_blank" rel="noopener">ResultSet</a> to a mapped type. Row
mappers are invoked once for each row in the result set.</p>
</div>
<div class="paragraph">
<p>Since <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper</a> is a functional interface, they can be provided inline to a
query using a lambda expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;User&gt; users = handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content"> FROM </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> ORDER BY id ASC</span><span class="delimiter">&quot;</span></span>)
        .map((rs, ctx) -&gt; <span class="keyword">new</span> User(rs.getInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>), rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)))
        .list();</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
There are three different types being used in the above example. <a href="./apidocs/org/jdbi/v3/core/statement/Query.html" target="_blank" rel="noopener">Query</a>,
returned by <code>Handle.createQuery()</code>, implements the <code>ResultBearing</code> interface.
The <code>ResultBearing.map()</code> method takes a <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper&lt;T&gt;</a> and returns a
<code>ResultIterable&lt;T&gt;</code>. Finally, <code>ResultBearing.list()</code> collects each row in the
result set into a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/List.html" target="_blank" rel="noopener">List&lt;T&gt;</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Row mappers may be defined as classes, which allows for re-use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">UserMapper</span> <span class="directive">implements</span> <span class="predefined-type">RowMapper</span>&lt;User&gt; {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> User map(<span class="predefined-type">ResultSet</span> rs, StatementContext ctx) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        <span class="keyword">return</span> <span class="keyword">new</span> User(rs.getInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>), rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>));
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;User&gt; users = handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content"> FROM </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> ORDER BY id ASC</span><span class="delimiter">&quot;</span></span>)
    .map(<span class="keyword">new</span> UserMapper())
    .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper</a> is equivalent to the lambda mapper above but more explicit.</p>
</div>
<div class="sect3">
<h4 id="_rowmappers_registry"><a class="anchor" href="#_rowmappers_registry"></a><a class="link" href="#_rowmappers_registry">7.1.1. RowMappers registry</a></h4>
<div class="paragraph">
<p>Row mappers can be registered for particular types. This simplifies usage,
requiring only that you specify what type you want to map to. Jdbi
automatically looks up the mapper from the registry, and uses it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.registerRowMapper(User.class,
    (rs, ctx) -&gt; <span class="keyword">new</span> User(rs.getInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>), rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>));

<span class="keyword">try</span> (Handle handle = jdbi.open()) {
    <span class="predefined-type">List</span>&lt;User&gt; users = handle
        .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name FROM user ORDER BY id ASC</span><span class="delimiter">&quot;</span></span>)
        .mapTo(User.class)
        .list();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A mapper which implements <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper</a> with an explicit mapped type (such as the
<code>UserMapper</code> class in the previous section) may be registered without specifying
the mapped type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.registerRowMapper(<span class="keyword">new</span> UserMapper());</code></pre>
</div>
</div>
<div class="paragraph">
<p>When this method is used, Jdbi inspects the generic class signature of the
mapper to automatically discover the mapped type.</p>
</div>
<div class="paragraph">
<p>It is possible to register more than one mapper for any given type. When this
happens, the last-registered mapper for a given type takes precedence. This
permits optimizations, like registering a "default" mapper for some type, while
allowing that default mapper to be overridden with a different one when
appropriate.</p>
</div>
</div>
<div class="sect3">
<h4 id="_rowmapperfactory"><a class="anchor" href="#_rowmapperfactory"></a><a class="link" href="#_rowmapperfactory">7.1.2. RowMapperFactory</a></h4>
<div class="paragraph">
<p>A <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapperFactory.html" target="_blank" rel="noopener">RowMapperFactory</a> can
produce row mappers for arbitrary types.</p>
</div>
<div class="paragraph">
<p>Implementing a factory might be preferable to a regular row mapper if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The mapper implementation is generic, and could apply to multiple mapped
types. For example, Jdbi provides a generalized <a href="#_beanmapper">BeanMapper</a>, which maps
columns to bean properties for any bean class.</p>
</li>
<li>
<p>The mapped type has a generic signature, and/or the mapper could be composed
of other registered mappers. For example, Jdbi provides a
<a href="#mapentry-mapping">Map.Entry&lt;K,V&gt; mapper</a>, provided a mapper is registered
for types <code>K</code> and <code>V</code>.</p>
</li>
<li>
<p>You want to bundle multiple mappers into a single class.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s take an example <code>Pair&lt;L, R&gt;</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">Pair</span>&lt;L, R&gt; {
    <span class="directive">public</span> <span class="directive">final</span> L left;
    <span class="directive">public</span> <span class="directive">final</span> R right;

    <span class="directive">public</span> Pair(L left, R right) {
        <span class="local-variable">this</span>.left = left;
        <span class="local-variable">this</span>.right = right;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s implement a row mapper factory. The factory should produce a
<a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper&lt;Pair&lt;L, R&gt;&gt;</a> for any <code>Pair&lt;L, R&gt;</code> type, where the <code>L</code> type is mapped
from the first column, and <code>R</code> from the second&#8212;&#8203;assuming there are column
mappers registered for both <code>L</code> and <code>R</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take this one step at a time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">PairMapperFactory</span> <span class="directive">implements</span> RowMapperFactory {
    <span class="directive">public</span> Optional&lt;<span class="predefined-type">RowMapper</span>&lt;?&gt;&gt; build(<span class="predefined-type">Type</span> type, ConfigRegistry config) {
        <span class="comment">// ...</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>build</code> method accepts a mapped type, and a config registry. It may return
<code>Optional.of(someMapper)</code> if it knows how to map that type, or
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html#empty--" target="_blank" rel="noopener">Optional.empty()</a> otherwise.</p>
</div>
<div class="paragraph">
<p>First we check whether the mapped type is a <code>Pair</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">if</span> (!Pair.class.equals(GenericTypes.getErasedType(type))) {
    <span class="keyword">return</span> Optional.empty();
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <code>GenericTypes</code> utility class is discussed in <a href="#_working_with_generic_types">Working with Generic Types</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, we extract the <code>L</code> and <code>R</code> generic parameters from the mapped type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Type</span> leftType = GenericTypes.resolveType(Pair.class.getTypeParameters()[<span class="integer">0</span>], type);
<span class="predefined-type">Type</span> rightType = GenericTypes.resolveType(Pair.class.getTypeParameters()[<span class="integer">1</span>], type);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the first line, <code>Pair.class.getTypeParameters()[0]</code> gives the type variable
<code>L</code>. Likewise in the second line, <code>Pair.class.getTypeParameters()[1]</code> gives the type
variable <code>R</code>.</p>
</div>
<div class="paragraph">
<p>We use <code>resolveType()</code> to resolve the types for the <code>L</code> and <code>R</code> type variables
in the context of the mapped type.</p>
</div>
<div class="paragraph">
<p>Now that we have the types for <code>L</code> and <code>R</code>, we can look up the column mappers
for those types from the <code>ColumnMappers</code> config class, through the config
registry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ColumnMappers columnMappers = config.get(ColumnMappers.class);

ColumnMapper&lt;?&gt; leftMapper = columnMappers.findFor(leftType)
    .orElseThrow(() -&gt; <span class="keyword">new</span> NoSuchMapperException(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">No column mapper registered for Pair left parameter </span><span class="delimiter">&quot;</span></span> + leftType));
ColumnMapper&lt;?&gt; rightMapper = columnMappers.findFor(rightType)
    .orElseThrow(() -&gt; <span class="keyword">new</span> NoSuchMapperException(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">No column mapper registered for Pair right parameter </span><span class="delimiter">&quot;</span></span> + rightType));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The config registry is a locator for config classes. So when we call
<code>config.get(ColumnMappers.class)</code>, we get back a <code>ColumnMappers</code> instance with
the current column mapper configuration.</p>
</div>
<div class="paragraph">
<p>Next we call <code>ColumnMappers.findFor()</code> to get the column mappers for the left
and right types.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You may have noticed that although this method can return <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html" target="_blank" rel="noopener">Optional</a>, we are
throwing an exception if we can&#8217;t find the left- or right-hand mappers. We have
found this to be a best practice: return <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html#empty--" target="_blank" rel="noopener">Optional.empty()</a> if the factory
knows nothing about the mapped type (<code>Pair</code>, in this case). If it knows the
mapped type but is missing some configuration to make it work (e.g. mappers not
registered for <code>L</code> or <code>R</code> parameter) it is more helpful to throw an exception
with an informative message, so users can diagnose <em>why</em> the mapper is not
working as expected.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, we construct a pair mapper, and return it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">RowMapper</span>&lt;?&gt; pairMapper = (rs, ctx) -&gt;
    <span class="keyword">new</span> Pair(leftMapper.map(rs, <span class="integer">1</span>, ctx), <span class="comment">// In JDBC, column numbers start at 1</span>
             rightMapper.map(rs, <span class="integer">2</span>, ctx));

<span class="keyword">return</span> Optional.of(pairMapper);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the factory class all together:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">PairMapperFactory</span> <span class="directive">implements</span> RowMapperFactory {
    <span class="directive">public</span> Optional&lt;<span class="predefined-type">RowMapper</span>&lt;?&gt;&gt; build(<span class="predefined-type">Type</span> type, ConfigRegistry config) {
        <span class="keyword">if</span> (!Pair.class.equals(GenericTypes.getErasedType(type))) {
            <span class="keyword">return</span> Optional.empty();
        }

        <span class="predefined-type">Type</span> leftType = GenericTypes.resolveType(Pair.class.getTypeParameters()[<span class="integer">0</span>], type);
        <span class="predefined-type">Type</span> rightType = GenericTypes.resolveType(Pair.class.getTypeParameters()[<span class="integer">1</span>], type);

        ColumnMappers columnMappers = config.get(ColumnMappers.class);

        ColumnMapper&lt;?&gt; leftMapper = columnMappers.findFor(leftType)
            .orElseThrow(() -&gt; <span class="keyword">new</span> NoSuchMapperException(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">No column mapper registered for Pair left parameter </span><span class="delimiter">&quot;</span></span> + leftType));
        ColumnMapper&lt;?&gt; rightMapper = columnMappers.findFor(rightType)
            .orElseThrow(() -&gt; <span class="keyword">new</span> NoSuchMapperException(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">No column mapper registered for Pair right parameter </span><span class="delimiter">&quot;</span></span> + rightType));

        <span class="predefined-type">RowMapper</span>&lt;?&gt; pairMapper = (rs, ctx) -&gt; <span class="keyword">new</span> Pair(leftMapper.map(rs, <span class="integer">1</span>, ctx),
            rightMapper.map(rs, <span class="integer">2</span>, ctx));

        <span class="keyword">return</span> Optional.of(pairMapper);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Row mapper factories may be registered similar to regular row mappers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.registerRowMapper(<span class="keyword">new</span> PairMapperFactory());

<span class="keyword">try</span> (Handle handle = jdbi.open()) {
    <span class="predefined-type">List</span>&lt;Pair&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;&gt; configPairs = handle
        .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT key, value FROM config</span><span class="delimiter">&quot;</span></span>)
        .mapTo(<span class="keyword">new</span> GenericType&lt;Pair&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;&gt;() {})
        .list();
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <code>GenericType</code> utility class is discussed in <a href="#_working_with_generic_types">Working with Generic Types</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_column_mappers"><a class="anchor" href="#_column_mappers"></a><a class="link" href="#_column_mappers">7.2. Column Mappers</a></h3>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/core/mapper/ColumnMapper.html" target="_blank" rel="noopener">ColumnMapper</a> is a functional
interface, which maps a column from the current row of a JDBC
<a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" target="_blank" rel="noopener">ResultSet</a> to a mapped type.</p>
</div>
<div class="paragraph">
<p>Since <a href="./apidocs/org/jdbi/v3/core/mapper/ColumnMapper.html" target="_blank" rel="noopener">ColumnMapper</a> is a functional interface, they can be provided inline to a query using a lambda expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;Money&gt; amounts = handle
    .select(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT amount FROM transactions WHERE account_id = ?</span><span class="delimiter">&quot;</span></span>, accountId)
    .map((rs, col, ctx) -&gt; Money.parse(rs.getString(col))) <i class="conum" data-value="1"></i><b>(1)</b>
    .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whenever a column mapper is used to map rows, only the first column of each row
is mapped.</p>
</div>
<div class="paragraph">
<p>Column mappers may be defined as classes, which allows for re-use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MoneyMapper</span> <span class="directive">implements</span> ColumnMapper&lt;Money&gt; {
    <span class="directive">public</span> Money map(<span class="predefined-type">ResultSet</span> r, <span class="type">int</span> columnNumber, StatementContext ctx) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        <span class="keyword">return</span> Money.parse(r.getString(columnNumber));
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;Money&gt; amounts = handle
    .select(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT amount FROM transactions WHERE account_id = ?</span><span class="delimiter">&quot;</span></span>, accountId)
    .map(<span class="keyword">new</span> MoneyMapper())
    .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <a href="./apidocs/org/jdbi/v3/core/mapper/ColumnMapper.html" target="_blank" rel="noopener">ColumnMapper</a> is equivalent to the lambda mapper above, but more explicit.</p>
</div>
<div class="sect3">
<h4 id="_columnmappers_registry"><a class="anchor" href="#_columnmappers_registry"></a><a class="link" href="#_columnmappers_registry">7.2.1. ColumnMappers registry</a></h4>
<div class="paragraph">
<p>Column mappers may be registered for specific types. This simplifies usage,
requiring only that you specify what type you want to map to. Jdbi automatically
looks up the mapper from the registry, and uses it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.registerColumnMapper(Money.class,
    (rs, col, ctx) -&gt; Money.parse(rs.getString(col)));

<span class="predefined-type">List</span>&lt;Money&gt; amounts = jdbi.withHandle(handle -&gt;
    handle.select(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT amount FROM transactions WHERE account_id = ?</span><span class="delimiter">&quot;</span></span>, accountId)
        .mapTo(Money.class)
        .list());</code></pre>
</div>
</div>
<div class="paragraph">
<p>A mapper which implements <a href="./apidocs/org/jdbi/v3/core/mapper/ColumnMapper.html" target="_blank" rel="noopener">ColumnMapper</a> with an explicit mapped type (such as
the <code>MoneyMapper</code> class in the previous section) may be registered without
specifying the mapped type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.registerColumnMapper(<span class="keyword">new</span> MoneyMapper());</code></pre>
</div>
</div>
<div class="paragraph">
<p>When this method is used, Jdbi inspects the generic class signature of the
mapper to automatically discover the mapped type.</p>
</div>
<div class="paragraph">
<p>It is possible to register more than one mapper for any given type. When this
happens, the last-registered mapper for a given type takes precedence. This
permits optimizations, like registering a "default" mapper for some type, while
allowing that default mapper to be overridden with a different one when
appropriate.</p>
</div>
<div class="paragraph">
<p>Out of the box, column mappers are registered for the following types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Primitives: <code>boolean</code>, <code>byte</code>, <code>short</code>, <code>int</code>, <code>long</code>, <code>char</code>, <code>float</code>, and
<code>double</code></p>
</li>
<li>
<p>java.lang: <code>Boolean</code>, <code>Byte</code>, <code>Short</code>, <code>Integer</code>, <code>Long</code>, <code>Character</code>,
<code>Float</code>, <code>Double</code>, <code>String</code>, and <code>Enum</code> (stored as the enum value&#8217;s name by default)</p>
</li>
<li>
<p>java.math: <code>BigDecimal</code></p>
</li>
<li>
<p><code>byte[]</code> arrays (e.g. for BLOB or VARBINARY columns)</p>
</li>
<li>
<p>java.net: <code>InetAddress</code>, <code>URL</code>, and <code>URI</code></p>
</li>
<li>
<p>java.sql: <code>Timestamp</code></p>
</li>
<li>
<p>java.time: <code>Instant</code>, <code>LocalDate</code>, <code>LocalDateTime</code>, <code>LocalTime</code>,
<code>OffsetDateTime</code>, <code>ZonedDateTime</code>, and <code>ZoneId</code></p>
</li>
<li>
<p>java.util: <code>UUID</code></p>
</li>
<li>
<p><code>java.util.Collection</code> and Java arrays (for array columns). Some
additional setup may be required depending on the type of array element&#8212;&#8203;see
<a href="#_sql_arrays">SQL Arrays</a>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The binding and mapping method for enum values
can be controlled via the <a href="./apidocs/org/jdbi/v3/core/enums/Enums.html" target="_blank" rel="noopener">Enums</a> config,
as well as the <a href="./apidocs/org/jdbi/v3/core/enums/EnumByName.html" target="_blank" rel="noopener">EnumByName</a> and
<a href="./apidocs/org/jdbi/v3/core/enums/EnumByOrdinal.html" target="_blank" rel="noopener">EnumByOrdinal</a> annotations.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_columnmapperfactory"><a class="anchor" href="#_columnmapperfactory"></a><a class="link" href="#_columnmapperfactory">7.2.2. ColumnMapperFactory</a></h4>
<div class="paragraph">
<p>A <a href="./apidocs/org/jdbi/v3/core/mapper/ColumnMapperFactory.html" target="_blank" rel="noopener">ColumnMapperFactory</a> can
produce column mappers for arbitrary types.</p>
</div>
<div class="paragraph">
<p>Implementing a factory might be preferable to a regular column mapper if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The mapper class is generic, and could apply to multiple mapped types.</p>
</li>
<li>
<p>The type being mapped is generic, and/or the mapper could be composed
of other registered mappers.</p>
</li>
<li>
<p>You want to bundle multiple mappers into a single class.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s create a mapper factory for <code>Optional&lt;T&gt;</code> as an example. The factory
should produce a <a href="./apidocs/org/jdbi/v3/core/mapper/ColumnMapper.html" target="_blank" rel="noopener">ColumnMapper&lt;Optional&lt;T&gt;&gt;</a> for any <code>T</code>, provided a column
mapper is registered for <code>T</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take this one step at a time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">OptionalColumnMapperFactory</span> <span class="directive">implements</span> ColumnMapperFactory {
    <span class="directive">public</span> Optional&lt;ColumnMapper&lt;?&gt;&gt; build(<span class="predefined-type">Type</span> type, ConfigRegistry config) {
        <span class="comment">// ...</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>build</code> method accepts a mapped type, and a config registry. It may return
<code>Optional.of(someMapper)</code> if it knows how to map that type, or
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html#empty--" target="_blank" rel="noopener">Optional.empty()</a> otherwise.</p>
</div>
<div class="paragraph">
<p>First, we check whether the mapped type is an <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html" target="_blank" rel="noopener">Optional</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">if</span> (!Optional.class.equals(GenericTypes.getErasedType(type))) {
    <span class="keyword">return</span> Optional.empty();
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <code>GenericTypes</code> utility class is discussed in <a href="#_working_with_generic_types">Working with Generic Types</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, extract the <code>T</code> generic parameter from the mapped type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Type</span> t = GenericTypes.resolveType(Optional.class.getTypeParameters()[<span class="integer">0</span>], type);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The expression <code>Optional.class.getTypeParameters()[0]</code> gives the type variable
<code>T</code>.</p>
</div>
<div class="paragraph">
<p>We use <code>resolveType()</code> to resolve the type of <code>T</code> in the context of the mapped
type.</p>
</div>
<div class="paragraph">
<p>Now that we have the type of <code>T</code>, we can look up a column mapper for that type
from the <code>ColumnMappers</code> config class, through the config registry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ColumnMapper&lt;?&gt; tMapper = config.get(ColumnMappers.class)
    .findFor(embeddedType)
    .orElseThrow(() -&gt; <span class="keyword">new</span> NoSuchMapperException(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">No column mapper registered for parameter </span><span class="delimiter">&quot;</span></span> + embeddedType + <span class="string"><span class="delimiter">&quot;</span><span class="content"> of type </span><span class="delimiter">&quot;</span></span> + type));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The config registry is a locator for config classes. So when we call
<code>config.get(ColumnMappers.class)</code>, we get back a <code>ColumnMappers</code> instance with
the current column mapper configuration.</p>
</div>
<div class="paragraph">
<p>Next we call <code>ColumnMappers.findFor()</code> to get the column mapper for the embedded
type.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You may have noticed that although this method can return <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html" target="_blank" rel="noopener">Optional</a>, we&#8217;re
throwing an exception if we can&#8217;t find a mapper for the embedded type. We&#8217;ve
found this to be a best practice: return <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html#empty--" target="_blank" rel="noopener">Optional.empty()</a> if the factory knows
nothing about the mapped type (<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html" target="_blank" rel="noopener">Optional</a>, in this case). If it knows the mapped
type but is missing some configuration to make it work (e.g. no mapper
registered for tye <code>T</code> parameter) it is more helpful to throw an exception with
an informative message, so users can diagnose <em>why</em> the mapper is not working as
expected.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, we construct the column mapper for optionals, and return it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ColumnMapper&lt;?&gt; optionalMapper = (rs, col, ctx) -&gt;
    Optional.ofNullable(tMapper.map(rs, col, ctx));

<span class="keyword">return</span> Optional.of(optionalMapper);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the factory class all together:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">OptionalColumnMapperFactory</span> <span class="directive">implements</span> ColumnMapperFactory {
    <span class="directive">public</span> Optional&lt;ColumnMapper&lt;?&gt;&gt; build(<span class="predefined-type">Type</span> type, ConfigRegistry config) {
        <span class="keyword">if</span> (!Optional.class.equals(GenericTypes.getErasedType(type))) {
            <span class="keyword">return</span> Optional.empty();
        }

        <span class="predefined-type">Type</span> t = GenericTypes.resolveType(Optional.class.getTypeParameters()[<span class="integer">0</span>], type);

        ColumnMapper&lt;?&gt; tMapper = config.get(ColumnMappers.class)
            .findFor(t)
            .orElseThrow(() -&gt; <span class="keyword">new</span> NoSuchMapperException(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">No column mapper registered for parameter </span><span class="delimiter">&quot;</span></span> + t + <span class="string"><span class="delimiter">&quot;</span><span class="content"> of type </span><span class="delimiter">&quot;</span></span> + type));

        ColumnMapper&lt;?&gt; optionalMapper = (rs, col, ctx) -&gt; Optional.ofNullable(tMapper.map(rs, col, ctx));

        <span class="keyword">return</span> Optional.of(optionalMapper);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Column mapper factories may be registered similar to regular column mappers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.registerColumnMapper(<span class="keyword">new</span> OptionalColumnMapperFactory());

<span class="keyword">try</span> (Handle handle = jdbi.open()) {
    <span class="predefined-type">List</span>&lt;Optional&lt;<span class="predefined-type">String</span>&gt;&gt; middleNames = handle
        .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT middle_name FROM contacts</span><span class="delimiter">&quot;</span></span>)
        .mapTo(<span class="keyword">new</span> GenericType&lt;Optional&lt;<span class="predefined-type">String</span>&gt;&gt;() {})
        .list();
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <code>GenericType</code> utility class is discussed in <a href="#_working_with_generic_types">Working with Generic Types</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_primitive_mapping"><a class="anchor" href="#_primitive_mapping"></a><a class="link" href="#_primitive_mapping">7.3. Primitive Mapping</a></h3>
<div class="paragraph">
<p>All Java primitive types have default mappings to their corresponding JDBC types.
Generally, Jdbi will automatically perform boxing and unboxing as appropriate when
it encounters wrapper types.</p>
</div>
<div class="paragraph">
<p>By default, SQL <code>null</code> mapped to a primitive type will adopt the Java default value.
This may be disabled by configuring
<code>jdbi.getConfig(ColumnMappers.class).setCoalesceNullPrimitivesToDefaults(false)</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_immutables_mapping"><a class="anchor" href="#_immutables_mapping"></a><a class="link" href="#_immutables_mapping">7.4. Immutables Mapping</a></h3>
<div class="paragraph">
<p><code>Immutables</code> value objects may be mapped, see the <a href="#_immutables">Immutables</a> section for details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_freebuilder_mapping"><a class="anchor" href="#_freebuilder_mapping"></a><a class="link" href="#_freebuilder_mapping">7.5. Freebuilder Mapping</a></h3>
<div class="paragraph">
<p><code>Freebuilder</code> value objects may be mapped, see the <a href="#_freebuilder">Freebuilder</a> section for details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_reflection_mappers_for_beans_and_pojos"><a class="anchor" href="#_reflection_mappers_for_beans_and_pojos"></a><a class="link" href="#_reflection_mappers_for_beans_and_pojos">7.6. Reflection Mappers for Beans and POJOs</a></h3>
<div class="paragraph">
<p>Jdbi provides a number of reflection-based mappers out of the box which treat column
names as attributes. The different mappers can be used to map values onto</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java Bean properties (<code>BeanMapper</code>)</p>
</li>
<li>
<p>Class fields (<code>FieldMapper</code>)</p>
</li>
<li>
<p>Constructor parameters (<code>ConstructorMapper</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is also an equivalent mapper for Kotlin classes that supports constructor arguments and class properties.</p>
</div>
<div class="paragraph">
<p>Reflective mappers are snake_case aware and will automatically match up these
columns to camelCase field/argument/property names.</p>
</div>
<div class="sect3">
<h4 id="_supported_property_annotations"><a class="anchor" href="#_supported_property_annotations"></a><a class="link" href="#_supported_property_annotations">7.6.1. Supported property annotations</a></h4>
<div class="paragraph">
<p>Reflection mappers support the following annotations.
Unless otherwise noted, all annotations are supported on bean getters and setters for the <code>BeanMapper</code>, constructor parameters for the <code>ConstructorMapper</code> and bean fields for the <code>FieldMapper</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./apidocs/org/jdbi/v3/core/mapper/reflect/ColumnName.html" target="_blank" rel="noopener">@ColumnName</a> allows explicit naming of the column that is mapped to the specific attribute.</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/core/mapper/Nested.html" target="_blank" rel="noopener">@Nested</a> for nested beans.
Without this annotation, any attribute is treated as mappable from a single column.
This annotation creates a mapper for the nested bean.
There is a limitation that only one type of mapper can be nested at a time; <code>BeanMapper</code> will create another <code>BeanMapper</code>, <code>ConstructorMapper</code> will create another <code>ConstructorMapper</code> etc. <a href="./apidocs/org/jdbi/v3/core/mapper/Nested.html" target="_blank" rel="noopener">@Nested</a> supports an optional prefix for all attributes in the nested bean (<code>@Nested("prefix")</code>).</p>
</li>
<li>
<p><code>@PropagateNull</code> on a given attribute propagates a null value for a specific attribute up.
So if the attribute or column is null, the whole bean will be discarded and a null value will be used instead of the bean itself.
This annotation can also be used on the bean class with a column name that must be present in the result set.
When used on an attribute, no value must be set.</p>
</li>
<li>
<p><code>@Nullable</code> for <code>ConstructorMapper</code> arguments.
If no column is mapped onto a specific constructor argument, don&#8217;t fail but use <code>null</code> as value.</p>
</li>
<li>
<p><code>@JdbiProperty(map=false)</code> allows configuring whether a discovered property is mapped in results.
Turn the <code>map</code> value off, and the property discovery mechanism will ignore it.
This used to be called <code>@Unmappable</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <a href="./apidocs/org/jdbi/v3/core/mapper/reflect/ColumnName.html" target="_blank" rel="noopener">@ColumnName</a> annotation only applies while mapping SQL data into Java objects.
When binding object properties (e.g. with <code>bindBean()</code>), bind the property name (<code>:id</code>) rather than the column name (<code>:user_id</code>).
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_using_nullable_annotations"><a class="anchor" href="#_using_nullable_annotations"></a><a class="link" href="#_using_nullable_annotations">Using <code>@Nullable</code> annotations</a></h5>
<div class="paragraph">
<p>Jdbi accepts any annotation that is named <code>Nullable</code> to mark a field or method as nullable.</p>
</div>
<div class="paragraph">
<p>These are popular choices:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>jakarta.annotation.Nullable</code>&#8201;&#8212;&#8201;<a href="https://search.maven.org/artifact/jakarta.annotation/jakarta.annotation-api" target="_blank" rel="noopener">jakarta annotation-api</a></p>
</li>
<li>
<p><code>javax.annotation.Nullable</code>&#8201;&#8212;&#8201;<a href="https://search.maven.org/artifact/com.google.code.findbugs/jsr305" target="_blank" rel="noopener">findbugs jsr305</a></p>
</li>
<li>
<p><code>edu.umd.cs.findbugs.annotations.Nullable</code>&#8201;&#8212;&#8201;<a href="https://search.maven.org/artifact/com.github.spotbugs/spotbugs-annotations" target="_blank" rel="noopener">Spotbugs annotations</a></p>
</li>
<li>
<p><code>org.jetbrains.annotations.Nullable</code>&#8201;&#8212;&#8201;<a href="https://search.maven.org/artifact/org.jetbrains/annotations" target="_blank" rel="noopener">Jetbrains annotations</a></p>
</li>
<li>
<p><code>org.checkerframework.checker.nullness.qual.Nullable</code>&#8201;&#8212;&#8201;<a href="https://search.maven.org/artifact/org.checkerframework/checker-qual" target="_blank" rel="noopener">checker framework</a></p>
</li>
<li>
<p><code>org.springframework.lang.Nullable</code>&#8201;&#8212;&#8201;<a href="https://search.maven.org/artifact/org.springframework/spring-core" target="_blank" rel="noopener">Spring Framework</a></p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
To allow Jdbi to discover the <code>@Nullable</code> annotation at runtime, it must use <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/RetentionPolicy.html#RUNTIME" target="_blank" rel="noopener">RetentionPolicy.RUNTIME</a>.
When in doubt, prefer the <a href="https://jakarta.ee/specifications/platform/10/apidocs/jakarta/annotation/nullable" target="_blank" rel="noopener">Jakarta variant</a>!.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_constructormapper"><a class="anchor" href="#_constructormapper"></a><a class="link" href="#_constructormapper">7.6.2. ConstructorMapper</a></h4>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/core/mapper/reflect/ConstructorMapper.html" target="_blank" rel="noopener">ConstructorMapper</a> assigns columns to constructor parameters by
name. If the java compiler stores method parameter names in the java
classes (using the <code>-parameters</code> flag on the compiler&#8201;&#8212;&#8201;see also
<a href="#compiling_with_parameter_names">Compiling with Parameter Names</a>), the constructor mapper will use
these names to select columns.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> User(<span class="type">int</span> id, <span class="predefined-type">String</span> name) {
    <span class="local-variable">this</span>.id = id;
    <span class="local-variable">this</span>.name = name;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Otherwise, the names can be explictly set with the <a href="./apidocs/org/jdbi/v3/core/mapper/reflect/ColumnName.html" target="_blank" rel="noopener">@ColumnName</a>
annotation on each constructor parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> User(<span class="annotation">@ColumnName</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="type">int</span> id, <span class="annotation">@ColumnName</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> name) {
    <span class="local-variable">this</span>.id = id;
    <span class="local-variable">this</span>.name = name;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The standard Java Bean <code>@ConstructorProperties</code> annotation can also be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ConstructorProperties</span>({<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>})
<span class="directive">public</span> User(<span class="type">int</span> id, <span class="predefined-type">String</span> name) {
    <span class="local-variable">this</span>.id = id;
    <span class="local-variable">this</span>.name = name;
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Lombok&#8217;s <code>@AllArgsConstructor</code> annotation generates the
<code>@ConstructorProperties</code> annotation for you.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Register a constructor mapper for your mapped class using the <code>factory()</code> or <code>of()</code>
methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.registerRowMapper(ConstructorMapper.factory(User.class));
<span class="predefined-type">Set</span>&lt;User&gt; userSet = handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> ORDER BY id ASC</span><span class="delimiter">&quot;</span></span>)
    .mapTo(User.class)
    .collect(Collectors.toSet());

assertThat(userSet).hasSize(<span class="integer">4</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The constructor parameter names "id", "name" match the database column names
and as such no custom mapper code is required at all.</p>
</div>
<div class="paragraph">
<p>Constructor mappers can be configured with a column name prefix for each mapped
constructor parameter. This can help to disambiguate mapping joins, e.g. when
two mapped classes have identical property names (like <code>id</code> or <code>name</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.registerRowMapper(ConstructorMapper.factory(Contact.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">c</span><span class="delimiter">&quot;</span></span>));
handle.registerRowMapper(ConstructorMapper.factory(Phone.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>));
handle.registerRowMapper(JoinRowMapper.forTypes(Contact.class, Phone.class);

<span class="predefined-type">List</span>&lt;JoinRow&gt; contactPhones = handle.select(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT </span><span class="delimiter">&quot;</span></span> +
    <span class="string"><span class="delimiter">&quot;</span><span class="content">c.id cid, c.name cname, </span><span class="delimiter">&quot;</span></span> +
    <span class="string"><span class="delimiter">&quot;</span><span class="content">p.id pid, p.name pname, p.number pnumber </span><span class="delimiter">&quot;</span></span> +
    <span class="string"><span class="delimiter">&quot;</span><span class="content">FROM contacts c LEFT JOIN phones p ON c.id = p.contact_id</span><span class="delimiter">&quot;</span></span>)
    .mapTo(JoinRow.class)
    .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Typically, the mapped class will have a single constructor. If it has multiple
constructors, Jdbi will pick one based on these rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First, use the constructor annotated with <code>@JdbiConstructor</code>, if any.</p>
</li>
<li>
<p>Next, use the constructor annotated with <code>@ConstructorProperties</code>, if any.</p>
</li>
<li>
<p>Otherwise, throw an exception that Jdbi does not know which constructor to
use.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For legacy column names that don&#8217;t match up to property names, use the
<a href="./apidocs/org/jdbi/v3/core/mapper/reflect/ColumnName.html" target="_blank" rel="noopener">@ColumnName</a> annotation to provide an exact column name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> User(<span class="annotation">@ColumnName</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">user_id</span><span class="delimiter">&quot;</span></span>) <span class="type">int</span> id, <span class="predefined-type">String</span> name) {
    <span class="local-variable">this</span>.id = id;
    <span class="local-variable">this</span>.name = name;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nested constructor-injected types can be mapped using the <a href="./apidocs/org/jdbi/v3/core/mapper/Nested.html" target="_blank" rel="noopener">@Nested</a> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">User</span> {
    <span class="directive">public</span> User(<span class="type">int</span> id,
                <span class="predefined-type">String</span> name,
                <span class="annotation">@Nested</span> Address address) {
        <span class="comment">// ...</span>
    }
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">Address</span> {
    <span class="directive">public</span> Address(<span class="predefined-type">String</span> street,
                   <span class="predefined-type">String</span> city,
                   <span class="predefined-type">String</span> state,
                   <span class="predefined-type">String</span> zip) {
        <span class="comment">// ...</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.registerRowMapper(ConstructorMapper.factory(User.class));

<span class="predefined-type">List</span>&lt;User&gt; users = handle
    .select(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name, street, city, state, zip FROM users</span><span class="delimiter">&quot;</span></span>)
    .mapTo(User.class)
    .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/mapper/Nested.html" target="_blank" rel="noopener">@Nested</a> annotation has an optional <code>value()</code> attribute, which can be used to apply a column name prefix to each nested constructor parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> User(<span class="type">int</span> id,
            <span class="predefined-type">String</span> name,
            <span class="annotation">@Nested</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">addr</span><span class="delimiter">&quot;</span></span>) Address address) {
    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.registerRowMapper(ConstructorMapper.factory(User.class));

<span class="predefined-type">List</span>&lt;User&gt; users = handle
    .select(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name, addr_street, addr_city, addr_state, addr_zip FROM users</span><span class="delimiter">&quot;</span></span>)
    .mapTo(User.class)
    .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, ConstructorMapper expects the result set to contain columns to map every constructor parameter, and will throw an exception if any parameters cannot be mapped.</p>
</div>
<div class="paragraph">
<p>Parameters annotated <code>@Nullable</code> (see <a href="#_using_nullable_annotations">Using <code>@Nullable</code> annotations</a>) may be omitted from the result set, in which
<code>ConstructorMapper</code> will pass <code>null</code> to the constructor for that parameter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">User</span> {
    <span class="directive">public</span> User(<span class="type">int</span> id,
                <span class="predefined-type">String</span> name,
                <span class="annotation">@Nullable</span> <span class="predefined-type">String</span> passwordHash,
                <span class="annotation">@Nullable</span> <span class="annotation">@Nested</span> Address address) {
        <span class="comment">// ...</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <code>id</code> and <code>name</code> columns must be present in the result set, but <code>passwordHash</code> and <code>address</code> are optional.
If they are present, they will be mapped.</p>
</div>
</div>
<div class="sect3">
<h4 id="_beanmapper"><a class="anchor" href="#_beanmapper"></a><a class="link" href="#_beanmapper">7.6.3. BeanMapper</a></h4>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/core/mapper/reflect/BeanMapper.html" target="_blank" rel="noopener">BeanMapper</a> assigns columns to bean properties. This mapper uses the standard Java Bean conventions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">UserBean</span> {
    <span class="directive">private</span> <span class="type">int</span> id;
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="directive">public</span> <span class="type">int</span> getId() {
        <span class="keyword">return</span> id;
    }
    <span class="directive">public</span> <span class="type">void</span> setId(<span class="type">int</span> id) {
        <span class="local-variable">this</span>.id = id;
    }
    <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
        <span class="keyword">return</span> name;
    }
    <span class="directive">public</span> <span class="type">void</span> setName(<span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.name = name;
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The standard bean convention requires that the setter returns a <code>void</code> value. The popular "builder pattern" setter
convention of returning the bean itself does not work with the standard Java Bean convention and the setter will not be found. This is a common source of problems when using the <code>BeanMapper</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Register a bean mapper for your mapped class, using the <code>factory()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.registerRowMapper(BeanMapper.factory(UserBean.class));

<span class="predefined-type">List</span>&lt;UserBean&gt; users = handle
        .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">select id, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content"> from </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>)
        .mapTo(UserBean.class)
        .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, call <code>mapToBean()</code> instead of registering a bean mapper:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;UserBean&gt; users = handle
        .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">select id, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content"> from </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>)
        .mapToBean(UserBean.class)
        .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or use <code>map</code> with an instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;UserBean&gt; users = handle
    .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">select id, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content"> from </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>)
    .map(BeanMapper.of(UserBean.class))
    .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Bean mappers can be configured with a column name prefix for each mapped
property. This can help to disambiguate mapping joins, e.g. when two mapped
classes have identical property names (like <code>id</code> or <code>name</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.registerRowMapper(BeanMapper.factory(ContactBean.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">c</span><span class="delimiter">&quot;</span></span>));
handle.registerRowMapper(BeanMapper.factory(PhoneBean.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>));
handle.registerRowMapper(JoinRowMapper.forTypes(ContactBean.class, PhoneBean.class));
<span class="predefined-type">List</span>&lt;JoinRow&gt; contactPhones = handle.select(<span class="string"><span class="delimiter">&quot;</span><span class="content">select </span><span class="delimiter">&quot;</span></span>
        + <span class="string"><span class="delimiter">&quot;</span><span class="content">c.id cid, c.</span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content"> cname, </span><span class="delimiter">&quot;</span></span>
        + <span class="string"><span class="delimiter">&quot;</span><span class="content">p.id pid, p.</span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content"> pname, p.</span><span class="char">\&quot;</span><span class="content">number</span><span class="char">\&quot;</span><span class="content"> pnumber </span><span class="delimiter">&quot;</span></span>
        + <span class="string"><span class="delimiter">&quot;</span><span class="content">from contacts c left join phones p on c.id = p.contact_id</span><span class="delimiter">&quot;</span></span>)
        .mapTo(JoinRow.class)
        .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>For legacy column names that don&#8217;t match up to property names, use the
<a href="./apidocs/org/jdbi/v3/core/mapper/reflect/ColumnName.html" target="_blank" rel="noopener">@ColumnName</a> annotation to provide an exact column name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">User</span> {
    <span class="directive">private</span> <span class="type">int</span> id;

    <span class="annotation">@ColumnName</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">user_id</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">int</span> getId() { <span class="keyword">return</span> id; }

    <span class="directive">public</span> <span class="type">void</span> setId(<span class="type">int</span> id) { <span class="local-variable">this</span>.id = id; }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/mapper/reflect/ColumnName.html" target="_blank" rel="noopener">@ColumnName</a> annotation can be placed on either the getter or setter method.
If conflicting annotations exist, then Annotations on the setter are preferred.</p>
</div>
<div class="paragraph">
<p>Nested Java Bean types can be mapped using the <a href="./apidocs/org/jdbi/v3/core/mapper/Nested.html" target="_blank" rel="noopener">@Nested</a> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">User</span> {
    <span class="directive">private</span> <span class="type">int</span> id;
    <span class="directive">private</span> <span class="predefined-type">String</span> name;
    <span class="directive">private</span> Address address;

    <span class="comment">// ... (getters and setters)</span>

    <span class="annotation">@Nested</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> Address getAddress() { ... }

    <span class="directive">public</span> <span class="type">void</span> setAddress(Address address) { ... }
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">Address</span> {
    <span class="directive">private</span> <span class="predefined-type">String</span> street;
    <span class="directive">private</span> <span class="predefined-type">String</span> city;
    <span class="directive">private</span> <span class="predefined-type">String</span> state;
    <span class="directive">private</span> <span class="predefined-type">String</span> zip;

    <span class="comment">// ... (getters and setters)</span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <a href="./apidocs/org/jdbi/v3/core/mapper/Nested.html" target="_blank" rel="noopener">@Nested</a> annotation can be placed on either the getter or setter method.
The setter is preferred.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.registerRowMapper(BeanMapper.factory(User.class));

<span class="predefined-type">List</span>&lt;User&gt; users = handle
    .select(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name, street, city, state, zip FROM users</span><span class="delimiter">&quot;</span></span>)
    .mapTo(User.class)
    .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/mapper/Nested.html" target="_blank" rel="noopener">@Nested</a> annotation has an optional <code>value()</code> attribute, which can be used to apply a column name prefix to each nested bean property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Nested</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">addr</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> Address getAddress() { ... }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.registerRowMapper(BeanMapper.factory(User.class));

<span class="predefined-type">List</span>&lt;User&gt; users = handle
    .select(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name, addr_street, addr_city, addr_state, addr_zip FROM users</span><span class="delimiter">&quot;</span></span>)
    .mapTo(User.class)
    .list();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<a href="./apidocs/org/jdbi/v3/core/mapper/Nested.html" target="_blank" rel="noopener">@Nested</a> properties are left unmodified (i.e. null) if the result set has no columns matching any properties of the nested object.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_fieldmapper"><a class="anchor" href="#_fieldmapper"></a><a class="link" href="#_fieldmapper">7.6.4. FieldMapper</a></h4>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/core/mapper/reflect/FieldMapper.html" target="_blank" rel="noopener">FieldMapper</a> uses reflection
to map database columns directly to object fields (including private fields).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">User</span> {
    <span class="directive">public</span> <span class="type">int</span> id;

    <span class="directive">public</span> <span class="predefined-type">String</span> name;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Register a field mapper for your mapped class, using the <code>factory()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.registerRowMapper(FieldMapper.factory(User.class));

<span class="predefined-type">List</span>&lt;UserBean&gt; users = handle
    .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name FROM user</span><span class="delimiter">&quot;</span></span>)
    .mapTo(User.class)
    .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Field mappers can be configured with a column name prefix for each mapped
field. This can help to disambiguate mapping joins, e.g. when two mapped
classes have identical property names (like <code>id</code> or <code>name</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.registerRowMapper(FieldMapper.factory(Contact.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">c</span><span class="delimiter">&quot;</span></span>));
handle.registerRowMapper(FieldMapper.factory(Phone.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>));
handle.registerRowMapper(JoinRowMapper.forTypes(Contact.class, Phone.class);
<span class="predefined-type">List</span>&lt;JoinRow&gt; contactPhones = handle.select(
    <span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT </span><span class="delimiter">&quot;</span></span> +
    <span class="string"><span class="delimiter">&quot;</span><span class="content">c.id cid, c.name cname, </span><span class="delimiter">&quot;</span></span> +
    <span class="string"><span class="delimiter">&quot;</span><span class="content">p.id pid, p.name pname, p.number pnumber </span><span class="delimiter">&quot;</span></span> +
    <span class="string"><span class="delimiter">&quot;</span><span class="content">FROM contacts c LEFT JOIN phones p ON c.id = p.contact_id</span><span class="delimiter">&quot;</span></span>)
    .mapTo(JoinRow.class)
    .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>For legacy column names that don&#8217;t match up to field names, use the
<a href="./apidocs/org/jdbi/v3/core/mapper/reflect/ColumnName.html" target="_blank" rel="noopener">@ColumnName</a> annotation to provide an exact column name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">User</span> {
    <span class="annotation">@ColumnName</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">user_id</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="type">int</span> id;

    <span class="directive">public</span> <span class="predefined-type">String</span> name;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nested field-mapped types can be mapped using the <a href="./apidocs/org/jdbi/v3/core/mapper/Nested.html" target="_blank" rel="noopener">@Nested</a> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">User</span> {
    <span class="directive">public</span> <span class="type">int</span> id;
    <span class="directive">public</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@Nested</span>
    <span class="directive">public</span> Address address;
}

<span class="directive">public</span> <span class="type">class</span> <span class="class">Address</span> {
    <span class="directive">public</span> <span class="predefined-type">String</span> street;
    <span class="directive">public</span> <span class="predefined-type">String</span> city;
    <span class="directive">public</span> <span class="predefined-type">String</span> state;
    <span class="directive">public</span> <span class="predefined-type">String</span> zip;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.registerRowMapper(FieldMapper.factory(User.class));

<span class="predefined-type">List</span>&lt;User&gt; users = handle
    .select(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name, street, city, state, zip FROM users</span><span class="delimiter">&quot;</span></span>)
    .mapTo(User.class)
    .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/mapper/Nested.html" target="_blank" rel="noopener">@Nested</a> annotation has an optional <code>value()</code> attribute, which can be used to apply a column name prefix to each nested field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">User</span> {
    <span class="directive">public</span> <span class="type">int</span> id;
    <span class="directive">public</span> <span class="predefined-type">String</span> name;

    <span class="annotation">@Nested</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">addr</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> Address address;
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.registerRowMapper(FieldMapper.factory(User.class));

<span class="predefined-type">List</span>&lt;User&gt; users = handle
    .select(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name, addr_street, addr_city, addr_state, addr_zip FROM users</span><span class="delimiter">&quot;</span></span>)
    .mapTo(User.class)
    .list();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<a href="./apidocs/org/jdbi/v3/core/mapper/Nested.html" target="_blank" rel="noopener">@Nested</a> fields are left unmodified (i.e. null) if the result set has no columns matching any fields of the nested object.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mapentry-mapping"><a class="anchor" href="#mapentry-mapping"></a><a class="link" href="#mapentry-mapping">7.7. Map.Entry Mapping</a></h3>
<div class="paragraph">
<p>Out of the box, Jdbi registers a <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper&lt;Map.Entry&lt;K,V&gt;&gt;</a>. Since each row in
the result set is a <code>Map.Entry&lt;K,V&gt;</code>, the entire result set can be easily
collected into a <code>Map&lt;K,V&gt;</code> (or Guava&#8217;s <code>Multimap&lt;K,V&gt;</code>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A mapper must be registered for both the key and value type.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Join rows can be gathered into a map result by specifying the generic map
signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">CharSequence</span> sql = <span class="string"><span class="delimiter">&quot;</span><span class="content">select u.id u_id, u.name u_name, p.id p_id, p.phone p_phone </span><span class="delimiter">&quot;</span></span>

    + <span class="string"><span class="delimiter">&quot;</span><span class="content">from </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> u left join phone p on u.id = p.user_id</span><span class="delimiter">&quot;</span></span>;
<span class="predefined-type">Map</span>&lt;User, Phone&gt; map = h.createQuery(sql)
        .registerRowMapper(ConstructorMapper.factory(User.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">u</span><span class="delimiter">&quot;</span></span>))
        .registerRowMapper(ConstructorMapper.factory(Phone.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>))
        .collectInto(<span class="keyword">new</span> GenericType&lt;<span class="predefined-type">Map</span>&lt;User, Phone&gt;&gt;() {});</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, the <code>User</code> mapper uses the "u" column name prefix, and
the <code>Phone</code> mapper uses "p". Since each mapper only reads columns with the
expected prefix, the respective <code>id</code> columns are unambiguous.</p>
</div>
<div class="paragraph">
<p>A unique index (e.g. by ID column) can be obtained by setting the key column
name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">Integer</span>, User&gt; map = h.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">select * from </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>)
        .setMapKeyColumn(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>)
        .registerRowMapper(ConstructorMapper.factory(User.class))
        .collectInto(<span class="keyword">new</span> GenericType&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">Integer</span>, User&gt;&gt;() {});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set both the key and value column names to gather a two-column query into a map
result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; map = h.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">select </span><span class="char">\&quot;</span><span class="content">key</span><span class="char">\&quot;</span><span class="content">, </span><span class="char">\&quot;</span><span class="content">value</span><span class="char">\&quot;</span><span class="content"> from config</span><span class="delimiter">&quot;</span></span>)
        .setMapKeyColumn(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>)
        .setMapValueColumn(<span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>)
        .collectInto(<span class="keyword">new</span> GenericType&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;&gt;() {});</code></pre>
</div>
</div>
<div class="paragraph">
<p>All the above examples assume a one-to-one key/value relationship. What if
there is a one-to-many relationship?</p>
</div>
<div class="paragraph">
<p><a href="#google-guava">Google Guava</a> provides a <code>Multimap</code> type, which supports mapping multiple
values per key.</p>
</div>
<div class="paragraph">
<p>First, follow the instructions in the <a href="#google-guava">Google Guava</a> section to install the
<a href="./apidocs/org/jdbi/v3/guava/GuavaPlugin.html" target="_blank" rel="noopener">GuavaPlugin</a> into Jdbi.</p>
</div>
<div class="paragraph">
<p>Then, simply ask for a <code>Multimap</code> instead of a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html" target="_blank" rel="noopener">Map</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> sql = <span class="string"><span class="delimiter">&quot;</span><span class="content">select u.id u_id, u.name u_name, p.id p_id, p.phone p_phone </span><span class="delimiter">&quot;</span></span>
    + <span class="string"><span class="delimiter">&quot;</span><span class="content">from </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> u left join phone p on u.id = p.user_id</span><span class="delimiter">&quot;</span></span>;
Multimap&lt;User, Phone&gt; map = h.createQuery(sql)
        .registerRowMapper(ConstructorMapper.factory(User.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">u</span><span class="delimiter">&quot;</span></span>))
        .registerRowMapper(ConstructorMapper.factory(Phone.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>))
        .collectInto(<span class="keyword">new</span> GenericType&lt;Multimap&lt;User, Phone&gt;&gt;() {});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>collectInto()</code> method is worth explaining. When you call it, several things
happen behind the scenes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Consult the <a href="./apidocs/org/jdbi/v3/core/collector/JdbiCollectors.html" target="_blank" rel="noopener">JdbiCollectors</a> registry to obtain a
<a href="./apidocs/org/jdbi/v3/core/collector/CollectorFactory.html" target="_blank" rel="noopener">CollectorFactory</a> which
 supports the given container type.</p>
</li>
<li>
<p>Next, ask that <code>CollectorFactory</code> to extract the element type from the
container type signature. In the above example, the element type of
<code>Multimap&lt;User,Phone&gt;</code> is <code>Map.Entry&lt;User,Phone&gt;</code>.</p>
</li>
<li>
<p>Obtain a mapper for that element type from the mapping registry.</p>
</li>
<li>
<p>Obtain a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html" target="_blank" rel="noopener">Collector</a> for the
container type from the <code>CollectorFactory</code>.</p>
</li>
<li>
<p>Finally, return <code>map(elementMapper).collect(collector)</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the lookup for the collector factory, element type, or element mapper
fails, an exception is thrown.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Jdbi can be enhanced to support arbitrary container types.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_codecs"><a class="anchor" href="#_codecs"></a><a class="link" href="#_codecs">8. Codecs</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>A codec is a replacement for registering an argument and a column mapper for a type. It is responsible for serializing a typed value into a database column and creating a type from a database column.</p>
</div>
<div class="paragraph">
<p>Codecs are collected in a codec factory, which can be registered with the registerCodecFactory convenience method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// register a single codec</span>
jdbi.registerCodecFactory(CodecFactory.forSingleCodec(type, codec));

<span class="comment">// register a few codecs</span>
jdbi.registerCodecFactory(CodecFactory.builder()
    <span class="comment">// register a codec by qualified type</span>
    .addCodec(QualifiedType.of(Foo.class), codec1)
    <span class="comment">// register a codec by direct java type</span>
    .addCodec(Foo.class, codec2)
    <span class="comment">// register a codec by generic type</span>
    .addCodec(<span class="keyword">new</span> GenericType&lt;<span class="predefined-type">Set</span>&lt;Foo&gt;&gt;() {}. codec3)
    .build());

<span class="comment">// register many codecs</span>
<span class="predefined-type">Map</span>&lt;QualifiedType&lt;?&gt;, Codec&lt;?&gt;&gt; codecs = ...
jdbi.registerCodecFactory(<span class="keyword">new</span> CodecFactory(codecs));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Codec example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Counter</span> {

    <span class="directive">private</span> <span class="type">int</span> count = <span class="integer">0</span>;

    <span class="directive">public</span> Counter() {}

    <span class="directive">public</span> <span class="type">int</span> nextValue() {
        <span class="keyword">return</span> count++;
    }

    <span class="directive">private</span> Counter setValue(<span class="type">int</span> value) {
        <span class="local-variable">this</span>.count = value;
        <span class="keyword">return</span> <span class="local-variable">this</span>;
    }

    <span class="directive">private</span> <span class="type">int</span> getValue() {
        <span class="keyword">return</span> count;
    }

    <span class="comment">/**
     * Codec to persist a counter to the database and restore it back.
     */</span>
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">CounterCodec</span> <span class="directive">implements</span> Codec&lt;Counter&gt; {

        <span class="annotation">@Override</span>
        <span class="directive">public</span> ColumnMapper&lt;Counter&gt; getColumnMapper() {
            <span class="keyword">return</span> (r, idx, ctx) -&gt; <span class="keyword">new</span> Counter().setValue(r.getInt(idx));
        }

        <span class="annotation">@Override</span>
        <span class="directive">public</span> Function&lt;Counter, Argument&gt; getArgumentFunction() {
            <span class="keyword">return</span> counter -&gt; (idx, stmt, ctx) -&gt; stmt.setInt(idx, counter.getValue());
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Jdbi core API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// register the codec with JDBI</span>
jdbi.registerCodecFactory(CodecFactory.forSingleCodec(COUNTER_TYPE, <span class="keyword">new</span> CounterCodec()));


<span class="comment">// store object</span>
<span class="type">int</span> result = jdbi.withHandle(h -&gt; h.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO counters (id, </span><span class="char">\&quot;</span><span class="content">value</span><span class="char">\&quot;</span><span class="content">) VALUES (:id, :value)</span><span class="delimiter">&quot;</span></span>)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, counterId)
    .bindByType(<span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>, counter, COUNTER_TYPE)
    .execute());


<span class="comment">// load object</span>
Counter restoredCounter = jdbi.withHandle(h -&gt; h.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT </span><span class="char">\&quot;</span><span class="content">value</span><span class="char">\&quot;</span><span class="content"> from counters where id = :id</span><span class="delimiter">&quot;</span></span>)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, counterId)
    .mapTo(COUNTER_TYPE).first());</code></pre>
</div>
</div>
<div class="paragraph">
<p>SQL Object API uses the codecs transparently:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// SQL object dao</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">CounterDao</span> {

    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO counters (id, </span><span class="char">\&quot;</span><span class="content">value</span><span class="char">\&quot;</span><span class="content">) VALUES (:id, :value)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">int</span> storeCounter(<span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> id, <span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>) Counter counter);

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT </span><span class="char">\&quot;</span><span class="content">value</span><span class="char">\&quot;</span><span class="content"> from counters where id = :id</span><span class="delimiter">&quot;</span></span>)
    Counter loadCounter(<span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> id);
}


    <span class="comment">// register the codec with JDBI</span>
    jdbi.registerCodecFactory(CodecFactory.forSingleCodec(COUNTER_TYPE, <span class="keyword">new</span> CounterCodec()));


    <span class="comment">// store object</span>
    <span class="type">int</span> result = jdbi.withExtension(CounterDao.class, dao -&gt; dao.storeCounter(counterId, counter));


    <span class="comment">// load object</span>
    Counter restoredCounter = jdbi.withExtension(CounterDao.class, dao -&gt; dao.loadCounter(counterId));</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_resolving_types"><a class="anchor" href="#_resolving_types"></a><a class="link" href="#_resolving_types">8.1. Resolving Types</a></h3>
<div class="paragraph">
<p>By using the <code>TypeResolvingCodecFactory</code> from the <a href="./apidocs/org/jdbi/v3/guava/package-summary.html" target="_blank" rel="noopener">guava</a> module, it is possible to use codecs that are registered for subclasses or interface types for concrete classes. This is necessary to e.g. map <a href="https://github.com/google/auto/blob/master/value/userguide/index.md" target="_blank" rel="noopener">Auto Value</a> generated classes to database columns.</p>
</div>
<div class="paragraph">
<p>In the following example, there is only a codec for <code>Value&lt;String&gt;</code> registered, but the code uses beans and classes that are concrete implementations (<code>StringBean</code> contains a <code>StringValue</code> and <code>StringValue</code> implements the <code>Value&lt;String&gt;</code> interface). The <code>TypeResolvingCodecFactory</code> will inspect the types to find a codec for an interface or superclass if no perfect match can be found.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// SQL object dao using concrete types</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">DataDao</span> {

    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO data (id, </span><span class="char">\&quot;</span><span class="content">value</span><span class="char">\&quot;</span><span class="content">) VALUES (:bean.id, :bean.value)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">int</span> storeData(<span class="annotation">@BindBean</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">bean</span><span class="delimiter">&quot;</span></span>) StringBean bean);

    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO data (id, </span><span class="char">\&quot;</span><span class="content">value</span><span class="char">\&quot;</span><span class="content">) VALUES (:id, :value)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">int</span> storeData(<span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> id, <span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>) StringValue data);

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT </span><span class="char">\&quot;</span><span class="content">value</span><span class="char">\&quot;</span><span class="content"> from data where id = :id</span><span class="delimiter">&quot;</span></span>)
    StringValue loadData(<span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> id);
}


<span class="comment">// generic type representation</span>
<span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> QualifiedType&lt;Value&lt;<span class="predefined-type">String</span>&gt;&gt; DATA_TYPE = QualifiedType.of(<span class="keyword">new</span> GenericType&lt;Value&lt;<span class="predefined-type">String</span>&gt;&gt;() {});


<span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">DataCodec</span> <span class="directive">implements</span> Codec&lt;Value&lt;<span class="predefined-type">String</span>&gt;&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> ColumnMapper&lt;Value&lt;<span class="predefined-type">String</span>&gt;&gt; getColumnMapper() {
        <span class="keyword">return</span> (r, idx, ctx) -&gt; <span class="keyword">new</span> StringValue(r.getString(idx));
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Function&lt;Value&lt;<span class="predefined-type">String</span>&gt;, Argument&gt; getArgumentFunction() {
        <span class="keyword">return</span> data -&gt; (idx, stmt, ctx) -&gt; stmt.setString(idx, data.getValue());
    }
}


<span class="comment">// value interface</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">Value</span>&lt;T&gt; {

    T getValue();
}


<span class="comment">// bean using concrete types, not interface types.</span>
<span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">StringBean</span> <span class="directive">implements</span> Bean&lt;Value&lt;<span class="predefined-type">String</span>&gt;&gt; {

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> id;

    <span class="directive">private</span> <span class="directive">final</span> StringValue value;

    <span class="directive">public</span> StringBean(<span class="predefined-type">String</span> id, StringValue value) {
        <span class="local-variable">this</span>.id = id;
        <span class="local-variable">this</span>.value = value;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getId() {
        <span class="keyword">return</span> id;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> StringValue getValue() {
        <span class="keyword">return</span> value;
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_results"><a class="anchor" href="#_results"></a><a class="link" href="#_results">9. Results</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>A number of operations return data from the database through a JDBC <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" target="_blank" rel="noopener">ResultSet</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_queries">Query</a> operations</p>
</li>
<li>
<p>The <a href="./apidocs/org/jdbi/v3/core/statement/Update.html#executeAndReturnGeneratedKeys(java.lang.String...)" target="_blank" rel="noopener">Update#executeAndReturnGeneratedKeys</a> and <a href="./apidocs/org/jdbi/v3/core/statement/PreparedBatch.html#executePreparedBatch(java.lang.String...)" target="_blank" rel="noopener">PreparedBatch#executeAndReturnGeneratedKeys</a> methods</p>
</li>
<li>
<p><a href="#_metadata">Metadata</a> operations</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The JDBC <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" target="_blank" rel="noopener">ResultSet</a> class can do simple mapping to Java primitives
and built in classes, but the API is often cumbersome to use.</p>
</div>
<div class="paragraph">
<p>Jdbi offers many ways to process and map these responses onto other objects using configurable mapping, including the ability to register custom mappers for rows  and columns.</p>
</div>
<div class="paragraph">
<p>A <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper</a> converts a row of a <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" target="_blank" rel="noopener">ResultSet</a> into a result object.</p>
</div>
<div class="paragraph">
<p>A <a href="./apidocs/org/jdbi/v3/core/mapper/ColumnMapper.html" target="_blank" rel="noopener">ColumnMapper</a> converts a single column&#8217;s value into a Java object. It can be
used as a <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper</a> if there is only one column present, or it can be used to
build more complex <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper</a> types.</p>
</div>
<div class="paragraph">
<p>The mapper is selected based on the declared result type of your query.</p>
</div>
<div class="paragraph">
<p>Jdbi iterates over the rows in the <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" target="_blank" rel="noopener">ResultSet</a> and presents the mapped results
to you in a container such as a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/List.html" target="_blank" rel="noopener">List</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html" target="_blank" rel="noopener">Stream</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html" target="_blank" rel="noopener">Optional</a>, or <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Iterator.html" target="_blank" rel="noopener">Iterator</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">User</span> {
    <span class="directive">final</span> <span class="type">int</span> id;
    <span class="directive">final</span> <span class="predefined-type">String</span> name;

    <span class="directive">public</span> User(<span class="type">int</span> id, <span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.id = id;
        <span class="local-variable">this</span>.name = name;
    }
}

<span class="annotation">@BeforeEach</span>
<span class="directive">public</span> <span class="type">void</span> setUp() {
    handle = h2Extension.getSharedHandle();

    handle.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE TABLE </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> (id INTEGER PRIMARY KEY AUTO_INCREMENT, </span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content"> VARCHAR)</span><span class="delimiter">&quot;</span></span>);
    <span class="keyword">for</span> (<span class="predefined-type">String</span> name : <span class="predefined-type">Arrays</span>.asList(<span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Charlie</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Data</span><span class="delimiter">&quot;</span></span>)) {
        handle.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> (</span><span class="char">\&quot;</span><span class="content">name</span><span class="char">\&quot;</span><span class="content">) VALUES (?)</span><span class="delimiter">&quot;</span></span>, name);
    }
}

<span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> findBob() {
    User u = findUserById(<span class="integer">2</span>).orElseThrow(() -&gt; <span class="keyword">new</span> <span class="exception">AssertionError</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">No user found</span><span class="delimiter">&quot;</span></span>));
    assertThat(u.id).isEqualTo(<span class="integer">2</span>);
    assertThat(u.name).isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>);
}

<span class="directive">public</span> Optional&lt;User&gt; findUserById(<span class="type">long</span> id) {
    <span class="predefined-type">RowMapper</span>&lt;User&gt; userMapper =
            (rs, ctx) -&gt; <span class="keyword">new</span> User(rs.getInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>), rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>));
    <span class="keyword">return</span> handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> WHERE id=:id</span><span class="delimiter">&quot;</span></span>)
        .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, id)
        .map(userMapper)
        .findFirst();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Jdbi operations that involve a <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" target="_blank" rel="noopener">ResultSet</a> are defined and executed in multiple steps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;User&gt; users = handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users WHERE department = :department</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">department</span><span class="delimiter">&quot;</span></span>, departmentId) <i class="conum" data-value="2"></i><b>(2)</b>
    .mapTo(User.class) <i class="conum" data-value="3"></i><b>(3)</b>
    .list(); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>create a <a href="#_statement_types">Statement</a> that implements <a href="./apidocs/org/jdbi/v3/core/result/ResultBearing.html" target="_blank" rel="noopener">ResultBearing</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>execute methods on the statement in builder-style which return the same statement type</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>execute a method defined by <a href="./apidocs/org/jdbi/v3/core/result/ResultBearing.html" target="_blank" rel="noopener">ResultBearing</a> that returns a <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html" target="_blank" rel="noopener">ResultIterable</a></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>execute a terminal method on <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html" target="_blank" rel="noopener">ResultIterable</a> that returns the result</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/result/ResultBearing.html" target="_blank" rel="noopener">ResultBearing</a> and <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html" target="_blank" rel="noopener">ResultIterable</a> interfaces define all data mapping operations that Jdbi offer.</p>
</div>
<div class="sect2">
<h3 id="_resultbearing"><a class="anchor" href="#_resultbearing"></a><a class="link" href="#_resultbearing">9.1. ResultBearing</a></h3>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/result/ResultBearing.html" target="_blank" rel="noopener">ResultBearing</a> interface represents the result set of a database operation, which has not been mapped to any particular result type.</p>
</div>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/core/result/ResultBearing.html" target="_blank" rel="noopener">ResultBearing</a> contains two major groups of operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>latent</em> operations that return a <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html" target="_blank" rel="noopener">ResultIterable</a>. These operations map the unmapped result of an operation to a specific type. They require a method on the <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html" target="_blank" rel="noopener">ResultIterable</a> to be called to execute the actual operation</p>
</li>
<li>
<p><em>terminal</em> operations that collect, scan or reduce the result set. Calling one of these methods, executes the actual operation and returns a result.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_mapping_result_types_with_latent_operations"><a class="anchor" href="#_mapping_result_types_with_latent_operations"></a><a class="link" href="#_mapping_result_types_with_latent_operations">9.1.1. Mapping result types with latent operations</a></h4>
<div class="paragraph">
<p>These operations create a map from the data returned by the database onto java objects. This mapping is described in multiple ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>map()</code> operations using a RowMapper, ColumnMapper or RowViewMapper instance.</p>
</li>
<li>
<p><code>mapTo()</code> operations using a type definition. The matching mapper is retrieved from the RowMappers registry. Supports <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Type.html" target="_blank" rel="noopener">regular Java Types</a>, <a href="#_generictype">Generic Types</a> and <a href="#_qualified_types">Qualified Types</a>.</p>
</li>
<li>
<p><code>mapToMap()</code> operations where the key is the (lower-cased) column name and the value is the column value. Supports <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Type.html" target="_blank" rel="noopener">regular Java Types</a>, <a href="#_generictype">Generic Types</a> and <a href="#_qualified_types">Qualified Types</a> for the values. The value mapper is retrieved from the RowMappers registry.</p>
</li>
<li>
<p><code>mapToBean()</code> maps to a mutable bean instance with that provides setters to set values. For each column name, the corresponding setter is called.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is the most common use case when using the <a href="./apidocs/org/jdbi/v3/core/result/ResultBearing.html" target="_blank" rel="noopener">ResultBearing</a> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ResultIterable&lt;User&gt; resultIterable = handle
    .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * from users</span><span class="delimiter">&quot;</span></span>)
    .mapTo(User.class);

<span class="predefined-type">List</span>&lt;User&gt; users = resultIterable.list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Describe terminal operations on the ResultBearing</p>
</li>
<li>
<p>reduceRows</p>
<div class="ulist">
<ul>
<li>
<p>RowView</p>
</li>
</ul>
</div>
</li>
<li>
<p>reduceResultSet</p>
</li>
<li>
<p>collectInto e.g. with a GenericType token. Implies a mapTo() and a collect()
in one operation. e.g. collectInto(new GenericType&lt;List&lt;User&gt;&gt;(){}) is the
same as mapTo(User.class).collect(toList())</p>
</li>
<li>
<p>Provide list of container types supported out of the box</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_resultiterable"><a class="anchor" href="#_resultiterable"></a><a class="link" href="#_resultiterable">9.2. ResultIterable</a></h3>
<div class="paragraph">
<p>A <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html" target="_blank" rel="noopener">ResultIterable</a> represents a result set which has been mapped to a specific type, e.g. a <code>ResultIterable&lt;User&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Almost all operations on the <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html" target="_blank" rel="noopener">ResultIterable</a> interface are <em>terminal</em> operations. When they finish, they close and release all resources, especially the <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" target="_blank" rel="noopener">ResultSet</a> and <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/PreparedStatement.html" target="_blank" rel="noopener">PreparedStatement</a> objects.</p>
</div>
<div class="paragraph">
<p>See <a href="#statement-resource-management">Statement resource management</a> for more details on how resources are released and should be managed.</p>
</div>
<div class="paragraph">
<p>The  <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#stream()" target="_blank" rel="noopener">stream()</a> and <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#stream()#iterator()" target="_blank" rel="noopener">iterator()</a> operations are <strong>not</strong> terminal. They return objects that need to be managed by the caller. See the <a href="#resources-with-streams-iterators">Resources with Streams and Iterators</a> chapter for more details.</p>
</div>
<div class="paragraph">
<p>TODO:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>one(), list(), first(), findOne(), findFirst()</p>
</li>
<li>
<p>mention filter, map as non-terminals</p>
</li>
<li>
<p>collect, reduce</p>
</li>
<li>
<p>callback consumers for iterator and stream</p>
</li>
<li>
<p>ResultIterable.forEach, forEachWithCount</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_finding_a_single_result"><a class="anchor" href="#_finding_a_single_result"></a><a class="link" href="#_finding_a_single_result">9.2.1. Finding a Single Result</a></h4>
<div class="paragraph">
<p><code>ResultIterable.one()</code> returns the only row in the result set. If zero or
multiple rows are encountered, it will throw <code>IllegalStateException</code>.</p>
</div>
<div class="paragraph">
<p><code>ResultIterable.findOne()</code> returns an <code>Optional&lt;T&gt;</code> of the only row in the
result set, or <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html#empty--" target="_blank" rel="noopener">Optional.empty()</a> if no rows are returned.</p>
</div>
<div class="paragraph">
<p><code>ResultIterable.first()</code> returns the first row in the result set. If zero
rows are encountered, <code>IllegalStateException</code> is thrown.</p>
</div>
<div class="paragraph">
<p><code>ResultIterable.findFirst()</code> returns an <code>Optional&lt;T&gt;</code> of the first row, if
any.</p>
</div>
</div>
<div class="sect3">
<h4 id="_stream"><a class="anchor" href="#_stream"></a><a class="link" href="#_stream">9.2.2. Stream</a></h4>
<div class="paragraph">
<p><strong>Stream</strong> integration allows you to use a <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper</a> to adapt a <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" target="_blank" rel="noopener">ResultSet</a> into  the Java Streams framework. The stream will lazily fetch rows from the database as necessary.</p>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#stream()" target="_blank" rel="noopener">stream()</a> method returns a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html" target="_blank" rel="noopener">Stream&lt;T&gt;</a>. This is not a terminal operation and the stream must be closed to release any database resources held. See <a href="#resources-with-streams-iterators">Resources with Streams and Iterators</a> for more details.</p>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#withStream(org.jdbi.v3.core.result.StreamCallback)" target="_blank" rel="noopener">withStream()</a> and <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.htmll#useStream(org.jdbi.v3.core.result.StreamConsumer)" target="_blank" rel="noopener">useStream()</a> methods pass the Stream into a callback.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name FROM user ORDER BY id ASC</span><span class="delimiter">&quot;</span></span>)
    .map(<span class="keyword">new</span> UserMapper())
    .useStream(stream -&gt; {
        Optional&lt;<span class="predefined-type">String</span>&gt; first = stream
            .filter(u -&gt; u.id &gt; <span class="integer">2</span>)
            .map(u -&gt; u.name)
            .findFirst();
        assertThat(first).contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Charlie</span><span class="delimiter">&quot;</span></span>);
    });</code></pre>
</div>
</div>
<div class="paragraph">
<p>These methods handle closing the stream for the caller. The <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html#withStream(org.jdbi.v3.core.result.StreamCallback)" target="_blank" rel="noopener">withStream()</a> method allows passing a result back to the caller, <a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.htmll#useStream(org.jdbi.v3.core.result.StreamConsumer)" target="_blank" rel="noopener">useStream()</a> only executed the code in the callback.</p>
</div>
</div>
<div class="sect3">
<h4 id="_list"><a class="anchor" href="#_list"></a><a class="link" href="#_list">9.2.3. List</a></h4>
<div class="paragraph">
<p><strong>#list</strong> emits a <strong>List&lt;T&gt;</strong>. This necessarily buffers all results in memory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;User&gt; users =
    handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name FROM user</span><span class="delimiter">&quot;</span></span>)
        .map(<span class="keyword">new</span> UserMapper())
        .list();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_collectors"><a class="anchor" href="#_collectors"></a><a class="link" href="#_collectors">9.2.4. Collectors</a></h4>
<div class="paragraph">
<p><strong>#collect</strong> takes a <code>Collector&lt;T, ?, R&gt;</code> that builds a resulting collection
<strong>R&lt;T&gt;</strong>. The <strong>java.util.stream.Collectors</strong> class has a number of interesting
<strong>Collector</strong> implementations to start with.</p>
</div>
<div class="paragraph">
<p>You can also write your own custom collectors.  For example, to accumulate
found rows into a <strong>Map</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">h.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO something (id, name) VALUES (1, 'Alice'), (2, 'Bob'), (3, 'Chuckles')</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">Map</span>&lt;<span class="predefined-type">Integer</span>, Something&gt; users = h.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name FROM something</span><span class="delimiter">&quot;</span></span>)
    .mapTo(Something.class)
    .collect(Collector.of(<span class="predefined-type">HashMap</span>::<span class="keyword">new</span>, (accum, item) -&gt; {
        accum.put(item.getId(), item);   <span class="comment">// Each entry is added into an accumulator map</span>
    }, (l, r) -&gt; {
        l.putAll(r);                     <span class="comment">// While jdbi does not process rows in parallel,</span>
        <span class="keyword">return</span> l;                        <span class="comment">// the Collector contract encourages writing combiners</span>
    }, Characteristics.IDENTITY_FINISH));</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_reduction"><a class="anchor" href="#_reduction"></a><a class="link" href="#_reduction">9.2.5. Reduction</a></h4>
<div class="paragraph">
<p><strong>#reduce</strong> provides a simplified <strong>Stream#reduce</strong>. Given an identity starting
value and a <strong>BiFunction&lt;U, T, U&gt;</strong> it will repeatedly combine <strong>U</strong> until only a
single remains, and then return that.</p>
</div>
</div>
<div class="sect3">
<h4 id="_resultsetscanner"><a class="anchor" href="#_resultsetscanner"></a><a class="link" href="#_resultsetscanner">9.2.6. ResultSetScanner</a></h4>
<div class="paragraph">
<p>The <strong>ResultSetScanner</strong> interface accepts a lazily-provided <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" target="_blank" rel="noopener">ResultSet</a>
and produces the result Jdbi returns from statement execution.</p>
</div>
<div class="paragraph">
<p>Most of the above operations are implemented in terms of <strong>ResultSetScanner</strong>.
The Scanner has ownership of the <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" target="_blank" rel="noopener">ResultSet</a> and may advance or seek it.</p>
</div>
<div class="paragraph">
<p>The return value ends up being the final result of statement execution.</p>
</div>
<div class="paragraph">
<p>Most users should prefer using the higher level result collectors described above,
but someone&#8217;s gotta do the dirty work.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_joins"><a class="anchor" href="#_joins"></a><a class="link" href="#_joins">9.3. Joins</a></h3>
<div class="paragraph">
<p>Joining multiple tables together is a very common database task. It is also
where the mismatch between the relational model and Java&#8217;s object model starts
to rear its ugly head.</p>
</div>
<div class="paragraph">
<p>Here we present a couple of strategies for retrieving results from more
complicated rows.</p>
</div>
<div class="paragraph">
<p>Consider a contact list app as an example. The contact list contains any
number of contacts. Contacts have a name, and any number of phone numbers.
Phone numbers have a type (e.g. home, work) and a phone number:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Contact</span> {
    <span class="predefined-type">Long</span> id;
    <span class="predefined-type">String</span> name;
    <span class="predefined-type">List</span>&lt;Phone&gt; phones = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="type">void</span> addPhone(Phone phone) {
        phones.add(phone);
    }
}

<span class="type">class</span> <span class="class">Phone</span> {
    <span class="predefined-type">Long</span> id;
    <span class="predefined-type">String</span> type;
    <span class="predefined-type">String</span> phone;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve left out getters, setters, and access modifiers for brevity.</p>
</div>
<div class="paragraph">
<p>Since we&#8217;ll be reusing the same queries, we&#8217;ll define them as constants now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="asciidoc">static final String SELECT_ALL = &quot;SELECT contacts.id c_id, name c_name, &quot;
    + &quot;phones.id p_id, type p_type, phones.phone p_phone &quot;
    + &quot;FROM contacts LEFT JOIN phones ON contacts.id = phones.contact_id &quot;
    + &quot;order by c_name, p_type &quot;;

static final String SELECT_ONE = SELECT_ALL + &quot;where phones.id = :id&quot;;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we&#8217;ve given aliases (e.g. <code>c_id</code>, <code>p_id</code>) to distinguish columns of
the same name (<code>id</code>) from different tables.</p>
</div>
<div class="paragraph">
<p>Jdbi provides a few different APIs for dealing with joined data.</p>
</div>
<div class="sect3">
<h4 id="_resultbearing_reducerows"><a class="anchor" href="#_resultbearing_reducerows"></a><a class="link" href="#_resultbearing_reducerows">9.3.1. ResultBearing.reduceRows()</a></h4>
<div class="paragraph">
<p>The
<a href="./apidocs/org/jdbi/v3/core/result/ResultBearing.html#reduceRows-U-java.util.function.BiFunction-" target="_blank" rel="noopener">"ResultBearing.reduceRows(U, BiFunction)"</a>
method accepts an accumulator seed value and a lambda function. For each row in
the result set, Jdbi calls the lambda with the current accumulator value and a
<a href="./apidocs/org/jdbi/v3/core/result/RowView.html" target="_blank" rel="noopener">RowView</a> over the current row of the
result set. The value returned for each row becomes the input accumulator
passed in for the next row. After the last row has been processed,
<code>reducedRows()</code> returns the last value returned from the lambda.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;Contact&gt; contacts = handle.createQuery(SELECT_ALL)
    .registerRowMapper(BeanMapper.factory(Contact.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">c</span><span class="delimiter">&quot;</span></span>))
    .registerRowMapper(BeanMapper.factory(Phone.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>)) <i class="conum" data-value="1"></i><b>(1)</b>
    .reduceRows(<span class="keyword">new</span> <span class="predefined-type">LinkedHashMap</span>&lt;<span class="predefined-type">Long</span>, Contact&gt;(), <i class="conum" data-value="2"></i><b>(2)</b>
        (map, rowView) -&gt; {
            Contact contact = map.computeIfAbsent( <i class="conum" data-value="3"></i><b>(3)</b>
                rowView.getColumn(<span class="string"><span class="delimiter">&quot;</span><span class="content">c_id</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Long</span>.class),
                id -&gt; rowView.getRow(Contact.class));

            <span class="keyword">if</span> (rowView.getColumn(<span class="string"><span class="delimiter">&quot;</span><span class="content">p_id</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Long</span>.class) != <span class="predefined-constant">null</span>) { <i class="conum" data-value="4"></i><b>(4)</b>
                contact.addPhone(rowView.getRow(Phone.class));
            }

            <span class="keyword">return</span> map; <i class="conum" data-value="5"></i><b>(5)</b>
        })
    .values() <i class="conum" data-value="6"></i><b>(6)</b>
    .stream()
    .collect(toList()); <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Register row mappers for <code>Contact</code> and <code>Phone</code>. Note the <code>"c"</code> and <code>"p"</code>
arguments used&#8212;&#8203;these are column name prefixes. By registering mappers with
prefixes, the <code>Contact</code> mapper will only map the <code>c_id</code> and <code>c_name</code>
columns, whereas the <code>Phone</code> mapper will only map <code>p_id</code>, <code>p_type</code>, and
<code>p_phone</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use an empty <a href="https://docs.oracle.com/javase/8/docs/api/java/util/LinkedHashMap.html" target="_blank" rel="noopener">LinkedHashMap</a>
as the accumulator seed, mapped by contact ID. <code>LinkedHashMap</code> is a good
accumulator when selecting multiple master records, since it has fast
storage and lookup while preserving insertion order (which helps honor
<code>ORDER BY</code> clauses). If ordering is unimportant, a <code>HashMap</code> would also
suffice.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Load the <code>Contact</code> from the accumulator if we already have it; otherwise,
initialize it through the <code>RowView</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If <code>p_id</code> column is not null, load the phone number from the current row
and add it to the current contact.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Return the input map (now sporting an additional contact and/or phone) as
the accumulator for the next row.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>At this point, all rows have been read into memory, and we don&#8217;t need the
contact ID keys. So we call <code>Map.values()</code> to get a <code>Collection&lt;Contact&gt;</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Collect the contacts into a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/List.html" target="_blank" rel="noopener">List&lt;Contact&gt;</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively, the
<a href="./apidocs/org/jdbi/v3/core/result/ResultBearing.html#reduceRows-org.jdbi.v3.core.result.RowReducer-" target="_blank" rel="noopener">ResultBearing.reduceRows(RowReducer)</a>
variant accepts a <a href="./apidocs/org/jdbi/v3/core/result/RowReducer.html" target="_blank" rel="noopener">RowReducer</a> and
returns a stream of reduced elements.</p>
</div>
<div class="paragraph">
<p>For simple master-detail joins, the
<a href="./apidocs/org/jdbi/v3/core/result/ResultBearing.html#reduceRows-java.util.function.BiConsumer-" target="_blank" rel="noopener">ResultBearing.reduceRows(BiConsumer&lt;Map&lt;K,V&gt;,RowView&gt;)</a>
method makes it easy to reduce these joins into a stream of master elements.</p>
</div>
<div class="paragraph">
<p>Adapting the example above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;Contact&gt; contacts = handle.createQuery(SELECT_ALL)
    .registerRowMapper(BeanMapper.factory(Contact.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">c</span><span class="delimiter">&quot;</span></span>))
    .registerRowMapper(BeanMapper.factory(Phone.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>))
    .reduceRows((<span class="predefined-type">Map</span>&lt;<span class="predefined-type">Long</span>, Contact&gt; map, RowView rowView) -&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
        Contact contact = map.computeIfAbsent(
            rowView.getColumn(<span class="string"><span class="delimiter">&quot;</span><span class="content">c_id</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Long</span>.class),
            id -&gt; rowView.getRow(Contact.class));

        <span class="keyword">if</span> (rowView.getColumn(<span class="string"><span class="delimiter">&quot;</span><span class="content">p_id</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Long</span>.class) != <span class="predefined-constant">null</span>) {
            contact.addPhone(rowView.getRow(Phone.class));
        }
        <i class="conum" data-value="2"></i><b>(2)</b>
    })
    .collect(toList()); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The lambda receives a map where result objects will be stored, and a
<code>RowView</code>. The map is a <code>LinkedHashMap</code>, so the result stream will
yield the result objects in the same order they were inserted.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>No <code>return</code> statement needed. The same <code>map</code> is reused on every row.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This <code>reduceRows()</code> invocation produces a <code>Stream&lt;Contact&gt;</code> (i.e. from
<code>map.values().stream()</code>. In this example, we collect the elements into a
list, but we could call any <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html" target="_blank" rel="noopener">Stream</a> method here.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You may be wondering about the <code>getRow()</code> and <code>getColumn()</code> calls to <code>rowView</code>.
When you call <code>rowView.getRow(SomeType.class)</code>, <code>RowView</code> looks up the
registered row mapper for <code>SomeType</code>, and uses it to map the current row to a
<code>SomeType</code> object.</p>
</div>
<div class="paragraph">
<p>Likewise, when you call <code>rowView.getColumn("my_value", MyValueType.class)</code>,
<code>RowView</code> looks up the registered column mapper for <code>MyValueType</code>, and uses it
to map the <code>my_value</code> column of the current row to a <code>MyValueType</code> object.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s do the same thing, but for a single contact:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Optional&lt;Contact&gt; contact = handle.createQuery(SELECT_ONE)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, contactId)
    .registerRowMapper(BeanMapper.factory(Contact.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">c</span><span class="delimiter">&quot;</span></span>))
    .registerRowMapper(BeanMapper.factory(Phone.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>))
    .reduceRows(LinkedHashMapRowReducer.&lt;<span class="predefined-type">Long</span>, Contact&gt; of((map, rowView) -&gt; {
      Contact contact = map.orElseGet(() -&gt; rowView.getRow(Contact.class));

      <span class="keyword">if</span> (rowView.getColumn(<span class="string"><span class="delimiter">&quot;</span><span class="content">p_id</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Long</span>.class) != <span class="predefined-constant">null</span>) {
        contact.addPhone(rowView.getRow(Phone.class));
      }
    })
    .findFirst();</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_resultbearing_reduceresultset"><a class="anchor" href="#_resultbearing_reduceresultset"></a><a class="link" href="#_resultbearing_reduceresultset">9.3.2. ResultBearing.reduceResultSet()</a></h4>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/core/result/ResultBearing.html#reduceResultSet-U-org.jdbi.v3.core.result.ResultSetAccumulator-" target="_blank" rel="noopener">ResultBearing.reduceResultSet()</a>
is a low-level API similar to <code>reduceRows()</code>, except it provides direct access
to the JDBC <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" target="_blank" rel="noopener">ResultSet</a> instead of a <code>RowView</code> for each row.</p>
</div>
<div class="paragraph">
<p>This method can provide superior performance compared to <code>reduceRows()</code>, at the
expense of verbosity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;Contact&gt; contacts = handle.createQuery(SELECT_ALL)
    .reduceResultSet(<span class="keyword">new</span> <span class="predefined-type">LinkedHashMap</span>&lt;<span class="predefined-type">Long</span>, Contact&gt;(),
        (acc, resultSet, ctx) -&gt; {
            <span class="type">long</span> contactId = resultSet.getLong(<span class="string"><span class="delimiter">&quot;</span><span class="content">c_id</span><span class="delimiter">&quot;</span></span>);
            Contact contact;
            <span class="keyword">if</span> (acc.containsKey(contactId)) {
                contact = acc.get(contactId);
            } <span class="keyword">else</span> {
                contact = <span class="keyword">new</span> Contact();
                acc.put(contactId, contact);
                contact.setId(contactId);
                contact.setName(resultSet.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">c_name</span><span class="delimiter">&quot;</span></span>));
            }

            <span class="type">long</span> phoneId = resultSet.getLong(<span class="string"><span class="delimiter">&quot;</span><span class="content">p_id</span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">if</span> (!resultSet.wasNull()) {
                Phone phone = <span class="keyword">new</span> Phone();
                phone.setId(phoneId);
                phone.setType(resultSet.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">p_type</span><span class="delimiter">&quot;</span></span>));
                phone.setPhone(resultSet.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">p_phone</span><span class="delimiter">&quot;</span></span>));
                contact.addPhone(phone);
            }

            <span class="keyword">return</span> acc;
        })
    .values()
    .stream()
    .collect(toList());</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_joinrowmapper"><a class="anchor" href="#_joinrowmapper"></a><a class="link" href="#_joinrowmapper">9.3.3. JoinRowMapper</a></h4>
<div class="paragraph">
<p>The JoinRowMapper takes a set of types to extract from each row. It uses the
mapping registry to determine how to map each given type, and presents you with
a JoinRow that holds all the resulting values.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s consider two simple types, User and Article, with a join table named
Author. Guava provides a Multimap class, which is very handy for representing
joined tables like this. Assuming we have mappers already registered:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">h.registerRowMapper(ConstructorMapper.factory(User.class));
h.registerRowMapper(ConstructorMapper.factory(Article.class));</code></pre>
</div>
</div>
<div class="paragraph">
<p>we can then easily populate a Multimap with the mapping from the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Multimap&lt;User, Article&gt; joined = HashMultimap.create();
h.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> NATURAL JOIN author NATURAL JOIN article</span><span class="delimiter">&quot;</span></span>)
    .map(JoinRowMapper.forTypes(User.class, Article.class))
    .forEach(jr -&gt; joined.put(jr.get(User.class), jr.get(Article.class)));</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
While this approach is easy to read and write, it can be inefficient for
certain patterns of data. Consider performance requirements when deciding
whether to use high level mapping or more direct low level access with
handwritten mappers.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also use it with SqlObject:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserArticleDao</span> {

    <span class="annotation">@RegisterJoinRowMapper</span>({User.class, Article.class})
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> NATURAL JOIN author NATURAL JOIN article</span><span class="delimiter">&quot;</span></span>)
    Stream&lt;JoinRow&gt; getAuthorship();
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Multimap&lt;User, Article&gt; joined = HashMultimap.create();

handle.attach(UserArticleDao.class)
    .getAuthorship()
    .forEach(jr -&gt; joined.put(jr.get(User.class), jr.get(Article.class)));

assertThat(joined).isEqualTo(JoinRowMapperTest.getExpected());</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_transactions"><a class="anchor" href="#_transactions"></a><a class="link" href="#_transactions">10. Transactions</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jdbi provides full support for JDBC transactions.</p>
</div>
<div class="sect2">
<h3 id="_managed_transactions"><a class="anchor" href="#_managed_transactions"></a><a class="link" href="#_managed_transactions">10.1. Managed Transactions</a></h3>
<div class="paragraph">
<p>A managed transaction is controlled through Jdbi code and provides a handle with an open transaction to user code.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#inTransaction(org.jdbi.v3.core.HandleCallback)" target="_blank" rel="noopener">inTransaction</a> and <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useTransaction(org.jdbi.v3.core.HandleConsumer)" target="_blank" rel="noopener">useTransaction</a> methods on the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> object create a new <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a>, open a transaction and pass it to the callback code.</p>
</li>
<li>
<p>The <a href="./apidocs/org/jdbi/v3/core/Handle.html#inTransaction(org.jdbi.v3.core.HandleCallback)" target="_blank" rel="noopener">inTransaction</a> and <a href="./apidocs/org/jdbi/v3/core/Handle.html#useTransaction(org.jdbi.v3.core.HandleConsumer)" target="_blank" rel="noopener">useTransaction</a> methods on <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> objects open a transaction on the handle itself and then pass it to the callback code. By default, if these methods are called while the handle is already in an open transaction, the existing transaction is reused (no nested transaction is created).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each of these methods also has a variant that allows setting the <a href="./apidocs/org/jdbi/v3/core/transaction/TransactionIsolationLevel.html" target="_blank" rel="noopener">transaction isolation level</a>. Changing the transaction isolation level within an open transaction is not supported (and will cause an exception).</p>
</div>
<div class="paragraph">
<p>At the end of the callback, the transaction is committed, if</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the code has not thrown an exception</p>
</li>
<li>
<p>it was not a nested call from another <code>useTransaction</code>/<code>inTransaction</code> callback. In that case, control is handed back to the original caller and the transaction finishes when that callback returns.</p>
</li>
<li>
<p>the code did not call the <a href="./apidocs/org/jdbi/v3/core/Handle.html#rollback()" target="_blank" rel="noopener">rollback()</a> method on the Handle object.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Executing a SQL operation in a transaction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// use a Jdbi object to create transaction</span>
<span class="directive">public</span> Optional&lt;User&gt; findUserById(Jdbi jdbi, <span class="type">long</span> id) {
    <span class="keyword">return</span> jdbi.inTransaction(transactionHandle -&gt;
            transactionHandle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users WHERE id=:id</span><span class="delimiter">&quot;</span></span>)
                    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, id)
                    .mapTo(User.class)
                    .findFirst());
}

<span class="comment">// use a Handle object to create transaction</span>
<span class="directive">public</span> Optional&lt;User&gt; findUserById(Handle handle, <span class="type">long</span> id) {
    <span class="keyword">return</span> handle.inTransaction(transactionHandle -&gt;
            transactionHandle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users WHERE id=:id</span><span class="delimiter">&quot;</span></span>)
                    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, id)
                    .mapTo(User.class)
                    .findFirst());
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_unmanaged_transactions"><a class="anchor" href="#_unmanaged_transactions"></a><a class="link" href="#_unmanaged_transactions">10.2. Unmanaged Transactions</a></h3>
<div class="paragraph">
<p>Jdbi provides the necessary primitives to control transactions directly from a Handle:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <a href="./apidocs/org/jdbi/v3/core/Handle.html#begin()">begin()<sup></a>/<a href="./apidocs/org/jdbi/v3/core/Handle.html#commit()">commit()</sup></a>/<a href="./apidocs/org/jdbi/v3/core/Handle.html#rollback()" target="_blank" rel="noopener">rollback()</a> methods provide standard transaction semantics</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/core/Handle.html#setTransactionIsolationLevel(org.jdbi.v3.core.transaction.TransactionIsolationLevel)" target="_blank" rel="noopener">setTransactionIsolationLevel()</a> and <a href="./apidocs/org/jdbi/v3/core/Handle.html#getTransactionIsolationLevel()" target="_blank" rel="noopener">getTransactionIsolationLevel()</a> to control the transaction isolation level</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/core/Handle.html#isInTransaction()" target="_blank" rel="noopener">isInTransaction()</a> returns <code>true</code> if the handle is currently in a transaction</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/core/Handle.html#savepoint(java.lang.String)">savepoint()<sup></a>/<a href="./apidocs/org/jdbi/v3/core/Handle.html#releaseSavepoint(java.lang.String)">releaseSavepoint()</sup></a>/<a href="./apidocs/org/jdbi/v3/core/Handle.html#rollbackToSavepoint(java.lang.String)" target="_blank" rel="noopener">rollbackToSavepoint()</a> for transaction savepoint support. This is not supported by all TransactionHandlers and requires support from the JDBC driver</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Transactions are managed by <a href="./apidocs/org/jdbi/v3/core/transaction/TransactionHandler.html" target="_blank" rel="noopener">TransactionHandler</a> implementations. By default, transactions are delegated to the JDBC connection and managed through the connection by the database.</p>
</div>
<div class="paragraph">
<p>The transaction handler can be set per <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance using the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#setTransactionHandler(org.jdbi.v3.core.transaction.TransactionHandler)" target="_blank" rel="noopener">setTransactionHandler</a> and <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#getTransactionHandler()" target="_blank" rel="noopener">getTransactionHandler</a> methods.</p>
</div>
<div class="paragraph">
<p>In addition to the <a href="./apidocs/org/jdbi/v3/core/transaction/LocalTransactionHandler.html" target="_blank" rel="noopener">standard transaction handler</a>, Jdbi includes a <a href="./apidocs/org/jdbi/v3/core/transaction/CMTTransactionHandler.html" target="_blank" rel="noopener">handler that works correctly in a container managed environment</a> and a <a href="./apidocs/org/jdbi/v3/core/transaction/SerializableTransactionRunner.html" target="_blank" rel="noopener">serializable transaction handler</a> that allows multiple concurrent operations on a single handle to retry transparently.</p>
</div>
</div>
<div class="sect2">
<h3 id="_serializable_transactions"><a class="anchor" href="#_serializable_transactions"></a><a class="link" href="#_serializable_transactions">10.3. Serializable Transactions</a></h3>
<div class="paragraph">
<p>For more advanced queries, sometimes serializable transactions are required.</p>
</div>
<div class="paragraph">
<p>Jdbi includes a <a href="./apidocs/org/jdbi/v3/core/transaction/SerializableTransactionRunner.html" target="_blank" rel="noopener">transaction runner that is able to retry transactions</a> that abort due to serialization failures.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
It is important that your transaction does not have side effects as it may be executed multiple times.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Automatically rerun transactions</span>
jdbi.setTransactionHandler(<span class="keyword">new</span> SerializableTransactionRunner());
handle.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE TABLE ints (value INTEGER)</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// Set up some values</span>
handle.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO ints (value) VALUES(?)</span><span class="delimiter">&quot;</span></span>, <span class="integer">10</span>);
handle.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO ints (value) VALUES(?)</span><span class="delimiter">&quot;</span></span>, <span class="integer">20</span>);

<span class="comment">// Run the following twice in parallel, and synchronize</span>
<span class="predefined-type">ExecutorService</span> executor = <span class="predefined-type">Executors</span>.newCachedThreadPool();
<span class="predefined-type">CountDownLatch</span> latch = <span class="keyword">new</span> <span class="predefined-type">CountDownLatch</span>(<span class="integer">2</span>);

<span class="predefined-type">Callable</span>&lt;<span class="predefined-type">Integer</span>&gt; sumAndInsert = () -&gt;
        jdbi.inTransaction(TransactionIsolationLevel.SERIALIZABLE, transactionHandle -&gt; {
            <span class="comment">// Both threads read initial state of table</span>
            <span class="type">int</span> sum = transactionHandle.select(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT sum(value) FROM ints</span><span class="delimiter">&quot;</span></span>).mapTo(<span class="type">int</span>.class).one();

            <span class="comment">// synchronize threads, make sure that they each has successfully read the data</span>
            latch.countDown();
            latch.await();

            <span class="comment">// Now do the write.</span>
            <span class="directive">synchronized</span> (<span class="local-variable">this</span>) {
                <span class="comment">// handle can be used by multiple threads, but not at the same time</span>
                transactionHandle.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO ints (value) VALUES(?)</span><span class="delimiter">&quot;</span></span>, sum);
            }
            <span class="keyword">return</span> sum;
        });

<span class="comment">// Both of these would calculate 10 + 20 = 30, but that violates serialization!</span>
<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Integer</span>&gt; result1 = executor.submit(sumAndInsert);
<span class="predefined-type">Future</span>&lt;<span class="predefined-type">Integer</span>&gt; result2 = executor.submit(sumAndInsert);

<span class="comment">// One of the transactions gets 30, the other will abort and automatically rerun.</span>
<span class="comment">// On the second attempt it will compute 10 + 20 + 30 = 60, seeing the update from its sibling.</span>
<span class="comment">// This assertion fails under any isolation level below SERIALIZABLE!</span>
assertThat(result1.get() + result2.get()).isEqualTo(<span class="integer">30</span> + <span class="integer">60</span>);

executor.shutdown();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above test is designed to run two transactions in lock step. Each attempts to read the sum of all rows in the table, and then insert a new row with that sum. We seed the table with the values 10 and 20.</p>
</div>
<div class="paragraph">
<p>Without serializable isolation, each transaction reads 10 and 20, and then returns 30. The end result is 30 + 30 = 60, which does not correspond to any serial execution of the transactions!</p>
</div>
<div class="paragraph">
<p>With serializable isolation, one of the two transactions is forced to abort and retry. On the second go around, it calculates 10 + 20 + 30 = 60. Adding to 30 from the other, we get 30 + 60 = 90 and the assertion succeeds.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration"><a class="anchor" href="#_configuration"></a><a class="link" href="#_configuration">11. Configuration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jdbi aims to be useful out of the box with minimal configuration. If necessary,
there is a wide range of configurations and customizations available to change the
default behavior or add in extensions to handle additional database types.</p>
</div>
<div class="paragraph">
<p>Configuration is managed by the
<a href="./apidocs/org/jdbi/v3/core/config/ConfigRegistry.html" target="_blank" rel="noopener">ConfigRegistry</a> class.
Each Jdbi object that represents a distinct database context (for
example, <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> itself, a
<a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> instance, or an attached
<a href="./apidocs/org/jdbi/v3/sqlobject/SqlObject.html" target="_blank" rel="noopener">SqlObject</a> class) has a
separate config registry instance.</p>
</div>
<div class="paragraph">
<p>When a new context is created, it inherits a copy of its parent
configuration at the time of creation - further modifications to the
original will not affect already created configuration contexts.
Configuration context copies happen when creating a
<a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> from
<a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a>, when opening a
<a href="./apidocs/org/jdbi/v3/core/statement/SqlStatement.html" target="_blank" rel="noopener">SqlStatement</a> from
the Handle, and when attaching or creating an on-demand extension such
as <a href="./apidocs/org/jdbi/v3/sqlobject/SqlObject.html" target="_blank" rel="noopener">SqlObject</a>.</p>
</div>
<div class="paragraph">
<p>A configurable Jdbi object implements the
<a href="./apidocs/org/jdbi/v3/core/config/Configurable.html" target="_blank" rel="noopener">Configurable</a> interface
which allows modification of its configuration as well as retrieving
the current context&#8217;s configuration for use by Jdbi core or
extensions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// fetch the config registry object</span>
ConfigRegistry config = jdbi.getConfig();

<span class="comment">// access the SqlStatements configuration object:</span>
SqlStatements sqlStatements = jdbi.getConfig(SqlStatements.class);

<span class="comment">// modify a setting in SqlStatements with a callback</span>
jdbi.configure(SqlStatements.class, s -&gt; s.setUnusedBindingAllowed(<span class="predefined-constant">true</span>));

<span class="comment">// modify a setting in SqlStatements with direct method invocation</span>
jdbi.getConfig(SqlStatements.class).setUnusedBindingAllowed(<span class="predefined-constant">true</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/config/Configurable.html" target="_blank" rel="noopener">Configurable</a>
interface also adds a number of convenience methods for commonly used
configuration objects.</p>
</div>
<div class="paragraph">
<p>See <a href="#_jdbiconfig">JdbiConfig</a> for more advanced implementation details.</p>
</div>
<div class="sect2">
<h3 id="_core_settings"><a class="anchor" href="#_core_settings"></a><a class="link" href="#_core_settings">11.1. core settings</a></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 18.1818%;">
<col style="width: 18.1818%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 45.4546%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Object</th>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-center valign-top">Type</th>
<th class="tableblock halign-center valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/argument/Arguments.html" target="_blank" rel="noopener">Arguments</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bindingNullToPrimitivesPermitted</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Allows binding <code>null</code> values for primitive types.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">preparedArgumentsEnabled</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PreparedArguments speed up argument processing but have some backwards compatibility risk with old (pre-3.24.0) releases.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">untypedNullArgument</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/argument/Argument.html" target="_blank" rel="noopener">Argument</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/argument/NullArgument.html" target="_blank" rel="noopener">NullArgument</a> using <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/Types.html#OTHER" target="_blank" rel="noopener">Types.OTHER</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This argument instance is invoked when a <code>null</code> value is assigned to an argument whose type is unknown (this can happen in some corner cases).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/mapper/ColumnMappers.html" target="_blank" rel="noopener">ColumnMappers</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">coalesceNullPrimitivesToDefaults</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Uses the driver default value for primitive types if a SQL NULL value was returned by the database. The exact value used is specific to the database driver.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/enums/Enums.html" target="_blank" rel="noopener">Enums</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">enumStrategy</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/enums/EnumStrategy.html" target="_blank" rel="noopener">EnumStrategy</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>BY_NAME</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sets the strategy to map a Java enum value onto a database column. Available strategies are</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/enums/EnumStrategy.html#BY_NAME" target="_blank" rel="noopener">BY_NAME</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map the name of the enum from and to the database column</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/enums/EnumStrategy.html#BY_ORDINAL" target="_blank" rel="noopener">BY_ORDINAL</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map the ordinal number of the enum value from and to the database column</p></td>
</tr>
</tbody>
</table></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/extension/Extensions.html" target="_blank" rel="noopener">Extensions</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowProxy</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Whether Jdbi is allowed to create <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Proxy.html" target="_blank" rel="noopener">proxy </a> instances for classes (as extension and on-demand reference). This is useful for debugging when using the generator to create java classes for sql objects.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">failFast</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If set to <code>true</code>, extension objects with misconfigured methods will fail at first use of any method. Default is to fail when a misconfigured method is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/Handles.html" target="_blank" rel="noopener">Handles</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">forceEndTransactions</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Whether to ensure transaction discipline. If <code>true</code>, transactions <strong>must</strong> be committed or rolled back before a Handle is closed. If <code>true</code>, any uncommitted
transaction is rolled back and an exception is thrown when the Handle is closed.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/mapper/MapMappers.html" target="_blank" rel="noopener">MapMappers</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">caseChange</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/UnaryOperator.html" target="_blank" rel="noopener">UnaryOperator&lt;String&gt;</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/mapper/CaseStrategy.html#LOCALE_LOWER" target="_blank" rel="noopener">LOCALE_LOWER</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Defines the strategy for mapping the database column names to key names. Available strategies are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/mapper/CaseStrategy.html#NOP" target="_blank" rel="noopener">NOP</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no name mapping, use name as is</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/mapper/CaseStrategy.html#LOWER" target="_blank" rel="noopener">LOWER</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lowercase column names using the <code>ROOT</code> locale</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/mapper/CaseStrategy.html#UPPER" target="_blank" rel="noopener">UPPER</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">uppercase column names using the <code>ROOT</code> locale</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/mapper/CaseStrategy.html#LOCALE_LOWER" target="_blank" rel="noopener">LOCALE_LOWER</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lowercase column names using the current locale</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/mapper/CaseStrategy.html#LOCALE_UPPER" target="_blank" rel="noopener">LOCALE_UPPER</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">uppercase column names using the current locale</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Custom strategies can be set by implementing <a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/UnaryOperator.html" target="_blank" rel="noopener">UnaryOperator&lt;String&gt;</a> with custom code.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/mapper/reflect/ReflectionMappers.html" target="_blank" rel="noopener">ReflectionMappers</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">caseChange</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/UnaryOperator.html" target="_blank" rel="noopener">UnaryOperator&lt;String&gt;</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/mapper/CaseStrategy.html#LOCALE_LOWER" target="_blank" rel="noopener">LOCALE_LOWER</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Defines the strategy for mapping the database column names to key names. Available strategies are:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/mapper/CaseStrategy.html#NOP" target="_blank" rel="noopener">NOP</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no name mapping, use name as is</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/mapper/CaseStrategy.html#LOWER" target="_blank" rel="noopener">LOWER</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lowercase column names using the <code>ROOT</code> locale</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/mapper/CaseStrategy.html#UPPER" target="_blank" rel="noopener">UPPER</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">uppercase column names using the <code>ROOT</code> locale</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/mapper/CaseStrategy.html#LOCALE_LOWER" target="_blank" rel="noopener">LOCALE_LOWER</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lowercase column names using the current locale</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/mapper/CaseStrategy.html#LOCALE_UPPER" target="_blank" rel="noopener">LOCALE_UPPER</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">uppercase column names using the current locale</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Custom strategies can be set by implementing <a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/UnaryOperator.html" target="_blank" rel="noopener">UnaryOperator&lt;String&gt;</a> with custom code.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">strictMatching</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>true</code>, all database columns must be mapped to a property. If any columns are unmatched or any property is unset, an exception is thrown.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/result/ResultProducers.html" target="_blank" rel="noopener">ResultProducers</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">allowNoResults</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>If <code>false</code>, Jdbi throws an exception if a query does not return a result set object (this is <strong>different</strong> from an empty result, e.g. no rows in a query). When setting this to <code>true</code>, Jdbi uses an empty result set instead.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="4"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/transaction/SerializableTransactionRunner.Configuration.html" target="_blank" rel="noopener">SerializableTransactionRunner.Configuration</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">maxRetries</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>5</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>number of times a transaction is retried if the database reports a serialization error.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">onFailure</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Consumer.html" target="_blank" rel="noopener">Consumer&lt;List&lt;Exception&gt;&gt;</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;unset&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Is called whenever a serialization failure occurs. Can be used e.g. for logging.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">onSuccess</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Consumer.html" target="_blank" rel="noopener">Consumer&lt;List&lt;Exception&gt;&gt;</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;unset&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Is called once a transaction successfully finishes with any exception that has happened during the transaction execution.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">serializationFailureSqlState</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>40001</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SQL state value from a <code>SQLException</code> that is considered a serialization failure. This is defined in the SQL:2011 standard as <code>40001</code> but can be different depending on the database.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/array/SqlArrayTypes.html" target="_blank" rel="noopener">SqlArrayTypes</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">argumentStrategy</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/array/SqlArrayArgumentStrategy.html" target="_blank" rel="noopener">SqlArrayArgumentStrategy</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/array/SqlArrayArgumentStrategy.html#SQL_ARRAY" target="_blank" rel="noopener">SQL_ARRAY</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sets the strategy on how to bind arrays in the database driver.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/array/SqlArrayArgumentStrategy.html#SQL_ARRAY" target="_blank" rel="noopener">SQL_ARRAY</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">create a SQL array using <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/Connection.html#createArrayOf-java.lang.String-java.lang.Object:A-" target="_blank" rel="noopener">Connection#createArrayOf</a> and call <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/PreparedStatement.html#setArray-int-java.sql.Array-" target="_blank" rel="noopener">PreparedStatement#setArray</a>. This is the default and any modern JDBC driver should support it.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/array/SqlArrayArgumentStrategy.html#OBJECT_ARRAY" target="_blank" rel="noopener">OBJECT_ARRAY</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">call <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/PreparedStatement.html#setObject-int-java.lang.Object-" target="_blank" rel="noopener">PreparedStatement#setObject</a> and assume that the driver can handle this.</p></td>
</tr>
</tbody>
</table></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="7"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/statement/SqlStatements.html" target="_blank" rel="noopener">SqlStatements</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">attachAllStatementsForCleanup</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Jdbi supports automatic resource management by attaching statements to their handle so that closing the handle will free up all its resources.
If this setting is <code>true</code>, then statements are attached by default.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">attachCallbackStatementsForCleanup</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Similar to <code>attachAllStatementsForCleanup</code> but for statements created in any of the Jdbi callback methods (<a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withHandle(org.jdbi.v3.core.HandleCallback)" target="_blank" rel="noopener">withHandle</a>, <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useHandle(org.jdbi.v3.core.HandleConsumer)" target="_blank" rel="noopener">useHandle</a>, <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#inTransaction(org.jdbi.v3.core.HandleCallback)" target="_blank" rel="noopener">inTransaction</a>, <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useTransaction(org.jdbi.v3.core.HandleConsumer)" target="_blank" rel="noopener">useTransaction</a>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">queryTimeout</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Integer</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;unset&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the query timeout value in seconds. This value is used to call <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/Statement.html#setQueryTimeout-int-" target="_blank" rel="noopener">Statement#setQueryTimeout</a>. Enforcement of the timeout depends on the JDBC driver.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sqlParser</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/statement/SqlParser.html" target="_blank" rel="noopener">SqlParser</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/statement/ColonPrefixSqlParser.html" target="_blank" rel="noopener">ColonPrefixSqlParser</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The parser used to find the placeholders to bind arguments to.</p>
</div>
<div class="paragraph">
<p>Jdbi currently provides the following parsers:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/statement/ColonPrefixSqlParser.html" target="_blank" rel="noopener">ColonPrefixSqlParser</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the default parser for <code>:name</code> placeholders.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/statement/HashPrefixSqlParser.html" target="_blank" rel="noopener">HashPrefixSqlParser</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">use <code>#name</code> placeholders</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Custom implementations must implement <a href="./apidocs/org/jdbi/v3/core/statement/SqlParser.html" target="_blank" rel="noopener">SqlParser</a> and may extend <a href="./apidocs/org/jdbi/v3/core/statement/CachingSqlParser.html" target="_blank" rel="noopener">CachingSqlParser</a> to benefit from caching.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">sqlLogger</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/statement/SqlLogger.html" target="_blank" rel="noopener">SqlLogger</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;unset&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls logging around statement execution. A SqlLogger instance receives the statement context before and after query execution and the context and an exception in case of an execution problem.</p>
<p class="tableblock">Jdbi provides <a href="./apidocs/org/jdbi/v3/core/statement/Slf4jSqlLogger.html" target="_blank" rel="noopener">Slf4jSqlLogger</a> for the popular <a href="https://slf4j.org/" target="_blank" rel="noopener">slf4j</a> logging framework.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">templateEngine</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/statement/TemplateEngine.html" target="_blank" rel="noopener">TemplateEngine</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/statement/DefinedAttributeTemplateEngine.html" target="_blank" rel="noopener">DefineAttributeTemplateEngine</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>The template engine to render SQL statements and substitute placeholders with values that have been defined on a statement (This is for <strong>defined</strong> attributes, not <strong>bound</strong> attributes!).</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jdbi core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/statement/DefinedAttributeTemplateEngine.html" target="_blank" rel="noopener">DefineAttributeTemplateEngine</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">the default engine, replaces angle-bracket placeholders (<code>&lt;name&gt;</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jdbi core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/statement/NoTemplateEngine.html" target="_blank" rel="noopener">NoTemplateEngine</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ignore all defined values, do not do any substitutions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jdbi commons-text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/commonstext/StringSubstitutorTemplateEngine.html" target="_blank" rel="noopener">StringSubstitutorTemplateEngine</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">use the <a href="https://commons.apache.org/proper/commons-text/" target="_blank" rel="noopener">Apache Commons Text</a> <code>StringSubstitutor</code> class</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jdbi freemarker</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/freemarker/FreemarkerEngine.html" target="_blank" rel="noopener">FreemarkerEngine</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">use <a href="https://freemarker.apache.org" target="_blank" rel="noopener">Apache Freemarker</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">jdbi stringtemplate4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/stringtemplate4/StringTemplateEngine.html" target="_blank" rel="noopener">StringTemplateEngine</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">use <a href="https://www.stringtemplate.org/" target="_blank" rel="noopener">StringTemplate 4</a>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Custom implementations must implement <a href="./apidocs/org/jdbi/v3/core/statement/TemplateEngine.html" target="_blank" rel="noopener">TemplateEngine</a>.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">unusedBindingsAllowed</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All bindings to a SQL operation must be used or an exception is thrown. If this setting is <code>true</code>, then unused bindings in a SQL operation are
ignored.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="2"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/statement/StatementExceptions.html" target="_blank" rel="noopener">StatementExceptions</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lengthLimit</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">int</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>1024</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Controls the maximum length for variable length strings when they are rendered using the <code>SHORT_STATEMENT</code> message rendering strategy.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">messageRendering</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/statement/StatementExceptions.MessageRendering.html" target="_blank" rel="noopener">MessageRendering</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/statement/StatementExceptions.MessageRendering.html#SHORT_STATEMENT" target="_blank" rel="noopener">SHORT_STATEMENT</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sets the message rendering strategy when fetching the message from a <a href="./apidocs/org/jdbi/v3/core/statement/StatementException.html" target="_blank" rel="noopener">StatementException</a> and its subclasses.</p>
</div>
<div class="paragraph">
<p>Controls how error messages from a Statement are displayed (e.g. for logging).</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/statement/StatementExceptions.MessageRendering.html#NONE" target="_blank" rel="noopener">NONE</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">only render the statement exception message itself, do not add any information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/statement/StatementExceptions.MessageRendering.html#PARAMETERS" target="_blank" rel="noopener">PARAMETERS</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">include exception message and the bound parameters</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/statement/StatementExceptions.MessageRendering.html#SHORT_STATEMENT" target="_blank" rel="noopener">SHORT_STATEMENT</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">include exception message, SQL statement and the bound parameters. Truncate the SQL statement and the list of parameters each to the value of <code>lengthLimit</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/statement/StatementExceptions.MessageRendering.html#DETAIL" target="_blank" rel="noopener">DETAIL</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">include exception message, unrendered SQL statement, rendered SQL statement, parsed SQL statement and binding parameters.</p></td>
</tr>
</tbody>
</table></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_sqlobject_configuration_settings"><a class="anchor" href="#_sqlobject_configuration_settings"></a><a class="link" href="#_sqlobject_configuration_settings">11.2. SQLObject configuration settings</a></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 18.1818%;">
<col style="width: 18.1818%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 45.4546%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Object</th>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-center valign-top">Type</th>
<th class="tableblock halign-center valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/sqlobject/SqlObjects.html" target="_blank" rel="noopener">SqlObjects</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sqlLocator</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/sqlobject/SqlLocator.html" target="_blank" rel="noopener">SqlLocator</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/sqlobject/AnnotationSqlLocator.html" target="_blank" rel="noopener">AnnotationSqlLocator</a></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sets the locator for finding SQL statements. Default is to look for SQL operation annotations.</p>
</div>
<div class="paragraph">
<p>Jdbi provides two implementations of the <code>SqlLocator</code> interface:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/sqlobject/AnnotationSqlLocator.html" target="_blank" rel="noopener">AnnotationSqlLocator</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use annotations (
<a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlBatch.html" target="_blank" rel="noopener">@SqlBatch</a>,
<a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlCall.html" target="_blank" rel="noopener">@SqlCall</a>,
<a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlQuery.html" target="_blank" rel="noopener">@SqlQuery</a>,
<a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlUpdate.html" target="_blank" rel="noopener">@SqlUpdate</a> and
<a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlScript.html" target="_blank" rel="noopener">@SqlScript</a>) to locate SQL statements</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/sqlobject/SqlObjectClasspathSqlLocator.html" target="_blank" rel="noopener">SqlObjectClasspathSqlLocator</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Associates a class or interface with a file located on the classpath (<code>com.foo.Bar#query()</code> becomes <code>com/foo/Bar/query.sql</code>) and loads the SQL from that file. The file may contain comments which are stripped.</p></td>
</tr>
</tbody>
</table></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/sqlobject/customizer/TimestampedConfig.html" target="_blank" rel="noopener">TimestampedConfig</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timezone</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://docs.oracle.com/javase/8/docs/api/java/time/ZoneId.html" target="_blank" rel="noopener">ZoneId</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">system zone id</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sets the timezone for the <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/Timestamped.html" target="_blank" rel="noopener">@Timestamped</a> annotation.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_other_configuration_settings"><a class="anchor" href="#_other_configuration_settings"></a><a class="link" href="#_other_configuration_settings">11.3. other configuration settings</a></h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 18.1818%;">
<col style="width: 18.1818%;">
<col style="width: 9.0909%;">
<col style="width: 9.0909%;">
<col style="width: 45.4546%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Object</th>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-center valign-top">Type</th>
<th class="tableblock halign-center valign-top">Default</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/json/JsonConfig.html" target="_blank" rel="noopener">JsonConfig</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">jsonMapper</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/json/JsonMapper.html" target="_blank" rel="noopener">JsonMapper</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">see description</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sets the JSON implementation used to serialize and deserialize json columns. Needs to be set when using the generic Json serialization/deserialization mapper. When installing the <code>jdbi3-gson2</code>, <code>jdbi3-jackson2</code> or <code>jdbi3-moshi</code> plugin, this is automatically set to the provided implementation.</p>
</div>
<div class="paragraph">
<p>If none of these modules is loaded, it defaults to an implementation that throws an exception whenever serialization or deserialization is attempted.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/gson2/Gson2Config.html" target="_blank" rel="noopener">Gson2Config</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gson</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://javadoc.io/doc/com.google.code.gson/gson/latest/com.google.gson/com/google/gson/Gson.html" target="_blank" rel="noopener">Gson</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">A <code>Gson</code> instance created with the default constructor.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sets the Gson object used to parse and render json text.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="4"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/jackson2/Jackson2Config.html" target="_blank" rel="noopener">Jackson2Config</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mapper</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://javadoc.io/static/com.fasterxml.jackson.core/jackson-databind/2.10.5.1/com/fasterxml/jackson/databind/ObjectMapper.html" target="_blank" rel="noopener">ObjectMapper</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">An <code>ObjectMapper</code> instance created with the default constructor.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sets the object mapper instance used to parse and render json text.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deserializationView</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Class.html" target="_blank" rel="noopener">Class&lt;?&gt;</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;unset&gt;</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sets a view (see <a href="https://javadoc.io/static/com.fasterxml.jackson.core/jackson-annotations/2.10.5/com/fasterxml/jackson/annotation/JsonView.html" target="_blank" rel="noopener">@JsonView</a>) for deserialization. Can be used to limit the values read when mapping a json column.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">serializationView</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Class.html" target="_blank" rel="noopener">Class&lt;?&gt;</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;unset&gt;</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sets a view (see <a href="https://javadoc.io/static/com.fasterxml.jackson.core/jackson-annotations/2.10.5/com/fasterxml/jackson/annotation/JsonView.html" target="_blank" rel="noopener">@JsonView</a>) for serialization. Can be used to limit the values written when using a json argument.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">view</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Class.html" target="_blank" rel="noopener">Class&lt;?&gt;</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">&lt;unset&gt;</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sets a view (see <a href="https://javadoc.io/static/com.fasterxml.jackson.core/jackson-annotations/2.10.5/com/fasterxml/jackson/annotation/JsonView.html" target="_blank" rel="noopener">@JsonView</a>) for serialization and deserialization. Can be used to limit the values read and written by json arguments and mappers.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/moshi/MoshiConfig.html" target="_blank" rel="noopener">MoshiConfig</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">moshi</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://javadoc.io/doc/com.squareup.moshi/moshi/latest/moshi/com.squareup.moshi/-moshi/index.html" target="_blank" rel="noopener">Moshi</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">A <code>Moshi</code> instance created with the default constructor.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sets the Moshi instance used to parse and render json text.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/freemarker/FreemarkerConfig.html" target="_blank" rel="noopener">FreemarkerConfig</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">freemarkerConfiguration</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><a href="https://javadoc.io/static/org.freemarker/freemarker/2.3.32/freemarker/template/Configuration.html" target="_blank" rel="noopener">Configuration</a></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">The default configuration object.</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Sets the freemarker configuration object for the template engine. See the <a href="https://freemarker.apache.org" target="_blank" rel="noopener">freemarker documentation</a> for details.
The default configuration has the following modifications for Jdbi:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>uses <code>Configuration.DEFAULT_INCOMPATIBLE_IMPROVEMENTS</code></p>
</li>
<li>
<p>configures a class template loader that loads templates from the root of the class path.</p>
</li>
<li>
<p>the number format is set to <code>computer</code>.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/stringtemplate4/StringTemplates.html" target="_blank" rel="noopener">StringTemplates</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">failOnMissingAttribute</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>If <code>true</code>, fail rendering a template if a referenced attribute is missing.</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sql_arrays"><a class="anchor" href="#_sql_arrays"></a><a class="link" href="#_sql_arrays">12. SQL Arrays</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jdbi can bind/map Java arrays to/from SQL arrays:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO groups (id, user_ids) VALUES (:id, :userIds)</span><span class="delimiter">&quot;</span></span>)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">userIds</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="type">int</span><span class="type">[]</span> {<span class="integer">10</span>, <span class="integer">5</span>, <span class="integer">70</span>})
    .execute();

<span class="type">int</span><span class="type">[]</span> userIds = handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT user_ids FROM groups WHERE id = :id</span><span class="delimiter">&quot;</span></span>)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>)
    .mapTo(<span class="type">int</span><span class="type">[]</span>.class)
    .one();</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use Collections in place of arrays, but you&#8217;ll need to provide
the element type if you&#8217;re using the fluent API, since it&#8217;s erased:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO groups (id, user_ids) VALUES (:id, :userIds)</span><span class="delimiter">&quot;</span></span>)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>)
    .bindArray(<span class="string"><span class="delimiter">&quot;</span><span class="content">userIds</span><span class="delimiter">&quot;</span></span>, <span class="type">int</span>.class, <span class="predefined-type">Arrays</span>.asList(<span class="integer">10</span>, <span class="integer">5</span>, <span class="integer">70</span>))
    .execute();

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt; userIds = handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT user_ids FROM groups WHERE id = :id</span><span class="delimiter">&quot;</span></span>)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>)
    .mapTo(<span class="keyword">new</span> GenericType&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt;&gt;() {})
    .one();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use <a href="./apidocs/org/jdbi/v3/sqlobject/SingleValue.html" target="_blank" rel="noopener">@SingleValue</a> for mapping an array result with the SqlObject API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">GroupsDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT user_ids FROM groups WHERE id = ?</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@SingleValue</span>
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt; getUserIds(<span class="type">int</span> groupId);
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_registering_array_types"><a class="anchor" href="#_registering_array_types"></a><a class="link" href="#_registering_array_types">12.1. Registering array types</a></h3>
<div class="paragraph">
<p>Any Java array element type you want binding support for needs to be registered
with Jdbi&#8217;s <code>SqlArrayTypes</code> registry. An array type that is directly supported
by your JDBC driver can be registered using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.registerArrayType(<span class="type">int</span>.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">integer</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, <code>"integer"</code> is the SQL type name that the JDBC driver supports natively.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Plugins like <code>PostgresPlugin</code> and <code>H2DatabasePlugin</code> automatically
register the most common array element types for their respective databases.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Postgres supports enum array types, so you can register an array type for
<code>enum Colors { red, blue }</code> using <code>jdbi.registerArrayType(Colors.class, "colors")</code>
where <code>"colors"</code> is a user-defined enum type name in your database.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_binding_custom_array_types"><a class="anchor" href="#_binding_custom_array_types"></a><a class="link" href="#_binding_custom_array_types">12.2. Binding custom array types</a></h3>
<div class="paragraph">
<p>You can also provide your own implementation of <code>SqlArrayType</code> that converts
a custom Java element type to a type supported by the JDBC driver:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">UserArrayType</span> <span class="directive">implements</span> SqlArrayType&lt;User&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getTypeName() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">integer</span><span class="delimiter">&quot;</span></span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Object</span> convertArrayElement(User user) {
        <span class="keyword">return</span> user.getId();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now bind instances of <code>User[]</code> to arguments of data type <code>integer[]</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">User user1 = <span class="keyword">new</span> User(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">bob</span><span class="delimiter">&quot;</span></span>);
User user2 = <span class="keyword">new</span> User(<span class="integer">42</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">alice</span><span class="delimiter">&quot;</span></span>);

handle.registerArrayType(<span class="keyword">new</span> UserArrayType());
handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO groups (id, user_ids) VALUES (:id, :users)</span><span class="delimiter">&quot;</span></span>)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> User<span class="type">[]</span> {user1, user2})
    .execute();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Like the <a href="#_the_arguments_registry">Arguments Registry</a>, if there are multiple <code>SqlArrayType</code> s
registered for the same data type, the last registered wins.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_mapping_array_types"><a class="anchor" href="#_mapping_array_types"></a><a class="link" href="#_mapping_array_types">12.3. Mapping array types</a></h3>
<div class="paragraph">
<p><code>SqlArrayType</code> only allows you to bind Java array/collection arguments to their
SQL counterparts. To map SQL array columns back to Java types, you can register
a regular <a href="./apidocs/org/jdbi/v3/core/mapper/ColumnMapper.html" target="_blank" rel="noopener">ColumnMapper</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">UserIdColumnMapper</span> <span class="directive">implements</span> ColumnMapper&lt;UserId&gt; {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> UserId map(<span class="predefined-type">ResultSet</span> rs, <span class="type">int</span> col, StatementContext ctx) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        <span class="keyword">return</span> <span class="keyword">new</span> UserId(rs.getInt(col));
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.registerColumnMapper(<span class="keyword">new</span> UserIdColumnMapper());
<span class="predefined-type">List</span>&lt;UserId&gt; userIds = handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT user_ids FROM groups WHERE id = :id</span><span class="delimiter">&quot;</span></span>)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>)
    .mapTo(<span class="keyword">new</span> GenericType&lt;<span class="predefined-type">List</span>&lt;UserId&gt;&gt;() {})
    .one();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Array columns can be mapped to any container type registered with the
<a href="./apidocs/org/jdbi/v3/core/collector/JdbiCollectors.html" target="_blank" rel="noopener">JdbiCollectors</a> registry. E.g. a <code>VARCHAR[]</code> may be mapped to an
<code>ImmutableList&lt;String&gt;</code> if the Guava plugin is installed.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sql-objects"><a class="anchor" href="#sql-objects"></a><a class="link" href="#sql-objects">13. SQL Objects</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>SQL Objects are a declarative-style extension to the fluent-style, programmatic Core APIs. SQL Objects are implemented as an extension to the core API using the
<a href="#extension-framework">Extension framework</a>.</p>
</div>
<div class="paragraph">
<p>To start using the SQL Object plugin, add a dependency to your project:</p>
</div>
<div class="paragraph">
<p>For Apache Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>jdbi3-sqlobject<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>3.41.3-SNAPSHOT<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For Gradle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
    implementation(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jdbi:jdbi3-sqlobject:3.41.3-SNAPSHOT</span><span class="delimiter">&quot;</span></span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then install the plugin into the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Jdbi jdbi = ...
jdbi.installPlugin(<span class="keyword">new</span> SqlObjectPlugin());</code></pre>
</div>
</div>
<div class="paragraph">
<p>With SQL Object, you declare a public interface class as a SQL Object extension type, add methods for database operations, and specify what SQL statement to
execute.</p>
</div>
<div class="paragraph">
<p>You can specify what each method does in one of two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Annotate the method with a SQL method annotation. Jdbi provides a number of these
annotations out of the box.</p>
</li>
<li>
<p>Use Java <em>interface default methods</em>, and provide your own implementation in the method body.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At runtime, you can request an instance of your interface, and Jdbi synthesizes
an implementation based on the annotations and methods you declared.</p>
</div>
<div class="sect2">
<h3 id="_sql_method_annotations"><a class="anchor" href="#_sql_method_annotations"></a><a class="link" href="#_sql_method_annotations">13.1. SQL Method annotations</a></h3>
<div class="paragraph">
<p>Interface methods can be annotated with one of Jdbi&#8217;s SQL method annotations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlQuery.html" target="_blank" rel="noopener">@SqlQuery</a> - select operations that return data</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlUpdate.html" target="_blank" rel="noopener">@SqlUpdate</a> - insert, update, delete etc. operations that modify data</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlBatch.html" target="_blank" rel="noopener">@SqlBatch</a> - bulk operations</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlCall.html" target="_blank" rel="noopener">@SqlCall</a> - call stored procedures</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlScript.html" target="_blank" rel="noopener">@SqlScript</a> - execute multiple statements as a script</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As with any extension type, parameters to the method are used as arguments. For the SQL Object extension, the arguments are passed to the statement, and the SQL statement result is mapped to the method return type.</p>
</div>
<div class="paragraph">
<p>SQL Object provides data mapping onto return types, argument mapping and mapper annotations to allow fully declarative definition of SQL queries.</p>
</div>
<div class="sect3">
<h4 id="_sqlquery"><a class="anchor" href="#_sqlquery"></a><a class="link" href="#_sqlquery">13.1.1. @SqlQuery</a></h4>
<div class="paragraph">
<p>Use the <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlQuery.html" target="_blank" rel="noopener">@SqlQuery</a> annotation for select operations. Each operation may return one or more rows which are mapped onto a return type by the SQL Object extension.</p>
</div>
<div class="paragraph">
<p>This is an example for a simple query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name FROM users</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="predefined-type">List</span>&lt;User&gt; retrieveUsers(); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>defines the SQL query that gets executed</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The method can return any type. The SQL Object framework will map the response from the SQL query onto this data type.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The SQL Object plugin uses the same configuration as the Jdbi core framework. Row and column mappers need to be registered to map to the correct types. This can be done through configuration or by using <a href="#sqlobject-mapper-annotations">Mapper annotations</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_sqlupdate"><a class="anchor" href="#_sqlupdate"></a><a class="link" href="#_sqlupdate">13.1.2. @SqlUpdate</a></h4>
<div class="paragraph">
<p>Use the <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlUpdate.html" target="_blank" rel="noopener">@SqlUpdate</a> annotation for operations that modify data (i.e. inserts, updates, deletes).</p>
</div>
<div class="paragraph">
<p>This is an example that uses <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/PreparedStatement.html" target="_blank" rel="noopener">PreparedStatement</a> placeholders (<code>?</code>) for arguments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name) VALUES (?, ?)</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="type">void</span> insert(<span class="type">long</span> id, <span class="predefined-type">String</span> name); <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Method arguments are bound to the <code>?</code> token in the SQL statement at their respective positions.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>id</code> is bound to the first placeholder (<code>?</code>), and <code>name</code> to the second placeholder.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlUpdate.html" target="_blank" rel="noopener">@SqlUpdate</a> can also be used for DDL (Data Definition Language) operations like creating or altering tables. However, we recommend using a schema migration tool such
as <a href="https://flywaydb.org/" target="_blank" rel="noopener">Flyway</a> or <a href="https://www.liquibase.org/" target="_blank" rel="noopener">Liquibase</a> to maintain your database schemas.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, a <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlUpdate.html" target="_blank" rel="noopener">@SqlUpdate</a> method may declare one of these return types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>void</code> - no return value</p>
</li>
<li>
<p><code>int</code> or <code>long</code> - returns the update count. Depending on the database vendor and JDBC driver, this may be either the number of rows changed, or the number
matched by the query (regardless of whether any data was changed).</p>
</li>
<li>
<p><code>boolean</code> - returns true if the update count is greater than zero.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Some databases also support returning additional values. See the <a href="#sqlupdate-getgeneratedkeys">@GetGeneratedKeys</a> annotation for more details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_sqlbatch"><a class="anchor" href="#_sqlbatch"></a><a class="link" href="#_sqlbatch">13.1.3. @SqlBatch</a></h4>
<div class="paragraph">
<p>Use the <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlBatch.html" target="_blank" rel="noopener">@SqlBatch</a> annotation for bulk update operations. It works similar to the <a href="#_prepared_batches">PreparedBatch</a> operation in the Jdbi core.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ContactDao</span> {
    <span class="annotation">@SqlBatch</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO contacts (id, name, email) VALUES (?, ?, ?)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> bulkInsert(<span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt; ids,  <i class="conum" data-value="1"></i><b>(1)</b>
                    <span class="predefined-type">Iterator</span>&lt;<span class="predefined-type">String</span>&gt; names, <i class="conum" data-value="2"></i><b>(2)</b>
                    <span class="predefined-type">String</span>... emails); <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>a collection argument for the batch operation</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>an iterable argument for the batch operation</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>a varargs argument for the batch operation</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When a batch method is called, it iterates through the method&#8217;s iterable parameters (collections, iterables, varargs etc.), and executes the SQL statement with the corresponding elements from each parameter.</p>
</div>
<div class="paragraph">
<p>Thus, a statement like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">contactDao.bulkInsert(
    ImmutableList.of(<span class="integer">1</span>, <span class="integer">2</span>, <span class="integer">3</span>),
    ImmutableList.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">baz</span><span class="delimiter">&quot;</span></span>).iterator(),
    <span class="string"><span class="delimiter">&quot;</span><span class="content">a@example.com</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">b@example.com</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">c@fake.com</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>would execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">INSERT</span> <span class="class">INTO</span> contacts (id, name, email) <span class="keyword">VALUES</span> (<span class="integer">1</span>, <span class="string"><span class="delimiter">'</span><span class="content">foo</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">a@example.com</span><span class="delimiter">'</span></span>);
<span class="class">INSERT</span> <span class="class">INTO</span> contacts (id, name, email) <span class="keyword">VALUES</span> (<span class="integer">2</span>, <span class="string"><span class="delimiter">'</span><span class="content">bar</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">b@example.com</span><span class="delimiter">'</span></span>);
<span class="class">INSERT</span> <span class="class">INTO</span> contacts (id, name, email) <span class="keyword">VALUES</span> (<span class="integer">3</span>, <span class="string"><span class="delimiter">'</span><span class="content">baz</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">c@fake.com</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Constant values may also be used as parameters to a SQL batch. In this case,
the same value is bound to that parameter for every SQL statement in the batch.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlBatch</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (tenant_id, id, name) </span><span class="delimiter">&quot;</span></span> +
              <span class="string"><span class="delimiter">&quot;</span><span class="content">VALUES (:tenantId, :user.id, :user.name)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> bulkInsert(<span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">tenantId</span><span class="delimiter">&quot;</span></span>) <span class="type">long</span> tenantId, <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="annotation">@BindBean</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>) User... users);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Insert each user record using the same <code>tenant_id</code>. See <a href="#mapping-arguments">SQL Object arguments mapping</a> for details about the @Bind annotation.</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Any method annotated with <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlBatch.html" target="_blank" rel="noopener">@SqlBatch</a> must have at least one iterable parameter.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, methods annotated with <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlBatch.html" target="_blank" rel="noopener">@SqlBatch</a> may declare one of these
return types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>void</code> - no return value</p>
</li>
<li>
<p><code>int[]</code> or <code>long[]</code> - returns the update count per execution in the batch.  Depending on the database vendor and JDBC driver, this may be either the number of
rows changed by a statement, or the number matched by the query (regardless of whether any data was changed).</p>
</li>
<li>
<p><code>boolean[]</code> - returns true if the update count is greater than zero, one value for each execution in the batch.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_sqlcall"><a class="anchor" href="#_sqlcall"></a><a class="link" href="#_sqlcall">13.1.4. @SqlCall</a></h4>
<div class="paragraph">
<p>Use the <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlCall.html" target="_blank" rel="noopener">@SqlCall</a> annotation to call stored procedures.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">AccountDao</span> {
    <span class="annotation">@SqlCall</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">{call suspend_account(:id)}</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> suspendAccount(<span class="type">long</span> id);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlCall.html" target="_blank" rel="noopener">@SqlCall</a> methods can return <code>void</code>, or may return
<a href="./apidocs/org/jdbi/v3/core/statement/OutParameters.html" target="_blank" rel="noopener">OutParameters</a> if the stored procedure has any output parameters. Each output parameter must be registered
with the <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/OutParameter.html" target="_blank" rel="noopener">@OutParameter</a> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">OrderDao</span> {
    <span class="annotation">@SqlCall</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">{call prepare_order_from_cart(:cartId, :orderId, :orderTotal)}</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@OutParameter</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">orderId</span><span class="delimiter">&quot;</span></span>,    sqlType = java.sql.Types.BIGINT)
    <span class="annotation">@OutParameter</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">orderTotal</span><span class="delimiter">&quot;</span></span>, sqlType = java.sql.Types.DECIMAL)
    OutParameters prepareOrderFromCart(<span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">cartId</span><span class="delimiter">&quot;</span></span>) <span class="type">long</span> cartId);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Individual output parameters can be extracted from the
<a href="./apidocs/org/jdbi/v3/core/statement/OutParameters.html" target="_blank" rel="noopener">OutParameters</a> returned from
the method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">OutParameters outParams = orderDao.prepareOrderFromCart(cartId);
<span class="type">long</span> orderId = outParams.getLong(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderId</span><span class="delimiter">&quot;</span></span>);
<span class="type">double</span> orderTotal = outParams.getDouble(<span class="string"><span class="delimiter">&quot;</span><span class="content">orderTotal</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlCall.html" target="_blank" rel="noopener">@SqlCall</a> supports <a href="#sql-call-consumer-arguments">special arguments</a> for <a href="./apidocs/org/jdbi/v3/core/statement/OutParameters.html" target="_blank" rel="noopener">OutParameters</a> processing.</p>
</div>
</div>
<div class="sect3">
<h4 id="_sqlscript"><a class="anchor" href="#_sqlscript"></a><a class="link" href="#_sqlscript">13.1.5. @SqlScript</a></h4>
<div class="paragraph">
<p>Use <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlScript.html" target="_blank" rel="noopener">@SqlScript</a> to execute one or more statements in a batch.</p>
</div>
<div class="paragraph">
<p>While <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlBatch.html" target="_blank" rel="noopener">@SqlBatch</a> executes the same SQL statement with different values, the <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlScript.html" target="_blank" rel="noopener">@SqlScript</a> annotation executes different SQL statements without explicit data bound to each statement.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlScript</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE TABLE &lt;name&gt; (pk int primary key)</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">void</span> createTable(<span class="annotation">@Define</span> <span class="predefined-type">String</span> name); <i class="conum" data-value="2"></i><b>(2)</b>

<span class="annotation">@SqlScript</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO cool_table VALUES (5), (6), (7)</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@SqlScript</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">DELETE FROM cool_table WHERE pk &gt; 5</span><span class="delimiter">&quot;</span></span>)
<span class="type">int</span><span class="type">[]</span> doSomeUpdates(); <span class="comment">// returns [ 3, 2 ]</span>

<span class="annotation">@UseClasspathSqlLocator</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="annotation">@SqlScript</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="annotation">@SqlScript</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">secondScript</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="5"></i><b>(5)</b>
<span class="type">int</span><span class="type">[]</span> externalScript();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sql scripts can use substitute placeholders. The default template engine uses angle brackets (<code>&lt;</code> and <code>&gt;</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/Define.html" target="_blank" rel="noopener">@Define</a> annotation provides values for the placeholder attributes</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="./apidocs/org/jdbi/v3/sqlobject/locator/UseClasspathSqlLocator.html" target="_blank" rel="noopener">@UseClasspathSqlLocator</a> annotation loads SQL templates from the classpath</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Use the name of the annotated method to locate the script</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>specify the script name in the annotation</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, methods annotated with <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlScript.html" target="_blank" rel="noopener">@SqlScript</a> may declare one of these return types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>void</code> - no return value</p>
</li>
<li>
<p><code>int[]</code> or <code>long[]</code> - return value of each statement executed.  Depending on the database vendor and JDBC driver, this may be either the number of rowsreturn
nothing changed by a statement, or the number matched by the query (regardless of whether any data was changed).</p>
</li>
<li>
<p><code>boolean[]</code> - returns true if the update count is greater than zero, one value for each statement in the script.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_sql_objects"><a class="anchor" href="#_using_sql_objects"></a><a class="link" href="#_using_sql_objects">13.2. Using SQL Objects</a></h3>
<div class="paragraph">
<p>SQL Object types are regular Java interfaces classes that must be public. Once they have been defined, there are multiple ways to use them. They differ in the <a href="#extension-handle-lifecycle">lifecycle</a> of the underlying <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> object:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>attached to an existing handle object</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/Handle.html#attach(java.lang.Class)" target="_blank" rel="noopener">Handle#attach()</a> method uses an existing handle to create a SQL object instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (Handle handle = jdbi.open()) {
    ContactPhoneDao dao = handle.attach(ContactPhoneDao.class);
    dao.insertFullContact(contact);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Attached SQL Objects have the same lifecycle as the handle&#8212;&#8203;when the handle is closed, the SQL Object becomes unusable.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>using Jdbi extension methods</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>SQL Object types can be created using
<a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withExtension-java.lang.Class-org.jdbi.v3.core.extension.ExtensionCallback-" target="_blank" rel="noopener">Jdbi#withExtension()</a>
for operations that return a result, or
<a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useExtension-java.lang.Class-org.jdbi.v3.core.extension.ExtensionConsumer-" target="_blank" rel="noopener">Jdbi#useExtension()</a>
for operations with no result. These methods take a callback (or a lambda object) and provide it with a managed instance of the SQL object type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.useExtension(ContactPhoneDao.class, dao -&gt; dao.insertFullContact(alice));
<span class="type">long</span> bobId = jdbi.withExtension(ContactPhoneDao.class, dao -&gt; dao.insertFullContact(bob));</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>creating an on-demand object</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On-demand instances are constructed with the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#onDemand(java.lang.Class)" target="_blank" rel="noopener">Jdbi#onDemand()</a> method. They have an open-ended lifecycle, as they obtain and release a connection for each method call. They are thread-safe, and may be reused across an application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ContactPhoneDao dao = jdbi.onDemand(ContactPhoneDao.class);
<span class="type">long</span> aliceId = dao.insertFullContact(alice); <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">long</span> bobId = dao.insertFullContact(bob); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>each of these operations creates and releases a new database connection.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The performance of on-demand objects depends on the database and database connection pooling. For performance critical operations, it may be better to manage the handle manually and use attached objects.</p>
</div>
<div class="sect3">
<h4 id="_interface_default_methods"><a class="anchor" href="#_interface_default_methods"></a><a class="link" href="#_interface_default_methods">13.2.1. Interface default methods</a></h4>
<div class="paragraph">
<p><em>Interface default methods</em> on a SQL object type can provide custom code functionality that uses the same handle as the SQL Object methods.</p>
</div>
<div class="paragraph">
<p>The SQL object framework manages the underlying handle so that calling a method on the same object on the same thread will use the same <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> object. If the handle is managed by the framework, it will only be closed when the outermost method exits.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="type">void</span> testDefaultMethod() {
    UserDao dao = jdbi.onDemand(UserDao.class);

    assertThat(dao.findUser(<span class="integer">1</span>))
            .isPresent()
            .contains(<span class="keyword">new</span> User(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>));

    dao.changeName(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Alex</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="1"></i><b>(1)</b>

    assertThat(dao.findUser(<span class="integer">1</span>))
            .isPresent()
            .contains(<span class="keyword">new</span> User(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Alex</span><span class="delimiter">&quot;</span></span>));
}

<span class="type">interface</span> <span class="class">UserDao</span> {

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users WHERE id = :id</span><span class="delimiter">&quot;</span></span>)
    Optional&lt;User&gt; findUser(<span class="type">int</span> id);

    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">UPDATE users SET name = :name WHERE id = :user.id</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> updateUser(<span class="annotation">@BindMethods</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>) User user, <span class="predefined-type">String</span> name);

    <span class="keyword">default</span> <span class="type">void</span> changeName(<span class="type">int</span> id, <span class="predefined-type">String</span> name) {
        findUser(id).ifPresent(user -&gt; updateUser(user, name));  <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>changeName()</code> method is called by the user code</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The implementation will call both <code>findUser()</code> and <code>updateUser()</code> with the same handle object.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sql_object_method_arguments"><a class="anchor" href="#_sql_object_method_arguments"></a><a class="link" href="#_sql_object_method_arguments">13.3. SQL Object method arguments</a></h3>
<div class="paragraph">
<p>All SQL Object methods support method arguments. Method arguments are mapped onto SQL statement parameters.</p>
</div>
<div class="sect3">
<h4 id="_mapping_arguments_to_positional_parameters"><a class="anchor" href="#_mapping_arguments_to_positional_parameters"></a><a class="link" href="#_mapping_arguments_to_positional_parameters">13.3.1. Mapping arguments to positional parameters</a></h4>
<div class="paragraph">
<p>By default, arguments passed to the method are bound as positional parameters in the SQL statement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name) VALUES (?, ?)</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="type">void</span> insert(<span class="type">long</span> id, <span class="predefined-type">String</span> name); <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>declares two positional parameters</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>provides two method parameters. <code>id</code> will be bound as the first, <code>name</code> as the second parameter.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This matches the <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/PreparedStatement.html" target="_blank" rel="noopener">PreparedStatement</a> way of binding arguments to a statement. Jdbi binds the arguments as the correct types and convert them if necessary.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-arguments"><a class="anchor" href="#mapping-arguments"></a><a class="link" href="#mapping-arguments">13.3.2. Mapping arguments to named parameters</a></h4>
<div class="paragraph">
<p>The Jdbi core supports named parameters in SQL statements. When using the SQL Object extension, those can be bound to specific method arguments using annotations.</p>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/Bind.html" target="_blank" rel="noopener">@Bind</a> annotation binds a single method argument to a named parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">void</span> insert(<span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> name, <span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="type">long</span> id); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The SQL statement uses two named parameters, <code>:id</code> and <code>:name</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The method declaration annotates each parameter with the <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/Bind.html" target="_blank" rel="noopener">@Bind</a> annotation with matching names. The order is not important as each method parameter is explicitly named</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Similar to the methods on the <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a>, arguments can be bound in many different ways:</p>
</div>
<div class="sect4">
<h5 id="_bind_any_iterable_object_with_bindlist"><a class="anchor" href="#_bind_any_iterable_object_with_bindlist"></a><a class="link" href="#_bind_any_iterable_object_with_bindlist">Bind any iterable object with @BindList</a></h5>
<div class="paragraph">
<p>Any Java object that implements the Iterable interface can be bound using the <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindList.html" target="_blank" rel="noopener">@BindList</a> annotation. This
will iterate the elements in 'a,b,c,d,&#8230;&#8203;' form.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This annotation requires you to use a template placeholder (using the <code>&lt;field&gt;</code> notation when using the default template engine), similar to the <a href="./apidocs/org/jdbi/v3/core/statement/SqlStatement.html#bindList(java.lang.String,java.lang.Iterable)" target="_blank" rel="noopener">SqlStatement#bindList()</a> method. Templates placeholders are incompatible with batch operations such as`PreparedBatch` as they are evaluated only once and the evaluated statement is cached. If subsequent batch executions use an iterable object with a different size, the number of placeholders and arguments will not match. If the database supports array types, it is strongly recommended to use <code>bindArray()</code> with a SQL array instead of the <code>bindList()</code> method.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT name FROM users WHERE id in (&lt;userIds&gt;)</span><span class="delimiter">&quot;</span></span>)
<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getFromIds(<span class="annotation">@BindList</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">userIds</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">List</span>&lt;<span class="predefined-type">Long</span>&gt; userIds)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_bind_map_instances_with_bindmap"><a class="anchor" href="#_bind_map_instances_with_bindmap"></a><a class="link" href="#_bind_map_instances_with_bindmap">Bind map instances with @BindMap</a></h5>
<div class="paragraph">
<p>Entries from a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html" target="_blank" rel="noopener">Map</a> can be bound using the <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindMap.html" target="_blank" rel="noopener">@BindMap</a> annotation. Each entry from the map is bound as a named parameter using the map key as the name and the map value as the value. Jdbi will bind the values as the correct types and convert them if necessary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">void</span> insert(<span class="annotation">@BindMap</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ?&gt; map); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The SQL statement expects two named parameters, <code>:id</code> and <code>:name</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Jdbi will look for two keys, <code>id</code> and a <code>name</code> in the map. The values for these keys are bound to the parameters.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_bind_bean_getters_with_bindbean"><a class="anchor" href="#_bind_bean_getters_with_bindbean"></a><a class="link" href="#_bind_bean_getters_with_bindbean">Bind bean getters with @BindBean</a></h5>
<div class="paragraph">
<p>Java Bean getters can be bound with the <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindBean.html" target="_blank" rel="noopener">@BindBean</a> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="type">class</span> <span class="class">UserBean</span> {

    <span class="directive">private</span> <span class="type">int</span> id;
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="directive">public</span> UserBean() {}

    <span class="directive">public</span> <span class="type">void</span> setId(<span class="type">int</span> id) {
        <span class="local-variable">this</span>.id = id;
    }

    <span class="directive">public</span> <span class="type">void</span> setName(<span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.name = name;
    }

    <span class="directive">public</span> <span class="type">int</span> getId() {
        <span class="keyword">return</span> id;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
        <span class="keyword">return</span> name;
    }
}

    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> insertUserBean(<span class="annotation">@BindBean</span> UserBean user);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This annotation uses the Java Bean syntax for getters.</p>
</div>
</div>
<div class="sect4">
<h5 id="_bind_parameterless_public_methods_with_bindmethods"><a class="anchor" href="#_bind_parameterless_public_methods_with_bindmethods"></a><a class="link" href="#_bind_parameterless_public_methods_with_bindmethods">Bind parameterless public methods with @BindMethods</a></h5>
<div class="paragraph">
<p>Similar to <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindBean.html" target="_blank" rel="noopener">@BindBean</a>, the <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindMethods.html" target="_blank" rel="noopener">@BindMethods</a> annotation bean methods as parameters. For each binding, it looks for a method with the same name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="type">class</span> <span class="class">User</span> {

    <span class="directive">private</span> <span class="directive">final</span> <span class="type">int</span> id;
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> name;

    <span class="directive">public</span> User(<span class="type">int</span> id, <span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.id = id;
        <span class="local-variable">this</span>.name = name;
    }

    <span class="directive">public</span> <span class="type">int</span> id() {
        <span class="keyword">return</span> id;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> name() {
        <span class="keyword">return</span> name;
    }
}

    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> insertUser(<span class="annotation">@BindMethods</span> User user);</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When using <a href="https://docs.oracle.com/en/java/javase/14/language/records.html" target="_blank" rel="noopener">Java 14+ record types</a>, all getters from the record can be bound using the <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindMethods.html" target="_blank" rel="noopener">@BindMethods</a> annotation.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_bind_public_fields_from_a_java_object_with_bindfields"><a class="anchor" href="#_bind_public_fields_from_a_java_object_with_bindfields"></a><a class="link" href="#_bind_public_fields_from_a_java_object_with_bindfields">Bind public fields from a java object with @BindFields</a></h5>
<div class="paragraph">
<p>Many objects offer public fields instead of getters. Those can be bound by using the <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindFields.html" target="_blank" rel="noopener">@BindFields</a> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="type">class</span> <span class="class">UserField</span> {

    <span class="directive">public</span> <span class="type">int</span> id;
    <span class="directive">public</span> <span class="predefined-type">String</span> name;
}

    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> insertUserField(<span class="annotation">@BindFields</span> UserField user);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_using_object_prefixes"><a class="anchor" href="#_using_object_prefixes"></a><a class="link" href="#_using_object_prefixes">Using object prefixes</a></h5>
<div class="paragraph">
<p>The `<a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindMap.html" target="_blank" rel="noopener">@BindMap</a>, <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindBean.html" target="_blank" rel="noopener">@BindBean</a>, <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindMethods.html" target="_blank" rel="noopener">@BindMethods</a>, and <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindFields.html" target="_blank" rel="noopener">@BindFields</a> annotations support an optional prefix:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name) VALUES (:user.id, :user.name)</span><span class="delimiter">&quot;</span></span>)
<i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">void</span> insertUserBeanPrefix(<span class="annotation">@BindBean</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>) UserBean user); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>id</code> and <code>name</code> parameters are prefixed with <code>user</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>User</code> object which provides the values uses a prefix. The <code>user.id</code> parameter will be mapped to the <code>getId()</code> method of this bean and the <code>user.name</code> parameter to the <code>getName()</code> method.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By providing prefixes, it is possible to use multiple objects with different prefixes or mix map and regular bound parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name, password) VALUES (:user.id, :user.name, :password)</span><span class="delimiter">&quot;</span></span>)
<span class="type">void</span> insert(<span class="annotation">@BindMap</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, ?&gt; map, <span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> password);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Even if the provided map would contain a key named <code>password</code>, it would not be used, because all values from the map are bound with the <code>user</code> prefix.</p>
</div>
</div>
<div class="sect4">
<h5 id="_using_nested_properties"><a class="anchor" href="#_using_nested_properties"></a><a class="link" href="#_using_nested_properties">Using nested properties</a></h5>
<div class="paragraph">
<p>Similar to the Core API, the  <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindBean.html" target="_blank" rel="noopener">@BindBean</a>, <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindFields.html" target="_blank" rel="noopener">@BindFields</a>, and <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindMethods.html" target="_blank" rel="noopener">@BindMethods</a> annotation will also map nested properties.</p>
</div>
<div class="paragraph">
<p>A Java object that returns a nested object can be bound and then nested properties are addressed using e.g. <code>:user.address.street</code>.</p>
</div>
<div class="paragraph">
<p>This functionality is <strong>not</strong> available for Map objects that have been bound with <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindMap.html" target="_blank" rel="noopener">@BindMap</a>. Map keys must match the bound parameter name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="type">class</span> <span class="class">NestedUser</span> {

    <span class="directive">private</span> <span class="directive">final</span> User user;
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> tag;

    <span class="directive">public</span> NestedUser(User user, <span class="predefined-type">String</span> tag) {
        <span class="local-variable">this</span>.user = user;
        <span class="local-variable">this</span>.tag = tag;
    }

    <span class="directive">public</span> User user() {
        <span class="keyword">return</span> user;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> tag() {
        <span class="keyword">return</span> tag;
    }
}

    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name) VALUES (:user.id, :user.name)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> insertUser(<span class="annotation">@BindMethods</span> NestedUser user);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
"Mixes style" nested properties are not supported. Any nested object will be inspected in the same way as the root object. All nested objects must use either bean-style, methods or fields.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mapping_arguments_to_java_parameter_names"><a class="anchor" href="#_mapping_arguments_to_java_parameter_names"></a><a class="link" href="#_mapping_arguments_to_java_parameter_names">13.3.3. Mapping arguments to Java parameter names</a></h4>
<div class="paragraph">
<p>When compiling a project with <a href="#compiling_with_parameter_names">parameter names</a> enabled, the <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/Bind.html" target="_blank" rel="noopener">@Bind</a> annotation is not needed. SQLObjects will bind un-annotated parameters to their names.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
<span class="type">void</span> insert(<span class="type">long</span> id, <span class="predefined-type">String</span> name);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_consumer_arguments"><a class="anchor" href="#_consumer_arguments"></a><a class="link" href="#_consumer_arguments">13.3.4. Consumer arguments</a></h4>
<div class="paragraph">
<p>In addition to the regular method arguments for a SQL Object method, it is possible to use a single <a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Consumer.html" target="_blank" rel="noopener">Consumer&lt;T&gt;</a> argument in addition to other arguments.</p>
</div>
<div class="paragraph">
<p>Consumer arguments are actually a special return type for SQL operations. They can be used to consume the results from a SQL operation with a callback instead of returning a value from the method.</p>
</div>
<div class="paragraph">
<p>Any SQL operation method that wants to use a consumer argument <strong>must</strong> return <code>void</code>. It can declare only a single consumer argument, but can have additional regular method arguments. The consumer argument can be in any position in the argument list. .</p>
</div>
<div class="paragraph">
<p>Unless the type <code>T</code> is a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html" target="_blank" rel="noopener">Stream</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Iterator.html" target="_blank" rel="noopener">Iterator</a> or <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Iterable.html" target="_blank" rel="noopener">Iterable</a>, the consumer is executed once for each row in the result set. The static type of parameter <code>T</code> determines the row type.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users WHERE id = :id</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@RegisterConstructorMapper</span>(User.class)
<span class="type">void</span> consumeUser(<span class="type">int</span> id, Consumer&lt;User&gt; consumer); <i class="conum" data-value="1"></i><b>(1)</b>

<span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@RegisterConstructorMapper</span>(User.class)
<span class="type">void</span> consumeMultiUsers(Consumer&lt;User&gt; consumer); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This SQL operation may return no or just one result. The consumer argument will only be invoked if a user exists.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This SQL operation may return multiple results. It will invoke the consumer argument once for every result.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the consumer implements <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html" target="_blank" rel="noopener">Stream</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Iterator.html" target="_blank" rel="noopener">Iterator</a> or <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Iterable.html" target="_blank" rel="noopener">Iterable</a>, then the consumer is executed once with the corresponding object holding the results. The static type of parameter <code>T</code> determines the mapped row type here as well. If the result set is empty, the SQL Object framework may not call the consumer or may call it with an empty result object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@RegisterConstructorMapper</span>(User.class)
<span class="type">void</span> consumeMultiUserIterable(Consumer&lt;<span class="predefined-type">Iterable</span>&lt;User&gt;&gt; consumer); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This consumer argument is called once if any number of results are present. It may be called with an empty iterable object or not at all if no results are present.</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
When using <a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Consumer.html" target="_blank" rel="noopener">Consumer&lt;Iterable&gt;</a> as a consumer argument, the <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Iterable.html" target="_blank" rel="noopener">Iterable</a> object passed into the consumer is <strong>NOT</strong> a general-purpose Iterable as it supports only a single invocation of the <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Iterable.html#iterator--" target="_blank" rel="noopener">Iterable#iterator()</a> method. Invoking it the iterator method again to obtain a second or subsequent iterator may throw <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/IllegalStateException.html" target="_blank" rel="noopener">IllegalStateException</a>.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="sql-call-consumer-arguments"><a class="anchor" href="#sql-call-consumer-arguments"></a><a class="link" href="#sql-call-consumer-arguments"><code>@SqlCall</code> Consumer and Function arguments</a></h5>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlCall.html" target="_blank" rel="noopener">@SqlCall</a> annotation supports either a Consumer argument or a Function argument for the <a href="./apidocs/org/jdbi/v3/core/statement/OutParameters.html" target="_blank" rel="noopener">OutParameters</a> return value.</p>
</div>
<div class="paragraph">
<p>A method that has been annotated with <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlCall.html" target="_blank" rel="noopener">@SqlCall</a> may have any number of regular method arguments and</p>
</div>
<div class="ulist">
<ul>
<li>
<p>declare <code>void</code> or <a href="./apidocs/org/jdbi/v3/core/statement/OutParameters.html" target="_blank" rel="noopener">OutParameters</a> as its return type.</p>
</li>
<li>
<p>declare <code>void</code> as its return type and have a single <a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Consumer.html" target="_blank" rel="noopener">Consumer&lt;OutParameters&gt;</a> consumer argument</p>
</li>
<li>
<p>declare an arbitrary type <code>T</code> as return type and have a single <a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Function.html" target="_blank" rel="noopener">Function&lt;OutParameters, T&gt;</a> function argument</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When using a consumer or function argument, these are called to process the <a href="./apidocs/org/jdbi/v3/core/statement/OutParameters.html" target="_blank" rel="noopener">OutParameters</a> value before the statement is closed.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mapping_arguments_to_defined_attributes"><a class="anchor" href="#_mapping_arguments_to_defined_attributes"></a><a class="link" href="#_mapping_arguments_to_defined_attributes">13.3.5. Mapping arguments to defined attributes</a></h4>
<div class="paragraph">
<p>The Jdbi core framework supports attributes that can be used anywhere in the SQL statement or that can control <a href="#query-templating">Query template rendering</a>. The <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/Define.html" target="_blank" rel="noopener">@Define</a> annotation provides this functionality for the SQL Object extension:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">UserDao</span> {

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT name FROM &lt;table&gt;</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getNames(<span class="annotation">@Define</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">table</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> tableName); <i class="conum" data-value="2"></i><b>(2)</b>
}

<span class="annotation">@Test</span>
<span class="type">void</span> testNames() {
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; result = jdbi.withExtension(UserDao.class, dao -&gt; dao.getNames(<span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span>)); <i class="conum" data-value="3"></i><b>(3)</b>
    assertThat(result).containsAll(names);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>declare an attribute placeholder for the table name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>bind the placeholder to the method argument</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>provide the value for the placeholder when calling the SQL object method</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sql_object_method_return_values"><a class="anchor" href="#_sql_object_method_return_values"></a><a class="link" href="#_sql_object_method_return_values">13.4. SQL Object method return values</a></h3>
<div class="paragraph">
<p>The SQL Object framework will try to convert the result of a database operation to the declared return value of a SQL Object method.</p>
</div>
<div class="paragraph">
<p>This is most important for <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlQuery.html" target="_blank" rel="noopener">@SqlQuery</a> operations as most other operations have a very limited set of possible return values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlUpdate.html" target="_blank" rel="noopener">@SqlUpdate</a> - supports <code>void</code>, <code>int</code>, <code>long</code>, <code>boolean</code></p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlBatch.html" target="_blank" rel="noopener">@SqlBatch</a> -  supports <code>void</code>, <code>int[]</code>, <code>long[]</code>, <code>boolean[]</code></p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlScript.html" target="_blank" rel="noopener">@SqlScript</a> - supports <code>void</code>, <code>int[]</code>, <code>long[]</code>, <code>boolean[]</code></p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlCall.html" target="_blank" rel="noopener">@SqlCall</a> - supports <code>void</code>, <a href="./apidocs/org/jdbi/v3/core/statement/OutParameters.html" target="_blank" rel="noopener">OutParameters</a> (and function arguments)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Query methods may return a single row or multiple rows, depending on whether the method return type looks like a collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT name FROM users</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; listNames(); <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT name FROM users WHERE id = ?</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">String</span> getName(<span class="type">long</span> id); <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT name FROM users WHERE id = ?</span><span class="delimiter">&quot;</span></span>)
    Optional&lt;<span class="predefined-type">String</span>&gt; findName(<span class="type">long</span> id); <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name FROM users WHERE id = ?</span><span class="delimiter">&quot;</span></span>)
    Optional&lt;User&gt; findUser(<span class="type">long</span> id); <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Returns a collection of results. This is never null, an empty collection is returned for an empty result set.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Returns a single result. If the query returns a result set with multiple rows, then only the first row is returned. If the row set is empty, <code>null</code> is returned.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Methods may return <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html" target="_blank" rel="noopener">Optional</a> values. If the query returns no rows (or if the value in the row is <code>null</code>),
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html#empty--" target="_blank" rel="noopener">Optional.empty()</a> is returned instead of <code>null</code>.  SQL Object throws an exception if query returns more than one
row.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>When returning a complex type, Jdbi must have row and column mappers registered, otherwise it will throw an exception. These can be registered through the Jdbi
core API or with annotations.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Jdbi can use different collection types by registering a <a href="./apidocs/org/jdbi/v3/core/collector/CollectorFactory.html" target="_blank" rel="noopener">CollectorFactory</a> with the <a href="./apidocs/org/jdbi/v3/core/collector/JdbiCollectors.html" target="_blank" rel="noopener">JdbiCollectors</a>
config registry.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See
<a href="./apidocs/org/jdbi/v3/core/collector/BuiltInCollectorFactory.html" target="_blank" rel="noopener">BuiltInCollectorFactory</a>
for the complete list of collection types supported out of the box. Some
Jdbi plugins (e.g. the <a href="./apidocs/org/jdbi/v3/guava/GuavaPlugin.html" target="_blank" rel="noopener">GuavaPlugin</a>) register additional collection types.</p>
</div>
<div class="sect3">
<h4 id="using-steams-and-iterators"><a class="anchor" href="#using-steams-and-iterators"></a><a class="link" href="#using-steams-and-iterators">13.4.1. Using Streams and Iterators</a></h4>
<div class="paragraph">
<p>SQL Object method may return
<a href="./apidocs/org/jdbi/v3/core/result/ResultIterable.html" target="_blank" rel="noopener">ResultIterable</a>,
<a href="./apidocs/org/jdbi/v3/core/result/ResultIterator.html" target="_blank" rel="noopener">ResultIterator</a> or
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html" target="_blank" rel="noopener">Stream</a> types. Each of these return values represents a cursor-type object that requires an active <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> object with a database connection <a href="#resources-with-streams-iterators">to support streaming results</a>.</p>
</div>
<div class="paragraph">
<p>All SQL object type methods are subject to the <a href="#extension-handle-lifecycle">extension framework Handle lifecycle</a>. When the <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> object is closed, the database connection and the corresponding stream or iterator is closed as well.</p>
</div>
<div class="paragraph">
<p>This is an example of a SQL Object type that returns cursor types:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT name FROM users</span><span class="delimiter">&quot;</span></span>)
    Stream&lt;<span class="predefined-type">String</span>&gt; getNamesAsStream();

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT name FROM users</span><span class="delimiter">&quot;</span></span>)
    ResultIterable&lt;<span class="predefined-type">String</span>&gt; getNamesAsIterable();

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT name FROM users</span><span class="delimiter">&quot;</span></span>)
    ResultIterator&lt;<span class="predefined-type">String</span>&gt; getNamesAsIterator();
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_use_the_method_return_value_directly"><a class="anchor" href="#_use_the_method_return_value_directly"></a><a class="link" href="#_use_the_method_return_value_directly">Use the method return value directly</a></h5>
<div class="paragraph">
<p>Only the <a href="./apidocs/org/jdbi/v3/core/Handle.html#attach(java.lang.Class)" target="_blank" rel="noopener">Handle#attach()</a> method allows cursor type objects as SQL Object method return values. Calling this method attaches the object to the Handle lifecycle which in turn is managed by user code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="type">void</span> testHandleAttach() {
    <span class="keyword">try</span> (Handle handle = jdbi.open()) { <i class="conum" data-value="1"></i><b>(1)</b>
        UserDao dao = handle.attach(UserDao.class);
        <span class="keyword">try</span> (Stream&lt;<span class="predefined-type">String</span>&gt; stream = dao.getNamesAsStream()) { <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; result = stream.collect(Collectors.toList()); <i class="conum" data-value="3"></i><b>(3)</b>
            assertThat(result).containsAll(names);
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The handle is managed in user code.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The stream is also managed.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The returned stream is used within the <em>try-with-resources</em> block.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The objects returned from these methods hold database resources that should be closed. <a href="#statement-resource-management">Jdbi usually handles resources well</a> but using a <em>try-with-resource</em> block is a good practice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (ResultIterable&lt;<span class="predefined-type">String</span>&gt; names = dao.getNamesAsIterable()) {
    <span class="comment">// ...</span>
}

<span class="keyword">try</span> (ResultIterator&lt;<span class="predefined-type">String</span>&gt; names = dao.getNamesAsIterator()) {
    <span class="comment">// ...</span>
}

<span class="keyword">try</span> (Stream&lt;<span class="predefined-type">String</span>&gt; names = dao.getNamesAsStream()) {
    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withExtension-java.lang.Class-org.jdbi.v3.core.extension.ExtensionCallback-" target="_blank" rel="noopener">Jdbi#withExtension()</a> or <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useExtension-java.lang.Class-org.jdbi.v3.core.extension.ExtensionConsumer-" target="_blank" rel="noopener">Jdbi#useExtension()</a> methods <strong>can not be used</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="type">void</span> testWithExtensionFails() {
    assertThatThrownBy(() -&gt; {
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; result = jdbi.withExtension(UserDao.class, UserDao::getNamesAsStream).collect(Collectors.toList()); <i class="conum" data-value="1"></i><b>(1)</b>
        assertThat(result).containsAll(names);
    }).isInstanceOf(ResultSetException.class); <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The handle is closed when leaving the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withExtension-java.lang.Class-org.jdbi.v3.core.extension.ExtensionCallback-" target="_blank" rel="noopener">Jdbi#withExtension()</a> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Calling the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#collect-java.util.stream.Collector-" target="_blank" rel="noopener">Stream#collect()</a> method on the returned stream causes a <a href="./apidocs/org/jdbi/v3/core/result/ResultSetException.html" target="_blank" rel="noopener">ResultSetException</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#onDemand(java.lang.Class)" target="_blank" rel="noopener">Jdbi#onDemand()</a> method <strong>can not be used either</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="type">void</span> testOnDemandFails() {
    assertThatThrownBy(() -&gt; {
        UserDao dao = jdbi.onDemand(UserDao.class);
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; result = dao.getNamesAsStream().collect(Collectors.toList()); <i class="conum" data-value="1"></i><b>(1)</b>
        assertThat(result).containsAll(names);
    }).isInstanceOf(ResultSetException.class); <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The handle is closed when leaving the <code>getNamesAsStream</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Calling the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#collect-java.util.stream.Collector-" target="_blank" rel="noopener">Stream#collect()</a> method on the returned stream causes a <a href="./apidocs/org/jdbi/v3/core/result/ResultSetException.html" target="_blank" rel="noopener">ResultSetException</a>.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_use_interface_default_methods"><a class="anchor" href="#_use_interface_default_methods"></a><a class="link" href="#_use_interface_default_methods">Use interface default methods</a></h5>
<div class="paragraph">
<p>The SQL Object framework closes the <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> object when returning from the outermost method in a SQL object type. It is possible to write processing logic in an <em>interface default method</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT name FROM users</span><span class="delimiter">&quot;</span></span>)
    Stream&lt;<span class="predefined-type">String</span>&gt; getNamesAsStream();

    <span class="keyword">default</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getNames() {  <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="keyword">try</span> (Stream&lt;<span class="predefined-type">String</span>&gt; stream = getNamesAsStream()) { <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="keyword">return</span> stream.collect(Collectors.toList()); <i class="conum" data-value="3"></i><b>(3)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The handle is closed when exiting the <code>getNames</code> method as this is the outermost method in the UserDao object.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The stream is managed with a <em>try-with-resources</em> block.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The stream can be processed within the <code>getNames</code> method.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The default method can be used with the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#onDemand(java.lang.Class)" target="_blank" rel="noopener">Jdbi#onDemand()</a>, <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withExtension-java.lang.Class-org.jdbi.v3.core.extension.ExtensionCallback-" target="_blank" rel="noopener">Jdbi#withExtension()</a> and <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useExtension-java.lang.Class-org.jdbi.v3.core.extension.ExtensionConsumer-" target="_blank" rel="noopener">Jdbi#useExtension()</a> methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="type">void</span> testOnDemandDefaultMethod() {
    UserDao dao = jdbi.onDemand(UserDao.class);
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; result = dao.getNames();
    assertThat(result).containsAll(names);
}

<span class="annotation">@Test</span>
<span class="type">void</span> testWithExtensionDefaultMethod() {
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; result = jdbi.withExtension(UserDao.class, UserDao::getNames);
    assertThat(result).containsAll(names);
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_use_consumer_arguments"><a class="anchor" href="#_use_consumer_arguments"></a><a class="link" href="#_use_consumer_arguments">Use consumer arguments</a></h5>
<div class="paragraph">
<p>Using the method return value either directly or through an <em>interface default method</em> has the drawback that the user code to process the cursor-type object must be written within the SQL Object type as it must be executed before closing the <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> object.</p>
</div>
<div class="paragraph">
<p>An elegant way to sidestep this problem is using a <a href="#_consumer_arguments">consumer argument</a> to provide a callback:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">CallbackDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT name FROM users</span><span class="delimiter">&quot;</span></span>)
     <span class="type">void</span> getNamesAsStream(Consumer&lt;Stream&lt;<span class="predefined-type">String</span>&gt;&gt; consumer);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using a callback argument supports all <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> and <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> methods to attach SQL objects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="type">void</span> testHandleAttachCallback() {
    <span class="keyword">try</span> (Handle handle = jdbi.open()) { <i class="conum" data-value="1"></i><b>(1)</b>
        CallbackDao dao = handle.attach(CallbackDao.class);
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; result = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
        dao.getNamesAsStream(stream -&gt; stream.forEach(result::add)); <i class="conum" data-value="2"></i><b>(2)</b>
        assertThat(result).containsAll(names);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> lifecycle must still be managed by user code.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The stream is managed by the SQL object framework and does not need to be closed by user code.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This code also works with the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#onDemand(java.lang.Class)" target="_blank" rel="noopener">Jdbi#onDemand()</a> and <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useExtension-java.lang.Class-org.jdbi.v3.core.extension.ExtensionConsumer-" target="_blank" rel="noopener">Jdbi#useExtension()</a> methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="type">void</span> testOnDemandCallback() {
    CallbackDao dao = jdbi.onDemand(CallbackDao.class);
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; result = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
    dao.getNamesAsStream(stream -&gt; stream.forEach(result::add));
    assertThat(result).containsAll(names);
}

<span class="annotation">@Test</span>
<span class="type">void</span> testWithExtensionCallback() {
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; result = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();
    jdbi.useExtension(CallbackDao.class, dao -&gt;  <i class="conum" data-value="1"></i><b>(1)</b>
            dao.getNamesAsStream(stream -&gt; stream.forEach(result::add)));
    assertThat(result).containsAll(names);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This code uses <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useExtension-java.lang.Class-org.jdbi.v3.core.extension.ExtensionConsumer-" target="_blank" rel="noopener">Jdbi#useExtension()</a> instead of <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withExtension-java.lang.Class-org.jdbi.v3.core.extension.ExtensionCallback-" target="_blank" rel="noopener">Jdbi#withExtension()</a> as the SQL Object method returns <code>void</code>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
While using a consumer argument is a great way to deal with cursor-type objects, there is the drawback that the user code is called while holding the handle (or the database connection) open. If the callback does very expensive or slow processing, this may hold the connection for a very long time.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sqlobject-mapper-annotations"><a class="anchor" href="#sqlobject-mapper-annotations"></a><a class="link" href="#sqlobject-mapper-annotations">13.5. SQL Object mapper annotations</a></h3>
<div class="paragraph">
<p>The most common use for annotations is to register specific row and column mappers to return values from <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlQuery.html" target="_blank" rel="noopener">@SqlQuery</a>.</p>
</div>
<div class="sect3">
<h4 id="_registerrowmapper"><a class="anchor" href="#_registerrowmapper"></a><a class="link" href="#_registerrowmapper">13.5.1. @RegisterRowMapper</a></h4>
<div class="paragraph">
<p>Use <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterRowMapper.html" target="_blank" rel="noopener">@RegisterRowMapper</a> to register a concrete row mapper class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@RegisterRowMapper</span>(UserMapper.class)
    <span class="predefined-type">List</span>&lt;User&gt; list();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Row mappers used with this annotation must meet a few requirements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">UserMapper</span> <span class="directive">implements</span> <span class="predefined-type">RowMapper</span>&lt;User&gt; {  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">public</span> UserMapper() { <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="comment">// ...</span>
    }

    <span class="directive">public</span> T map(<span class="predefined-type">ResultSet</span> rs, StatementContext ctx) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        <span class="comment">// ...</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Must be a public class.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Must implement <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper</a> with an explicit type argument (e.g.
<a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper&lt;User&gt;</a>) instead of a type variable (e.g. <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper&lt;T&gt;</a>).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Must have a public, no-argument constructor (or a default constructor).</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterRowMapper.html" target="_blank" rel="noopener">@RegisterRowMapper</a> annotation may be repeated multiple times on the same
type or method to register multiple mappers.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_registerrowmapperfactory"><a class="anchor" href="#_registerrowmapperfactory"></a><a class="link" href="#_registerrowmapperfactory">13.5.2. @RegisterRowMapperFactory</a></h4>
<div class="paragraph">
<p>Use <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterRowMapperFactory.html" target="_blank" rel="noopener">@RegisterRowMapperFactory</a> to register a <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapperFactory.html" target="_blank" rel="noopener">RowMapperFactory</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@RegisterRowMapperFactory</span>(UserMapperFactory.class)
    <span class="predefined-type">List</span>&lt;User&gt; list();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Row mapper factories used with this annotation must meet a few requirements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">UserMapperFactory</span> <span class="directive">implements</span> RowMapperFactory { <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> UserMapperFactory() { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="comment">// ...</span>
    }

    <span class="directive">public</span> Optional&lt;<span class="predefined-type">RowMapper</span>&lt;?&gt;&gt; build(<span class="predefined-type">Type</span> type, ConfigRegistry config) {
        <span class="comment">// ...</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Must be a public class.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Must have a public, no-argument constructor (or a default constructor).</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterRowMapperFactory.html" target="_blank" rel="noopener">@RegisterRowMapperFactory</a> annotation may be repeated multiple times on the
same type or method to register multiple factories.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_registercolumnmapper"><a class="anchor" href="#_registercolumnmapper"></a><a class="link" href="#_registercolumnmapper">13.5.3. @RegisterColumnMapper</a></h4>
<div class="paragraph">
<p>Use <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterColumnMapper.html" target="_blank" rel="noopener">@RegisterColumnMapper</a> to register a column mapper:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">AccountDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT balance FROM accounts WHERE id = ?</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@RegisterColumnMapper</span>(MoneyMapper.class)
    Money getBalance(<span class="type">long</span> id);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Column mappers used with this annotation must meet a few requirements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">MoneyMapper</span> <span class="directive">implements</span> ColumnMapper&lt;Money&gt; {  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="directive">public</span> MoneyMapper() { <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="comment">// ...</span>
    }

    <span class="directive">public</span> T map(<span class="predefined-type">ResultSet</span> r, <span class="type">int</span> columnNumber, StatementContext ctx) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        <span class="comment">// ...</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Must be a public class.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Must implement <a href="./apidocs/org/jdbi/v3/core/mapper/ColumnMapper.html" target="_blank" rel="noopener">ColumnMapper</a> with an explicit type argument (e.g.
<a href="./apidocs/org/jdbi/v3/core/mapper/ColumnMapper.html" target="_blank" rel="noopener">ColumnMapper&lt;User&gt;</a>) instead of a type variable (e.g. <a href="./apidocs/org/jdbi/v3/core/mapper/ColumnMapper.html" target="_blank" rel="noopener">ColumnMapper&lt;T&gt;</a>).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Must have a public, no-argument constructor (or a default constructor).</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterColumnMapper.html" target="_blank" rel="noopener">@RegisterColumnMapper</a> annotation may be repeated multiple times on the
same type or method to register multiple mappers.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_registercolumnmapperfactory"><a class="anchor" href="#_registercolumnmapperfactory"></a><a class="link" href="#_registercolumnmapperfactory">13.5.4. @RegisterColumnMapperFactory</a></h4>
<div class="paragraph">
<p>Use <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterColumnMapperFactory.html" target="_blank" rel="noopener">@RegisterColumnMapperFactory</a> to register a column mapper factory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">AccountDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@RegisterColumnMapperFactory</span>(MoneyMapperFactory.class)
    <span class="predefined-type">List</span>&lt;User&gt; list();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Column mapper factories used with this annotation must meet a few requirements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">UserMapperFactory</span> <span class="directive">implements</span> RowMapperFactory { <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> UserMapperFactory() { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="comment">// ...</span>
    }

    <span class="directive">public</span> Optional&lt;<span class="predefined-type">RowMapper</span>&lt;?&gt;&gt; build(<span class="predefined-type">Type</span> type, ConfigRegistry config) {
        <span class="comment">// ...</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Must be a public class.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Must have a public, no-argument constructor (or a default constructor).</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterColumnMapperFactory.html" target="_blank" rel="noopener">@RegisterColumnMapperFactory</a> annotation may be repeated multiple times on
the same type or method to register multiple factories.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_registerbeanmapper"><a class="anchor" href="#_registerbeanmapper"></a><a class="link" href="#_registerbeanmapper">13.5.5. @RegisterBeanMapper</a></h4>
<div class="paragraph">
<p>Use <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterBeanMapper.html" target="_blank" rel="noopener">@RegisterBeanMapper</a> to register a <a href="#_beanmapper">BeanMapper</a> for a bean class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@RegisterBeanMapper</span>(User.class)
    <span class="predefined-type">List</span>&lt;User&gt; list();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the <code>prefix</code> attribute causes the bean mapper to map only those columns
that begin with the prefix:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT u.id u_id, u.name u_name, r.id r_id, r.name r_name </span><span class="delimiter">&quot;</span></span> +
              <span class="string"><span class="delimiter">&quot;</span><span class="content">FROM users u LEFT JOIN roles r ON u.role_id = r.id</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@RegisterBeanMapper</span>(value = User.class, prefix = <span class="string"><span class="delimiter">&quot;</span><span class="content">u</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@RegisterBeanMapper</span>(value = <span class="predefined-type">Role</span>.class, prefix = <span class="string"><span class="delimiter">&quot;</span><span class="content">r</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">Map</span>&lt;User,<span class="predefined-type">Role</span>&gt; getRolesPerUser();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <code>User</code> mapper will map the columns <code>u_id</code> and <code>u_name</code> into
the <code>User.id</code> and <code>User.name</code> properties. Likewise for <code>r_id</code> and <code>r_name</code> into
<code>Role.id</code> and <code>Role.name</code>, respectively.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterBeanMapper.html" target="_blank" rel="noopener">@RegisterBeanMapper</a> annotation may be repeated (as demonstrated above) on
the same type or method to register multiple bean mappers.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_registerconstructormapper"><a class="anchor" href="#_registerconstructormapper"></a><a class="link" href="#_registerconstructormapper">13.5.6. @RegisterConstructorMapper</a></h4>
<div class="paragraph">
<p>Use <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterConstructorMapper.html" target="_blank" rel="noopener">@RegisterConstructorMapper</a> to register a <a href="#_constructormapper">ConstructorMapper</a> for classes
that are instantiated with all properties through the constructor.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@RegisterConstructorMapper</span>(User.class)
    <span class="predefined-type">List</span>&lt;User&gt; list();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the <code>prefix</code> attribute causes the constructor mapper to only map those
columns that begin with the prefix:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT u.id u_id, u.name u_name, r.id r_id, r.name r_name </span><span class="delimiter">&quot;</span></span> +
              <span class="string"><span class="delimiter">&quot;</span><span class="content">FROM users u LEFT JOIN roles r ON u.role_id = r.id</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@RegisterConstructorMapper</span>(value = User.class, prefix = <span class="string"><span class="delimiter">&quot;</span><span class="content">u</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@RegisterConstructorMapper</span>(value = <span class="predefined-type">Role</span>.class, prefix = <span class="string"><span class="delimiter">&quot;</span><span class="content">r</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">Map</span>&lt;User,<span class="predefined-type">Role</span>&gt; getRolesPerUser();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <code>User</code> mapper will map the columns <code>u_id</code> and <code>u_name</code> into
the <code>id</code> and <code>name</code> parameters of the <code>User</code> constructor. Likewise for <code>r_id</code>
and <code>r_name</code> into <code>id</code> and <code>name</code> parameters of the <code>Role</code> constructor,
respectively.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterConstructorMapper.html" target="_blank" rel="noopener">@RegisterConstructorMapper</a> annotation may be repeated multiple times on
the same type or method to register multiple constructor mappers.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_registerfieldmapper"><a class="anchor" href="#_registerfieldmapper"></a><a class="link" href="#_registerfieldmapper">13.5.7. @RegisterFieldMapper</a></h4>
<div class="paragraph">
<p>Use <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterFieldMapper.html" target="_blank" rel="noopener">@RegisterFieldMapper</a> to register a <a href="#_fieldmapper">FieldMapper</a> for a given class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@RegisterFieldMapper</span>(User.class)
    <span class="predefined-type">List</span>&lt;User&gt; list();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the <code>prefix</code> attribute causes the field mapper to only map those columns
that begin with the prefix:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT u.id u_id, u.name u_name, r.id r_id, r.name r_name </span><span class="delimiter">&quot;</span></span> +
              <span class="string"><span class="delimiter">&quot;</span><span class="content">FROM users u LEFT JOIN roles r ON u.role_id = r.id</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@RegisterFieldMapper</span>(value = User.class, prefix = <span class="string"><span class="delimiter">&quot;</span><span class="content">u</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@RegisterFieldMapper</span>(value = <span class="predefined-type">Role</span>.class, prefix = <span class="string"><span class="delimiter">&quot;</span><span class="content">r</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">Map</span>&lt;User,<span class="predefined-type">Role</span>&gt; getRolesPerUser();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <code>User</code> mapper will map the columns <code>u_id</code> and <code>u_name</code> into
the <code>User.id</code> and <code>User.name</code> fields. Likewise for <code>r_id</code> and <code>r_name</code> into the
<code>Role.id</code> and <code>Role.name</code> fields, respectively.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterConstructorMapper.html" target="_blank" rel="noopener">@RegisterConstructorMapper</a> annotation may be repeated multiple times on
the same type or method to register multiple constructor mappers.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_other_sql_object_annotations"><a class="anchor" href="#_other_sql_object_annotations"></a><a class="link" href="#_other_sql_object_annotations">13.6. Other SQL Object annotations</a></h3>
<div class="sect3">
<h4 id="sqlupdate-getgeneratedkeys"><a class="anchor" href="#sqlupdate-getgeneratedkeys"></a><a class="link" href="#sqlupdate-getgeneratedkeys">13.6.1. @GetGeneratedKeys</a></h4>
<div class="paragraph">
<p>Some SQL statements will cause data to be generated on your behalf at the
database, e.g. a table with an auto-generated primary key, or a primary key
selected from a sequence.  The <a href="./apidocs/org/jdbi/v3/sqlobject/statement/GetGeneratedKeys.html" target="_blank" rel="noopener">@GetGeneratedKeys</a> annotation may be used to return the keys generated from the SQL statement:</p>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/sqlobject/statement/GetGeneratedKeys.html" target="_blank" rel="noopener">@GetGeneratedKeys</a> annotation tells Jdbi that the return value should be generated key from the SQL statement, instead of the update count.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name) VALUES (nextval('user_seq'), ?)</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@GetGeneratedKeys</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>)
    <span class="type">long</span> insert(<span class="predefined-type">String</span> name);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple columns may be generated and returned:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name, created_on) VALUES (nextval('user_seq'), ?, now())</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@GetGeneratedKeys</span>({<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">created_on</span><span class="delimiter">&quot;</span></span>})
    <span class="annotation">@RegisterBeanMapper</span>(IdCreateTime.class)
    IdCreateTime insert(<span class="predefined-type">String</span> name);
}</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Databases vary in support for generated keys. Some support only one generated key column per statement, and some (such as Postgres) can return the entire row.
You should check your database vendor&#8217;s documentation before relying on this behavior.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlBatch.html" target="_blank" rel="noopener">@SqlBatch</a> also supports the annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> sqlObjectBatchKeys() {
    db.useExtension(UserDao.class, dao -&gt; {
        <span class="predefined-type">List</span>&lt;User&gt; users = dao.createUsers(<span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Charlie</span><span class="delimiter">&quot;</span></span>);
        assertThat(users).hasSize(<span class="integer">3</span>);

        assertThat(users.get(<span class="integer">0</span>).id).isOne();
        assertThat(users.get(<span class="integer">0</span>).name).isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>);

        assertThat(users.get(<span class="integer">1</span>).id).isEqualTo(<span class="integer">2</span>);
        assertThat(users.get(<span class="integer">1</span>).name).isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>);

        assertThat(users.get(<span class="integer">2</span>).id).isEqualTo(<span class="integer">3</span>);
        assertThat(users.get(<span class="integer">2</span>).name).isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">Charlie</span><span class="delimiter">&quot;</span></span>);
    });
}

<span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlBatch</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (name) VALUES(?)</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@GetGeneratedKeys</span>
    <span class="predefined-type">List</span>&lt;User&gt; createUsers(<span class="predefined-type">String</span>... names);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlBatch.html" target="_blank" rel="noopener">@SqlBatch</a>, the <a href="./apidocs/org/jdbi/v3/sqlobject/statement/GetGeneratedKeys.html" target="_blank" rel="noopener">@GetGeneratedKeys</a> annotations tells SQL Object  that the return value should be the generated keys from each SQL statement, instead of the update count.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlBatch</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name) VALUES (nextval('user_seq'), ?)</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@GetGeneratedKeys</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>)
    <span class="type">long</span><span class="type">[]</span> bulkInsert(<span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; names); <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Returns the generated ID for each inserted name.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Multiple columns may be generated and returned in this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlBatch</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name, created_on) VALUES (nextval('user_seq'), ?, now())</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@GetGeneratedKeys</span>({<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">created_on</span><span class="delimiter">&quot;</span></span>})
    <span class="annotation">@RegisterBeanMapper</span>(IdCreateTime.class)
    <span class="predefined-type">List</span>&lt;IdCreateTime&gt; bulkInsert(<span class="predefined-type">String</span>... names);
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Postgres supports additional functionality when returning generated keys. See <a href="#postgres-getgeneratedkeys">PostgreSQL</a> for more details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="sqllocator"><a class="anchor" href="#sqllocator"></a><a class="link" href="#sqllocator">13.6.2. @SqlLocator</a></h4>
<div class="paragraph">
<p>When SQL statements grow in complexity, it may be cumbersome to provide
the statements as Java strings in the SQL method annotations.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Jdbi supports the <a href="https://docs.oracle.com/en/java/javase/15/text-blocks/index.html">Java Textblock construct</a> available in Java 15 and later. Using a text block is an elegant way to specify multi-line SQL statements.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Jdbi provides annotations that let you configure external locations to
load SQL statements.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/locator/UseAnnotationSqlLocator.html" target="_blank" rel="noopener">@UseAnnotationSqlLocator</a> - use  annotation value of the SQL method annotations (this is the default behavior)</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/locator/UseClasspathSqlLocator.html" target="_blank" rel="noopener">@UseClasspathSqlLocator</a> - loads SQL from a file on the classpath, based on the package and name of the SQL Object interface type.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.foo</span>;

<span class="annotation">@UseClasspathSqlLocator</span>
<span class="type">interface</span> <span class="class">BarDao</span> {
    <span class="comment">// loads classpath resource com/foo/BarDao/query.sql</span>
    <span class="annotation">@SqlQuery</span>
    <span class="type">void</span> query();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/sqlobject/locator/UseClasspathSqlLocator.html" target="_blank" rel="noopener">@UseClasspathSqlLocator</a> is implemented using the <a href="#_classpathsqllocator">ClasspathSqlLocator</a>, as described above.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<a href="#_classpathsqllocator">ClasspathSqlLocator</a> loads a file unchanged by default. Using the <a href="./apidocs/org/jdbi/v3/sqlobject/locator/UseClasspathSqlLocator.html" target="_blank" rel="noopener">@UseClasspathSqlLocator</a> annotation will strip out comments by default! This may lead to unexpected behavior, e.g. SQL Server uses the <code>#</code> character to denote temporary tables. This can be controlled with the <code>stripComments</code> annotation attribute.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.foo</span>;

<span class="annotation">@UseClasspathSqlLocator</span>(stripComments=<span class="predefined-constant">false</span>)
<span class="type">interface</span> <span class="class">BarDao</span> {
    <span class="comment">// loads classpath resource com/foo/BarDao/query.sql without stripping comment lines</span>
    <span class="annotation">@SqlQuery</span>
    <span class="type">void</span> query();
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="#stringtemplate4">jdbi-stringtemplate4</a> module provides <a href="./apidocs/org/jdbi/v3/stringtemplate4/UseStringTemplateSqlLocator.html" target="_blank" rel="noopener">@UseStringTemplateSqlLocator</a>, a SqlLocator, which can load SQL templates from StringTemplate 4 files on the classpath.</p>
</li>
<li>
<p>The jdbi-freemarker module provides <a href="./apidocs/org/jdbi/v3/freemarker/UseFreemarkerSqlLocator.html" target="_blank" rel="noopener">@UseFreemarkerSqlLocator</a>, which can load SQL templates from Freemarker files on the classpath.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_createsqlobject"><a class="anchor" href="#_createsqlobject"></a><a class="link" href="#_createsqlobject">13.6.3. @CreateSqlObject</a></h4>
<div class="paragraph">
<p>Use the <a href="./apidocs/org/jdbi/v3/sqlobject/CreateSqlObject.html" target="_blank" rel="noopener">@CreateSqlObject</a> annotation to reuse a SQL Object type within another object.</p>
</div>
<div class="paragraph">
<p>This is an example where a SQL update defined in a different SQL Object type is executed as part of a transaction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Bar</span> {
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO bar (name) VALUES (:name)</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@GetGeneratedKeys</span>
    <span class="type">int</span> insert(<span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> name);
}

<span class="directive">public</span> <span class="type">interface</span> <span class="class">Foo</span> {

    <span class="annotation">@CreateSqlObject</span>
    Bar createBar();

    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO foo (bar_id, name) VALUES (:bar_id, :name)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> insert(<span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">bar_id</span><span class="delimiter">&quot;</span></span>) <span class="type">int</span> barId, <span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> name);

    <span class="annotation">@Transaction</span>
    <span class="keyword">default</span> <span class="type">void</span> insertBarAndFoo(<span class="predefined-type">String</span> barName, <span class="predefined-type">String</span> fooName) {
        <span class="type">int</span> barId = createBar().insert(barName);
        insert(barId, fooName);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/sqlobject/CreateSqlObject.html" target="_blank" rel="noopener">@CreateSqlObject</a> annotation can also be used to  process cursor-type objects inside <em>interface default methods</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">NestedDao</span> {
    <span class="annotation">@CreateSqlObject</span>
    UserDao userDao(); <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="keyword">default</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getNames() {
        <span class="keyword">try</span> (Stream&lt;<span class="predefined-type">String</span>&gt; stream = userDao().getNamesAsStream()) {
            <span class="keyword">return</span> stream.collect(Collectors.toList());
        }
    }
}

<span class="annotation">@Test</span>
<span class="type">void</span> testOnDemandNestedMethod() {
    NestedDao dao = jdbi.onDemand(NestedDao.class);
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; result = dao.getNames();
    assertThat(result).containsAll(names);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Returns a nested object that provides a stream of users.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_timestamped"><a class="anchor" href="#_timestamped"></a><a class="link" href="#_timestamped">13.6.4. @Timestamped</a></h4>
<div class="paragraph">
<p>You can annotate any statement with <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/Timestamped.html" target="_blank" rel="noopener">@Timestamped</a> to bind an <a href="https://docs.oracle.com/javase/8/docs/api/java/time/OffsetDateTime.html" target="_blank" rel="noopener">OffsetDateTime</a> object representing the current time as <code>now</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Bar</span> {
    <span class="annotation">@Timestamped</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO times(val) VALUES(:now)</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="type">int</span> insert();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Bind a timestamp as <code>now</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use the timestamp as a named binding.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The binding name can be customized:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">Bar</span> {
    <span class="annotation">@Timestamped</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">timestamp</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO times(val) VALUES(:timestamp)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">int</span> insert();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/TimestampedConfig.html" target="_blank" rel="noopener">TimestampedConfig</a> config object allows setting the timezone for the timestamp.</p>
</div>
</div>
<div class="sect3">
<h4 id="_singlevalue"><a class="anchor" href="#_singlevalue"></a><a class="link" href="#_singlevalue">13.6.5. @SingleValue</a></h4>
<div class="paragraph">
<p>Sometimes, when using advanced SQL features like Arrays, a container type such as
<code>int[]</code> or <a href="https://docs.oracle.com/javase/8/docs/api/java/util/List.html" target="_blank" rel="noopener">List&lt;Integer&gt;</a> can ambiguously mean either "a single SQL int[]" or
"a ResultSet of int".</p>
</div>
<div class="paragraph">
<p>Since arrays are not commonly used in normalized schemas, SQL Object assumes by
default that you are collecting a <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" target="_blank" rel="noopener">ResultSet</a> into a container object. You can
annotate a return type as <a href="./apidocs/org/jdbi/v3/sqlobject/SingleValue.html" target="_blank" rel="noopener">@SingleValue</a> to override this.</p>
</div>
<div class="paragraph">
<p>For example, suppose we want to select a <code>varchar[]</code> column from a single row:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT roles FROM users WHERE id = ?</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@SingleValue</span>
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getUserRoles(<span class="type">long</span> userId)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Normally, Jdbi would interpret <a href="https://docs.oracle.com/javase/8/docs/api/java/util/List.html" target="_blank" rel="noopener">List&lt;String&gt;</a> to mean that the mapped type is
<code>String</code>, and to collect all result rows into a list. The <a href="./apidocs/org/jdbi/v3/sqlobject/SingleValue.html" target="_blank" rel="noopener">@SingleValue</a>
annotation causes Jdbi to treat <a href="https://docs.oracle.com/javase/8/docs/api/java/util/List.html" target="_blank" rel="noopener">List&lt;String&gt;</a> as the mapped type instead.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It&#8217;s tempting to use the <a href="./apidocs/org/jdbi/v3/sqlobject/SingleValue.html" target="_blank" rel="noopener">@SingleValue</a> annotation on an <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html" target="_blank" rel="noopener">Optional&lt;T&gt;</a> type , but usually this is not needed.
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html" target="_blank" rel="noopener">Optional&lt;T&gt;</a> is implemented as a container of zero-or-one elements.  Adding <a href="./apidocs/org/jdbi/v3/sqlobject/SingleValue.html" target="_blank" rel="noopener">@SingleValue</a> implies that the database itself has a column of a type like <code>optional&lt;varchar&gt;</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/sqlobject/SingleValue.html" target="_blank" rel="noopener">@SingleValue</a> annotation can also be used on an array, collection or iterable method parameter. This causes SQL Object to bind the whole iterable as the parameter value. This is especially useful for <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlBatch.html" target="_blank" rel="noopener">@SqlBatch</a> operations (often for a SQL Array parameter):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlBatch</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name, roles) VALUES (?, ?, ?)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> bulkInsert(<span class="predefined-type">List</span>&lt;<span class="predefined-type">Long</span>&gt; ids,
                    <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; names,
                    <span class="annotation">@SingleValue</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; roles);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, each new row would get the same <code>varchar[]</code> value in the <code>roles</code> column.</p>
</div>
</div>
<div class="sect3">
<h4 id="_annotations_for_mapkv_results"><a class="anchor" href="#_annotations_for_mapkv_results"></a><a class="link" href="#_annotations_for_mapkv_results">13.6.6. Annotations for Map&lt;K,V&gt; Results</a></h4>
<div class="paragraph">
<p>SQL Object methods may return <code>Map&lt;K,V&gt;</code> types (see <a href="#mapentry-mapping">Map.Entry mapping</a> in
the Core API). In this scenario, each row is mapped to a <code>Map.Entry&lt;K,V&gt;</code>,
and the entries for each row are collected into a single <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html" target="_blank" rel="noopener">Map</a> instance.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A mapper must be registered for both the key and value types.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Gather master/detail join rows into a map, simply by registering mappers
for the key and value types.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">select u.id u_id, u.name u_name, p.id p_id, p.phone p_phone </span><span class="delimiter">&quot;</span></span>
    + <span class="string"><span class="delimiter">&quot;</span><span class="content">from </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> u left join phone p on u.id = p.user_id</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@RegisterConstructorMapper</span>(value = User.class, prefix = <span class="string"><span class="delimiter">&quot;</span><span class="content">u</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@RegisterConstructorMapper</span>(value = Phone.class, prefix = <span class="string"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>)
<span class="predefined-type">Map</span>&lt;User, Phone&gt; getMap();</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the preceding example, the <code>User</code> mapper uses the "u" column name prefix, and
the <code>Phone</code> mapper uses "p". Since each mapper only reads the column with the
expected prefix, the respective <code>id</code> columns are unambiguous.</p>
</div>
<div class="paragraph">
<p>A unique index (e.g. by ID column) can be obtained by setting the key column
name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">select * from </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@KeyColumn</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@RegisterConstructorMapper</span>(User.class)
<span class="predefined-type">Map</span>&lt;<span class="predefined-type">Integer</span>, User&gt; getAll();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Set both the key and value column names to gather a two-column query into a map
result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">select </span><span class="char">\&quot;</span><span class="content">key</span><span class="char">\&quot;</span><span class="content">, </span><span class="char">\&quot;</span><span class="content">value</span><span class="char">\&quot;</span><span class="content"> from config</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@KeyColumn</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@ValueColumn</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>)
<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; getAll();</code></pre>
</div>
</div>
<div class="paragraph">
<p>All of the above examples assume a one-to-one key/value relationship.</p>
</div>
<div class="paragraph">
<p>What if there is a one-to-many relationship? <a href="#google-guava">Google Guava</a> provides a <code>Multimap</code>
type, which supports mapping multiple values per key.</p>
</div>
<div class="paragraph">
<p>First, follow the instructions in the <a href="#google-guava">Google Guava</a> section to install the
<a href="./apidocs/org/jdbi/v3/guava/GuavaPlugin.html" target="_blank" rel="noopener">GuavaPlugin</a>.</p>
</div>
<div class="paragraph">
<p>Then, simply specify a <code>Multimap</code> return type instead of <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html" target="_blank" rel="noopener">Map</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">select u.id u_id, u.name u_name, p.id p_id, p.phone p_phone </span><span class="delimiter">&quot;</span></span>
    + <span class="string"><span class="delimiter">&quot;</span><span class="content">from </span><span class="char">\&quot;</span><span class="content">user</span><span class="char">\&quot;</span><span class="content"> u left join phone p on u.id = p.user_id</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@RegisterConstructorMapper</span>(value = User.class, prefix = <span class="string"><span class="delimiter">&quot;</span><span class="content">u</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@RegisterConstructorMapper</span>(value = Phone.class, prefix = <span class="string"><span class="delimiter">&quot;</span><span class="content">p</span><span class="delimiter">&quot;</span></span>)
Multimap&lt;User, Phone&gt; getMultimap();</code></pre>
</div>
</div>
<div class="paragraph">
<p>All the examples so far have been <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html" target="_blank" rel="noopener">Map</a> types where each row in the result set
is a single <code>Map.Entry</code>. However, what if the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html" target="_blank" rel="noopener">Map</a> we want to return is
actually a single row or even a single column?</p>
</div>
<div class="paragraph">
<p>Jdbi&#8217;s <a href="./apidocs/org/jdbi/v3/core/mapper/MapMapper.html" target="_blank" rel="noopener">MapMapper</a> maps each row to a
<code>Map&lt;String, Object&gt;</code>, where column names are mapped to column values.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Jdbi&#8217;s default setting is to convert column names to lowercase for Map keys. This behavior can be
changed via the <code>MapMappers</code> config class.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, SQL Object treats <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html" target="_blank" rel="noopener">Map</a> return types as a collection of <code>Map.Entry</code>
values. Use the <a href="./apidocs/org/jdbi/v3/sqlobject/SingleValue.html" target="_blank" rel="noopener">@SingleValue</a> annotation to override this, so that the return
type is treated as a single value instead of a collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users WHERE id = ?</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@RegisterRowMapper</span>(MapMapper.class)
<span class="annotation">@SingleValue</span>
<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; getById(<span class="type">long</span> userId);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/mapper/GenericMapMapperFactory.html" target="_blank" rel="noopener">GenericMapMapperFactory</a>,
provides the same feature but allows value types other than <code>Object</code> as long as a suitable ColumnMapper
is registered and all columns are of the same type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT 1.0 AS LOW, 2.0 AS MEDIUM, 3.0 AS HIGH</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@RegisterRowMapperFactory</span>(GenericMapMapperFactory.class)
<span class="annotation">@SingleValue</span>
<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">BigDecimal</span>&gt; getNumericLevels();</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <a href="#_postgresql">PostgreSQL</a> plugin provides an <code>hstore</code> to <code>Map&lt;String, String&gt;</code> column mapper. See <a href="#postgres-hstore">hstore</a> for more information.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_userowreducer"><a class="anchor" href="#_userowreducer"></a><a class="link" href="#_userowreducer">13.6.7. @UseRowReducer</a></h4>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlQuery.html" target="_blank" rel="noopener">@SqlQuery</a> methods that use join queries may reduce master-detail joins
into one or more master-level objects. See <a href="#_resultbearing_reducerows">ResultBearing.reduceRows()</a> for
an introduction to row reducers.</p>
</div>
<div class="paragraph">
<p>Consider a filesystem metaphor with folders and documents. In the join, we&#8217;ll
prefix folder columns with <code>f_</code> and document columns with <code>d_</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@RegisterBeanMapper</span>(value = Folder.class, prefix = <span class="string"><span class="delimiter">&quot;</span><span class="content">f</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@RegisterBeanMapper</span>(value = <span class="predefined-type">Document</span>.class, prefix = <span class="string"><span class="delimiter">&quot;</span><span class="content">d</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">DocumentDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT </span><span class="delimiter">&quot;</span></span> +
        <span class="string"><span class="delimiter">&quot;</span><span class="content">f.id f_id, f.name f_name, </span><span class="delimiter">&quot;</span></span> +
        <span class="string"><span class="delimiter">&quot;</span><span class="content">d.id d_id, d.name d_name, d.contents d_contents </span><span class="delimiter">&quot;</span></span> +
        <span class="string"><span class="delimiter">&quot;</span><span class="content">FROM folders f LEFT JOIN documents d </span><span class="delimiter">&quot;</span></span> +
        <span class="string"><span class="delimiter">&quot;</span><span class="content">ON f.id = d.folder_id </span><span class="delimiter">&quot;</span></span> +
        <span class="string"><span class="delimiter">&quot;</span><span class="content">WHERE f.id = :folderId</span><span class="delimiter">&quot;</span></span> +
        <span class="string"><span class="delimiter">&quot;</span><span class="content">ORDER BY d.name</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@UseRowReducer</span>(FolderDocReducer.class) <i class="conum" data-value="2"></i><b>(2)</b>
    Optional&lt;Folder&gt; getFolder(<span class="type">int</span> folderId); <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT </span><span class="delimiter">&quot;</span></span> +
        <span class="string"><span class="delimiter">&quot;</span><span class="content">f.id f_id, f.name f_name, </span><span class="delimiter">&quot;</span></span> +
        <span class="string"><span class="delimiter">&quot;</span><span class="content">d.id d_id, d.name d_name, d.contents d_contents </span><span class="delimiter">&quot;</span></span> +
        <span class="string"><span class="delimiter">&quot;</span><span class="content">FROM folders f LEFT JOIN documents d </span><span class="delimiter">&quot;</span></span> +
        <span class="string"><span class="delimiter">&quot;</span><span class="content">ON f.id = d.folder_id </span><span class="delimiter">&quot;</span></span> +
        <span class="string"><span class="delimiter">&quot;</span><span class="content">ORDER BY f.name, d.name</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@UseRowReducer</span>(FolderDocReducer.class) <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="predefined-type">List</span>&lt;Folder&gt; listFolders(); <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="type">class</span> <span class="class">FolderDocReducer</span> <span class="directive">implements</span> LinkedHashMapRowReducer&lt;<span class="predefined-type">Integer</span>, Folder&gt; { <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="annotation">@Override</span>
        <span class="directive">public</span> <span class="type">void</span> accumulate(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">Integer</span>, Folder&gt; map, RowView rowView) {
            Folder f = map.computeIfAbsent(rowView.getColumn(<span class="string"><span class="delimiter">&quot;</span><span class="content">f_id</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Integer</span>.class), <i class="conum" data-value="5"></i><b>(5)</b>
                id -&gt; rowView.getRow(Folder.class));

            <span class="keyword">if</span> (rowView.getColumn(<span class="string"><span class="delimiter">&quot;</span><span class="content">d_id</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Integer</span>.class) != <span class="predefined-constant">null</span>) { <i class="conum" data-value="6"></i><b>(6)</b>
                f.getDocuments().add(rowView.getRow(<span class="predefined-type">Document</span>.class));
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this example, we register the folder and document mappers with a
prefix, so that each mapper only looks at the columns with that prefix.
These mappers are used indirectly by the row reducer in the
<code>getRow(Folder.class)</code> and <code>getRow(Document.class)</code> calls.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate the method with <code>@UseRowReducer</code>, and specify the <code>RowReducer</code>
implementation class.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The same <code>RowReducer</code> implementation may be used for both single- and
multi-master-record queries.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><a href="./apidocs/org/jdbi/v3/core/result/LinkedHashMapRowReducer.html" target="_blank" rel="noopener">LinkedHashMapRowReducer</a>
is an abstract <code>RowReducer</code> implementation that uses a <code>LinkedHashMap</code> as the result
container, and returns the <code>values()</code> collection as the result.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Get the <code>Folder</code> for this row from the map by ID, or create it if not in the map.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Confirm this row has a document (this <em>is</em> a left join) before mapping a document
and adding it to the folder.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_registercollector_and_registercollectorfactory"><a class="anchor" href="#_registercollector_and_registercollectorfactory"></a><a class="link" href="#_registercollector_and_registercollectorfactory">13.6.8. @RegisterCollector and @RegisterCollectorFactory</a></h4>
<div class="paragraph">
<p>Convenience annotations to register a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html" target="_blank" rel="noopener">Collector</a> for a SqlObject method.</p>
</div>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterCollectorFactory.html" target="_blank" rel="noopener">@RegisterCollectorFactory</a> allows registration of a factory that returns a collector instance and <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterCollector.html" target="_blank" rel="noopener">@RegisterCollector</a> registers a collector implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">RegisterCollectorDao</span> {
    <span class="annotation">@RegisterCollector</span>(StringConcatCollector.class)
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">select i from i order by i asc</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">String</span> selectWithCollector();

    <span class="annotation">@RegisterCollectorFactory</span>(StringConcatCollectorFactory.class)
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">select i from i order by i asc</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">String</span> selectWithCollectorFactory();
}

<span class="type">class</span> <span class="class">StringConcatCollectorFactory</span> <span class="directive">implements</span> CollectorFactory {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> accepts(<span class="predefined-type">Type</span> containerType) {
        <span class="keyword">return</span> containerType == <span class="predefined-type">String</span>.class;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Optional&lt;<span class="predefined-type">Type</span>&gt; elementType(<span class="predefined-type">Type</span> containerType) {
        <span class="keyword">return</span> Optional.of(<span class="predefined-type">Integer</span>.class);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Collector&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt;, <span class="predefined-type">String</span>&gt; build(<span class="predefined-type">Type</span> containerType) {
        <span class="keyword">return</span> Collector.of(
            <span class="predefined-type">ArrayList</span>::<span class="keyword">new</span>,
            <span class="predefined-type">List</span>::add,
            (x, y) -&gt; {
                x.addAll(y);
                <span class="keyword">return</span> x;
            },
            i -&gt; i.stream().map(<span class="predefined-type">Object</span>::toString).collect(Collectors.joining(<span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span>)));
    }
}

<span class="type">class</span> <span class="class">StringConcatCollector</span> <span class="directive">implements</span> Collector&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt;, <span class="predefined-type">String</span>&gt; {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> Supplier&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt;&gt; supplier() {
        <span class="keyword">return</span> <span class="predefined-type">ArrayList</span>::<span class="keyword">new</span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> BiConsumer&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt;, <span class="predefined-type">Integer</span>&gt; accumulator() {
        <span class="keyword">return</span> <span class="predefined-type">List</span>::add;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> BinaryOperator&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt;&gt; combiner() {
        <span class="keyword">return</span> (a, b) -&gt; {
            a.addAll(b);
            <span class="keyword">return</span> a;
        };
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Function&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt;, <span class="predefined-type">String</span>&gt; finisher() {
        <span class="keyword">return</span> i -&gt; i.stream().map(<span class="predefined-type">Object</span>::toString).collect(Collectors.joining(<span class="string"><span class="delimiter">&quot;</span><span class="content"> </span><span class="delimiter">&quot;</span></span>));
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;Characteristics&gt; characteristics() {
        <span class="keyword">return</span> <span class="predefined-type">Collections</span>.emptySet();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The element and result types are inferred from the concrete <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collector.html" target="_blank" rel="noopener">Collector&lt;Element, ?, Result&gt;</a> implementation&#8217;s type parameters. See <a href="#_collectors">Collectors</a> for more details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_other_sql_object_annotations_2"><a class="anchor" href="#_other_sql_object_annotations_2"></a><a class="link" href="#_other_sql_object_annotations_2">13.6.9. Other SQL Object annotations</a></h4>
<div class="paragraph">
<p>Jdbi provides many additional annotations out of the box:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/config/package-summary.html" target="_blank" rel="noopener">org.jdbi.v3.sqlobject.config</a>
 provides annotations for things that can be configured at the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> or
<a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> level. This includes registration of mappers and arguments, and for
 configuring SQL statement rendering and parsing.</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/customizer/package-summary.html" target="_blank" rel="noopener">org.jdbi.v3.sqlobject.customizer</a>
provides annotations for binding parameters, defining attributes, and
controlling the fetch behavior of the statement&#8217;s result set.</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/jpa/package-summary.html" target="_blank" rel="noopener">org.jdbi.v3.jpa</a>
provides the <a href="./apidocs/org/jdbi/v3/jpa/BindJpa.html" target="_blank" rel="noopener">@BindJpa</a> annotation, for binding properties to column according
to JPA <code>@Column</code> annotations.</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/locator/package-summary.html" target="_blank" rel="noopener">org.jdbi.v3.sqlobject.locator</a>
provides annotations that configure Jdbi to load SQL statements from an
alternative source, e.g. a file on the classpath.</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/statement/package-summary.html" target="_blank" rel="noopener">org.jdbi.v3.sqlobject.statement</a>
provides the <a href="./apidocs/org/jdbi/v3/sqlobject/statement/MapTo.html" target="_blank" rel="noopener">@MapTo</a> annotation, which is used for dynamically specifying the
mapped type at the time the method is invoked.</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/stringtemplate4/package-summary.html" target="_blank" rel="noopener">org.jdbi.v3.stringtemplate4</a>
provides annotations that configure Jdbi to load SQL from StringTemplate 4
<code>.stg</code> files on the classpath, and/or to parse SQL templates using the
ST4 template engine.</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/transaction/package-summary.html" target="_blank" rel="noopener">org.jdbi.v3.sqlobject.transaction</a>
provides annotations for transaction management in a SQL object. See
<a href="#_sql_object_transactions">SQL Object Transactions</a> for details.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The SQL Object framework is built on top of the <a href="#extension-framework">Jdbi Extension framework</a> which can be extended with user-defined annotations. See the
<a href="#extension-framework-annotations">extension framework annotation documentation</a> for an overview on how to build your own annotations.</p>
</div>
</div>
<div class="sect3">
<h4 id="_annotations_and_inheritance"><a class="anchor" href="#_annotations_and_inheritance"></a><a class="link" href="#_annotations_and_inheritance">13.6.10. Annotations and Inheritance</a></h4>
<div class="paragraph">
<p>SQL Objects inherit methods and annotations from the interfaces they extend:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.app.dao</span>;

<span class="annotation">@UseClasspathSqlLocator</span>  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">CrudDao</span>&lt;T, ID&gt; {
    <span class="annotation">@SqlUpdate</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="type">void</span> insert(<span class="annotation">@BindBean</span> T entity);

    <span class="annotation">@SqlQuery</span> <i class="conum" data-value="3"></i><b>(3)</b>
    Optional&lt;T&gt; findById(ID id);

    <span class="annotation">@SqlQuery</span>
    <span class="predefined-type">List</span>&lt;T&gt; list();

    <span class="annotation">@SqlUpdate</span>
    <span class="type">void</span> update(<span class="annotation">@BindBean</span> T entity);

    <span class="annotation">@SqlUpdate</span>
    <span class="type">void</span> deleteById(ID id);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>See <a href="#sqllocator">@SqlLocator</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Class annotations are inherited by subtypes.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Method and parameter annotations are inherited by subtypes, unless the
subtype overrides the method.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.app.contact</span>;

<span class="annotation">@RegisterBeanMapper</span>(Contact.class)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">ContactDao</span> <span class="directive">extends</span> CrudDao&lt;Contact, <span class="predefined-type">Long</span>&gt; {}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.app.account</span>;

<span class="annotation">@RegisterConstructorMapper</span>(Account.class)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">AccountDao</span> <span class="directive">extends</span> CrudDao&lt;Account, <span class="predefined-type">UUID</span>&gt; {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example we&#8217;re using the <a href="./apidocs/org/jdbi/v3/sqlobject/locator/UseClasspathSqlLocator.html" target="_blank" rel="noopener">@UseClasspathSqlLocator</a> annotation, so each
method will use SQL loaded from the classpath. Thus, <code>ContactDao</code> methods will
use SQL from:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/com/app/contact/ContactDao/insert.sql</code></p>
</li>
<li>
<p><code>/com/app/contact/ContactDao/findById.sql</code></p>
</li>
<li>
<p><code>/com/app/contact/ContactDao/list.sql</code></p>
</li>
<li>
<p><code>/com/app/contact/ContactDao/update.sql</code></p>
</li>
<li>
<p><code>/com/app/contact/ContactDao/deleteById.sql</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Whereas <code>AccountDao</code> will use SQL from:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/com/app/account/AccountDao/insert.sql</code></p>
</li>
<li>
<p><code>/com/app/account/AccountDao/findById.sql</code></p>
</li>
<li>
<p><code>/com/app/account/AccountDao/list.sql</code></p>
</li>
<li>
<p><code>/com/app/account/AccountDao/update.sql</code></p>
</li>
<li>
<p><code>/com/app/account/AccountDao/deleteById.sql</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Suppose <code>Account</code> used <code>name()</code>-style accessors instead of <code>getName()</code>. In that
case, we&#8217;d want <code>AccountDao</code> to use <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindMethods.html" target="_blank" rel="noopener">@BindMethods</a> instead of <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindBean.html" target="_blank" rel="noopener">@BindBean</a>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s override those methods with the right annotations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.app.account</span>;

<span class="annotation">@RegisterConstructorMapper</span>(Account.class)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">AccountDao</span> <span class="directive">extends</span> CrudDao&lt;Account, <span class="predefined-type">UUID</span>&gt; {
    <span class="annotation">@Override</span>
    <span class="annotation">@SqlUpdate</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="type">void</span> insert(<span class="annotation">@BindMethods</span> Account entity);

    <span class="annotation">@Override</span>
    <span class="annotation">@SqlUpdate</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="type">void</span> update(<span class="annotation">@BindMethods</span> Account entity);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Method annotations are not inherited on override, so we must duplicate
those we want to keep.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_combining_sql_object_and_the_core_api"><a class="anchor" href="#_combining_sql_object_and_the_core_api"></a><a class="link" href="#_combining_sql_object_and_the_core_api">13.7. Combining SQL Object and the core API</a></h3>
<div class="paragraph">
<p>The SQL Object extension uses the same core API as programmatic SQL operations. There is an underlying <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> object that is used to execute the SQL methods.</p>
</div>
<div class="paragraph">
<p>A SQL Object type can extend the <a href="./apidocs/org/jdbi/v3/sqlobject/SqlObject.html" target="_blank" rel="noopener">SqlObject</a> mixin interface to get access to the handle. It also exposes a number of operations that can be used to mix declarative SQL Object methods with programmatic core API code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">SomeDao</span> <span class="directive">extends</span> SqlObject {
    <span class="comment">// ...</span>
}

<span class="type">void</span> mixedCode() {
    SomeDao dao = jdbi.onDemand(SomeDao.class);

    dao.withHandle(handle -&gt; {
        handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * from users</span><span class="delimiter">&quot;</span></span>).mapTo(User.class).list();
    })
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This interface gives access to the handle and offers <a href="./apidocs/org/jdbi/v3/sqlobject/SqlObject.html#withHandle(org.jdbi.v3.core.HandleCallback)" target="_blank" rel="noopener">SqlObject#withHandle()</a> and
<a href="./apidocs/org/jdbi/v3/sqlobject/SqlObject.html#useHandle(org.jdbi.v3.core.HandleConsumer)" target="_blank" rel="noopener">SqlObject#useHandle()</a> methods that execute callback code using the same handle object as the methods on the SQL object interface itself.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is most useful for SQL object instances that get passed from other code, have been created from
<a href="./apidocs/org/jdbi/v3/core/Jdbi.html#onDemand(java.lang.Class)" target="_blank" rel="noopener">Jdbi#onDemand()</a> or use default methods. Any object that was created using the
<a href="./apidocs/org/jdbi/v3/core/Handle.html#attach(java.lang.Class)" target="_blank" rel="noopener">Handle#attach()</a> method will return the handle it was attached to.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_using_default_methods_with_the_sqlobject_mixin"><a class="anchor" href="#_using_default_methods_with_the_sqlobject_mixin"></a><a class="link" href="#_using_default_methods_with_the_sqlobject_mixin">13.7.1. Using default Methods with the <code>SqlObject</code> mixin</a></h4>
<div class="paragraph">
<p>Occasionally a use case comes up where SQL Method annotations don&#8217;t fit. In these situations, it is possible to "drop down" to the Core API using interface
<code>default</code> methods and the <a href="./apidocs/org/jdbi/v3/sqlobject/SqlObject.html" target="_blank" rel="noopener">SqlObject</a> mixin interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">SplineDao</span> <span class="directive">extends</span> SqlObject {
    <span class="keyword">default</span> <span class="type">void</span> reticulateSplines(Spline spline) {
        Handle handle = getHandle();
        <span class="comment">// do tricky stuff using the Core API</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Default methods can also be used to group multiple SQL operations into a single method call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">ContactPhoneDao</span> {
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO contacts (id, name) VALUES (nextval('contact_id'), :name)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">long</span> insertContact(<span class="annotation">@BindBean</span> Contact contact);

    <span class="annotation">@SqlBatch</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO phones (contact_id, type, phone) VALUES (:contactId, :type, :phone)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> insertPhone(<span class="type">long</span> contactId, <span class="annotation">@BindBean</span> <span class="predefined-type">Iterable</span>&lt;Phone&gt; phones);

    <span class="keyword">default</span> <span class="type">long</span> insertFullContact(Contact contact) {
        <span class="type">long</span> id = insertContact(contact);
        insertPhone(id, contact.getPhones());
        <span class="keyword">return</span> id;
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sql_object_transactions"><a class="anchor" href="#_sql_object_transactions"></a><a class="link" href="#_sql_object_transactions">13.8. SQL Object Transactions</a></h3>
<div class="paragraph">
<p>Methods on a SQL object can have a <a href="./apidocs/org/jdbi/v3/sqlobject/transaction/Transaction.html" target="_blank" rel="noopener">@Transaction</a> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transaction</span>
<span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users WHERE id=:id</span><span class="delimiter">&quot;</span></span>)
Optional&lt;User&gt; findUserById(<span class="type">int</span> id);</code></pre>
</div>
</div>
<div class="paragraph">
<p>SQL methods with a <a href="./apidocs/org/jdbi/v3/sqlobject/transaction/Transaction.html" target="_blank" rel="noopener">@Transaction</a> annotation may optionally specify a
transaction isolation level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transaction</span>(TransactionIsolationLevel.READ_COMMITTED)
<span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO USERS (name) VALUES (:name)</span><span class="delimiter">&quot;</span></span>)
<span class="type">void</span> insertUser(<span class="predefined-type">String</span> name);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar to the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#inTransaction(org.jdbi.v3.core.HandleCallback)" target="_blank" rel="noopener">Jdbi#inTransaction()</a> and <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useTransaction(org.jdbi.v3.core.HandleConsumer)" target="_blank" rel="noopener">Jdbi#useTransaction()</a> operations in the core API, transactions are not nested. If a method, that has been annotated with <a href="./apidocs/org/jdbi/v3/sqlobject/transaction/Transaction.html" target="_blank" rel="noopener">@Transaction</a>, calls another method that is annotated as well (e.g. through an <em>interface default method</em>), then the same transaction will be reused, and it will be committed when the outer transaction ends.</p>
</div>
<div class="paragraph">
<p>Nested method calls must either use the same transaction isolation level or inner methods must not specify any transaction level. In that case, the transaction level of the outer transaction maintained.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transaction</span>(TransactionIsolationLevel.READ_UNCOMMITTED)
<span class="keyword">default</span> <span class="type">void</span> outerMethodCallsInnerWithSameLevel() {
    <span class="comment">// this works: isolation levels agree</span>
    innerMethodSameLevel();
}

<span class="annotation">@Transaction</span>(TransactionIsolationLevel.READ_UNCOMMITTED)
<span class="keyword">default</span> <span class="type">void</span> innerMethodSameLevel() {}

<span class="annotation">@Transaction</span>(TransactionIsolationLevel.READ_COMMITTED)
<span class="keyword">default</span> <span class="type">void</span> outerMethodWithLevelCallsInnerMethodWithNoLevel() {
    <span class="comment">// this also works: inner method doesn't specify a level, so the outer method controls.</span>
    innerMethodWithNoLevel();
}

<span class="annotation">@Transaction</span>
<span class="keyword">default</span> <span class="type">void</span> innerMethodWithNoLevel() {}

<span class="annotation">@Transaction</span>(TransactionIsolationLevel.REPEATABLE_READ)
<span class="keyword">default</span> <span class="type">void</span> outerMethodWithOneLevelCallsInnerMethodWithAnotherLevel() <span class="directive">throws</span> TransactionException {
    <span class="comment">// error! inner method specifies a different isolation level.</span>
    innerMethodWithADifferentLevel();
}

<span class="annotation">@Transaction</span>(TransactionIsolationLevel.SERIALIZABLE)
<span class="keyword">default</span> <span class="type">void</span> innerMethodWithADifferentLevel() {}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_executing_multiple_sql_operations_in_a_single_transaction"><a class="anchor" href="#_executing_multiple_sql_operations_in_a_single_transaction"></a><a class="link" href="#_executing_multiple_sql_operations_in_a_single_transaction">13.8.1. Executing multiple SQL operations in a single transaction</a></h4>
<div class="paragraph">
<p>A SQL object method uses its own transaction. Multiple method calls can be grouped together to use a shared transaction:</p>
</div>
<div class="paragraph">
<p>For an existing handle, attach the SQL object inside the transaction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@Transaction</span>
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> createUser(<span class="type">int</span> id, <span class="predefined-type">String</span> name);
}

<span class="directive">public</span> <span class="type">void</span> createUsers(Handle handle) {
    handle.useTransaction(transactionHandle -&gt; {
        UserDao dao = transactionHandle.attach(UserDao.class);

        <span class="comment">// both inserts happen in the same transaction</span>
        dao.createUser(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>);
        dao.createUser(<span class="integer">2</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an alternative, the <a href="./apidocs/org/jdbi/v3/sqlobject/transaction/Transactional.html" target="_blank" rel="noopener">Transactional</a> mixin interface can be used to provide transaction support on a SQL object.</p>
</div>
<div class="paragraph">
<p>Similar to the <a href="./apidocs/org/jdbi/v3/sqlobject/SqlObject.html" target="_blank" rel="noopener">SqlObject</a> interface, it gives access to all transaction related methods on the Handle and offers the same callbacks as the Handle itself.</p>
</div>
<div class="paragraph">
<p>With this mixin interface, the <a href="./apidocs/org/jdbi/v3/sqlobject/transaction/Transactional.html#useTransaction(org.jdbi.v3.sqlobject.transaction.TransactionalConsumer)" target="_blank" rel="noopener">Transactional#useTransaction()</a> and <a href="./apidocs/org/jdbi/v3/sqlobject/transaction/Transactional.html#inTransaction(org.jdbi.v3.sqlobject.transaction.TransactionalCallback)" target="_blank" rel="noopener">Transactional#inTransaction()</a> methods group statements into a single transaction by using a callback:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> <span class="directive">extends</span> Transactional&lt;UserDao&gt; {
    <span class="annotation">@Transaction</span>
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> createUser(<span class="type">int</span> id, <span class="predefined-type">String</span> name);
}

<span class="directive">public</span> <span class="type">void</span> createUsers(Jdbi jdbi) {
    UserDao dao = jdbi.onDemand(UserDao.class);

    dao.useTransaction(transactionDao -&gt; {
        <span class="comment">// both inserts happen in the same transaction</span>
        transactionDao.createUser(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>);
        transactionDao.createUser(<span class="integer">2</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>);
    });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nested calls can be used as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> <span class="directive">extends</span> Transactional&lt;UserDao&gt; {
    <span class="annotation">@Transaction</span>
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> createUser(<span class="type">int</span> id, <span class="predefined-type">String</span> name);
}

<span class="directive">public</span> <span class="type">void</span> createUsers(Jdbi jdbi) {
    UserDao dao = jdbi.onDemand(UserDao.class);

    dao.useTransaction(transactionDao1 -&gt; {
        <span class="comment">// both inserts happen in the same transaction</span>
        transactionDao1.createUser(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>);

        transactionDao1.useTransaction(transactionDao2 -&gt; {
            transactionDao2.createUser(<span class="integer">2</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>);
        });
    });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>SQL object calls and core API calls can be mixed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> <span class="directive">extends</span> Transactional&lt;UserDao&gt; {
    <span class="annotation">@Transaction</span>
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> createUser(<span class="type">int</span> id, <span class="predefined-type">String</span> name);
}

<span class="directive">public</span> <span class="type">void</span> createUsers(Jdbi jdbi) {
    UserDao dao = jdbi.onDemand(UserDao.class);

    dao.useTransaction(transactionDao -&gt; {
        <span class="comment">// inserts happen in the same transaction</span>
        transactionDao.createUser(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Alice</span><span class="delimiter">&quot;</span></span>);
        transactionDao.createUser(<span class="integer">2</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>);

        <span class="comment">// this insert as well</span>
        transactionDao.getHandle().useTransaction(transactionHandle -&gt;
            transactionHandle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">USERT INTO users VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
                .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">3</span>)
                .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Charlie</span><span class="delimiter">&quot;</span></span>)
                .execute();
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_miscellaneous"><a class="anchor" href="#_miscellaneous"></a><a class="link" href="#_miscellaneous">14. Miscellaneous</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_generated_keys"><a class="anchor" href="#_generated_keys"></a><a class="link" href="#_generated_keys">14.1. Generated Keys</a></h3>
<div class="paragraph">
<p>An Update or PreparedBatch may automatically generate keys. These keys
are treated separately from normal results. Depending on your database and
configuration, the entire inserted row may be available.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
There is a lot of variation between databases supporting
this feature so please test this feature&#8217;s interaction with your database
thoroughly.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In PostgreSQL, the entire row is available, so you can immediately map your
inserted names back to full User objects!  This avoids the overhead of
separately querying after the insert completes.</p>
</div>
<div class="paragraph">
<p>Consider the following table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">User</span> {

    <span class="directive">final</span> <span class="type">int</span> id;
    <span class="directive">final</span> <span class="predefined-type">String</span> name;

    <span class="directive">public</span> User(<span class="type">int</span> id, <span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.id = id;
        <span class="local-variable">this</span>.name = name;
    }
}

<span class="annotation">@BeforeEach</span>
<span class="directive">public</span> <span class="type">void</span> setUp() {
    db = pgExtension.getJdbi();

    db.useHandle(h -&gt; h.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE TABLE users (id SERIAL PRIMARY KEY, name VARCHAR)</span><span class="delimiter">&quot;</span></span>));
    db.registerRowMapper(ConstructorMapper.factory(User.class));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can get generated keys in the fluent style:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> fluentInsertKeys() {
    db.useHandle(handle -&gt; {
        User data = handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (name) VALUES(?)</span><span class="delimiter">&quot;</span></span>)
                .bind(<span class="integer">0</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Data</span><span class="delimiter">&quot;</span></span>)
                .executeAndReturnGeneratedKeys()
                .mapTo(User.class)
                .one();

        assertThat(data.id).isOne(); <span class="comment">// this value is generated by the database</span>
        assertThat(data.name).isEqualTo(<span class="string"><span class="delimiter">&quot;</span><span class="content">Data</span><span class="delimiter">&quot;</span></span>);
    });
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_qualified_types"><a class="anchor" href="#_qualified_types"></a><a class="link" href="#_qualified_types">14.2. Qualified Types</a></h3>
<div class="paragraph">
<p>Sometimes the same Java object can correspond to multiple data types in a database. For example,
a <code>String</code> could be <code>varchar</code> plaintext, <code>nvarchar</code> text, <code>json</code> data, etc., all with different handling requirements.</p>
</div>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/core/qualifier/QualifiedType.html" target="_blank" rel="noopener">QualifiedType</a> allows you to add such context to a Java type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">QualifiedType.of(<span class="predefined-type">String</span>.class).with(Json.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>QualifiedType</code> still represents the <code>String</code> <em>type</em>, but <em>qualified</em> with the <a href="./apidocs/org/jdbi/v3/json/Json.html" target="_blank" rel="noopener">@Json</a> annotation.
It can be used in a way similar to <a href="#_generictype">GenericType</a>, to make components
handling values (mainly <code>ArgumentFactories</code> and <code>ColumnMapperFactories</code>) perform their work differently,
and to have the values handled by different implementations altogether:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Json</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">JsonArgumentFactory</span> <span class="directive">extends</span> AbstractArgumentFactory&lt;<span class="predefined-type">String</span>&gt; {
    <span class="annotation">@Override</span>
    <span class="directive">protected</span> Argument build(<span class="predefined-type">String</span> value, ConfigRegistry config) {
        <span class="comment">// do something specifically for json data</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once registered, this <a href="./apidocs/org/jdbi/v3/json/Json.html" target="_blank" rel="noopener">@Json</a> qualified factory will receive <strong>only</strong> <code>@Json String</code> values.
Other factories <em>not</em> qualified as such will <strong>not</strong> receive this value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">QualifiedType&lt;<span class="predefined-type">String</span>&gt; json = QualifiedType.of(<span class="predefined-type">String</span>.class).with(Json.class);
query.bindByType(<span class="string"><span class="delimiter">&quot;</span><span class="content">jsonValue</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">{</span><span class="char">\&quot;</span><span class="content">foo</span><span class="char">\&quot;</span><span class="content">:1}</span><span class="delimiter">&quot;</span></span>, json);</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Jdbi chooses factories to handle values by <strong>exactly matching</strong> their <em>qualifiers</em>. It&#8217;s up to the
factory implementations to discriminate on the <em>type</em> of the value afterward.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Qualifiers are implemented as <code>Annotations</code>. This allows factories to independently inspect values for qualifiers at the source,
such as on their <code>Class</code>, to alter their own behavior or to <em>requalify</em> a value
and have it re-evaluated by Jdbi&#8217;s lookup chain.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Qualifiers being annotations does <strong>not</strong> mean they inherently activate
their function when placed in source classes. Each feature decides its own
rules regarding their use.
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Arguments can only be qualified for binding via <code>bindByType</code> calls, not regular
<code>bind</code> or <code>update.execute(Object...)</code>. Also, arrays cannot be qualified.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>These features currently make use of qualified types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@NVarchar</code> and <code>@MacAddr</code> (the latter in <code>jdbi3-postgres</code>) bind and map Strings as <code>nvarchar</code> and <code>macaddr</code>
respectively, instead of the usual <code>varchar</code>.</p>
</li>
<li>
<p><code>jdbi3-postgres</code> offers <a href="#postgres-hstore">HStore</a>.</p>
</li>
<li>
<p><a href="#jdbi3-json">JSON</a></p>
</li>
<li>
<p><code>BeanMapper</code>, <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindBean.html" target="_blank" rel="noopener">@BindBean</a>, <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterBeanMapper.html" target="_blank" rel="noopener">@RegisterBeanMapper</a>, <code>mapTobean()</code>, and <code>bindBean()</code> respect qualifiers on getters, setters,
and setter parameters.</p>
</li>
<li>
<p><code>ConstructorMapper</code> and <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterConstructorMapper.html" target="_blank" rel="noopener">@RegisterConstructorMapper</a> respect qualifiers on constructor parameters.</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindMethods.html" target="_blank" rel="noopener">@BindMethods</a> and <code>bindMethods()</code> respect qualifiers on methods.</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindFields.html" target="_blank" rel="noopener">@BindFields</a>, <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterFieldMapper.html" target="_blank" rel="noopener">@RegisterFieldMapper</a>, <code>FieldMapper</code> and <code>bindFields()</code> respect qualifiers on fields.</p>
</li>
<li>
<p><code>SqlObject</code> respects qualifiers on methods (applies them to the return type) and parameters.</p>
<div class="ulist">
<ul>
<li>
<p>on parameters of type <a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Consumer.html" target="_blank" rel="noopener">Consumer&lt;T&gt;</a>, qualifiers are applied to the <code>T</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/statement/MapTo.html" target="_blank" rel="noopener">@MapTo</a></p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/jpa/BindJpa.html" target="_blank" rel="noopener">@BindJpa</a> and <code>JpaMapper</code> respect qualifiers on getters and setters.</p>
</li>
<li>
<p><code>@BindKotlin</code>, <code>bindKotlin()</code>, and <code>KotlinMapper</code> respect qualifiers on constructor parameters, getters, setters, and setter parameters.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="query-templating"><a class="anchor" href="#query-templating"></a><a class="link" href="#query-templating">14.3. Query Templating</a></h3>
<div class="paragraph">
<p>Binding query parameters, as described above, is excellent for sending a static set of parameters to the database engine.  Binding ensures that the parameterized query string (<code>... where foo = ?</code>) is transmitted to the database without allowing hostile parameter values to inject SQL.</p>
</div>
<div class="paragraph">
<p>Bound parameters are not always enough. Sometimes a query needs complicated or structural changes before being executed, and parameters just don&#8217;t cut it. Templating (using a <a href="./apidocs/org/jdbi/v3/core/statement/TemplateEngine.html" target="_blank" rel="noopener">TemplateEngine</a>) allows you to alter a query&#8217;s content with general String manipulations.</p>
</div>
<div class="paragraph">
<p>Typical uses for templating are optional or repeating segments (conditions and loops), complex variables such as comma-separated lists for IN clauses, and variable substitution for non-bindable SQL elements (like table names). Unlike <em>argument binding</em>, the <em>rendering</em> of <em>attributes</em> performed by TemplateEngines is <strong>not</strong> SQL-aware. Since they perform generic String manipulations, TemplateEngines can easily produce horribly mangled or subtly defective queries if you don&#8217;t use them carefully.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<a href="https://www.xkcd.com/327/" target="_blank" rel="noopener">Query templating is a common attack vector!</a> Always prefer binding parameters to static SQL over dynamic SQL when possible.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM &lt;TABLE&gt; WHERE name = :n</span><span class="delimiter">&quot;</span></span>)

    <span class="comment">// -&gt; &quot;SELECT * FROM Person WHERE name = :n&quot;</span>
    .define(<span class="string"><span class="delimiter">&quot;</span><span class="content">TABLE</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Person</span><span class="delimiter">&quot;</span></span>)

    <span class="comment">// -&gt; &quot;SELECT * FROM Person WHERE name = 'MyName'&quot;</span>
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">n</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">MyName</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Use a TemplateEngine to perform crude String manipulations on a query. Query parameters should be handled by Arguments.
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
TemplateEngines and SqlParsers operate sequentially: the initial String will be rendered by the TemplateEngine using attributes, then parsed by the SqlParser with Argument bindings.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the TemplateEngine outputs text matching the parameter format of the SqlParser, the parser will attempt to bind an Argument to it. This can be useful to e.g. have named parameters of which the name itself is also a variable, but can also cause confusing bugs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> paramName = <span class="string"><span class="delimiter">&quot;</span><span class="content">arg</span><span class="delimiter">&quot;</span></span>;

handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM Foo WHERE bar = :&lt;attr&gt;</span><span class="delimiter">&quot;</span></span>)
    .define(<span class="string"><span class="delimiter">&quot;</span><span class="content">attr</span><span class="delimiter">&quot;</span></span>, paramName)
    <span class="comment">// ...</span>
    .bind(paramName, <span class="string"><span class="delimiter">&quot;</span><span class="content">baz</span><span class="delimiter">&quot;</span></span>); <span class="comment">// &lt;- does not need to know the parameter's name (&quot;arg&quot;)!</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM emotion WHERE emoticon = &lt;sticker&gt;</span><span class="delimiter">&quot;</span></span>)
    .define(<span class="string"><span class="delimiter">&quot;</span><span class="content">sticker</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">:-)</span><span class="delimiter">&quot;</span></span>) <span class="comment">// -&gt; &quot;... WHERE emoticon = :-)&quot;</span>
    .mapToMap()
    <span class="comment">// exception: no binding/argument named &quot;-)&quot; present</span>
    .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Bindings and definitions are usually separate.  You can link them in a limited manner
using the <code>stmt.defineNamedBindings()</code> or <code>@DefineNamedBindings</code> customizers.
For each bound parameter (including bean properties), this will define a boolean which is <code>true</code> if the
binding is present and not <code>null</code>.  You can use this to
craft conditional updates and query clauses.</p>
</div>
<div class="paragraph">
<p>For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">MyBean</span> {
    <span class="type">long</span> id();
    <span class="predefined-type">String</span> getA();
    <span class="predefined-type">String</span> getB();
    Instant getModified();
}

handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">UPDATE mybeans SET &lt;if(a)&gt;a = :a,&lt;endif&gt; &lt;if(b)&gt;b = :b,&lt;endif&gt; modified=now() WHERE id=:id</span><span class="delimiter">&quot;</span></span>)
    .bindBean(mybean)
    .defineNamedBindings()
    .execute();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also see the section about <a href="#_templateengine">TemplateEngine</a>.</p>
</div>
<div class="sect3">
<h4 id="_classpathsqllocator"><a class="anchor" href="#_classpathsqllocator"></a><a class="link" href="#_classpathsqllocator">14.3.1. ClasspathSqlLocator</a></h4>
<div class="paragraph">
<p>You may find it helpful to store your SQL templates in individual files on the
classpath, rather than in string inside Java code.</p>
</div>
<div class="paragraph">
<p>The <code>ClasspathSqlLocator</code> converts Java type and method names into classpath locations,
and then reads, parses, and caches the loaded statements.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// reads classpath resource com/foo/BarDao/query.sql</span>
ClasspathSqlLocator.create().locate(com.foo.BarDao.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">query</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// same resource as above</span>
ClasspathSqlLocator.create().locate(<span class="string"><span class="delimiter">&quot;</span><span class="content">com.foo.BarDao.query</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, any comments in the loaded file are left untouched. Comments can be stripped out by
instantiating the <code>ClasspathSqlLocator</code> with the <code>removingComments()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// reads classpath resource com/foo/BarDao/query.sql, stripping all comments</span>
ClasspathSqlLocator.removingComments().locate(com.foo.BarDao.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">query</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// same resource as above</span>
ClasspathSqlLocator.removingComments().locate(<span class="string"><span class="delimiter">&quot;</span><span class="content">com.foo.BarDao.query</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple comment styles are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>C-style (<code>/* ... */</code> and <code>//</code> to the end of the line)</p>
</li>
<li>
<p>SQL style (<code>--</code> to the end of the line)</p>
</li>
<li>
<p>shell style (<code>#</code> to the end of the line; except when followed immediately by the <code>&gt;</code> character; this is required for the Postgres <code>#&gt;</code> and <code>#&gt;&gt;</code> operators).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each piece of core or extension that wishes to participate in
configuration defines a configuration class, for example the <code>SqlStatements</code>
class stores SqlStatement related configuration.  Then, on any <code>Configurable</code> context
(like a <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> or <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a>) you can change configuration in a type safe way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.getConfig(SqlStatements.class).setUnusedBindingAllowed(<span class="predefined-constant">true</span>);
jdbi.getConfig(Arguments.class).register(<span class="keyword">new</span> MyTypeArgumentFactory());
jdbi.getConfig(Handles.class).setForceEndTransactions(<span class="predefined-constant">true</span>);

<span class="comment">// Or, if you have a bunch of work to do:</span>
jdbi.configure(RowMappers.class, rm -&gt; {
    rm.register(<span class="keyword">new</span> TypeARowMapperFactory();
    rm.register(<span class="keyword">new</span> TypeBRowMapperFactory();
});</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_statement_caching"><a class="anchor" href="#_statement_caching"></a><a class="link" href="#_statement_caching">14.4. Statement caching</a></h3>
<div class="paragraph">
<p>Jdbi caches statement information in multiple places:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>preparsed SQL where placeholders have been replaced.</p>
</li>
<li>
<p>rendered statement templates if the template engine supports it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Caching can dramatically speed up the execution of statements. By default, Jdbi uses a simple LRU in-memory cache with 1,000 entries. This cache is sufficient for most use cases.</p>
</div>
<div class="paragraph">
<p>For applications than run a lot of different SQL operations, it is possible to use different cache implementations. Jdbi provides <a href="./apidocs/org/jdbi/v3/core/cache/package-summary.html" target="_blank" rel="noopener">a cache SPI</a> for this.</p>
</div>
<div class="paragraph">
<p>The following cache implementations are included:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>jdbi3-caffeine-cache</code> - using the <a href="https://github.com/ben-manes/caffeine" target="_blank" rel="noopener">Caffeine</a> cache library. This used to be the default cache up to version 3.36.0</p>
</li>
<li>
<p><code>jdbi3-noop-cache</code>, - disables caching. This is useful for testing and debugging.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A cache module can provide a plugin to enable it. Only one plugin can be in use at a time (last one installed wins):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// use the caffeine cache library</span>
jdbi.installPlugin(<span class="keyword">new</span> CaffeineCachePlugin());</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_using_custom_cache_instances"><a class="anchor" href="#_using_custom_cache_instances"></a><a class="link" href="#_using_custom_cache_instances">14.4.1. Using custom cache instances</a></h4>
<div class="paragraph">
<p>The default cache instances are installed when the Jdbi object is created. When using a cache plugin, the implementation is changed but only very few aspects of the cache can be modified.</p>
</div>
<div class="paragraph">
<p>Full customization is possible by creating the cache outside Jdbi and then use a cache builder adapter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// create a custom Caffeine cache</span>
JdbiCacheBuilder customCacheBuilder = <span class="keyword">new</span> CaffeineCacheBuilder(
    Caffeine.newBuilder()
        .maximumSize(<span class="integer">100</span>_000)
        .expireAfterWrite(<span class="integer">10</span>, <span class="predefined-type">TimeUnit</span>.MINUTES)
        .recordStats());

SqlStatements config = jdbi.getConfig(SqlStatements.class);
config.setTemplateCache(customCacheBuilder));
config.setSqlParser(<span class="keyword">new</span> ColonPrefixSqlParser(customCacheBuilder));</code></pre>
</div>
</div>
<div class="paragraph">
<p>When setting the caches explicitly, no cache plugin needs to be installed.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If the underlying cache library exposes per-cache statistics, these can be accessed through the <a href="./apidocs/org/jdbi/v3//core/statement/SqlStatements.html#cacheStats()" target="_blank" rel="noopener">SqlStatements#cacheStats()</a> and <a href="https://./apidocs/org/jdbi/v3/core/statement/CachingSqlParser.html#cacheStats()" target="_blank" rel="noopener">CachingSqlParser#cacheStats()</a> methods.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing"><a class="anchor" href="#_testing"></a><a class="link" href="#_testing">15. Testing</a></h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The official test support from Jdbi is in the <code>jdbi-testing</code> package. There are a number of additional JUnit 5 extensions in the <code>jdbi-core</code> test artifact. These are only intended for Jdbi internal use and not part of the official, public API.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_junit_4"><a class="anchor" href="#_junit_4"></a><a class="link" href="#_junit_4">15.1. JUnit 4</a></h3>
<div class="paragraph">
<p>The <code>jdbi3-testing</code> artifact provides <a href="./apidocs/org/jdbi/v3/testing/JdbiRule.html" target="_blank" rel="noopener">JdbiRule</a>
class which implements <a href="https://junit.org/junit4/javadoc/latest/org/junit/rules/TestRule.html" target="_blank" rel="noopener">TestRule</a> and can be used with the <a href="https://junit.org/junit4/javadoc/latest/org/junit/Rule.html" target="_blank" rel="noopener">Rule</a> and <a href="https://junit.org/junit4/javadoc/latest/org/junit/ClassRule.html" target="_blank" rel="noopener">ClassRule</a> annotations.</p>
</div>
<div class="paragraph">
<p>It provides helpers for writing JUnit 4 tests integrated with a managed database instance. This makes writing unit tests quick and easy!  You must remember to include the database dependency itself, for example to get a pure H2 Java database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>com.h2database<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>h2<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>2.1.212<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>JUnit 4 supports the OTJ embedded postgres component, which needs to be included when using Postgres:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>com.opentable.components<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>otj-pg-embedded<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>1.0.1<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;scope&gt;</span>test<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_junit_5"><a class="anchor" href="#_junit_5"></a><a class="link" href="#_junit_5">15.2. JUnit 5</a></h3>
<div class="paragraph">
<p>The <code>jdbi3-testing</code> artifact provides <a href="./apidocs/org/jdbi/v3/testing/junit5/JdbiExtension.html" target="_blank" rel="noopener">JdbiExtension</a> for JUnit 5 based tests.</p>
</div>
<div class="paragraph">
<p>It supports both the <a href="https://junit.org/junit5/docs/current/api/org.junit.jupiter.api/org/junit/jupiter/api/extension/RegisterExtension.html" target="_blank" rel="noopener">@RegisterExtension</a> and <a href="https://junit.org/junit5/docs/current/api/org.junit.jupiter.api/org/junit/jupiter/api/extension/ExtendWith.html" target="_blank" rel="noopener">@ExtendWith</a> annotations.</p>
</div>
<div class="paragraph">
<p>When using <a href="https://junit.org/junit5/docs/current/api/org.junit.jupiter.api/org/junit/jupiter/api/extension/RegisterExtension.html" target="_blank" rel="noopener">@RegisterExtension</a>, the extensions can be customized further:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Test</span> {
    <span class="annotation">@RegisterExtension</span>
    <span class="directive">public</span> JdbiExtension h2Extension = JdbiExtension.h2()
        withPlugin(<span class="keyword">new</span> SqlObjectPlugin());

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> testWithJunit5() {
        Jdbi jdbi = h2Extension.getJdbi();
        Handle handle = h2Extension.openHandle();
        <span class="comment">// ...</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/testing/junit5/JdbiExtension.html" target="_blank" rel="noopener">JdbiExtension</a> and all its database specific subclasses can be registered as instance fields or as class-level (static) fields.</p>
</div>
<div class="paragraph">
<p>When registered as an instance field, each test will get a new Jdbi instance. The in-memory database specific subclasses (H2, SQLite or HsqlDB with the generic extension) will reset their content and provide a new instance.</p>
</div>
<div class="paragraph">
<p>When registered as a static field, the extension will be initialized before all test methods are executed. All tests share the same extension instance and its associated fields. The in-memory database specific subclasses will retain their contents across multiple tests.</p>
</div>
<div class="paragraph">
<p>The javadoc page for <a href="./apidocs/org/jdbi/v3/testing/junit5/JdbiExtension.html" target="_blank" rel="noopener">JdbiExtension</a> contains additional information on how to customize a programmatically registered instance.</p>
</div>
<div class="paragraph">
<p>When using the <a href="https://junit.org/junit5/docs/current/api/org.junit.jupiter.api/org/junit/jupiter/api/extension/ExtendWith.html" target="_blank" rel="noopener">@ExtendWith</a> declarative extension, test methods can access the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> and <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> objects through method parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ExtendWith</span>(JdbiH2Extension.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Test</span> {
    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> testWithJunit5(Jdbi jdbi, Handle handle) {
        <span class="comment">// ...</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The instances injected are the same instances as returned by <a href="./apidocs/org/jdbi/v3/testing/junit5/JdbiExtension.html#getJdbi()" target="_blank" rel="noopener">getJdbi()</a> and <a href="./apidocs/org/jdbi/v3/testing/junit5/JdbiExtension.html#getSharedHandle()" target="_blank" rel="noopener">getSharedHandle()</a>.</p>
</div>
<div class="paragraph">
<p>Currently supported databases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.postgresql.org/" target="_blank" rel="noopener">Postgres</a> - <a href="./apidocs/org/jdbi/v3/testing/junit5/JdbiPostgresExtension.html" target="_blank" rel="noopener">JdbiPostgresExtension</a>, <a href="./apidocs/org/jdbi/v3/testing/junit5/JdbiExternalPostgresExtension.html" target="_blank" rel="noopener">JdbiExternalPostgresExtension</a>, <a href="./apidocs/org/jdbi/v3/testing/junit5/JdbiOtjPostgresExtension.html" target="_blank" rel="noopener">JdbiOtjPostgresExtension</a></p>
</li>
<li>
<p><a href="https://www.h2database.com/" target="_blank" rel="noopener">H2</a> - <a href="./apidocs/org/jdbi/v3/testing/junit5/JdbiH2Extension.html" target="_blank" rel="noopener">JdbiH2Extension</a></p>
</li>
<li>
<p><a href="https://www.sqlite.org/" target="_blank" rel="noopener">Sqlite</a> - <a href="./apidocs/org/jdbi/v3/testing/junit5/JdbiSqliteExtension.html" target="_blank" rel="noopener">JdbiSqliteExtension</a></p>
</li>
<li>
<p>Generic JDBC database support - <a href="./apidocs/org/jdbi/v3/testing/junit5/JdbiGenericExtension.html" target="_blank" rel="noopener">JdbiGenericExtension</a>. This is a minimal extension that can support any database that support JDBC. The driver for the database must be on the classpath. All database management (schema creation, DDL object management etc.) must be done by the calling code.</p>
</li>
<li>
<p><a href="https://testcontainers.org/" target="_blank" rel="noopener">Testcontainers</a> - <a href="./apidocs/org/jdbi/v3/testing/junit5/tc/JdbiTestcontainersExtension.html" target="_blank" rel="noopener">JdbiTestcontainersExtension</a>. See <a href="#_using_testcontainers">Using Testcontainers</a> for detailed documentation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Support for other databases wanted!</p>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/testing/junit5/JdbiExtension.html" target="_blank" rel="noopener">JdbiExtension</a> provides a number of convenience methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">JdbiExtension</span> {
    <span class="directive">public</span> JdbiExtension postgres(...) <span class="comment">// new JdbiPostgresExtension(...)</span>

    <span class="directive">public</span> JdbiExtension externalPostgres(...) <span class="comment">// new JdbiExternalPostgresExtension(...)</span>

    <span class="directive">public</span> JdbiExtension otjEmbeddedPostgres() <span class="comment">// new JdbiOtjPostgresExtension()</span>

    <span class="directive">public</span> JdbiExtension h2() <span class="comment">// new JdbiH2Extension()</span>

    <span class="directive">public</span> JdbiExtension sqlite() <span class="comment">// new JdbiSqliteExtension()</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additional functionality may be available by using the database specific implementation classes directly. For most common use cases, the convenience methods should suffice.</p>
</div>
<div class="sect3">
<h4 id="_testing_with_h2"><a class="anchor" href="#_testing_with_h2"></a><a class="link" href="#_testing_with_h2">15.2.1. Testing with H2</a></h4>
<div class="paragraph">
<p>The H2 database is one of the most popular choices for embedded testing. The <a href="./apidocs/org/jdbi/v3/testing/junit5/JdbiH2Extension.html" target="_blank" rel="noopener">JdbiH2Extension</a> class allows for a few additional customizations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// JdbiH2Extension(String) constructor allows H2 options</span>
<span class="comment">// JDBC URL is jdbc:h2:mem:&lt;UUID&gt;;MODE=MySQL</span>
JdbiH2Extension extension = <span class="keyword">new</span> JdbiH2Extension(<span class="string"><span class="delimiter">&quot;</span><span class="content">MODE=MySQL</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// set H2 user</span>
extension.withUser(<span class="string"><span class="delimiter">&quot;</span><span class="content">h2-user</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// set H2 user and password</span>
extension.withCredentials(<span class="string"><span class="delimiter">&quot;</span><span class="content">h2-user</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">h2-password</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_testing_with_postgres"><a class="anchor" href="#_testing_with_postgres"></a><a class="link" href="#_testing_with_postgres">15.2.2. Testing with Postgres</a></h4>
<div class="paragraph">
<p>Postgres is supported through multiple test classes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./apidocs/org/jdbi/v3/testing/junit5/JdbiPostgresExtension.html" target="_blank" rel="noopener">JdbiPostgresExtension</a> manages a local database on the host. It uses the <a href="https://pg-embedded.softwareforge.de/" target="_blank" rel="noopener">pg-embedded</a> library that can spin up Postgres instances on various OS and architectures. This is the fastest way to get to a Postgres instance. Most of the Jdbi test classes that use Postgres use this extension.</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/testing/junit5/JdbiExternalPostgresExtension.html" target="_blank" rel="noopener">JdbiExternalPostgresExtension</a> supports an external Postgres database and can run tests against any local or remote database.</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/testing/junit5/JdbiOtjPostgresExtension.html" target="_blank" rel="noopener">JdbiOtjPostgresExtension</a> supports the <a href="https://github.com/opentable/otj-pg-embedded" target="_blank" rel="noopener">OpenTable Java Embedded PostgreSQL component</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_testcontainers"><a class="anchor" href="#_using_testcontainers"></a><a class="link" href="#_using_testcontainers">15.3. Using Testcontainers</a></h3>
<div class="paragraph">
<p>The <a href="https://testcontainers.org" target="_blank" rel="noopener">Testcontainers</a> project provides a number of services as docker containers with a programmatic interface for JVM code. Jdbi supports JDBC type databases with the <a href="./apidocs/org/jdbi/v3/testing/junit5/tc/JdbiTestcontainersExtension.html" target="_blank" rel="noopener">JdbiTestcontainersExtension</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Testcontainers</span>
<span class="type">class</span> <span class="class">TestWithContainers</span> {
    <span class="annotation">@Container</span>
    <span class="directive">static</span> JdbcDatabaseContainer&lt;?&gt; dbContainer = <span class="keyword">new</span> YugabyteDBYSQLContainer(<span class="string"><span class="delimiter">&quot;</span><span class="content">yugabytedb/yugabyte</span><span class="delimiter">&quot;</span></span>);

    <span class="annotation">@RegisterExtension</span>
    JdbiExtension extension = JdbiTestcontainersExtension.instance(dbContainer);

    <span class="comment">// ... test code using the yugabyte engine</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/testing/junit5/tc/JdbiTestcontainersExtension.html" target="_blank" rel="noopener">JdbiTestcontainersExtension</a> has built-in support to isolate each test method in a test class. The container can be declared as a static class member which speeds up test execution significantly.</p>
</div>
<div class="paragraph">
<p>There is built-in support for MySQL, MariaDB, TiDB, PostgreSQL, CockroachDB, YugabyteDB, ClickHouse, Oracle XE and Trino. It also supports the various compatible flavors (such as PostGIS for PostgreSQL).</p>
</div>
<div class="sect3">
<h4 id="_providing_custom_database_information"><a class="anchor" href="#_providing_custom_database_information"></a><a class="link" href="#_providing_custom_database_information">15.3.1. Providing custom database information</a></h4>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/testing/junit5/tc/JdbiTestcontainersExtension.html" target="_blank" rel="noopener">JdbiTestcontainersExtension</a> creates a new database or schema (depending on the database engine) for each test. This speeds up test execution. In some cases (e.g. when using a not yet supported database engine or when using a custom docker image), it may be necessary to provide a custom instance of the <a href="./apidocs/org/jdbi/v3/testing/junit5/tc/TestcontainersDatabaseInformation.html" target="_blank" rel="noopener">TestcontainersDatabaseInformation</a> class that describes how to manage a specific database engine.</p>
</div>
<div class="paragraph">
<p>Here are examples for MySQL and PostgreSQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// MySQL has only databases, no schemata. The Jdbi extension creates a new database</span>
<span class="comment">// for each test method.</span>
<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> TestcontainersDatabaseInformation MYSQL = TestcontainersDatabaseInformation.of(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">root</span><span class="delimiter">&quot;</span></span>,  <span class="comment">// Testcontainers provides the 'root' superuser for MySQL instances.</span>
        <span class="predefined-constant">null</span>,    <span class="comment">// do not override the generated catalog name</span>
        <span class="predefined-constant">null</span>,    <span class="comment">// do not override the generated schema name (which is not used by MySQL)</span>
        <span class="comment">// create a new database from the catalog name</span>
        (catalogName, schemaName) -&gt; format(<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE DATABASE %s</span><span class="delimiter">&quot;</span></span>, catalogName)
);

<span class="comment">// PostgreSQL knows about schemata but needs to use the predefined &quot;test&quot; database.</span>
<span class="comment">// The Jdbi extension creates a new schema for each test method</span>
<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> TestcontainersDatabaseInformation POSTGRES = TestcontainersDatabaseInformation.of(
        <span class="predefined-constant">null</span>,   <span class="comment">// Use the default user that testcontainers provides</span>
        <span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>, <span class="comment">// override the generated catalog name with 'test'</span>
        <span class="predefined-constant">null</span>,   <span class="comment">// do not override the generated schema name</span>
        <span class="comment">// create a new schema from the schema name</span>
        (catalogName, schemaName) -&gt; format(<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE SCHEMA %s</span><span class="delimiter">&quot;</span></span>, schemaName)
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>See the Javadoc for the <a href="./apidocs/org/jdbi/v3/testing/junit5/tc/TestcontainersDatabaseInformation.html" target="_blank" rel="noopener">TestcontainersDatabaseInformation</a> class for further details.</p>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/testing/junit5/tc/JdbiTestcontainersExtension.html" target="_blank" rel="noopener">JdbiTestcontainersExtension</a> provides the <a href="./apidocs/org/jdbi/v3/testing/junit5/tc/JdbiTestcontainersExtension.html#instance(org.jdbi.v3.testing.junit5.tc.TestcontainersDatabaseInformation,org.testcontainers.containers.JdbcDatabaseContainer)" target="_blank" rel="noopener">instance(TestcontainersDatabaseInformation, JdbcDatabaseContainer)</a> method which uses a custom database information object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Testcontainers</span>
<span class="type">class</span> <span class="class">TestWithCustomContainer</span> {
    <span class="annotation">@Container</span>
    <span class="directive">static</span> JdbcDatabaseContainer&lt;?&gt; dbContainer = <span class="keyword">new</span> PostgreSQLContainer&lt;&gt;(
       DockerImageName.parse(<span class="string"><span class="delimiter">&quot;</span><span class="content">custom-image</span><span class="delimiter">&quot;</span></span>).asCompatibleSubstituteFor(<span class="string"><span class="delimiter">&quot;</span><span class="content">postgres</span><span class="delimiter">&quot;</span></span>));


    <span class="directive">static</span> <span class="directive">final</span> TestcontainersDatabaseInformation CUSTOM_DATABASE =
       TestcontainersDatabaseInformation.of( ... custom setup ...);

    <span class="annotation">@RegisterExtension</span>
    JdbiExtension extension = JdbiTestcontainersExtension.instance(CUSTOM_DATABASE, dbContainer);

    <span class="comment">// ... test code using the custom engine</span>
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_third_party_integration"><a class="anchor" href="#_third_party_integration"></a><a class="link" href="#_third_party_integration">16. Third-Party Integration</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="google-guava"><a class="anchor" href="#google-guava"></a><a class="link" href="#google-guava">16.1. Google Guava</a></h3>
<div class="paragraph">
<p>This plugin adds support for the following types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Optional&lt;T&gt;</code> - registers an argument and mapper. Supports <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html" target="_blank" rel="noopener">Optional</a> for any
wrapped type <code>T</code> for which a mapper / argument factory is registered.</p>
</li>
<li>
<p>Most Guava collection and map types - see
<a href="./apidocs/org/jdbi/v3/guava/GuavaCollectors.html" target="_blank" rel="noopener">GuavaCollectors</a> for a complete
 list of supported types.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To use this plugin, add a Maven dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>jdbi3-guava<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then install the plugin into the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.installPlugin(<span class="keyword">new</span> GuavaPlugin());</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the plugin installed, any supported Guava collection type can
be returned from a SQL object method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">select * from users order by name</span><span class="delimiter">&quot;</span></span>)
    ImmutableList&lt;User&gt; list();

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">select * from users where id = :id</span><span class="delimiter">&quot;</span></span>)
    com.google.common.base.Optional&lt;User&gt; getById(<span class="type">long</span> id);
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_h2_database"><a class="anchor" href="#_h2_database"></a><a class="link" href="#_h2_database">16.2. H2 Database</a></h3>
<div class="paragraph">
<p>This plugin configures Jdbi to correctly handle <code>integer[]</code> and <code>uuid[]</code> data
types in an H2 database.</p>
</div>
<div class="paragraph">
<p>This plugin is included with the core jar (but may be extracted to separate
artifact in the future). Use it by installing the plugin into your <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a>
instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.installPlugin(<span class="keyword">new</span> H2DatabasePlugin());</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="jdbi3-json"><a class="anchor" href="#jdbi3-json"></a><a class="link" href="#jdbi3-json">16.3. JSON</a></h3>
<div class="paragraph">
<p>The <code>jdbi3-json</code> module adds a <a href="./apidocs/org/jdbi/v3/json/Json.html" target="_blank" rel="noopener">@Json</a> type qualifier that allows to store arbitrary Java objects as JSON data in your database.</p>
</div>
<div class="paragraph">
<p>The actual JSON (de)serialization code is not included. For that, you must install a backing plugin (see below).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Backing plugins will install the <code>JsonPlugin</code> for you.
You do <strong>not</strong> need to install it yourself or include the <code>jdbi3-json</code> dependency directly.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The feature has been tested with Postgres <code>json</code> columns
and <code>varchar</code> columns in H2 and Sqlite.</p>
</div>
<div class="sect3">
<h4 id="_jackson_2"><a class="anchor" href="#_jackson_2"></a><a class="link" href="#_jackson_2">16.3.1. Jackson 2</a></h4>
<div class="paragraph">
<p>This plugin provides JSON backing through Jackson 2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>jdbi3-jackson2<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.installPlugin(<span class="keyword">new</span> Jackson2Plugin());
<span class="comment">// optionally configure your ObjectMapper (recommended)</span>
jdbi.getConfig(Jackson2Config.class).setMapper(myObjectMapper);

<span class="comment">// now with simple support for Json Views if you want to filter properties:</span>
jdbi.getConfig(Jackson2Config.class).setView(ApiProperty.class);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_gson_2"><a class="anchor" href="#_gson_2"></a><a class="link" href="#_gson_2">16.3.2. Gson 2</a></h4>
<div class="paragraph">
<p>This plugin provides JSON backing through Gson 2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>jdbi3-gson2<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.installPlugin(<span class="keyword">new</span> Gson2Plugin());
<span class="comment">// optional</span>
jdbi.getConfig(Gson2Config.class).setGson(myGson);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_moshi"><a class="anchor" href="#_moshi"></a><a class="link" href="#_moshi">16.3.3. Moshi</a></h4>
<div class="paragraph">
<p>This plugin provides JSON backing through Moshi.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>jdbi3-moshi<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.installPlugin(<span class="keyword">new</span> MoshiPlugin());
<span class="comment">// optional</span>
jdbi.getConfig(MoshiConfig.class).setMoshi(myMoshi);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_operation"><a class="anchor" href="#_operation"></a><a class="link" href="#_operation">16.3.4. Operation</a></h4>
<div class="paragraph">
<p>Any bound object qualified as <a href="./apidocs/org/jdbi/v3/json/Json.html" target="_blank" rel="noopener">@Json</a>
will be converted by the <a href="./apidocs/org/jdbi/v3/json/JsonConfig.html" target="_blank" rel="noopener">registered</a>
<a href="./apidocs/org/jdbi/v3/json/JsonMapper.html" target="_blank" rel="noopener">JsonMapper</a> and <em>requalified</em> as
<a href="./apidocs/org/jdbi/v3/json/EncodedJson.html" target="_blank" rel="noopener">@EncodedJson</a> <code>String</code>.
A corresponding <code>@EncodedJson ArgumentFactory</code> will then be called to store the JSON data,
allowing special JSON handling for your database to be implemented.
If none are found, a factory for plain <code>String</code> will be used instead, to handle the JSON as plaintext.</p>
</div>
<div class="paragraph">
<p>Mapping works just the same way, but in reverse: an output type qualified as <code>@Json T</code> will be fetched from a
<code>@EncodedJson String</code> or <code>String</code> ColumnMapper, and then passed through the <code>JsonMapper</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Our PostgresPlugin provides qualified factories that will
bind/map the <code>@EncodedJson String</code> to/from <code>json</code> or <code>jsonb</code>-typed columns.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_usage"><a class="anchor" href="#_usage"></a><a class="link" href="#_usage">16.3.5. Usage</a></h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">create table myjsons (id serial not null, value json not null)</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>SqlObject:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// any json-serializable type</span>
<span class="type">class</span> <span class="class">MyJson</span> {}

<span class="comment">// use @Json qualifier:</span>
<span class="type">interface</span> <span class="class">MyJsonDao</span> {
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO myjsons (json) VALUES(:value)</span><span class="delimiter">&quot;</span></span>)
    <span class="comment">// on parameters</span>
    <span class="type">int</span> insert(<span class="annotation">@Json</span> MyJson value);

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT value FROM myjsons</span><span class="delimiter">&quot;</span></span>)
    <span class="comment">// on result types</span>
    <span class="annotation">@Json</span>
    <span class="predefined-type">List</span>&lt;MyJson&gt; select();
}

<span class="comment">// also works on bean or property-mapped objects:</span>
<span class="type">class</span> <span class="class">MyBean</span> {
    <span class="directive">private</span> <span class="directive">final</span> MyJson property;
    <span class="annotation">@Json</span>
    <span class="directive">public</span> MyJson getProperty() { <span class="keyword">return</span> ...; }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the Fluent API, you provide a <code>QualifiedType&lt;T&gt;</code> any place you&#8217;d normally provide a <code>Class&lt;T&gt;</code> or <code>GenericType&lt;T&gt;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">QualifiedType&lt;MyJson&gt; qualifiedType = QualifiedType.of(MyJson.class).with(Json.class);

h.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO myjsons(json) VALUES(:json)</span><span class="delimiter">&quot;</span></span>)
    .bindByType(<span class="string"><span class="delimiter">&quot;</span><span class="content">json</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> MyJson(), qualifiedType)
    .execute();

MyJson result = h.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT json FROM myjsons</span><span class="delimiter">&quot;</span></span>)
    .mapTo(qualifiedType)
    .one();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_immutables"><a class="anchor" href="#_immutables"></a><a class="link" href="#_immutables">16.4. Immutables</a></h3>
<div class="paragraph">
<p><a href="https://immutables.github.io/" target="_blank" rel="noopener">Immutables</a> is an annotation processor that generates
value types based on simple interface descriptions.  The value types naturally map very well
to property binding and row mapping.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Immutables support is still experimental and does not yet support custom naming schemes.
We do support the configurable <code>get</code>, <code>is</code>, and <code>set</code> prefixes.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Just tell us about your types by installing the plugin and configuring your <code>Immutables</code> type:</p>
</div>
<div class="paragraph">
<p><code>jdbi.getConfig(JdbiImmutables.class).registerImmutable(MyValueType.class)</code></p>
</div>
<div class="paragraph">
<p>The configuration will both register appropriate <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper</a>&#8288;s as well as configure the new <code>bindPojo</code> (or <code>@BindPojo</code>) binders:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Value</span>.Immutable
<span class="directive">public</span> <span class="type">interface</span> <span class="class">Train</span> {

    <span class="predefined-type">String</span> name();

    <span class="type">int</span> carriages();

    <span class="type">boolean</span> observationCar();
}

<span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> simpleTest() {
    jdbi.getConfig(JdbiImmutables.class).registerImmutable(Train.class);
    <span class="keyword">try</span> (Handle handle = jdbi.open()) {
        handle.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">create table train (name varchar, carriages int, observation_car boolean)</span><span class="delimiter">&quot;</span></span>);

        assertThat(
            handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">insert into train(name, carriages, observation_car) values (:name, :carriages, :observationCar)</span><span class="delimiter">&quot;</span></span>)
                .bindPojo(ImmutableTrain.builder().name(<span class="string"><span class="delimiter">&quot;</span><span class="content">Zephyr</span><span class="delimiter">&quot;</span></span>).carriages(<span class="integer">8</span>).observationCar(<span class="predefined-constant">true</span>).build())
                .execute())
            .isOne();

        assertThat(
            handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">select * from train</span><span class="delimiter">&quot;</span></span>)
                .mapTo(Train.class)
                .one())
            .extracting(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">carriages</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">observationCar</span><span class="delimiter">&quot;</span></span>)
            .containsExactly(<span class="string"><span class="delimiter">&quot;</span><span class="content">Zephyr</span><span class="delimiter">&quot;</span></span>, <span class="integer">8</span>, <span class="predefined-constant">true</span>);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_freebuilder"><a class="anchor" href="#_freebuilder"></a><a class="link" href="#_freebuilder">16.5. Freebuilder</a></h3>
<div class="paragraph">
<p><a href="https://freebuilder.inferred.org/" target="_blank" rel="noopener">Freebuilder</a> is an annotation
processor that generates value types based on simple interface or abstract
class descriptions. Jdbi supports Freebuilder in much the same way that it
supports Immutables.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Freebuilder support is still experimental and may not support all Freebuilder
implemented features. We do support both JavaBean style getters and setters as
well as unprefixed getters and setters.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Just tell us about your Freebuilder types by installing the plugin and
configuring your <code>Freebuilder</code> type:</p>
</div>
<div class="paragraph">
<p><code>jdbi.getConfig(JdbiFreebuilder.class).registerFreebuilder(MyFreeBuilderType.class)</code></p>
</div>
<div class="paragraph">
<p>The configuration will both register appropriate <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper</a>s as well as
configure the new <code>bindPojo</code> (or <code>@BindPojo</code>) binders:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@FreeBuilder</span>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">Train</span> {
    <span class="predefined-type">String</span> name();
    <span class="type">int</span> carriages();
    <span class="type">boolean</span> observationCar();

    <span class="type">class</span> <span class="class">Builder</span> <span class="directive">extends</span> FreeBuildersTest_Train_Builder {}
}

<span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> simpleTest() {
    jdbi.getConfig(JdbiFreeBuilders.class).registerFreeBuilder(Train.class);
    <span class="keyword">try</span> (Handle handle = jdbi.open()) {
        handle.execute(<span class="string"><span class="delimiter">&quot;</span><span class="content">create table train (name varchar, carriages int, observation_car boolean)</span><span class="delimiter">&quot;</span></span>);

        Train train = <span class="keyword">new</span> Train.Builder()
            .name(<span class="string"><span class="delimiter">&quot;</span><span class="content">Zephyr</span><span class="delimiter">&quot;</span></span>)
            .carriages(<span class="integer">8</span>)
            .observationCar(<span class="predefined-constant">true</span>)
            .build();

        assertThat(
            handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">insert into train(name, carriages, observation_car) values (:name, :carriages, :observationCar)</span><span class="delimiter">&quot;</span></span>)
                .bindPojo(train)
                .execute())
            .isOne();

        assertThat(
            handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">select * from train</span><span class="delimiter">&quot;</span></span>)
                .mapTo(Train.class)
                .one())
            .extracting(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">carriages</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">observationCar</span><span class="delimiter">&quot;</span></span>)
            .containsExactly(<span class="string"><span class="delimiter">&quot;</span><span class="content">Zephyr</span><span class="delimiter">&quot;</span></span>, <span class="integer">8</span>, <span class="predefined-constant">true</span>);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jodatime"><a class="anchor" href="#_jodatime"></a><a class="link" href="#_jodatime">16.6. JodaTime</a></h3>
<div class="paragraph">
<p>This plugin adds support for using joda-time&#8217;s <code>DateTime</code> type.</p>
</div>
<div class="paragraph">
<p>To use this plugin, add a Maven dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>jdbi3-jodatime2<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then install the plugin into the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.installPlugin(<span class="keyword">new</span> JodaTimePlugin());</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_google_guice"><a class="anchor" href="#_google_guice"></a><a class="link" href="#_google_guice">16.7. Google Guice</a></h3>
<div class="paragraph">
<p>The Guice module adds support for configuring and injecting <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instances in applications and services that use the <a href="https://github.com/google/guice/wiki" target="_blank" rel="noopener">Google Guice</a> dependency injection framework.</p>
</div>
<div class="paragraph">
<p>Guice support for Jdbi is split into two module types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>A Jdbi definition module</strong> extends the <a href="./apidocs/org/jdbi/v3/guice/AbstractJdbiDefinitionModule.html" target="_blank" rel="noopener">AbstractJdbiDefinitionModule</a> class. Each of these modules creates a new <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance which is exposed into the Guice binding process using an annotation.</p>
</li>
<li>
<p><strong>A Jdbi element configuration module</strong> extends the <a href="./apidocs/org/jdbi/v3/guice/AbstractJdbiConfigurationModule.html" target="_blank" rel="noopener">AbstractJdbiConfigurationModule</a>. These modules contribute elements that are referenced in Jdbi definition modules.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Jdbi definition modules are by far more common. Element configuration modules are completely optional. They are most useful in larger projects.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_jsr_330_vs_jee_9_annotations"><a class="anchor" href="#_jsr_330_vs_jee_9_annotations"></a><a class="link" href="#_jsr_330_vs_jee_9_annotations">16.7.1. JSR 330 vs. JEE 9+ annotations</a></h4>
<div class="paragraph">
<p>For a long time, Java used the <a href="https://javax-inject.github.io/javax-inject/" target="_blank" rel="noopener">JSR-330</a> annotations in the <code>javax.inject</code> namespace to define dependency injections. The <a href="https://jakarta.ee/release/9/" target="_blank" rel="noopener">Java Enterprise Edition 9</a> specification updated the dependency injection specification to <a href="https://jakarta.ee/specifications/dependency-injection/2.0/" target="_blank" rel="noopener">version 2.0</a>, which changed the namespace to <code>jakarta.inject</code>.</p>
</div>
<div class="paragraph">
<p>The <code>jdbi3-guice</code> module supports all Google Guice releases since 5.x including 6.x (which uses <code>javax.inject</code> annotations) and 7.x (which uses <code>jakarta.inject</code>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_definition_modules"><a class="anchor" href="#_definition_modules"></a><a class="link" href="#_definition_modules">16.7.2. Definition modules</a></h4>
<div class="paragraph">
<p>Every <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance is defined in its own Guice module which extends the <a href="./apidocs/org/jdbi/v3/guice/AbstractJdbiDefinitionModule.html" target="_blank" rel="noopener">AbstractJdbiDefinitionModule</a> base class.</p>
</div>
<div class="paragraph">
<p>The  annotation instance or class used on the constructor is used to bind the resulting Jdbi object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">GuiceJdbiModule</span> <span class="directive">extends</span> AbstractJdbiDefinitionModule {

    <span class="directive">public</span> GuiceJdbiModule() {
        <span class="local-variable">super</span>(GuiceJdbi.class);
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="type">void</span> configureJdbi() {
        <span class="comment">// bind a custom row mapper</span>
        bindRowMapper().to(CustomRowMapper.class);

        <span class="comment">// bind a custom column mapper</span>
        bindColumnMapper().toInstance(<span class="keyword">new</span> CustomColumnMapper());

        <span class="comment">// bind a Codec</span>
        bindCodec(<span class="predefined-type">String</span>.class).to(<span class="predefined-type">Key</span>.get(CustomStringCodec.class, Custom.class));

        <span class="comment">// bind a custom array type</span>
        bindArrayType(CustomArrayType.class).toInstance(<span class="string"><span class="delimiter">&quot;</span><span class="content">custom_array</span><span class="delimiter">&quot;</span></span>);

        <span class="comment">// bind a jdbi plugin</span>
        bindPlugin().toInstance(<span class="keyword">new</span> SqlObjectPlugin());

        <span class="comment">// bind a customizer</span>
        bindCustomizer().to(SpecialCustomizer.class);
    }
}

<span class="type">class</span> <span class="class">Application</span> {
    <span class="annotation">@Inject</span>
    <span class="annotation">@GuiceJdbi</span>
    <span class="directive">private</span> Jdbi jdbi;

    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span> ... args) {
        Injector inj = Guice.createInjector(
            <span class="keyword">new</span> GuiceJdbiModule(),
)           binder -&gt; binder.bind(<span class="predefined-type">DataSource</span>.class).annotatedWith(GuiceJdbi.class).toInstance(... data source instance ...);
        );
        inj.injectMembers(<span class="local-variable">this</span>);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, a new <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> object is defined using specific mappers and other customizations. The <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> object is exposed to Guice using the annotation passed on the module constructor (<code>GuiceJdbi</code> in the example). The <a href="./apidocs/org/jdbi/v3/guice/AbstractJdbiDefinitionModule.html" target="_blank" rel="noopener">AbstractJdbiDefinitionModule</a> supports both annotation instances and classes, similar to Guice itself.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A Jdbi definition module requires that a DataSource object is bound within Guice using the same annotation or annotation class as is passed into the module constructor. <strong>Creating this data source is outside the scope of a Jdbi definition module!</strong>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When implementing the <a href="./apidocs/org/jdbi/v3/guice/AbstractJdbiDefinitionModule.html#jdbiBinder()" target="_blank" rel="noopener">configureJdbi()</a> method, a number of convenience methods are available as shown above. These methods return Guice LinkedBindingBuilder instances and allow the full range of bindings that guice supports (classes, instances, providers etc).</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Supported bindings</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Type of binding</th>
<th class="tableblock halign-left valign-top">Jdbi function</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/guice/JdbiBinder.html#bindRowMapper()" target="_blank" rel="noopener">bindRowMapper()</a></p></td>
<td class="tableblock halign-left valign-top" rowspan="3"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper&lt;?&gt;</a></p></td>
<td class="tableblock halign-left valign-top" rowspan="3"><p class="tableblock"><a href="#_row_mappers">Row Mappers</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/guice/JdbiBinder.html#bindRowMapper(org.jdbi.v3.core.generic.GenericType)" target="_blank" rel="noopener">bindRowMapper(GenericType&lt;?&gt;)</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/guice/JdbiBinder.html#bindRowMapper(java.lang.reflect.Type)" target="_blank" rel="noopener">bindRowMapper(Type)</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/guice/JdbiBinder.html#bindColumnMapper()" target="_blank" rel="noopener">bindColumnMapper()</a></p></td>
<td class="tableblock halign-left valign-top" rowspan="4"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/mapper/ColumnMapper.html" target="_blank" rel="noopener">ColumnMapper&lt;?&gt;</a></p></td>
<td class="tableblock halign-left valign-top" rowspan="4"><p class="tableblock"><a href="#_column_mappers">Column Mappers</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/guice/JdbiBinder.html#bindColumnMapper(org.jdbi.v3.core.qualifier.QualifiedType)" target="_blank" rel="noopener">bindColumnMapper(QualifiedType&lt;?&gt;)</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/guice/JdbiBinder.html#bindColumnMapper(org.jdbi.v3.core.generic.GenericType)" target="_blank" rel="noopener">bindColumnMapper(GenericType&lt;?&gt;)</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/guice/JdbiBinder.html#bindColumnMapper(java.lang.reflect.Type)" target="_blank" rel="noopener">bindColumnMapper(Type)</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/guice/JdbiBinder.html#bindCodec(org.jdbi.v3.core.qualifier.QualifiedType)" target="_blank" rel="noopener">bindCodec(QualifiedType&lt;?&gt;)</a></p></td>
<td class="tableblock halign-left valign-top" rowspan="3"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/codec/Codec.html" target="_blank" rel="noopener">Codec&lt;?&gt;</a></p></td>
<td class="tableblock halign-left valign-top" rowspan="3"><p class="tableblock"><a href="#_codecs">Codecs</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/guice/JdbiBinder.html#bindCodec(org.jdbi.v3.core.generic.GenericType)" target="_blank" rel="noopener">bindCodec(GenericType&lt;?&gt;)</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/guice/JdbiBinder.html#bindCodec(java.lang.reflect.Type)" target="_blank" rel="noopener">bindCodec(Type)</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/guice/JdbiBinder.html#bindArrayType(java.lang.Class)" target="_blank" rel="noopener">bindArrayType(Class&lt;?&gt;)</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_registering_array_types">Registering array types</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/guice/JdbiBinder.html#bindPlugin()" target="_blank" rel="noopener">bindPlugin()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/core/spi/JdbiPlugin.html" target="_blank" rel="noopener">JdbiPlugin</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_installing_plugins">Installing Plugins</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/guice/JdbiBinder.html#bindCustomizer()" target="_blank" rel="noopener">bindCustomizer()</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./apidocs/org/jdbi/v3/guice/GuiceJdbiCustomizer.html" target="_blank" rel="noopener">GuiceJdbiCustomizer</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#_jdbi_customization_using_guice">Jdbi customization using Guice</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Each Jdbi definition module is completely independent and all definitions within the module only apply to the specific <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_guice_injection_in_jdbi_classes"><a class="anchor" href="#_using_guice_injection_in_jdbi_classes"></a><a class="link" href="#_using_guice_injection_in_jdbi_classes">16.7.3. Using Guice injection in Jdbi classes</a></h4>
<div class="paragraph">
<p>The Jdbi related guice modules store the various related elements (mappers, codecs etc.) using <a href="https://github.com/google/guice/wiki/Multibindings" target="_blank" rel="noopener">Multibindings</a>. As a result, it is not possible to use injection directly when constructing mapper instances.</p>
</div>
<div class="paragraph">
<p>The following example <strong>does not work</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">JdbiModule</span> <span class="directive">extends</span> AbstractJdbiDefinitionModule {

    <span class="directive">public</span> JdbiModule() {
        <span class="local-variable">super</span>(Names.named(<span class="string"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>));
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="type">void</span> configureJdbi() {
        bindRowMapper().to(BrokenRowMapper.class);
        bindColumnMapper().to(CustomStringMapper.class);
    }
}

<span class="type">class</span> <span class="class">CustomStringMapper</span> <span class="directive">implements</span> ColumnMapper&lt;<span class="predefined-type">String</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> map(<span class="predefined-type">ResultSet</span> r, <span class="type">int</span> columnNumber, StatementContext ctx) {
        <span class="type">long</span> x = r.getLong(columnNumber);
        <span class="keyword">return</span> (x &gt; <span class="integer">1000</span>) ? <span class="string"><span class="delimiter">&quot;</span><span class="content">Huge</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">Small</span><span class="delimiter">&quot;</span></span>;
    }
}

<span class="type">class</span> <span class="class">BrokenRowMapper</span> <span class="directive">implements</span> <span class="predefined-type">RowMapper</span>&lt;DataRow&gt; {

    <span class="directive">private</span> <span class="directive">final</span> ColumnMapper&lt;<span class="predefined-type">String</span>&gt; stringMapper;

    <span class="annotation">@Inject</span>
    <span class="directive">public</span> BrokenRowMapper(CustomStringMapper stringMapper) {
        <span class="local-variable">this</span>.stringMapper = stringMapper;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> DataRow map(<span class="predefined-type">ResultSet</span> rs, StatementContext ctx) {
        <span class="keyword">return</span> <span class="keyword">new</span> DataRow(rs.getInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">intValue</span><span class="delimiter">&quot;</span></span>),
                stringMapper.map(rs, <span class="string"><span class="delimiter">&quot;</span><span class="content">longValue</span><span class="delimiter">&quot;</span></span>, ctx));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Guice will report an error that it cannot locate the <code>CustomStringMapper</code> instance. The Guice Jdbi integration manages mappers etc. as groups and the separate instances are not directly accessible for injection. The right way to compose mappers is using the Jdbi configuration (see <a href="#_jdbiconfig">JdbiConfig</a>), which is configured through Guice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">JdbiModule</span> <span class="directive">extends</span> AbstractJdbiDefinitionModule {

    <span class="directive">public</span> JdbiModule() {
        <span class="local-variable">super</span>(Names.named(<span class="string"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>));
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="type">void</span> configureJdbi() {
        bindRowMapper().to(WorkingRowMapper.class);
        bindColumnMapper(CustomStringMapper.TYPE).to(CustomStringMapper.class);
    }
}

<span class="type">class</span> <span class="class">CustomStringMapper</span> <span class="directive">implements</span> ColumnMapper&lt;<span class="predefined-type">String</span>&gt; {

    <span class="directive">public</span> <span class="directive">static</span> QualifiedType&lt;<span class="predefined-type">String</span>&gt; TYPE = QualifiedType.of(<span class="predefined-type">String</span>.class).with(Names.named(<span class="string"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>));

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> map(<span class="predefined-type">ResultSet</span> r, <span class="type">int</span> columnNumber, StatementContext ctx) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        <span class="type">long</span> x = r.getLong(columnNumber);
        <span class="keyword">return</span> (x &gt; <span class="integer">1000</span>) ? <span class="string"><span class="delimiter">&quot;</span><span class="content">Huge</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">Small</span><span class="delimiter">&quot;</span></span>;
    }
}

<span class="type">class</span> <span class="class">WorkingRowMapper</span> <span class="directive">implements</span> <span class="predefined-type">RowMapper</span>&lt;DataRow&gt; {

    <span class="directive">private</span> ColumnMapper&lt;<span class="predefined-type">String</span>&gt; stringMapper;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> init(ConfigRegistry registry) {
        <span class="local-variable">this</span>.stringMapper = registry.get(ColumnMappers.class).findFor(CustomStringMapper.TYPE)
                .orElseThrow(<span class="exception">IllegalStateException</span>::<span class="keyword">new</span>);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> DataRow map(<span class="predefined-type">ResultSet</span> rs, StatementContext ctx) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        <span class="keyword">return</span> <span class="keyword">new</span> DataRow(rs.getInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">intValue</span><span class="delimiter">&quot;</span></span>),
            stringMapper.map(rs, <span class="string"><span class="delimiter">&quot;</span><span class="content">longValue</span><span class="delimiter">&quot;</span></span>, ctx));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This limitation <strong>only</strong> applies to bindings that are made in through the various <code>bindXXX()</code> methods in Jdbi specific modules. Any other binding is available for injection into Jdbi elements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">ThresholdMapper</span> <span class="directive">implements</span> ColumnMapper&lt;<span class="predefined-type">String</span>&gt; {

    <span class="directive">public</span> <span class="directive">static</span> QualifiedType&lt;<span class="predefined-type">String</span>&gt; TYPE = QualifiedType.of(<span class="predefined-type">String</span>.class).with(Threshold.class);

    <span class="directive">private</span> <span class="directive">final</span> <span class="type">long</span> threshold;

    <span class="comment">// Injection of a named constant here.</span>
    <span class="annotation">@Inject</span>
    ThresholdMapper(<span class="annotation">@Threshold</span> <span class="type">long</span> threshold) {
        <span class="local-variable">this</span>.threshold = threshold;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> map(<span class="predefined-type">ResultSet</span> r, <span class="type">int</span> columnNumber, StatementContext ctx) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        <span class="type">long</span> x = r.getLong(columnNumber);
        <span class="keyword">return</span> (x &gt; threshold) ? <span class="string"><span class="delimiter">&quot;</span><span class="content">Huge</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">Small</span><span class="delimiter">&quot;</span></span>;
    }
}

<span class="type">class</span> <span class="class">JdbiModule</span> <span class="directive">extends</span> AbstractJdbiDefinitionModule {

    <span class="directive">public</span> JdbiModule() {
        <span class="local-variable">super</span>(Data.class);
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="type">void</span> configureJdbi() {
        bindColumnMapper(CustomStringMapper.TYPE).to(CustomStringMapper.class);
    }
}

Injector inj = Guice.createInjector(
    <span class="keyword">new</span> JdbiModule(),
    <span class="comment">// define injected constant here</span>
    binder -&gt; binder.bindConstant().annotatedWith(Threshold.class).to(<span class="integer">5000L</span>);
)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jdbi_customization_using_guice"><a class="anchor" href="#_jdbi_customization_using_guice"></a><a class="link" href="#_jdbi_customization_using_guice">16.7.4. Jdbi customization using Guice</a></h4>
<div class="paragraph">
<p>Many Jdbi specific settings can be configured through the <code>bindXXX()</code> methods available on Jdbi modules (row mappers, column mappers, codecs, plugins etc.)</p>
</div>
<div class="paragraph">
<p>However, there are additional features that may not be available through these methods. For these use cases, the <a href="./apidocs/org/jdbi/v3/guice/GuiceJdbiCustomizer.html" target="_blank" rel="noopener">GuiceJdbiCustomizer</a> interface can be used.</p>
</div>
<div class="paragraph">
<p>Instances that implement this interface can be added to Jdbi modules using the <a href="./apidocs/org/jdbi/v3/guice/JdbiBinder.html#bindCustomizer()" target="_blank" rel="noopener">bindCustomizer()</a> method.</p>
</div>
<div class="paragraph">
<p>Every customizer will get the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance passed at construction time and may modify any aspect before it gets exposed to other parts of the application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">GuiceCustomizationModule</span> <span class="directive">extends</span> AbstractJdbiDefinitionModule {

    <span class="directive">public</span> GuiceCustomizationModule() {
        <span class="local-variable">super</span>(Custom.class);
    }

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="type">void</span> configureJdbi() {
        bindCustomizer().to(MyCustomizer.class);
    }
}

<span class="type">class</span> <span class="class">MyCustomizer</span> <span class="directive">implements</span> GuiceJdbiCustomizer {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> customize(Jdbi jdbi) {
        <span class="comment">// set the logger to use Slf4j</span>
        jdbi.setSqlLogger(<span class="keyword">new</span> Slf4JSqlLogger());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In combination with Jdbi configuration modules, these customizers allow easy enforcement of standard configurations for all Jdbi instances in larger projects.</p>
</div>
</div>
<div class="sect3">
<h4 id="_element_configuration_modules"><a class="anchor" href="#_element_configuration_modules"></a><a class="link" href="#_element_configuration_modules">16.7.5. Element configuration modules</a></h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Element configuration modules are completely optional and should not be used when only a single Jdbi instance is required. They are intended to help with code organization in larger projects that have more complex needs.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All bindings in a Jdbi module that defines a <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> object are local to that module. This is useful if all Jdbi related code can be grouped around the module. In larger projects, some parts of the code (and their Jdbi related elements such as row and column mappers) may be located in different part of the code base.</p>
</div>
<div class="paragraph">
<p>In larger projects, generic mappers should be available for multiple Jdbi instances. This leads often to a proliferation of small modules that only contain such generic code and is in turn imported into every code module that wants to use them.</p>
</div>
<div class="paragraph">
<p>To support modular code design, any part of a code base that wants to contribute Jdbi specific classes such as mappers to the overall system can use an element configuration module to expose these to all Jdbi instances in a project.</p>
</div>
<div class="paragraph">
<p>Jdbi element configuration modules extend <a href="./apidocs/org/jdbi/v3/guice/AbstractJdbiConfigurationModule.html" target="_blank" rel="noopener">AbstractJdbiConfigurationModule</a> and can define mappers, plugins etc. similar to a Jdbi definition module. Anything that is registered in such a module is global and will be applied to all instances even if they are defined in another module.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">DomainModule</span> <span class="directive">extends</span> AbstractJdbiConfigurationModule {

    <span class="annotation">@Override</span>
    <span class="directive">protected</span> <span class="type">void</span> configureJdbi() {
        bindRowMapper().to(DomainMapper.class);
    }
}

<span class="type">class</span> <span class="class">DomainMapper</span> <span class="directive">implements</span> <span class="predefined-type">RowMapper</span>&lt;DomainObject&gt; {

    <span class="directive">private</span> ColumnMapper&lt;<span class="predefined-type">UUID</span>&gt; uuidMapper;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> init(ConfigRegistry registry) {
        <span class="local-variable">this</span>.uuidMapper = registry.get(ColumnMappers.class).findFor(<span class="predefined-type">UUID</span>.class)
                .orElseThrow(<span class="exception">IllegalStateException</span>::<span class="keyword">new</span>);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> DomainObject map(<span class="predefined-type">ResultSet</span> rs, StatementContext ctx) <span class="directive">throws</span> <span class="exception">SQLException</span> {
        <span class="keyword">return</span> <span class="keyword">new</span> DomainObject(
            uuidMapper.map(rs, <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, ctx),
            rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>),
            rs.getString(<span class="string"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>),
            rs.getInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span>),
            rs.getBoolean(<span class="string"><span class="delimiter">&quot;</span><span class="content">flag</span><span class="delimiter">&quot;</span></span>));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>DomainModule</code> is bound within Guice, then all configured <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instances will be able to map DomainObject instances without having to configure them explicitly as a row mapper.</p>
</div>
<div class="paragraph">
<p>Multiple modules extending <a href="./apidocs/org/jdbi/v3/guice/AbstractJdbiConfigurationModule.html" target="_blank" rel="noopener">AbstractJdbiConfigurationModule</a> can be installed in a single injector; the resulting bindings will be aggregated.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
It is not possible to install a configuration module from within the <code>configureJdbi</code> method of a definition module using the <code>install()</code> or <code>binder().install()</code> methods!
Definition modules are Guice private modules and anything defined within them will not be exposed to the general dependency tree. This is a limitation due to the way Guice works.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_advanced_topics"><a class="anchor" href="#_advanced_topics"></a><a class="link" href="#_advanced_topics">16.7.6. Advanced Topics</a></h4>
<div class="sect4">
<h5 id="_exposing_additional_bindings"><a class="anchor" href="#_exposing_additional_bindings"></a><a class="link" href="#_exposing_additional_bindings">Exposing additional bindings</a></h5>
<div class="paragraph">
<p>Each definition module that defines a <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance keeps all bindings private and exposes only the actual <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> object itself. This allows the installation of multiple modules where each definition is completely independent. Sometimes it is useful to attach additional objects and expose them using the same annotations. The most common use cases are data access objects.</p>
</div>
<div class="paragraph">
<p>Consider a use case where two DataSource instances exist, one annotated as <code>Writer</code> and the other as <code>Reader</code>. Both are accessing databases with the same schema, and it makes sense to have two data access objects that are identical except that they are using the different data sources (this is often referred to as the "robot legs" problem of dependency injection).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">DatabaseAccess</span> {
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO data_table ....</span><span class="delimiter">&quot;</span></span>)
    <span class="type">int</span> insert(...);

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM data_table</span><span class="delimiter">&quot;</span></span>)
    Data select();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To bind two instances of this data access object and connect each to the appropriate Jdbi instance, add the binding to the Jdbi definition module and expose it with <a href="./apidocs/org/jdbi/v3/guice/AbstractJdbiDefinitionModule.html#exposeBinding(java.lang.Class)" target="_blank" rel="noopener">exposeBinding(Class&lt;?&gt;)</a> or <a href="./apidocs/org/jdbi/v3/guice/AbstractJdbiDefinitionModule.html#exposeBinding(com.google.inject.TypeLiteral)" target="_blank" rel="noopener">exposeBinding(TypeLiteral&lt;?&gt;)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">DatabaseModule</span> <span class="directive">extends</span> AbstractJdbiDefinitionModule {
    <span class="directive">public</span> DatabaseModule(<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">Annotation</span>&gt; a) {
        <span class="local-variable">super</span>(a);
    }

    <span class="annotation">@Provides</span>
    <span class="annotation">@Singleton</span>
    DatabaseAccess createDatabaseAccess(Jdbi jdbi) {
        <span class="keyword">return</span> jdbi.onDemand(DatabaseAccess.class);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configureJdbi() {
        <span class="comment">// ... bind mappers, plugins etc. ...</span>

        exposeBinding(DatabaseAccess.class);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now install the module multiple times with different annotation classes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Injector injector = Guice.createInjector(
    <span class="comment">// bind existing data sources</span>
    binder -&gt; binder.bind(<span class="predefined-type">DataSource</span>.class).annotatedWith(<span class="predefined-type">Reader</span>.class).toInstance(...);
    binder -&gt; binder.bind(<span class="predefined-type">DataSource</span>.class).annotatedWith(<span class="predefined-type">Writer</span>.class).toInstance(...);

    <span class="keyword">new</span> DatabaseModule(<span class="predefined-type">Reader</span>.class),
    <span class="keyword">new</span> DatabaseModule(<span class="predefined-type">Writer</span>.class)
);

<span class="comment">// fetch object directly from the injector</span>
DatabaseAccess readerAccess = injector.getInstance(<span class="predefined-type">Key</span>.get(DatabaseAccess.class, <span class="predefined-type">Reader</span>.class));
DatabaseAccess writerAccess = injector.getInstance(<span class="predefined-type">Key</span>.get(DatabaseAccess.class, <span class="predefined-type">Writer</span>.class));</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_importing_external_bindings"><a class="anchor" href="#_importing_external_bindings"></a><a class="link" href="#_importing_external_bindings">Importing external bindings</a></h5>
<div class="paragraph">
<p>The main use case of guice is code modularization and code reuse. Jdbi definition modules can pull dependencies out of the global dependency definitions and using the <code>importBinding</code> and <code>importBindingLoosely</code> methods.</p>
</div>
<div class="paragraph">
<p><code>importBinding</code> requires a dependency to exist and pulls it into the definition module. The dependency must be defined using the same annotation or annotation class as the definition module uses.</p>
</div>
<div class="paragraph">
<p>This example shows how to define an external dependency (<code>SpecialLogger</code>, annotated with <code>Store</code>) in a different module and then pull it into the definition module using <code>importBinding</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">//</span>
<span class="comment">// This is logging code that can be located e.g. in a specific part of the code base that</span>
<span class="comment">// deals with all aspects of logging. The Logging module creates the binding for the special</span>
<span class="comment">// logger depending on the environment that the code has been deployed in.</span>
<span class="type">class</span> <span class="class">LoggingModule</span> <span class="directive">extends</span> AbstractModule {

    <span class="directive">private</span> <span class="directive">final</span> <span class="type">boolean</span> production;
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">Annotation</span>&gt; annotation;

    LoggingModule(<span class="type">boolean</span> production, <span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">Annotation</span>&gt; annotation) {
        <span class="local-variable">this</span>.production = production;
        <span class="local-variable">this</span>.annotation = annotation;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configure() {
        <span class="keyword">if</span> (production) {
            bind(SpecialLogger.class).annotatedWith(annotation).toInstance(<span class="keyword">new</span> MaskingLogger());
        } <span class="keyword">else</span> {
            bind(SpecialLogger.class).annotatedWith(annotation).toInstance(<span class="keyword">new</span> DebugLogger());
        }
    }
}

<span class="comment">//</span>
<span class="comment">// This is Jdbi code that deals with the data store. It can be located in a different part of the</span>
<span class="comment">// application. It requires the &quot;SpecialLogger&quot; dependency to be bound somewhere.</span>
<span class="comment">//</span>
<span class="annotation">@Singleton</span>
<span class="type">class</span> <span class="class">JdbiSpecialLogging</span> <span class="directive">implements</span> GuiceJdbiCustomizer {

    <span class="directive">private</span> <span class="directive">final</span> SpecialLogger logger;

    <span class="annotation">@Inject</span>
    JdbiSpecialLogging(SpecialLogger logger) {
        <span class="local-variable">this</span>.logger = logger;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> customize(Jdbi jdbi) {
        jdbi.setSqlLogger(<span class="keyword">new</span> SpecialSqlLogger(logger));
    }
}

<span class="type">class</span> <span class="class">DatabaseModule</span> <span class="directive">extends</span> AbstractJdbiDefinitionModule {
    <span class="directive">public</span> DatabaseModule(<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> <span class="predefined-type">Annotation</span>&gt; a) {
        <span class="local-variable">super</span>(a);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configureJdbi() {
        ... bind mappers, plugins etc. ...

        <span class="comment">// pull the &quot;SpecialLogger&quot; annotated with Store into the module scope</span>
        importBinding(SpecialLogger.class).in(Scopes.SINGLETON);
        bindCustomizer().to(JdbiSpecialLogging.class);
    }
}


Injector injector = Guice.createInjector(
    <span class="keyword">new</span> LoggingModule(production, Store.class),
    <span class="keyword">new</span> DatabaseModule(Store.class)
)</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>importBinding</code> returns a binding builder, that allows different binding styles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">DatabaseModule</span> <span class="directive">extends</span> AbstractJdbiDefinitionModule {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configureJdbi() {
         <span class="comment">// simplest use case, pull in Foo.class using the same annotation</span>
        importBinding(Foo.class);

         <span class="comment">// supports everything that a ScopedBindingBuilder does</span>
        importBinding(Foo.class).in(Scopes.SINGLETON);

         <span class="comment">// supports &quot;to()&quot; to bind interfaces to implementation</span>
        importBinding(Foo.class).to(FooImpl.class);

         <span class="comment">// supports type literals</span>
        importBinding(<span class="keyword">new</span> TypeLiteral&lt;<span class="predefined-type">Set</span>&lt;Foo&gt;&gt;() {}).to(FooSet.class);

        <span class="comment">// supports binding into the various binder methods as well</span>

        <span class="comment">// pull SpecialCustomizer using the same annotation as the module and add it to the set of customizers</span>
        importBinding(bindCustomizer(), SpecialCustomizer.class).in(Scopes.SINGLETON);

        <span class="comment">// bind column mapper using a type literal</span>
        importBinding(bindColumnMapper(), <span class="keyword">new</span> TypeLiteral&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;&gt;() {}).to(JsonMapper.class);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Static bindings require that the dependency is always defined. However, it is often desirable to have optional bindings that do not need to exist. This is supported using the <code>importLooseBinding</code> mechanism.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">DropwizardStoreModule</span> <span class="directive">extends</span> AbstractModule {

    <span class="annotation">@Store</span>
    <span class="annotation">@Provides</span>
    <span class="annotation">@Singleton</span>
    DropwizardJdbiSupport getDropwizardJdbiSupport(<span class="annotation">@Dropwizard</span> DataSourcConfiguration configuration, <span class="annotation">@Dropwizard</span> Environment environment) {
            <span class="keyword">return</span> <span class="keyword">new</span> DropwizardJdbiSupport(<span class="string"><span class="delimiter">&quot;</span><span class="content">store</span><span class="delimiter">&quot;</span></span>, configuration, environment);
    }

    <span class="directive">static</span> <span class="type">class</span> <span class="class">DropwizardJdbiSupport</span> <span class="directive">implements</span> GuiceJdbiCustomizer {
        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> name;
        <span class="directive">private</span> <span class="directive">final</span> Environment environment;
        <span class="directive">private</span> <span class="directive">final</span> DataSourceConfiguration&lt;?&gt; configuration;


    DropwizardJdbiSupport(<span class="predefined-type">String</span> name, DataSourceConfiguration configuration, Environment environment) {
        <span class="local-variable">this</span>.name = name;
        <span class="local-variable">this</span>.configuration = configuration;
        <span class="local-variable">this</span>.environment = environment;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> customize(<span class="directive">final</span> Jdbi jdbi) {
        <span class="directive">final</span> <span class="predefined-type">String</span> validationQuery = configuration.getValidationQuery();
        environment.healthChecks().register(name, <span class="keyword">new</span> JdbiHealthCheck(
                environment.getHealthCheckExecutorService(),
                configuration.getValidationQueryTimeout().orElse(<span class="predefined-type">Duration</span>.seconds(<span class="integer">5</span>)),
                jdbi,
                Optional.of(validationQuery)));
    }
}

<span class="type">class</span> <span class="class">StoreJdbiModule</span> <span class="directive">extends</span> AbstractJdbiDefinitionModule {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configureJdbi() {
        <span class="comment">// ... other Jdbi code bindings for the store ...</span>

        importBindingLoosely(bindCustomizer(), GuiceJdbiCustomizer.class)
                .withDefault(GuiceJdbiCustomizer.NOP)
                .to(DropwizardJdbiSupport.class);
    }
}

<span class="comment">// production code (running in dropwizard framework)</span>
Injector injector = Guice.createInjector(
    <span class="keyword">new</span> DropwizardModule(),      <span class="comment">// binds @Dropwizard stuff</span>
    <span class="keyword">new</span> DropwizardStoreModule(), <span class="comment">// binds dropwizard support for store jdbi</span>
    <span class="keyword">new</span> StoreDataSourceModule(), <span class="comment">// binds @Store DataSource</span>
    <span class="keyword">new</span> StoreJdbiModule()        <span class="comment">// Store Jdbi code</span>
);

<span class="comment">// test code</span>
Injector injector = Guice.createInjector(
    <span class="keyword">new</span> StoreTestingDataSourceModule(), <span class="comment">// testing datasource for store</span>
    <span class="keyword">new</span> StoreJdbiModule()               <span class="comment">// store Jdbi code</span>
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example there is code specific to the dropwizard framework that would not work in unit tests (that are not run within the framework). This code is only bound in the production environment using the <code>DropwizardStoreModule</code> and not present in testing.</p>
</div>
<div class="paragraph">
<p>The <code>StoreJdbiModule</code> uses <code>importBindingLoosely</code> to pull in the <code>DropwizardJdbiSupport</code> binding using the <code>Store</code> annotation if it exists or uses a No-Op otherwise.</p>
</div>
<div class="paragraph">
<p><code>importBindingLoosely</code> allows for full decoupling of optional dependencies without having to resort to conditionals or separate testing modules.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">DatabaseModule</span> <span class="directive">extends</span> AbstractJdbiDefinitionModule {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configureJdbi() {
         <span class="comment">// simplest use case, pull in Foo.class using the same annotation</span>
        importBindingLoosely(Foo.class);

         <span class="comment">// supports everything that a ScopedBindingBuilder does</span>
        importBindingLoosely(Foo.class).in(Scopes.SINGLETON);

         <span class="comment">// supports &quot;to()&quot; to bind interfaces to implementation</span>
        importBindingLoosely(Foo.class).to(FooImpl.class);

        <span class="comment">// supports default value that is used if the binding</span>
        <span class="comment">// is not present</span>
        importBindingLoosely(Foo.class)
            .withDefault(<span class="keyword">new</span> Foo(<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span>));

         <span class="comment">// supports type literals</span>
        importBindingLoosely(<span class="keyword">new</span> TypeLiteral&lt;<span class="predefined-type">Set</span>&lt;Foo&gt;&gt;() {}).to(FooSet.class);

        <span class="comment">// supports binding into the various binder methods as well</span>

        <span class="comment">// pull SpecialCustomizer using the same annotation as the module and add it to the set of customizers</span>
        importBindingLoosely(bindCustomizer(), SpecialCustomizer.class).in(Scopes.SINGLETON);

        <span class="comment">// bind column mapper using a type literal</span>
        importBindingLoosely(bindColumnMapper(), <span class="keyword">new</span> TypeLiteral&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;&gt;() {}).to(JsonMapper.class);

        <span class="comment">// full example</span>
        importBindingLoosely(bindCustomizer(), GuiceJdbiCustomizer.class)
            .withDefault(GuiceJdbiCustomizer.NOP)
            .to(SpecialCustomizer.class)
            .asEagerSingleton();
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_custom_element_configuration_modules"><a class="anchor" href="#_custom_element_configuration_modules"></a><a class="link" href="#_custom_element_configuration_modules">Custom element configuration modules</a></h5>
<div class="paragraph">
<p>In larger projects, <a href="#_element_configuration_modules">Element configuration modules</a> help to organize the various Jdbi related elements. By default, all modules contribute their configuration to a single, global configuration that is used in all Jdbi definition modules.</p>
</div>
<div class="paragraph">
<p>Sometimes it is useful to create separate configurations that only affect a subset of Jdbi definitions. This can be done by using a custom annotation for both the Jdbi element configuration and the Jdbi definition modules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">CustomConfigurationModule</span> <span class="directive">extends</span> AbstractJdbiConfigurationModule {

    CustomModule() {
        <span class="local-variable">super</span>(CustomConfiguration.class); <span class="comment">// definition modules must use this annotation explictly</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configureJdbi() {
        bindColumnMapper().to(CustomColumnMapper.class);
        bindPlugin().to(SpecialDatabaseModule.class);
    }
}

<span class="type">class</span> <span class="class">SpecialDatabaseModule</span> <span class="directive">extends</span> AbstractJdbiDefinitionModule {

    SpecialDatabaseModule() {
        <span class="local-variable">super</span>(
            SpecialDatabase.class,     <span class="comment">// The Jdbi instance is bound using this annotation class</span>
            CustomConfiguration.class  <span class="comment">// Use an explicit configuration</span>
        );
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configureJdbi() {
        ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Jdbi element bound with the <code>SpecialDatabase</code> annotation will have the <code>SpecialDatabaseModule</code> loaded and can use the <code>CustomColumnMapper</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jpa"><a class="anchor" href="#_jpa"></a><a class="link" href="#_jpa">16.8. JPA</a></h3>
<div class="paragraph">
<p>Using the JPA plugin is a great way to trick your boss into letting you try
Jdbi. "No problem boss, it already supports JPA annotations, easy-peasy!"</p>
</div>
<div class="paragraph">
<p>This plugin adds mapping support for a small subset of JPA entity annotations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Entity</p>
</li>
<li>
<p>MappedSuperclass</p>
</li>
<li>
<p>Column</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To use this plugin, add a Maven dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>jdbi3-jpa<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then install the plugin into the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.installPlugin(<span class="keyword">new</span> JpaPlugin());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Honestly though&#8230;&#8203; just tear off the bandage and switch to Jdbi proper.</p>
</div>
</div>
<div class="sect2">
<h3 id="_kotlin"><a class="anchor" href="#_kotlin"></a><a class="link" href="#_kotlin">16.9. Kotlin</a></h3>
<div class="paragraph">
<p><a href="https://kotlinlang.org/" target="_blank" rel="noopener">Kotlin</a> support is provided by <strong>jdbi3-kotlin</strong> and
<strong>jdbi3-kotlin-sqlobject</strong> modules.</p>
</div>
<div class="paragraph">
<p>Kotlin API documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="apidocs-kotlin/jdbi3-kotlin/index.html" target="_blank" rel="noopener">jdbi3-kotlin</a></p>
</li>
<li>
<p><a href="apidocs-kotlin/jdbi3-kotlin-sqlobject/index.html" target="_blank" rel="noopener">jdbi3-kotlin-sqlobject</a></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_resultset_mapping"><a class="anchor" href="#_resultset_mapping"></a><a class="link" href="#_resultset_mapping">16.9.1. ResultSet Mapping</a></h4>
<div class="paragraph">
<p>The <strong>jdbi3-kotlin</strong> plugin adds mapping to Kotlin data classes. It
supports data classes where all fields are present in the constructor as well
as classes with writable properties. Any fields not present in the constructor
will be set after the constructor call. The mapper supports nullable types. It
also uses default parameter values in the constructor if the parameter type is
not nullable and the value absent in the result set.</p>
</div>
<div class="paragraph">
<p>To use this plugin, add a Maven dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>jdbi3-kotlin<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ensure the Kotlin compiler&#8217;s <a href="https://kotlinlang.org/docs/reference/using-maven.html#attributes-specific-for-jvm" target="_blank" rel="noopener">JVM target version</a> is set to at least 11:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;kotlin.compiler.jvmTarget&gt;</span>11<span class="tag">&lt;/kotlin.compiler.jvmTarget&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then install the plugin into the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">jdbi.installPlugin(KotlinPlugin());</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Kotlin mapper also supports <a href="./apidocs/org/jdbi/v3/core/mapper/reflect/ColumnName.html" target="_blank" rel="noopener">@ColumnName</a> annotation that allows to specify name for a property or parameter explicitly, as well as the <a href="./apidocs/org/jdbi/v3/core/mapper/Nested.html" target="_blank" rel="noopener">@Nested</a> annotation that allows mapping nested Kotlin objects.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Instead of using <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindBean.html" target="_blank" rel="noopener">@BindBean</a>, <code>bindBean()</code>, and <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterBeanMapper.html" target="_blank" rel="noopener">@RegisterBeanMapper</a> use <code>@BindKotlin</code>, <code>bindKotlin()</code>, and <code>KotlinMapper</code>
for qualifiers on constrictor parameters, getter, setters, and setter parameters of Kotlin class.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <a href="./apidocs/org/jdbi/v3/core/mapper/reflect/ColumnName.html" target="_blank" rel="noopener">@ColumnName</a> annotation only applies while mapping SQL data into Java objects.
When binding object properties (e.g. with <code>bindBean()</code>), bind the property name (<code>:id</code>) rather than the column name (<code>:user_id</code>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you load all Jdbi plugins via <code>Jdbi.installPlugins()</code> this plugin will be
discovered and registered automatically. Otherwise, you can attach it using
<code>Jdbi.installPlugin(KotlinPlugin())</code>.</p>
</div>
<div class="paragraph">
<p>An example from the test class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">data class IdAndName(val id: Int, val name: String)
data class Thing(
    @Nested val idAndName: IdAndName,
    val nullable: String?,
    val nullableDefaultedNull: String? = null,
    val nullableDefaultedNotNull: String? = &quot;not null&quot;,
    val defaulted: String = &quot;default value&quot;
)
@Test
fun testFindById() {
    val qry = h2Extension.sharedHandle.createQuery(&quot;select id, name from something where id = :id&quot;)
    val things: List&lt;Thing&gt; = qry.bind(&quot;id&quot;, brian.idAndName.id).mapTo&lt;Thing&gt;().list()
    assertEquals(1, things.size)
    assertEquals(brian, things[0])
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two extensions to help:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;reified T : Any&gt;ResultBearing.mapTo()</code></p>
</li>
<li>
<p><code>&lt;T : Any&gt;ResultIterable&lt;T&gt;.useSequence(block: (Sequence&lt;T&gt;) &#8594; Unit)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Allowing code like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">val qry = handle.createQuery(&quot;SELECT id, name FROM something WHERE id = :id&quot;)
val things = qry.bind(&quot;id&quot;, brian.id).mapTo&lt;Thing&gt;.list()</code></pre>
</div>
</div>
<div class="paragraph">
<p>and for using a Sequence that is auto closed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">qryAll.mapTo&lt;Thing&gt;.useSequence {
    it.forEach(::println)
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sqlobject"><a class="anchor" href="#_sqlobject"></a><a class="link" href="#_sqlobject">16.9.2. SqlObject</a></h4>
<div class="paragraph">
<p>The <strong>jdbi3-kotlin-sqlobject</strong> plugin adds automatic parameter binding by name
for Kotlin methods in SqlObjects as well as support for Kotlin default methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>jdbi3-kotlin-sqlobject<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then install the plugin into the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">jdbi.installPlugin(KotlinSqlObjectPlugin());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Parameter binding supports individual primitive types as well as Kotlin or
JavaBean style objects as a parameter (referenced in binding as
<code>:paramName.propertyName</code>). No annotations are needed.</p>
</div>
<div class="paragraph">
<p>If you load all Jdbi plugins via <code>Jdbi.installPlugins()</code> this plugin will be
discovered and registered automatically. Otherwise, you can attach the plugin
via: <code>Jdbi.installPlugin(KotlinSqlObjectPlugin())</code>.</p>
</div>
<div class="paragraph">
<p>An example from the test class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">interface ThingDao {
    @SqlUpdate(&quot;insert into something (id, name) values (:something.idAndName.id, :something.idAndName.name)&quot;)
    fun insert(something: Thing)

    @SqlQuery(&quot;select id, name from something&quot;)
    fun list(): List&lt;Thing&gt;
}
@BeforeEach
fun setUp() {
    val dao = h2Extension.jdbi.onDemand&lt;ThingDao&gt;()

    val brian = Thing(IdAndName(1, &quot;Brian&quot;), null)
    val keith = Thing(IdAndName(2, &quot;Keith&quot;), null)

    dao.insert(brian)
    dao.insert(keith)
}
@Test
fun testDao() {
    val dao = h2Extension.jdbi.onDemand&lt;ThingDao&gt;()

    val rs = dao.list()

    assertEquals(2, rs.size.toLong())
    assertEquals(brian, rs[0])
    assertEquals(keith, rs[1])
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jackson_json_processing"><a class="anchor" href="#_jackson_json_processing"></a><a class="link" href="#_jackson_json_processing">16.9.3. Jackson JSON Processing</a></h4>
<div class="paragraph">
<p>Jackson needs a specialized ObjectMapper instance in order to understand deserialization
of Kotlin types. Make sure to configure your Jackson plugin:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">import com.fasterxml.jackson.module.kotlin.jacksonObjectMapper
jdbi.getConfig(Jackson2Config::class.java).mapper = jacksonObjectMapper()</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lombok"><a class="anchor" href="#_lombok"></a><a class="link" href="#_lombok">16.10. Lombok</a></h3>
<div class="paragraph">
<p>Lombok is a tool for auto-generation of mutable and immutable data classes through annotations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Data</span>
<span class="directive">public</span> <span class="type">void</span> DataClass {
    <span class="directive">private</span> <span class="predefined-type">Long</span> id;
    <span class="directive">private</span> <span class="predefined-type">String</span> name;
    <span class="comment">// autogenerates default constructor, getters, setters, equals, hashCode, and toString</span>
}

<span class="annotation">@Value</span>
<span class="directive">public</span> <span class="type">void</span> ValueClass {
    <span class="directive">private</span> <span class="type">long</span> id;
    <span class="directive">private</span> <span class="predefined-type">String</span> name;
    <span class="comment">// autogenerates all-args constructor, getters, equals, hashCode, and toString</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Classes annotated with <code>@Value</code> are immutable, classes annotated with <code>@Data</code> behave like standard, mutable Java Beans.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use <code>BeanMapper</code> or <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterBeanMapper.html" target="_blank" rel="noopener">@RegisterBeanMapper</a> to map <code>@Data</code> classes.</p>
</li>
<li>
<p>Use <code>ConstructorMapper</code> or <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterConstructorMapper.html" target="_blank" rel="noopener">@RegisterConstructorMapper</a> to map <code>@Value</code>
classes.</p>
</li>
<li>
<p>Use <code>bindBean()</code> or <code>@BindBean</code> to bind <code>@Data</code> or <code>@Value</code> classes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Lombok must be configured to propagate annotations from the source code into the generated classes. Since version 1.18.4, lombok
supports the <code>lombok.copyableAnnotations</code> setting in its config file. To support all Jdbi features, the following lines must be added:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">lombok.copyableAnnotations += org.jdbi.v3.core.mapper.reflect.ColumnName
lombok.copyableAnnotations += org.jdbi.v3.core.mapper.Nested
lombok.copyableAnnotations += org.jdbi.v3.core.mapper.PropagateNull
lombok.copyableAnnotations += org.jdbi.v3.core.annotation.JdbiProperty
lombok.copyableAnnotations += org.jdbi.v3.core.mapper.reflect.JdbiConstructor</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any additional annotation (such as the <code>@HStore</code> annotation for PostgreSQL support) can also be added:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">lombok.copyableAnnotations += org.jdbi.v3.postgres.HStore</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using any of the Json mappers (<a href="#_jackson_2">Jackson 2</a>, <a href="#_gson_2">Gson 2</a> or <a href="#_moshi">Moshi</a> ) with lombok, the <a href="./apidocs/org/jdbi/v3/json/Json.html" target="_blank" rel="noopener">@Json</a> annotation must also be added to the lombok config file, otherwise Jdbi can not map json columns to lombok bean properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">lombok.copyableAnnotations += org.jdbi.v3.json.Json</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_oracle_12"><a class="anchor" href="#_oracle_12"></a><a class="link" href="#_oracle_12">16.11. Oracle 12</a></h3>
<div class="paragraph">
<p>This module adds support for Oracle <code>RETURNING</code> DML expressions.</p>
</div>
<div class="paragraph">
<p>To use this feature, add a Maven dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>jdbi3-oracle12<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, use the <code>OracleReturning</code> class with an <a href="./apidocs/org/jdbi/v3/core/statement/Update.html" target="_blank" rel="noopener">Update</a> or <code>PreparedBatch</code>
to get the returned DML.</p>
</div>
</div>
<div class="sect2">
<h3 id="_postgresql"><a class="anchor" href="#_postgresql"></a><a class="link" href="#_postgresql">16.12. PostgreSQL</a></h3>
<div class="paragraph">
<p>The <strong>jdbi3-postgres</strong> plugin provides enhanced integration with the
<a href="https://jdbc.postgresql.org/" target="_blank" rel="noopener">PostgreSQL JDBC Driver</a>.</p>
</div>
<div class="paragraph">
<p>To use this feature, add a Maven dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>jdbi3-postgres<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then install the plugin into the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Jdbi jdbi = Jdbi.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:postgresql://host:port/database</span><span class="delimiter">&quot;</span></span>)
                .installPlugin(<span class="keyword">new</span> PostgresPlugin());</code></pre>
</div>
</div>
<div class="paragraph">
<p>The plugin configures mappings for <a href="https://docs.oracle.com/javase/8/docs/api/java/time/package-summary.html" target="_blank" rel="noopener">java.time</a> types like
<a href="https://docs.oracle.com/javase/8/docs/api/java/time/Instant.html" target="_blank" rel="noopener">Instant</a> or <a href="https://docs.oracle.com/javase/8/docs/api/java/time/Duration.html" target="_blank" rel="noopener">Duration</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/net/InetAddress.html" target="_blank" rel="noopener">InetAddress</a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/util/UUID.html" target="_blank" rel="noopener">UUID</a>, typed enums, and <a href="#postgres-hstore">hstore</a>.</p>
</div>
<div class="paragraph">
<p>It also configures SQL array type support for <code>int</code>, <code>long</code>, <code>float</code>, <code>double</code>,
<code>String</code>, and <code>UUID</code>.</p>
</div>
<div class="paragraph">
<p>See the <a href="./apidocs/org/jdbi/v3/postgres/package-summary.html" target="_blank" rel="noopener">javadoc</a> for an
exhaustive list.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Some Postgres operators, for example the <code>?</code> query operator, collide
with Jdbi or JDBC specific special characters.  In such cases, you may need to
escape operators to e.g. <code>??</code> or <code>\:</code>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="postgres-hstore"><a class="anchor" href="#postgres-hstore"></a><a class="link" href="#postgres-hstore">16.12.1. hstore</a></h4>
<div class="paragraph">
<p>The Postgres plugin provides an <code>hstore</code> to <code>Map&lt;String, String&gt;</code> column mapper
and vice versa argument factory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; accountAttributes = handle
    .select(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT attributes FROM account WHERE id = ?</span><span class="delimiter">&quot;</span></span>, userId)
    .mapTo(<span class="keyword">new</span> GenericType&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;&gt;() {})
    .one();</code></pre>
</div>
</div>
<div class="paragraph">
<p>With <code>@HStore</code> qualified type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">QualifiedType&lt;&gt; HSTORE_MAP = QualifiedType.of(<span class="keyword">new</span> GenericType&lt;<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;&gt;() {})
    .with(HStore.class);

<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; caps = handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">UPDATE account SET attributes = :hstore</span><span class="delimiter">&quot;</span></span>)
    .bindByType(<span class="string"><span class="delimiter">&quot;</span><span class="content">hstore</span><span class="delimiter">&quot;</span></span>, mapOfStrings, HSTORE_MAP)
    .execute();</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, SQL Object treats <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html" target="_blank" rel="noopener">Map</a> return types as a collection of <code>Map.Entry</code>
values. Use the <a href="./apidocs/org/jdbi/v3/sqlobject/SingleValue.html" target="_blank" rel="noopener">@SingleValue</a> annotation to override this, so that the return
type is treated as a single value instead of a collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">AccountDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT attributes FROM account WHERE id = ?</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@SingleValue</span>
    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; getAccountAttributes(<span class="type">long</span> accountId);
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The default variant to install the plugin adds unqualified mappings of raw <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html" target="_blank" rel="noopener">Map</a> types from and to the <code>hstore</code> Postgres data type. There are situations where this interferes with other mappings of maps. It is recommended to always use the variant with the <code>@HStore</code> qualified type.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To avoid binding the unqualified Argument and ColumnMapper bindings, install the plugin using the static factory method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Jdbi jdbi = Jdbi.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:postgresql://host:port/database</span><span class="delimiter">&quot;</span></span>)
                .installPlugin(PostgresPlugin.noUnqualifiedHstoreBindings());</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="postgres-getgeneratedkeys"><a class="anchor" href="#postgres-getgeneratedkeys"></a><a class="link" href="#postgres-getgeneratedkeys">16.12.2. @GetGeneratedKeys Annotation</a></h4>
<div class="paragraph">
<p>In Postgres, <a href="./apidocs/org/jdbi/v3/sqlobject/statement/GetGeneratedKeys.html" target="_blank" rel="noopener">@GetGeneratedKeys</a> can return the entire modified row if you request generated keys without naming any columns.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name, created_on) VALUES (nextval('user_seq'), ?, now())</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@GetGeneratedKeys</span>
    <span class="annotation">@RegisterBeanMapper</span>(User.class)
    User insert(<span class="predefined-type">String</span> name);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a database operation modifies multiple rows (e.g. an update that will modify
several rows), your method can return all the modified rows in a collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">UserDao</span> {
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">UPDATE users SET active = false WHERE id = any(?)</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@GetGeneratedKeys</span>
    <span class="annotation">@RegisterBeanMapper</span>(User.class)
    <span class="predefined-type">List</span>&lt;User&gt; deactivateUsers(<span class="type">long</span>... userIds);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_large_objects"><a class="anchor" href="#_large_objects"></a><a class="link" href="#_large_objects">16.12.3. Large Objects</a></h4>
<div class="paragraph">
<p>Postgres supports storing large character or binary data in separate storage from
table data.  Jdbi allows you to stream this data in and out of the database as part
of an enclosing transaction.  Operations for storing, reading, and a hook for deletions are provided.
The test case serves as a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> blobCrud(<span class="predefined-type">InputStream</span> myStream) <span class="directive">throws</span> <span class="exception">IOException</span> {
    h.useTransaction(th -&gt; {
        Lobject lob = th.attach(Lobject.class);
        lob.insert(<span class="integer">1</span>, myStream);
        readItBack = lob.readBlob(<span class="integer">1</span>);
        lob.deleteLob(<span class="integer">1</span>);
        <span class="keyword">assert</span> lob.readBlob(<span class="integer">1</span>) == <span class="predefined-constant">null</span>;
    });
}

<span class="directive">public</span> <span class="type">interface</span> <span class="class">Lobject</span> {
    <span class="comment">// CREATE TABLE lob (id int, lob oid</span>
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO lob (id, lob) VALUES (:id, :blob)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> insert(<span class="type">int</span> id, <span class="predefined-type">InputStream</span> blob);

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT lob FROM lob WHERE id = :id</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">InputStream</span> readBlob(<span class="type">int</span> id);

    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">DELETE FROM lob WHERE id = :id RETURNING lo_unlink(lob)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">void</span> deleteLob(<span class="type">int</span> id);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please refer to
<a href="https://jdbc.postgresql.org/documentation/head/binary-data.html" target="_blank" rel="noopener">Pg-JDBC docs</a>
for upstream driver documentation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spring_5"><a class="anchor" href="#_spring_5"></a><a class="link" href="#_spring_5">16.13. Spring 5</a></h3>
<div class="paragraph">
<p>This module provides <code>JdbiFactoryBean</code>, a factory bean which sets up a <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a>
singleton in a Spring 5 (or Spring Boot) application context.</p>
</div>
<div class="paragraph">
<p>To use this module, add a Maven dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>jdbi3-spring5<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then configure the Jdbi factory bean in your Spring container, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:aop</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/aop</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:tx</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/tx</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
       <span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd</span>
       <span class="content">http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.0.xsd</span>
       <span class="content">http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.0.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">db</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.jdbc.datasource.DriverManagerDataSource</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:h2:mem:testing</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/bean&gt;</span>

  <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.springframework.jdbc.datasource.DataSourceTransactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">db</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/bean&gt;</span>
  <span class="tag">&lt;tx:annotation-driven</span> <span class="attribute-name">transaction-manager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">transactionManager</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

  <i class="conum" data-value="3"></i><b>(3)</b>
  <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbi</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jdbi.v3.spring5.JdbiFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">db</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/bean&gt;</span>

  <i class="conum" data-value="4"></i><b>(4)</b>
  <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">service</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.example.service.MyService</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;constructor-arg</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbi</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/bean&gt;</span>
<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The SQL data source that Jdbi will connect to. In this example we use an H2
database, but it can be any JDBC-compatible database.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Enable configuration of transactions via annotations.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configure <code>JdbiFactoryBean</code> using the data source configured earlier.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Inject a <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance into a service class. Alternatively, use standard JSR-330 <code>@Inject</code> annotations on the target class instead of configuring it in your <code>beans.xml</code>.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_installing_plugins"><a class="anchor" href="#_installing_plugins"></a><a class="link" href="#_installing_plugins">16.13.1. Installing Plugins</a></h4>
<div class="paragraph">
<p>Plugins may be automatically installed by scanning the classpath for
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/ServiceLoader.html" target="_blank" rel="noopener">ServiceLoader</a> manifests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbi</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jdbi.v3.spring5.JdbiFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">autoInstallPlugins</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Plugins may also be installed explicitly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbi</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jdbi.v3.spring5.JdbiFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">plugins</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;list&gt;</span>
      <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jdbi.v3.sqlobject.SqlObjectPlugin</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jdbi.v3.guava.GuavaPlugin</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/list&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Not all plugins are automatically installable. In these situations, you can
auto-install some plugins and manually install the rest:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbi</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jdbi.v3.spring5.JdbiFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">autoInstallPlugins</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">plugins</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;list&gt;</span>
      <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jdbi.v3.core.h2.H2DatabasePlugin</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/list&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_global_attributes"><a class="anchor" href="#_global_attributes"></a><a class="link" href="#_global_attributes">16.13.2. Global Attributes</a></h4>
<div class="paragraph">
<p>Global defined attributes may be configured on the factory bean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbi</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.jdbi.v3.spring5.JdbiFactoryBean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">db</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">globalDefines</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;map&gt;</span>
      <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/map&gt;</span>
  <span class="tag">&lt;/property&gt;</span>
<span class="tag">&lt;/bean&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sqlite"><a class="anchor" href="#_sqlite"></a><a class="link" href="#_sqlite">16.14. SQLite</a></h3>
<div class="paragraph">
<p>The <strong>jdbi3-sqlite</strong> plugin provides support for using the
<a href="https://github.com/xerial/sqlite-jdbc" target="_blank" rel="noopener">SQLite JDBC Driver</a>
with Jdbi.</p>
</div>
<div class="paragraph">
<p>The plugin configures mapping for the Java <strong>URL</strong> type which is not
supported by driver.</p>
</div>
<div class="paragraph">
<p>To use this plugin, first add a Maven dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>jdbi3-sqlite<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then install the plugin into the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Jdbi jdbi = Jdbi.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">jdbc:sqlite:database</span><span class="delimiter">&quot;</span></span>)
                .installPlugin(<span class="keyword">new</span> SQLitePlugin());</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="stringtemplate4"><a class="anchor" href="#stringtemplate4"></a><a class="link" href="#stringtemplate4">16.15. StringTemplate 4</a></h3>
<div class="paragraph">
<p>This module allows you to plug in the <a href="https://www.stringtemplate.org/" target="_blank" rel="noopener">StringTemplate 4</a> templating engine, in
place of the standard Jdbi templating engine.</p>
</div>
<div class="paragraph">
<p>To use module plugin, add a Maven dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>jdbi3-stringtemplate4<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To use StringTemplate format in SQL statements, set the template engine to <a href="./apidocs/org/jdbi/v3/stringtemplate4/StringTemplateEngine.html" target="_blank" rel="noopener">StringTemplateEngine</a>.</p>
</div>
<div class="paragraph">
<p>Defined attributes are provided to the StringTemplate engine to render the SQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> sortColumn = <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>;
<span class="predefined-type">String</span> sql = <span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name </span><span class="delimiter">&quot;</span></span> +
             <span class="string"><span class="delimiter">&quot;</span><span class="content">FROM account </span><span class="delimiter">&quot;</span></span> +
             <span class="string"><span class="delimiter">&quot;</span><span class="content">ORDER BY &lt;if(sort)&gt; &lt;sortBy&gt;, &lt;endif&gt; id</span><span class="delimiter">&quot;</span></span>;

<span class="predefined-type">List</span>&lt;Account&gt; accounts = handle
    .createQuery(sql)
    .setTemplateEngine(<span class="keyword">new</span> StringTemplateEngine())
    .define(<span class="string"><span class="delimiter">&quot;</span><span class="content">sort</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>)
    .define(<span class="string"><span class="delimiter">&quot;</span><span class="content">sortBy</span><span class="delimiter">&quot;</span></span>, sortColumn)
    .mapTo(Account.class)
    .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since StringTemplate by default uses the <code>&lt;</code> character to mark ST expressions,
you might need to escape some SQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> datePredicateSql = <span class="string"><span class="delimiter">&quot;</span><span class="content">&lt;if(datePredicate)&gt; &lt;dateColumn&gt; </span><span class="char">\\</span><span class="content">&lt; :dateFilter &lt;endif&gt;</span><span class="delimiter">&quot;</span></span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, SQL templates can be loaded from StringTemplate group files on  the classpath:</p>
</div>
<div class="listingblock">
<div class="title">com/foo/AccountDao.sql.stg</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="stringtemplate">group AccountDao;

selectAll(sort,sortBy) ::= &lt;&lt;
  SELECT id, name
  FROM account
  ORDER BY &lt;if(sort)&gt; &lt;sortBy&gt;, &lt;endif&gt; id
&gt;&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">ST template = StringTemplateSqlLocator.findStringTemplate(
                  <span class="string"><span class="delimiter">&quot;</span><span class="content">com/foo/AccountDao.sql.stg</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">selectAll</span><span class="delimiter">&quot;</span></span>);

<span class="predefined-type">String</span> sql = template.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">sort</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>)
                     .add(<span class="string"><span class="delimiter">&quot;</span><span class="content">sortBy</span><span class="delimiter">&quot;</span></span>, sortColumn)
                     .render();</code></pre>
</div>
</div>
<div class="paragraph">
<p>In SQL Objects, the <code>@UseStringTemplateEngine</code> annotation sets the
statement locator, similar to first example above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.foo</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">AccountDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name </span><span class="delimiter">&quot;</span></span> +
              <span class="string"><span class="delimiter">&quot;</span><span class="content">FROM account </span><span class="delimiter">&quot;</span></span> +
              <span class="string"><span class="delimiter">&quot;</span><span class="content">ORDER BY &lt;if(sort)&gt; &lt;sortBy&gt;, &lt;endif&gt; id</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@UseStringTemplateEngine</span>
    <span class="predefined-type">List</span>&lt;Account&gt; selectAll(<span class="annotation">@Define</span> <span class="type">boolean</span> sort,
                            <span class="annotation">@Define</span> <span class="predefined-type">String</span> sortBy);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, the <code>@UseStringTemplateSqlLocator</code> annotation sets the statement
locator, and loads SQL from a StringTemplate group file on the classpath:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.foo</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">AccountDao</span> {
    <span class="annotation">@SqlQuery</span>
    <span class="annotation">@UseStringTemplateSqlLocator</span>
    <span class="predefined-type">List</span>&lt;Account&gt; selectAll(<span class="annotation">@Define</span> <span class="type">boolean</span> sort,
                            <span class="annotation">@Define</span> <span class="predefined-type">String</span> sortBy);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, since the fully qualified class name is <code>com.foo.AccountDao</code>,
SQL will be loaded from the file <code>com/foo/AccountDao.sql.stg</code> on the
classpath.</p>
</div>
<div class="paragraph">
<p>By default, the template in the group with the same name as the method will be
used. This can be overridden on the <code>@Sql___</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.foo</span>;

<span class="directive">public</span> <span class="type">interface</span> <span class="class">AccountDao</span> {
    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">listSorted</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@UseStringTemplateSqlLocator</span>
    <span class="predefined-type">List</span>&lt;Account&gt; selectAll(<span class="annotation">@Define</span> <span class="type">boolean</span> sort,
                            <span class="annotation">@Define</span> <span class="predefined-type">String</span> sortBy);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the SQL template will still be loaded from the file
<code>com/foo/AccountDao.sql.stg</code> on the classpath, however the <code>listSorted</code>
template will be used, regardless of the method name.</p>
</div>
<div class="paragraph">
<p>There are some options for StringTemplateEngine on the
<a href="./apidocs/org/jdbi/v3/stringtemplate4/StringTemplates.html" target="_blank" rel="noopener">StringTemplates</a> configuration class,
like whether missing attributes are considered an error or not.</p>
</div>
</div>
<div class="sect2">
<h3 id="_vavr"><a class="anchor" href="#_vavr"></a><a class="link" href="#_vavr">16.16. Vavr</a></h3>
<div class="paragraph">
<p>The Vavr Plugin offers deep integration of Jdbi with the Vavr functional library:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Supports argument resolution of sever Vavr Value types such as
<code>Option&lt;T&gt;</code>, <code>Either&lt;L, T&gt;</code>, <code>Lazy&lt;T&gt;</code>, <code>Try&lt;T&gt;</code> and <code>Validation&lt;T&gt;</code>.
Given that for the wrapped type <code>T</code> a Mapper is registered.</p>
</li>
<li>
<p>Return Vavr collection types from queries. Supported are <code>Seq&lt;T&gt;</code>, <code>Set&lt;T&gt;</code>,
<code>Map&lt;K, T&gt;</code> and <code>Multimap&lt;K, T&gt;</code> as well as all subtypes thereof.
It is possible to collect into a <code>Traversable&lt;T&gt;</code>, in this case a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/List.html" target="_blank" rel="noopener">List&lt;T&gt;</a>
will be returned.
For all interface types a sensible default implementation will be used
(e.q. <a href="https://docs.oracle.com/javase/8/docs/api/java/util/List.html" target="_blank" rel="noopener">List&lt;T&gt;</a> for <code>Seq&lt;T&gt;</code>). Furthermore <code>Multimap&lt;K, T&gt;</code>s are backed by a <code>Seq&lt;T&gt;</code>
as default value container.</p>
</li>
<li>
<p>Columns can be mapped into Vavr&#8217;s <code>Option&lt;T&gt;</code> type.</p>
</li>
<li>
<p>Tuple projections for Jdbi! Yey! Vavr offers Tuples up to a maximum arity of 8.
you can map your query results e.g. to <code>Tuple3&lt;Integer, String, Long&gt;</code>.
If you select more columns than the arity of the projection the columns
up to that index will be used.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To use the plugin, add a Maven dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.jdbi<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>jdbi3-vavr<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Vavr introduced binary incompatibilities between 0.10.x and 1.0.0-alpha. The Jdbi plugin only supports 0.9.x and 0.10.x and requires recompilation for vavr 1.0.0.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.installPlugin(<span class="keyword">new</span> VavrPlugin());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are some usage examples of the features listed above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> query = <span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users WHERE :name is null or name = :name</span><span class="delimiter">&quot;</span></span>;
<span class="predefined-type">Option</span>&lt;<span class="predefined-type">String</span>&gt; param = <span class="predefined-type">Option</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">eric</span><span class="delimiter">&quot;</span></span>);

<span class="comment">// will fetch first user with given name or first user with any name (Option.none)</span>
<span class="keyword">return</span> handle
    .createQuery(query)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, param)
    .mapToBean(User.class)
    .findFirst();</code></pre>
</div>
</div>
<div class="paragraph">
<p>where <code>param</code> may be one of <code>Option&lt;T&gt;</code>, <code>Either&lt;L, T&gt;</code>, <code>Lazy&lt;T&gt;</code>, <code>Try&lt;T&gt;</code>
or <code>Validation&lt;T&gt;</code>. Note that in the case of these types, the nested value must
be 'present' otherwise a <code>null</code> value is used (e.g. for <code>Either.Left</code> or
<code>Validation.Invalid</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT name FROM users</span><span class="delimiter">&quot;</span></span>)
      .collectInto(<span class="keyword">new</span> GenericType&lt;Seq&lt;<span class="predefined-type">String</span>&gt;&gt;() {});</code></pre>
</div>
</div>
<div class="paragraph">
<p>This works for all the collection types supported. For the nested value
row and column mappers already installed in Jdbi will be used.
Therefore, the following would work and can make sense if the column is nullable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT middle_name FROM users</span><span class="delimiter">&quot;</span></span>) <span class="comment">// nulls incoming!</span>
      .collectInto(<span class="keyword">new</span> GenericType&lt;Seq&lt;<span class="predefined-type">Option</span>&lt;<span class="predefined-type">String</span>&gt;&gt;&gt;() {});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The plugin will obey configured key and value columns for <code>Map&lt;K, T&gt;</code>
and <code>Multimap&lt;K, T&gt;</code> return types. In the next example we will key users
by their name, which is not necessarily unique.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Multimap&lt;<span class="predefined-type">String</span>, User&gt; usersByName = handle
    .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT * FROM users</span><span class="delimiter">&quot;</span></span>)
    .setMapKeyColumn(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
    .collectInto(<span class="keyword">new</span> GenericType&lt;Multimap&lt;<span class="predefined-type">String</span>, User&gt;&gt;() {});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Last but not least we can now project simple queries to Vavr tuples like that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// given a 'tuples' table with t1 int, t2 varchar, t3 varchar, ...</span>
<span class="predefined-type">List</span>&lt;Tuple3&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;&gt; tupleProjection = handle
    .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT t1, t2, t3 FROM tuples</span><span class="delimiter">&quot;</span></span>)
    .mapTo(<span class="keyword">new</span> GenericType&lt;Tuple3&lt;<span class="predefined-type">Integer</span>, <span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt;&gt;() {})
    .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also project complex types into a tuple as long as a row mapper is
registered.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// given that there are row mappers registered for both complex types</span>
Tuple2&lt;City, Address&gt; tupleProjection = handle
    .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT cityname, zipcode, street, housenumber FROM </span><span class="delimiter">&quot;</span></span> +
                 <span class="string"><span class="delimiter">&quot;</span><span class="content">addresses WHERE user_id = 1</span><span class="delimiter">&quot;</span></span>)
    .mapTo(<span class="keyword">new</span> GenericType&lt;Tuple2&lt;City, Address&gt;&gt;() {})
    .one();</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to mix complex types and simple ones we also got you covered.
Using the <code>TupleMappers</code> class you can configure your projections.(In fact,
you have to - read below!)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.configure(TupleMappers.class, c -&gt; c.setColumn(<span class="integer">2</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">street</span><span class="delimiter">&quot;</span></span>).setColumn(<span class="integer">3</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">housenumber</span><span class="delimiter">&quot;</span></span>));

Tuple3&lt;City, <span class="predefined-type">String</span>, <span class="predefined-type">Integer</span>&gt; result = handle
    .createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT cityname, zipcode, street, housenumber </span><span class="delimiter">&quot;</span></span> +
                 <span class="string"><span class="delimiter">&quot;</span><span class="content">FROM addresses WHERE user_id = 1</span><span class="delimiter">&quot;</span></span>)
    .mapTo(<span class="keyword">new</span> GenericType&lt;Tuple3&lt;City, <span class="predefined-type">String</span>, <span class="predefined-type">Integer</span>&gt;&gt;() {})
    .one();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Bear in mind:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The configuration of the columns is 1-based, since they reflect
the tuples' values (which you would query by e.g. <code>._1</code>).</p>
</li>
<li>
<p>Tuples are always mapped fully column-wise or fully via row mappers.
If you want to mix row-mapped types and single-column mappings the
<code>TupleMappers</code> must be configured properly i.e. all non row-mapped
tuple indices must be provided with a column configuration!</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cookbook"><a class="anchor" href="#_cookbook"></a><a class="link" href="#_cookbook">17. Cookbook</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section includes examples of various things you might like to do with Jdbi.</p>
</div>
<div class="sect2">
<h3 id="_simple_dependency_injection"><a class="anchor" href="#_simple_dependency_injection"></a><a class="link" href="#_simple_dependency_injection">17.1. Simple Dependency Injection</a></h3>
<div class="paragraph">
<p>Jdbi tries to be independent of using a dependency injection framework,
but it&#8217;s straightforward to integrate yours.  Just do field injection on a simple custom config type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">InjectedDependencies</span> <span class="directive">implements</span> JdbiConfig&lt;InjectedDependencies&gt; {
    <span class="annotation">@Inject</span>
    SomeDependency dep;

    <span class="directive">public</span> InjectedDependencies() {}

    <span class="annotation">@Override</span>
    <span class="directive">public</span> InjectedDependencies createCopy() {
        <span class="keyword">return</span> <span class="local-variable">this</span>; <span class="comment">// effectively immutable</span>
    }
}

Jdbi jdbi = Jdbi.create(myDataSource);
myIoC.inject(jdbi.getConfig(InjectedDependencies.class));

<span class="comment">// Then, in any component that needs to access it:</span>
getHandle().getConfig(InjectedDependencies.class).dep</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_like_clauses_with_parameters"><a class="anchor" href="#_like_clauses_with_parameters"></a><a class="link" href="#_like_clauses_with_parameters">17.2. LIKE clauses with Parameters</a></h3>
<div class="paragraph">
<p>Since JDBC (and therefore Jdbi) does not allow binding parameters into the middle of string literals,
you cannot interpolate bindings into <code>LIKE</code> clauses (<code>LIKE '%:param%'</code>).</p>
</div>
<div class="paragraph">
<p>Incorrect usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT name FROM things WHERE name like '%:search%'</span><span class="delimiter">&quot;</span></span>)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">search</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>)
    .mapTo(<span class="predefined-type">String</span>.class)
    .list()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query would try to select <code>where name like '%:search%'</code> <em>literally</em>, without binding any arguments.
This is because JDBC drivers will not bind arguments <em>inside string literals</em>.</p>
</div>
<div class="paragraph">
<p>It never gets that far, though&#8201;&#8212;&#8201;this query will throw an exception,
because we don&#8217;t allow unused argument bindings by default.</p>
</div>
<div class="paragraph">
<p>The solution is to use SQL string concatenation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT name FROM things WHERE name like '%' || :search || '%'</span><span class="delimiter">&quot;</span></span>)
    .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">search</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span>)
    .mapTo(<span class="predefined-type">String</span>.class)
    .list()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, <code>search</code> can be properly bound as a parameter to the statement, and it all works as desired.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Check the string concatenation syntax of your database before doing this.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="extension-framework"><a class="anchor" href="#extension-framework"></a><a class="link" href="#extension-framework">18. The Extension Framework</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Jdbi core provides a rich, programmatic interface for database operations. It is possible to extend this core by writing extensions that plug into the
Jdbi core framework and provide new functionality.</p>
</div>
<div class="paragraph">
<p>The Extension framework is generic and supports any type of extension that can be registered with the Jdbi core.</p>
</div>
<div class="paragraph">
<p>Jdbi provides the <a href="#sql-objects">SQLObject plugin</a>, which offers a declarative API by placing annotations on interface methods.</p>
</div>
<div class="sect2">
<h3 id="_using_jdbi_extensions"><a class="anchor" href="#_using_jdbi_extensions"></a><a class="link" href="#_using_jdbi_extensions">18.1. Using Jdbi extensions</a></h3>
<div class="paragraph">
<p><em>Extension types are usually java interface classes.</em> Any interface can be an extension type.</p>
</div>
<div class="paragraph">
<p>Jdbi offers multiple ways to obtain an extension type implementation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Calling either
<a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withExtension(java.lang.Class,org.jdbi.v3.core.extension.ExtensionCallback)" target="_blank" rel="noopener">Jdbi#withExtension()</a> or
<a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useExtension(java.lang.Class,org.jdbi.v3.core.extension.ExtensionConsumer)" target="_blank" rel="noopener">Jdbi#useExtension()</a> methods with an extension type will pass an extension type implementation to a callback that contains user code.</p>
</li>
<li>
<p>The <a href="./apidocs/org/jdbi/v3/core/Handle.html#attach(java.lang.Class)" target="_blank" rel="noopener">Handle#attach()</a> attaches an extension type implementation directly to an existing  <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> object.</p>
</li>
<li>
<p>Finally, the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#onDemand(java.lang.Class)" target="_blank" rel="noopener">Jdbi#onDemand()</a> method creates an on-demand implementation of an extension type that is not limited to a callback.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is an extension type for the <a href="#sql-objects">SQL Object extension</a> which uses annotations to identify functionality:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">SomethingDao</span> {
    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO something (id, name) VALUES (:s.id, :s.name)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">int</span> insert(<span class="annotation">@BindBean</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">s</span><span class="delimiter">&quot;</span></span>) Something s);

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name FROM something WHERE id = ?</span><span class="delimiter">&quot;</span></span>)
    Optional&lt;Something&gt; findSomething(<span class="type">int</span> id);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If any of the SQL method annotations (<a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlBatch.html" target="_blank" rel="noopener">@SqlBatch</a>,
<a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlCall.html" target="_blank" rel="noopener">@SqlCall</a>, <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlQuery.html" target="_blank" rel="noopener">@SqlQuery</a>,
<a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlScript.html" target="_blank" rel="noopener">@SqlScript</a> and <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlUpdate.html" target="_blank" rel="noopener">@SqlUpdate</a>) is present on either the
extension type itself or any extension type method, the SQL Object extension will be used.</p>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withExtension(java.lang.Class,org.jdbi.v3.core.extension.ExtensionCallback)" target="_blank" rel="noopener">Jdbi#withExtension()</a> and
<a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useExtension(java.lang.Class,org.jdbi.v3.core.extension.ExtensionConsumer)" target="_blank" rel="noopener">Jdbi#useExtension()</a> methods are used to access
SQLObject functionality:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jdbi.useExtension(SomethingDao.class, dao -&gt; {
    dao.insert(<span class="keyword">new</span> Something(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">apple</span><span class="delimiter">&quot;</span></span>));
});

Optional&lt;Something&gt; result = jdbi.withExtension(SomethingDao.class, dao -&gt; dao.findSomething(<span class="integer">1</span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a handle has already been created, an extension type can be directly attached with the
<a href="./apidocs/org/jdbi/v3/core/Handle.html#attach(java.lang.Class)" target="_blank" rel="noopener">Handle#attach()</a> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">SomethingDao dao = handle.attach(SomethingDao.class);
Optional&lt;Something&gt; result = dao.findSomething(<span class="integer">1</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withExtension(java.lang.Class,org.jdbi.v3.core.extension.ExtensionCallback)" target="_blank" rel="noopener">Jdbi#withExtension()</a>, <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useExtension(java.lang.Class,org.jdbi.v3.core.extension.ExtensionConsumer)" target="_blank" rel="noopener">Jdbi#useExtension()</a> and <a href="./apidocs/org/jdbi/v3/core/Handle.html#attach(java.lang.Class)" target="_blank" rel="noopener">Handle#attach()</a> methods are the most common way to use extension type implementations.</p>
</div>
<div class="sect3">
<h4 id="_on_demand_extensions"><a class="anchor" href="#_on_demand_extensions"></a><a class="link" href="#_on_demand_extensions">18.1.1. On-demand extensions</a></h4>
<div class="paragraph">
<p>An extension type implementation can be acquired by calling the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#onDemand(java.lang.Class)" target="_blank" rel="noopener">Jdbi#onDemand()</a> method which returns
an implementation of the extension type that will transparently create a new handle instance when a method on the extension type is called.</p>
</div>
<div class="paragraph">
<p>This is an example for an on-demand extension:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">SomethingDao dao = jdbi.onDemand(SomethingDao.class);
dao.insert(<span class="keyword">new</span> Something(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">apple</span><span class="delimiter">&quot;</span></span>));

Optional&lt;Something&gt; result = dao.findSomething(<span class="integer">1</span>);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#onDemand(java.lang.Class)" target="_blank" rel="noopener">Jdbi#onDemand()</a> uses a <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Proxy.html" target="_blank" rel="noopener">Java proxy</a> object to provide
the on-demand handle object. Java proxies only support Java interface classes as extension types and may not be compatible with
<a href="https://docs.oracle.com/en/graalvm/enterprise/21/docs/reference-manual/native-image/DynamicProxy/" target="_blank" rel="noopener">GraalVM</a> when creating native code.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="extension-handle-lifecycle"><a class="anchor" href="#extension-handle-lifecycle"></a><a class="link" href="#extension-handle-lifecycle">18.1.2. Handle lifecycle for extensions</a></h4>
<div class="paragraph">
<p>The difference between the methods to acquire an extension type implementation is the handle (and database connection) lifecycle:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withExtension(java.lang.Class,org.jdbi.v3.core.extension.ExtensionCallback)" target="_blank" rel="noopener">Jdbi#withExtension()</a> and
<a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useExtension(java.lang.Class,org.jdbi.v3.core.extension.ExtensionConsumer)" target="_blank" rel="noopener">Jdbi#useExtension()</a> provides a managed handle object when the callback is entered and reuses it for any extension type method call as long as the code does not return from the callback.</p>
</li>
<li>
<p>The <a href="./apidocs/org/jdbi/v3/core/Handle.html#attach(java.lang.Class)" target="_blank" rel="noopener">Handle#attach()</a> does not manage the handle at all. Any extension type method call will use the handle that the object was attached to and be part of its lifecycle.</p>
</li>
<li>
<p>The <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#onDemand(java.lang.Class)" target="_blank" rel="noopener">Jdbi#onDemand()</a> provides a managed handle object for every extension type method call. When the method call returns, the handle is closed.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_an_extension_works"><a class="anchor" href="#_how_an_extension_works"></a><a class="link" href="#_how_an_extension_works">18.2. How an extension works</a></h3>
<div class="paragraph">
<p><em>Any interface class can be an extension type.</em> There is nothing special to an extension type unless an extension requires some specific information
(e.g. annotations present or specific naming).</p>
</div>
<div class="paragraph">
<p>Extensions should document which information is needed for the extension framework to determine that a specific interface class represents an extension  type that they accept.</p>
</div>
<div class="paragraph">
<p>The extension type creation methods (<a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withExtension(java.lang.Class,org.jdbi.v3.core.extension.ExtensionCallback)" target="_blank" rel="noopener">Jdbi#withExtension()</a>,
<a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useExtension(java.lang.Class,org.jdbi.v3.core.extension.ExtensionConsumer)" target="_blank" rel="noopener">Jdbi#useExtension()</a>,
<a href="./apidocs/org/jdbi/v3/core/Handle.html#attach(java.lang.Class)" target="_blank" rel="noopener">Handle#attach()</a> and <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#onDemand(java.lang.Class)" target="_blank" rel="noopener">Jdbi#onDemand()</a>) all take the extension type as a parameter and provide an implementation either to the caller or within a callback object.</p>
</div>
<div class="paragraph">
<p>The extension framework selects an <a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html" target="_blank" rel="noopener">ExtensionFactory</a> to handle the extension type and create an implementation. Extension factories must be registered ahead of time with the Jdbi core using the
<a href="./apidocs/org/jdbi/v3/core/extension/Extensions.html#register(org.jdbi.v3.core.extension.ExtensionFactory)" target="_blank" rel="noopener">Extensions#register()</a> method.</p>
</div>
<div class="paragraph">
<p>The extension factory then creates an <a href="./apidocs/org/jdbi/v3/core/extension/ExtensionMetadata.html" target="_blank" rel="noopener">ExtensionMetadata</a> object that contains information about each
method on the extension type:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Which <a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandler.html" target="_blank" rel="noopener">ExtensionHandler</a> to invoke for each method</p>
</li>
<li>
<p>All <a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandlerCustomizer.html" target="_blank" rel="noopener">ExtensionHandlerCustomizer</a> instances that change the behavior of the extension handler</p>
</li>
<li>
<p>Per extension type and per extension type method specific <a href="./apidocs/org/jdbi/v3/core/extension/ConfigCustomizer.html" target="_blank" rel="noopener">ConfigCustomizer</a> instances to apply when an extension handler is invoked</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Extension metadata is created once for each extension type and then reused.</p>
</div>
<div class="paragraph">
<p>Jdbi usually returns a <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Proxy.html" target="_blank" rel="noopener">Java proxy</a> object to user code. Calling a method on that proxy will invoke per-method extension handlers. For each extension handler, objects specific to the invocation
(<a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a>, <a href="./apidocs/org/jdbi/v3/core/config/ConfigRegistry.html" target="_blank" rel="noopener">configuration</a>) are managed separately .</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-ditaa-md5-8d4ed3f9494355bc0fcef8c74be183e3.png" alt="Diagram" width="1330" height="518">
</div>
</div>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandler.html" target="_blank" rel="noopener">ExtensionHandler</a>,
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandlerCustomizer.html" target="_blank" rel="noopener">ExtensionHandlerCustomizer</a> and
<a href="./apidocs/org/jdbi/v3/core/extension/ConfigCustomizer.html" target="_blank" rel="noopener">ConfigCustomizer</a> are the three main extension framework objects to implement:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An <a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandler.html" target="_blank" rel="noopener">ExtensionHandler</a> object is created by an
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandlerFactory.html" target="_blank" rel="noopener">ExtensionHandlerFactory</a>, which can be registered either globally (with the
<a href="./apidocs/org/jdbi/v3/core/extension/Extensions.html" target="_blank" rel="noopener">Extensions configuration</a>) and then applied to all extensions types, or directly with an extension factory. It is also possible to specify extension handlers through annotations.</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandlerCustomizer.html" target="_blank" rel="noopener">ExtensionHandlerCustomizer</a> objects can modify the behavior of an extension handler. They are
registered globally or provided by an extension factory. They can also be specified through annotations.</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/core/extension/ConfigCustomizer.html" target="_blank" rel="noopener">ConfigCustomizer</a> objects are created by a
<a href="./apidocs/org/jdbi/v3/core/extension/ConfigCustomizerFactory.html" target="_blank" rel="noopener">ConfigCustomizerFactory</a> and modify the configuration that is used when an extension handler is
executed. Factory instances are registered globally or with an extension factory. Config customization
can also be specified through annotations.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_extension_framework_sdk"><a class="anchor" href="#_extension_framework_sdk"></a><a class="link" href="#_extension_framework_sdk">18.3. Extension framework SDK</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This chapter is intended for developers who want to write a new extension for Jdbi and need to understand the Extension framework details. This chapter is only
relevant if you plan to write an extension or implement specific extension objects.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This chapter lists all the classes that make up the extension framework, their function and how to use them when writing a new extension. Not all pieces are
needed for every extension.</p>
</div>
<div class="sect3">
<h4 id="_extension_configuration"><a class="anchor" href="#_extension_configuration"></a><a class="link" href="#_extension_configuration">18.3.1. Extension configuration</a></h4>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/extension/Extensions.html" target="_blank" rel="noopener">Extensions</a> class is the configuration object for the extension framework. It contains a registry for
extension factories and global extension objects (<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandlerFactory.html" target="_blank" rel="noopener">ExtensionHandlerFactory</a>,
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandlerCustomizer.html" target="_blank" rel="noopener">ExtensionHandlerCustomizer</a> and
<a href="./apidocs/org/jdbi/v3/core/extension/ConfigCustomizerFactory.html" target="_blank" rel="noopener">ConfigCustomizerFactory</a>).</p>
</div>
<div class="paragraph">
<p>Any extension object registered here will be applied to all extension types, independent of the extension factory which is ultimately chosen to process an
extension type.</p>
</div>
<div class="paragraph">
<p>By default, the following extension objects are globally registered and can not be removed. These are always processed last (after all user registered extension
objects):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An extension handler factory for the <a href="./apidocs/org/jdbi/v3/core/extension/annotation/UseExtensionHandler.html" target="_blank" rel="noopener">@UseExtensionHandler</a> annotation.</p>
</li>
<li>
<p>An extension handler customizer for the <a href="./apidocs/org/jdbi/v3/core/extension/annotation/UseExtensionHandlerCustomizer.html" target="_blank" rel="noopener">@UseExtensionHandlerCustomizer</a>
annotation.</p>
</li>
<li>
<p>A config customizer factory for the <a href="./apidocs/org/jdbi/v3/core/extension/annotation/UseExtensionConfigurer.html" target="_blank" rel="noopener">@UseExtensionConfigurer</a> annotation.</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Order matters with extension objects! For each extension object, the extension specific instances are applied first, then the globally registered ones.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_the_extension_factory"><a class="anchor" href="#_the_extension_factory"></a><a class="link" href="#_the_extension_factory">18.3.2. The Extension factory</a></h4>
<div class="paragraph">
<p>Extension factories are the core piece for any extension. An <a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html" target="_blank" rel="noopener">ExtensionFactory</a> object can provide all the
specific pieces that make up the extension functionality or delegate to annotations.</p>
</div>
<div class="paragraph">
<p>The only method that must be implemented in this interface is
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html#accepts(java.lang.Class)" target="_blank" rel="noopener">ExtensionFactory#accepts()</a>. If this method returns <code>true</code>, then the given
extension type is handled by this factory. E.g. the <a href="./apidocs/org/jdbi/v3/sqlobject/SqlObjectFactory.html" target="_blank" rel="noopener">SQL Object factory</a> accepts any interface that has at least
one SQL annotation on the class itself or a method.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Even though it is possible to implement all the functions of an extension with annotations, there still needs to be an extension factory that accepts the
extension type. Without such a factory, the extension framework will throw a
<a href="./apidocs/org/jdbi/v3/core/extension/NoSuchExtensionException.html" target="_blank" rel="noopener">NoSuchExtensionException</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Any extension factory can provide specific extension objects (by returning instances of
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandlerFactory.html" target="_blank" rel="noopener">ExtensionHandlerFactory</a>,
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandlerCustomizer.html" target="_blank" rel="noopener">ExtensionHandlerCustomizer</a> and
<a href="./apidocs/org/jdbi/v3/core/extension/ConfigCustomizerFactory.html" target="_blank" rel="noopener">ConfigCustomizerFactory</a>) which are only applied when the factory has accepted an extension
type. The extension factory provides the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html#getExtensionHandlerFactories(org.jdbi.v3.core.config.ConfigRegistry)" target="_blank" rel="noopener">ExtensionFactory#getExtensionHandlerFactories()</a>,
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html#getExtensionHandlerCustomizers(org.jdbi.v3.core.config.ConfigRegistry)" target="_blank" rel="noopener">ExtensionFactory#getExtensionHandlerCustomizers()</a>
and
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html#getConfigCustomizerFactories(org.jdbi.v3.core.config.ConfigRegistry)" target="_blank" rel="noopener">ExtensionFactory#getConfigCustomizerFactories()</a>
getters that a factory can implement.  By default, each returns an empty collection.</p>
</div>
<div class="sect4">
<h5 id="_java_object_methods"><a class="anchor" href="#_java_object_methods"></a><a class="link" href="#_java_object_methods">Java Object methods</a></h5>
<div class="paragraph">
<p>When the extension framework returns an implementation of an extension type, it usually returns a <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Proxy.html" target="_blank" rel="noopener">Java proxy</a>
object which will invoke an extension handler for every method on the extension type.</p>
</div>
<div class="paragraph">
<p>In addition to the methods defined by the extension type, the following methods also invoke extension handlers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#toString--" target="_blank" rel="noopener">Object#toString()</a> returns "Jdbi extension proxy for <em>&lt;extension type&gt;</em>"</p>
</li>
<li>
<p><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#equals-java.lang.Object-" target="_blank" rel="noopener">Object#equals()</a> and <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#hashCode--" target="_blank" rel="noopener">Object#hashCode()</a>
implementations that ensure that each instance is only equal to itself.</p>
</li>
<li>
<p><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Object.html#finalize--" target="_blank" rel="noopener">Object#finalize()</a> has no effect.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All methods except <code>finalize()</code> can be overridden by the extension type (e.g. through an <em>interface default method</em>).</p>
</div>
</div>
<div class="sect4">
<h5 id="_non_virtual_factories"><a class="anchor" href="#_non_virtual_factories"></a><a class="link" href="#_non_virtual_factories">Non-virtual factories</a></h5>
<div class="paragraph">
<p>Normally, a factory will use extension handlers to provide functionality when an extension type method is called and a
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Proxy.html" target="_blank" rel="noopener">Java proxy</a> object is returned as an implementation of the extension type. This is a <em>virtual</em>
factory (because there is no actual object implementing the interface). Extension factories are by default virtual factories.</p>
</div>
<div class="paragraph">
<p>The <a href="#sql-objects">SQL Object extension</a> is an example of a virtual factory because it never provides an implementation for extension types but  dispatches any method calls to a specific handler to execute SQL operations.</p>
</div>
<div class="paragraph">
<p>The extension framework also supports <em>non-virtual</em> factories. These factories produce a backing object that implements the extension type. A non-virtual factory will still return a proxy object to the caller but calling any method on the proxy object may call the corresponding method on the backing object through a special extension handler.</p>
</div>
<div class="paragraph">
<p>This is an example of a non-virtual factory that provides an implementation for a specific extension type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">NonVirtualExtensionFactory</span> <span class="directive">implements</span> ExtensionFactory {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;FactoryFlag&gt; getFactoryFlags() {
        <span class="keyword">return</span> <span class="predefined-type">EnumSet</span>.of(NON_VIRTUAL_FACTORY); <i class="conum" data-value="1"></i><b>(1)</b>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> accepts(<span class="predefined-type">Class</span>&lt;?&gt; extensionType) {
        <span class="keyword">return</span> extensionType == NonVirtualDao.class;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> &lt;E&gt; E attach(<span class="predefined-type">Class</span>&lt;E&gt; extensionType, HandleSupplier handleSupplier) {
        <span class="keyword">return</span> (E) <span class="keyword">new</span> NonVirtualDaoImpl(handleSupplier); <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>An extension factory declares itself non-virtual by returning the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.FactoryFlag.html#NO_VIRTUAL_FACTORY" target="_blank" rel="noopener"><code>NON_VIRTUAL_FACTORY</code></a> flag on the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html#getFactoryFlags()" target="_blank" rel="noopener">ExtensionFactory#getFactoryFlags()</a> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The extension framework calls the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html#attach(java.lang.Class,org.jdbi.v3.core.extension.HandleSupplier)" target="_blank" rel="noopener">ExtensionFactory#attach()</a> method with
the current extension type and a handle supplier. The factory is expected to return an instance of the extension type. Methods on the instance will be wrapped
in extension handlers and a proxy object is returned to the caller.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_extensions_without_java_proxy_objects"><a class="anchor" href="#_extensions_without_java_proxy_objects"></a><a class="link" href="#_extensions_without_java_proxy_objects">Extensions without Java proxy objects</a></h5>
<div class="paragraph">
<p>A drawback of the standard extension factories is that returning a <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Proxy.html" target="_blank" rel="noopener">Java proxy</a> object limits factory functionality
and is incompatible with some use cases (e.g. <a href="https://docs.oracle.com/en/graalvm/enterprise/21/docs/reference-manual/native-image/DynamicProxy/" target="_blank" rel="noopener">using GraalVM
for native compilation</a>).</p>
</div>
<div class="paragraph">
<p>A factory can return the <a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.FactoryFlag.html#DONT_USE_PROXY" target="_blank" rel="noopener"><code>DONT_USE_PROXY</code></a> flag on the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html#getFactoryFlags()" target="_blank" rel="noopener">ExtensionFactory#getFactoryFlags()</a> method to signal that the extension framework should
return the backing object <em>as-is</em>.</p>
</div>
<div class="paragraph">
<p>This is an example of a factory that supports abstract classes in addition to interfaces. Abstract classes are incompatible with java proxies, so the factory
must use the <a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.FactoryFlag.html#DONT_USE_PROXY" target="_blank" rel="noopener"><code>DONT_USE_PROXY</code></a> flag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">abstract</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">AbstractDao</span> {

    <span class="directive">public</span> <span class="directive">abstract</span> Optional&lt;Something&gt; findSomething(<span class="type">int</span> id);

    Something findFirstSomething() {
        <span class="keyword">return</span> findSomething(<span class="integer">1</span>).orElseGet(Assertions::fail);
    }
}

<span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">DontUseProxyExtensionFactory</span> <span class="directive">implements</span> ExtensionFactory {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;FactoryFlag&gt; getFactoryFlags() {
        <span class="keyword">return</span> <span class="predefined-type">EnumSet</span>.of(DONT_USE_PROXY); <i class="conum" data-value="1"></i><b>(1)</b>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> accepts(<span class="predefined-type">Class</span>&lt;?&gt; extensionType) {
        <span class="keyword">return</span> extensionType == AbstractDao.class;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> &lt;E&gt; E attach(<span class="predefined-type">Class</span>&lt;E&gt; extensionType, HandleSupplier handleSupplier) {
        <span class="keyword">return</span> extensionType.cast(<span class="keyword">new</span> DaoImpl(handleSupplier)); <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>An extension factory declares that it does not want to use the proxy mechanism by returning the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.FactoryFlag.html#DONT_USE_PROXY" target="_blank" rel="noopener"><code>DONT_USE_PROXY</code></a> flag from the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html#getFactoryFlags()" target="_blank" rel="noopener">ExtensionFactory#getFactoryFlags()</a> method. Using this flag bypasses all the extension
framework proxy mechanism and calls the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html#attach(java.lang.Class,org.jdbi.v3.core.extension.HandleSupplier)" target="_blank" rel="noopener">ExtensionFactory#attach()</a> method
immediately.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The extension factory creates an instance that must be compatible with the extension type. It can provide the current extension type and a handle supplier
if needed. Unlike a non-virtual factory, this instance is returned <em>as-is</em> to the caller. Neither proxy object nor extension handlers are created.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Jdbi provides <a href="./apidocs/org/jdbi/v3/generator/GenerateSqlObjectProcessor.html" target="_blank" rel="noopener">an annotation processor</a> that creates java implementations of extension types. In addition, it
provides <a href="./apidocs/org/jdbi/v3/sqlobject/GeneratorSqlObjectFactory.html" target="_blank" rel="noopener">an extension factory</a> which does not use proxy objects and returns these as extension type implementations. Calling a method on the extension type will invoke the methods on the generated classes directly.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_extension_handlers_and_their_factories"><a class="anchor" href="#_extension_handlers_and_their_factories"></a><a class="link" href="#_extension_handlers_and_their_factories">18.3.3. Extension handlers and their factories</a></h4>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandler.html" target="_blank" rel="noopener">ExtensionHandler</a> objects are the main place for extension functionality. Each method on an extension type
is mapped to an extension handler. Extension handlers are executed by calling the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandler.html#invoke(org.jdbi.v3.core.extension.HandleSupplier,java.lang.Object,java.lang.Object%2e%2e%2e)" target="_blank" rel="noopener">ExtensionHandler#invoke()</a>
method.</p>
</div>
<div class="paragraph">
<p>This is an example of an extension handler that provides a value whenever a method on the extension type is called:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">TestExtensionHandler</span> <span class="directive">implements</span> ExtensionHandler {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Object</span> invoke(HandleSupplier handleSupplier, <span class="predefined-type">Object</span> target, <span class="predefined-type">Object</span>... args) {
        <span class="keyword">return</span> <span class="keyword">new</span> Something((<span class="type">int</span>) args[<span class="integer">0</span>], (<span class="predefined-type">String</span>) args[<span class="integer">1</span>]); <i class="conum" data-value="1"></i><b>(1)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Invoking this handler returns a <code>Something</code> instance.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Extension handlers are not shared, so every extension type method maps onto a separate instance. The
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandlerFactory.html" target="_blank" rel="noopener">ExtensionHandlerFactory</a> interface provides the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandlerFactory.html#accepts(java.lang.Class,java.lang.reflect.Method)" target="_blank" rel="noopener">ExtensionHandlerFactory#accepts()</a> method which
is called for each method that needs to be mapped. If a factory accepts a method, the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandlerFactory.html#createExtensionHandler(java.lang.Class,java.lang.reflect.Method)" target="_blank" rel="noopener">ExtensionHandlerFactory#createExtensionHandler()</a>
method is called, which should return an extension handler instance.</p>
</div>
<div class="paragraph">
<p>This is an example for an extension handler factory that returns an extension handler for methods named <code>getSomething</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">TestExtensionHandlerFactory</span> <span class="directive">implements</span> ExtensionHandlerFactory {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> accepts(<span class="predefined-type">Class</span>&lt;?&gt; extensionType, <span class="predefined-type">Method</span> method) {
        <span class="keyword">return</span> method.getName().equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">getSomething</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="1"></i><b>(1)</b>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Optional&lt;ExtensionHandler&gt; createExtensionHandler(<span class="predefined-type">Class</span>&lt;?&gt; extensionType, <span class="predefined-type">Method</span> method) {
        <span class="keyword">return</span> Optional.of(<span class="keyword">new</span> TestExtensionHandler()); <i class="conum" data-value="2"></i><b>(2)</b>
    }
}

<span class="type">interface</span> <span class="class">ExtensionType</span> {
    Something getSomething(<span class="type">int</span> id, <span class="predefined-type">String</span> name);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The extension handler factory tests that the method has the right name.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If the factory accepts the method, it returns a new instance of the extension handler shown above.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandlerFactory.html#createExtensionHandler(java.lang.Class,java.lang.reflect.Method)" target="_blank" rel="noopener">ExtensionHandlerFactory#createExtensionHandler()</a>
method returns an <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html" target="_blank" rel="noopener">Optional&lt;ExtensionHandler&gt;</a> object for backwards compatibility reasons. While it is legal for a
factory to accept a method on an extension type and then return an <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html#empty--" target="_blank" rel="noopener">Optional.empty()</a> object, it is discouraged
in new code.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The extension framework provides extension handlers for <em>interface default methods</em> and synthetic methods.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An extension handler for a specific extension type can be either registered globally by adding a factory using the
<a href="./apidocs/org/jdbi/v3/core/extension/Extensions.html#registerHandlerFactory(org.jdbi.v3.core.extension.ExtensionHandlerFactory)" target="_blank" rel="noopener">Extensions#registerHandlerFactory()</a>
method, or it can be returned on the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html#getExtensionHandlerFactories(org.jdbi.v3.core.config.ConfigRegistry)" target="_blank" rel="noopener">ExtensionFactory#getExtensionHandlerFactories()</a>
method of the extension factory for the extension type. It can also be configured through an annotation.</p>
</div>
<div class="paragraph">
<p>This is the extension factory for the <code>ExtensionType</code> extension type defined above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">TestExtensionFactory</span> <span class="directive">implements</span> ExtensionFactory {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> accepts(<span class="predefined-type">Class</span>&lt;?&gt; extensionType) {
        <span class="keyword">return</span> extensionType == ExtensionType.class; <i class="conum" data-value="1"></i><b>(1)</b>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;ExtensionHandlerFactory&gt; getExtensionHandlerFactories(ConfigRegistry config) {
        <span class="keyword">return</span> <span class="predefined-type">Collections</span>.singleton(<span class="keyword">new</span> TestExtensionHandlerFactory()); <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The factory will accept the <code>ExtensionType</code> extension type.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>When processing the type, the <code>TestExtensionHandlerFactory</code> shown above will be used when creating the extension handlers.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_extension_handler_customizers"><a class="anchor" href="#_extension_handler_customizers"></a><a class="link" href="#_extension_handler_customizers">18.3.4. Extension handler customizers</a></h4>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandlerCustomizer.html" target="_blank" rel="noopener">ExtensionHandlerCustomizer</a> objects can modify extension handler execution. They are
either registered globally with the
<a href="./apidocs/org/jdbi/v3/core/extension/Extensions.html#registerHandlerCustomizer(org.jdbi.v3.core.extension.ExtensionHandlerCustomizer)" target="_blank" rel="noopener">Extensions#registerHandlerCustomizer()</a>
and will augment any extension handler, or they can be provided by an extension factory by implementing the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html#getConfigCustomizerFactories(org.jdbi.v3.core.config.ConfigRegistry)" target="_blank" rel="noopener">ExtensionFactory#getConfigCustomizerFactories()</a>
method.</p>
</div>
<div class="paragraph">
<p>Here is an example for an extension handler customizer that logs every method handler invocation. It gets registered as a global extension handler customizer
with the <a href="./apidocs/org/jdbi/v3/core/extension/Extensions.html" target="_blank" rel="noopener">Extensions configuration object</a> and will then log every method invocation on an extension type.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    jdbi.configure(Extensions.class, e -&gt;
            e.registerHandlerCustomizer(<span class="keyword">new</span> LoggingExtensionHandlerCustomizer())); <i class="conum" data-value="1"></i><b>(1)</b>

<span class="directive">static</span> <span class="type">class</span> <span class="class">LoggingExtensionHandlerCustomizer</span> <span class="directive">implements</span> ExtensionHandlerCustomizer {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> ExtensionHandler customize(ExtensionHandler handler, <span class="predefined-type">Class</span>&lt;?&gt; extensionType, <span class="predefined-type">Method</span> method) {
        <span class="keyword">return</span> (handleSupplier, target, args) -&gt; {
            LOG.info(format(<span class="string"><span class="delimiter">&quot;</span><span class="content">Entering %s on %s</span><span class="delimiter">&quot;</span></span>, method, extensionType.getSimpleName()));
            <span class="keyword">try</span> {
                <span class="keyword">return</span> handler.invoke(handleSupplier, target, args);
            } <span class="keyword">finally</span> {
                LOG.info(format(<span class="string"><span class="delimiter">&quot;</span><span class="content">Leaving %s on %s</span><span class="delimiter">&quot;</span></span>, method, extensionType.getSimpleName()));
            }
        };
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Register as a global <a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandlerCustomizer.html" target="_blank" rel="noopener">ExtensionHandlerCustomizer</a> instance to log every method invocation.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is example code. Jdbi actually offers better logging facilities with <a href="./apidocs/org/jdbi/v3/core/statement/SqlLogger.html" target="_blank" rel="noopener">SqlLogger</a> and the
<a href="./apidocs/org/jdbi/v3/core/statement/SqlStatements.html#setSqlLogger(org.jdbi.v3.core.statement.SqlLogger)" target="_blank" rel="noopener">SqlStatements#setSqlLogger()</a> method.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandlerCustomizer.html" target="_blank" rel="noopener">ExtensionHandlerCustomizer</a> instances usually wrap or replace an existing extension
handler. They must be stateless and can only modify or operate on the <a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandler.html" target="_blank" rel="noopener">ExtensionHandler</a> object
that was passed into the <a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandlerCustomizer.html#customize(org.jdbi.v3.core.extension.ExtensionHandler,java.lang.Class,java.lang.reflect.Method)" target="_blank" rel="noopener">ExtensionHandlerCustomizer#customize()</a>
method.</p>
</div>
</div>
<div class="sect3">
<h4 id="_config_customizers_and_their_factories"><a class="anchor" href="#_config_customizers_and_their_factories"></a><a class="link" href="#_config_customizers_and_their_factories">18.3.5. Config customizers and their factories</a></h4>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/core/extension/ConfigCustomizer.html" target="_blank" rel="noopener">ConfigCustomizer</a> instances modify the <a href="./apidocs/org/jdbi/v3/core/config/ConfigRegistry.html" target="_blank" rel="noopener">configuration
registry</a> object which is used when an extension type method is invoked. This configuration object is passed to all extension handler customizers and the
extension handler itself.</p>
</div>
<div class="paragraph">
<p>Config customizer instances are created by <a href="./apidocs/org/jdbi/v3/core/extension/ConfigCustomizerFactory.html" target="_blank" rel="noopener">ConfigCustomizerFactory</a> instances which decide whether
to provide a config customizer for every method on an extension type by implementing the
<a href="./apidocs/org/jdbi/v3/core/extension/ConfigCustomizerFactory.html#forExtensionType(java.lang.Class)" target="_blank" rel="noopener">ConfigCustomizerFactory#forExtensionType()</a> method, or it can
implement
<a href="./apidocs/org/jdbi/v3/core/extension/ConfigCustomizerFactory.html#forExtensionMethod(java.lang.Class,java.lang.reflect.Method)" target="_blank" rel="noopener">ConfigCustomizerFactory#forExtensionMethod()</a>
for per-method selection.</p>
</div>
<div class="paragraph">
<p>This is an example for a global configuration customizer that registers a specific <a href="#_rowmappers_registry">row mapper</a> for all methods on every extension type.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    jdbi.configure(Extensions.class, e -&gt;
            e.registerConfigCustomizerFactory(<span class="keyword">new</span> SomethingMapperConfigCustomizerFactory())); <i class="conum" data-value="1"></i><b>(1)</b>

<span class="directive">static</span> <span class="type">class</span> <span class="class">SomethingMapperConfigCustomizerFactory</span> <span class="directive">implements</span> ConfigCustomizerFactory {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;ConfigCustomizer&gt; forExtensionType(<span class="predefined-type">Class</span>&lt;?&gt; extensionType) {
        <span class="keyword">return</span> <span class="predefined-type">Collections</span>.singleton(
                config -&gt; config.get(RowMappers.class).register(<span class="keyword">new</span> SomethingMapper()) <i class="conum" data-value="2"></i><b>(2)</b>
        );
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Register a global config customizer. It will be applied to all extension types.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Register the <code>SomethingMapper</code> to the every extension handler for every extension type.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="extension-framework-annotations"><a class="anchor" href="#extension-framework-annotations"></a><a class="link" href="#extension-framework-annotations">18.4. Annotations</a></h3>
<div class="paragraph">
<p>A Jdbi extension like the <a href="#sql-objects">SQL Object extension</a> uses annotations on the extension types. It is possible to implement a large part of the
functionality directly as annotation related objects without having to provide extension objects through an extension factory.</p>
</div>
<div class="paragraph">
<p>The extension framework offers <em>meta-annotations</em> to configure <a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandler.html" target="_blank" rel="noopener">ExtensionHandler</a> and
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionHandlerCustomizer.html" target="_blank" rel="noopener">ExtensionHandlerCustomizer</a> instances directly and another <em>meta-annotation</em> to define
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionConfigurer.html" target="_blank" rel="noopener">ExtensionConfigurer</a> instances which allows configuration modification similar to
<a href="./apidocs/org/jdbi/v3/core/extension/ConfigCustomizer.html" target="_blank" rel="noopener">ConfigCustomizer</a>).</p>
</div>
<div class="paragraph">
<p>Meta-annotations are used to annotate other annotation classes for processing by the extension framework.</p>
</div>
<div class="sect3">
<h4 id="_extension_handler_annotation"><a class="anchor" href="#_extension_handler_annotation"></a><a class="link" href="#_extension_handler_annotation">18.4.1. Extension handler annotation</a></h4>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/extension/annotation/UseExtensionHandler.html" target="_blank" rel="noopener">@UseExtensionHandler</a> meta-annotation marks any other annotation as defining an
extension handler.</p>
</div>
<div class="paragraph">
<p>These annotations must be placed on a method in an extension type, therefore annotations that are marked with the meta-annotation should use the
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/Target.html" target="_blank" rel="noopener">@Target({ElementType.METHOD})</a> annotation to limit their scope.</p>
</div>
<div class="paragraph">
<p>The extension framework processes all annotations that use this meta-annotation. It will instantiate the extension handler by locating</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a constructor that takes both the extension type and a method object</p>
</li>
<li>
<p>a constructor that takes only the extension type</p>
</li>
<li>
<p>a no-argument constructor</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If none of those can be found, an exception will be thrown.</p>
</div>
<div class="paragraph">
<p>When using this meta-annotation, the <a href="./apidocs/org/jdbi/v3/core/extension/annotation/UseExtensionHandler.html#id()" target="_blank" rel="noopener">UseExtensionHandler#id()</a> method must return an id
value that is specific for the extension factory that should process the annotation. This allows multiple extensions that use annotations to co-exist.</p>
</div>
<div class="paragraph">
<p>This is an example of an annotation that provides the handler for the <code>getSomething</code> method on an extension type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    jdbi.configure(Extensions.class, extensions -&gt;  <i class="conum" data-value="1"></i><b>(1)</b>
            extensions.register(extensionType -&gt;
                    Stream.of(extensionType.getMethods())
                            .anyMatch(method -&gt;
                                    Stream.of(method.getAnnotations())
                                            .map(annotation -&gt; annotation.annotationType()
                                                    .getAnnotation(UseExtensionHandler.class)) <i class="conum" data-value="2"></i><b>(2)</b>
                                            .anyMatch(a -&gt; a != <span class="predefined-constant">null</span> &amp;&amp; <span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>.equals(a.id())) <i class="conum" data-value="3"></i><b>(3)</b>
                            )));

<span class="type">interface</span> <span class="class">ExtensionType</span> {

    <span class="annotation">@SomethingAnnotation</span> <i class="conum" data-value="4"></i><b>(4)</b>
    Something getSomething(<span class="type">int</span> id, <span class="predefined-type">String</span> name);
}

<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Target</span>({<span class="predefined-type">ElementType</span>.METHOD}) <i class="conum" data-value="5"></i><b>(5)</b>
<span class="annotation">@UseExtensionHandler</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>, <i class="conum" data-value="6"></i><b>(6)</b>
        value = SomethingExtensionHandler.class) <i class="conum" data-value="7"></i><b>(7)</b>
<span class="annotation">@interface</span> SomethingAnnotation {}

<span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">SomethingExtensionHandler</span> <span class="directive">implements</span> ExtensionHandler {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Object</span> invoke(HandleSupplier handleSupplier, <span class="predefined-type">Object</span> target, <span class="predefined-type">Object</span>... args) {
        <span class="keyword">return</span> <span class="keyword">new</span> Something((<span class="type">int</span>) args[<span class="integer">0</span>], (<span class="predefined-type">String</span>) args[<span class="integer">1</span>]);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>An extension factory that implements only the <a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html#accepts(java.lang.Class)" target="_blank" rel="noopener">ExtensionFactory#accepts()</a> method can be written as a lambda.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The factory accepts this extension type if it has at least one method that is annotated with the
<a href="./apidocs/org/jdbi/v3/core/extension/annotation/UseExtensionHandler.html" target="_blank" rel="noopener">@UseExtensionHandler</a> meta-annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ensure that the annotation uses the <code>test</code> id value.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>@SomethingAnnotation</code> provides the extension handler. Any method with this annotation will use the same extension handler.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The custom annotation targets only methods.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The <code>test</code> id value ensures that the registered factory will accept the extension type. Any extension type must be accepted by a factory, otherwise the
extension framework will reject the extension type.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The annotation provides the extension handler class. An instance of this class is created by the extension framework directly without an extension handler
factory.</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Even though multiple extensions can can be used at the same time, they can not share an extension type.  Every extension type will only get extension handlers
associated with a single factory. It is not possible to have an extension type where methods are processed by extension handlers that are annotated with
annotations that use different id values. Any extension handler must be provided either by annotations that match the id value of the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html" target="_blank" rel="noopener">ExtensionFactory</a> or an extension handler factory.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All SQL method annotations in the <a href="#sql-objects">Jdbi SQL Object</a> extension (<a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlBatch.html" target="_blank" rel="noopener">@SqlBatch</a>,
<a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlCall.html" target="_blank" rel="noopener">@SqlCall</a>, <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlQuery.html" target="_blank" rel="noopener">@SqlQuery</a>,
<a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlScript.html" target="_blank" rel="noopener">@SqlScript</a> and <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlUpdate.html" target="_blank" rel="noopener">@SqlUpdate</a>) are marked with this
meta-annotation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_extension_handler_customizer_annotation"><a class="anchor" href="#_extension_handler_customizer_annotation"></a><a class="link" href="#_extension_handler_customizer_annotation">18.4.2. Extension handler customizer annotation</a></h4>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/extension/annotation/UseExtensionHandlerCustomizer.html" target="_blank" rel="noopener">@UseExtensionHandlerCustomizer</a> meta-annotation marks any other annotation
as defining an extension handler customizer.</p>
</div>
<div class="paragraph">
<p>An example in the <a href="#sql-objects">SQL object extension</a> is the <a href="./apidocs/org/jdbi/v3/sqlobject/transaction/Transaction.html" target="_blank" rel="noopener">@Transaction</a> annotation which allows
wrapping multiple SQL operations into a database transaction.</p>
</div>
<div class="paragraph">
<p>Extension handler customizers either apply to all methods in an extension type by adding an annotation to the extension type, or to specific methods by adding
the annotation to a method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Target</span>({<span class="predefined-type">ElementType</span>.METHOD, <span class="predefined-type">ElementType</span>.TYPE}) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@UseExtensionHandlerCustomizer</span>(
        value = LoggingExtensionHandlerCustomizer.class)
<span class="annotation">@interface</span> LogThis {}

<span class="type">interface</span> <span class="class">MethodExtensionType</span> {

    <span class="annotation">@LogThis</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="annotation">@SomethingAnnotation</span>
    Something getSomething(<span class="type">int</span> id, <span class="predefined-type">String</span> name);
}

<span class="annotation">@LogThis</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="type">interface</span> <span class="class">InstanceExtensionType</span> {

    <span class="annotation">@SomethingAnnotation</span>
    Something getSomething(<span class="type">int</span> id, <span class="predefined-type">String</span> name);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>An annotation that uses the <a href="./apidocs/org/jdbi/v3/core/extension/annotation/UseExtensionHandlerCustomizer.html" target="_blank" rel="noopener">@UseExtensionHandlerCustomizer</a> annotation can
be placed on a method or the extension type itself.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The extension handler customizer is only applied to an annotated method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The extension handler customizer is applied to all methods on the extension type.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The extension framework processes all annotations that use this meta-annotation. It will instantiate the extension handler customizer by locating</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a constructor that takes both the extension type and a method object</p>
</li>
<li>
<p>a constructor that takes only the extension type</p>
</li>
<li>
<p>a no-argument constructor</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If none of those can be found, an exception will be thrown.</p>
</div>
<div class="paragraph">
<p>This is an example for an annotation that provides a handler customizer which logs method entry and exit for any extension handler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">LoggingExtensionHandlerCustomizer</span> <span class="directive">implements</span> ExtensionHandlerCustomizer {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> ExtensionHandler customize(ExtensionHandler handler, <span class="predefined-type">Class</span>&lt;?&gt; extensionType, <span class="predefined-type">Method</span> method) {
        <span class="keyword">return</span> (handleSupplier, target, args) -&gt; {
            LOG.info(format(<span class="string"><span class="delimiter">&quot;</span><span class="content">Entering %s on %s</span><span class="delimiter">&quot;</span></span>, method, extensionType.getSimpleName()));
            <span class="keyword">try</span> {
                <span class="keyword">return</span> handler.invoke(handleSupplier, target, args);
            } <span class="keyword">finally</span> {
                LOG.info(format(<span class="string"><span class="delimiter">&quot;</span><span class="content">Leaving %s on %s</span><span class="delimiter">&quot;</span></span>, method, extensionType.getSimpleName()));
            }
        };
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Extension handler customizer objects are not tied to a specific extension factory. This is an example where <a href="#sql-objects">SQL Object</a> method annotations are
used with the custom logging annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">SomethingDao</span> {

    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO something (id, name) VALUES (:s.id, :s.name)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">int</span> insert(<span class="annotation">@BindBean</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">s</span><span class="delimiter">&quot;</span></span>) Something s);

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name FROM something WHERE id = ?</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@LogThis</span>
    Optional&lt;Something&gt; findSomething(<span class="type">int</span> id);
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_specifying_extension_handler_customization_order"><a class="anchor" href="#_specifying_extension_handler_customization_order"></a><a class="link" href="#_specifying_extension_handler_customization_order">Specifying extension handler customization order</a></h5>
<div class="paragraph">
<p>When multiple extension customizers are used on the same extension type method, the order in which they are applied is undefined. If a specific order is
required (e.g. because one customization depends on another), the
<a href="./apidocs/org/jdbi/v3/core/extension/annotation/ExtensionHandlerCustomizationOrder.html" target="_blank" rel="noopener">@ExtensionHandlerCustomizationOrder</a> annotation may be used to enforce a
specific order.</p>
</div>
<div class="paragraph">
<p>Listing the annotation classes orders the extension customizers from outermost to innermost (outermost is called first). Any unlisted annotation will still be
applied but its position is undefined. It is recommended to list all applicable annotation classes when specifying the order.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">interface</span> <span class="class">OrderedCustomizers</span> {
    <span class="annotation">@Bar</span>
    <span class="annotation">@Foo</span>
    <span class="annotation">@ExtensionHandlerCustomizationOrder</span>({Foo.class, Bar.class}) <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="type">void</span> execute();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The annotation ensures that the <code>Foo</code> extension customizer is called first, then the <code>Bar</code> extension customizer. Otherwise, the order is undefined.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_extension_handler_configurer_annotation"><a class="anchor" href="#_extension_handler_configurer_annotation"></a><a class="link" href="#_extension_handler_configurer_annotation">18.4.3. Extension handler configurer annotation</a></h4>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/extension/annotation/UseExtensionConfigurer.html" target="_blank" rel="noopener">@UseExtensionConfigurer</a> meta-annotation marks any other annotation as defining an
extension configurer.</p>
</div>
<div class="paragraph">
<p>Similar to extension handler customizers, configurers either apply to all methods in an extension type by adding an annotation to the extension type, or to
specific methods by adding the annotation to a method.</p>
</div>
<div class="paragraph">
<p>The meta-annotation provides an implementation of the <a href="./apidocs/org/jdbi/v3/core/extension/ExtensionConfigurer.html" target="_blank" rel="noopener">ExtensionConfigurer</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionConfigurer.html#configureForType(org.jdbi.v3.core.config.ConfigRegistry,java.lang.annotation.Annotation,java.lang.Class)" target="_blank" rel="noopener">ExtensionConfigurer#configureForType()</a>
is called if the anntation is placed on the extension type</p>
</li>
<li>
<p>method provides and
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionConfigurer.html#configureForMethod(org.jdbi.v3.core.config.ConfigRegistry,java.lang.annotation.Annotation,java.lang.Class,java.lang.reflect.Method)" target="_blank" rel="noopener">ExtensionConfigurer#configureForMethod()</a>
is called when the annotation is placed on an extension type method</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These methods are the equivalent of
<a href="./apidocs/org/jdbi/v3/core/extension/ConfigCustomizerFactory.html#forExtensionType(java.lang.Class)" target="_blank" rel="noopener">ConfigCustomizerFactory#forExtensionType()</a> and
<a href="./apidocs/org/jdbi/v3/core/extension/ConfigCustomizerFactory.html#forExtensionMethod(java.lang.Class,java.lang.reflect.Method)" target="_blank" rel="noopener">ConfigCustomizerFactory#forExtensionMethod()</a>.</p>
</div>
<div class="paragraph">
<p>The extension framework processes all annotations that use this meta-annotation.</p>
</div>
<div class="paragraph">
<p>It will instantiate the extension configurer by locating</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a constructor that takes the annotation, the extension type, and a method object</p>
</li>
<li>
<p>a constructor that takes the annotation and the extension type</p>
</li>
<li>
<p>a constructor that takes the annotation only</p>
</li>
<li>
<p>a no-argument constructor</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If none can be found, an exception will be thrown.</p>
</div>
<div class="paragraph">
<p>This is an example of an extension configurer annotation that adds a specific <a href="#_row_mappers">row mapper</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Target</span>({<span class="predefined-type">ElementType</span>.METHOD, <span class="predefined-type">ElementType</span>.TYPE})
<span class="annotation">@UseExtensionConfigurer</span>(value = SomethingMapperExtensionConfigurer.class) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@interface</span> RegisterSomethingMapper {}

<span class="type">interface</span> <span class="class">SomethingDao</span> {

    <span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO something (id, name) VALUES (:s.id, :s.name)</span><span class="delimiter">&quot;</span></span>)
    <span class="type">int</span> insert(<span class="annotation">@BindBean</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">s</span><span class="delimiter">&quot;</span></span>) Something s);

    <span class="annotation">@SqlQuery</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT id, name FROM something WHERE id = ?</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@RegisterSomethingMapper</span> <i class="conum" data-value="2"></i><b>(2)</b>
    Optional&lt;Something&gt; findSomething(<span class="type">int</span> id);
}

<span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">SomethingMapperExtensionConfigurer</span> <span class="directive">extends</span> SimpleExtensionConfigurer { <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> configure(ConfigRegistry config, <span class="predefined-type">Annotation</span> annotation, <span class="predefined-type">Class</span>&lt;?&gt; extensionType) {
        config.get(RowMappers.class).register(<span class="keyword">new</span> SomethingMapper());
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>define the extension configurer class in the annotation</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>add the custom annotation to a method in a SQL Object extension type</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The implementation extends <a href="./apidocs/org/jdbi/v3/core/extension/SimpleExtensionConfigurer.html" target="_blank" rel="noopener">SimpleExtensionConfigurer</a> as it should behave the same when used
on an extension type or an extension type method.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Similar to extension handler customizer objects, extension configurers are also not tied to a specific extension factory.  In the example above, a custom
extension configurer is used in combination with the <a href="#sql-objects">SQL Object extension</a> annotations.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If an extension configurer should behave the same way independent of its position, the implementation should extend
<a href="./apidocs/org/jdbi/v3/core/extension/SimpleExtensionConfigurer.html" target="_blank" rel="noopener">SimpleExtensionConfigurer</a> and implement the
<a href="./apidocs/org/jdbi/v3/core/extension/SimpleExtensionConfigurer.html#configure(org.jdbi.v3.core.config.ConfigRegistry,java.lang.annotation.Annotation,java.lang.Class)" target="_blank" rel="noopener">SimpleExtensionConfigurer#configure()</a>
method.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <a href="#sql-objects">SQL Object extension</a> implements all per-method and per-class registration of specific objects
(e.g. <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterColumnMapper.html" target="_blank" rel="noopener">@RegisterColumnMapper</a> or
<a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterRowMapper.html" target="_blank" rel="noopener">@RegisterRowMapper</a>) through extension configurer objects which in turn create config customizer
instances.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_extension_metadata"><a class="anchor" href="#_extension_metadata"></a><a class="link" href="#_extension_metadata">18.5. Extension metadata</a></h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Interacting directly with the <a href="./apidocs/org/jdbi/v3/core/extension/ExtensionMetadata.html" target="_blank" rel="noopener">ExtensionMetadata</a> and
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionMetadata.ExtensionHandlerInvoker.html" target="_blank" rel="noopener">ExtensionHandlerInvoker</a> is an advanced use case when writing specific extension
code. For most extensions, all metadata interactions are handled by the framework and don&#8217;t require anything special.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For every extension type that is processed by the framework, an <a href="./apidocs/org/jdbi/v3/core/extension/ExtensionMetadata.html" target="_blank" rel="noopener">ExtensionMetadata</a> object is created. It
collects all the information that is required to create the <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Proxy.html" target="_blank" rel="noopener">java proxy</a> object:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>extension handlers for each extension type method including optional extension handler customizers.</p>
</li>
<li>
<p>instance config customizers which are applied to every method</p>
</li>
<li>
<p>method specific config customizers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Extension metadata is created using a builder when an extension type is processed for the first time. It is possible for an
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html" target="_blank" rel="noopener">ExtensionFactory</a> to participate in the metadata creation. E.g. the <a href="#sql-objects">SQL Object extension</a>
uses this to add extension handlers for the <a href="./apidocs/org/jdbi/v3/sqlobject/SqlObject.html" target="_blank" rel="noopener">SqlObject</a> interface methods.</p>
</div>
<div class="paragraph">
<p>If an extension factory wants to participate in the metadata creation, it needs to implement the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html#buildExtensionMetaData(org.jdbi.v3.core.extension.ExtensionMetadata.Builder)" target="_blank" rel="noopener">ExtensionFactory#buildExtensionMetadata()</a>
method which is called with the extension metadata builder right before the actual metadata object is created. See the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionMetadata.Builder.html" target="_blank" rel="noopener">ExtensionMetadata.Builder</a> documentation for all available methods.</p>
</div>
<div class="paragraph">
<p>Metadata for an extension type can be retrieved from the <a href="./apidocs/org/jdbi/v3/core/extension/Extensions.html" target="_blank" rel="noopener">Extensions configuration object</a> by calling the
<a href="./apidocs/org/jdbi/v3/core/extension/Extensions.html#findMetadata(java.lang.Class,org.jdbi.v3.core.extension.ExtensionFactory)" target="_blank" rel="noopener">Extensions#findMetadata()</a>.</p>
</div>
<div class="paragraph">
<p>A metadata object can create <a href="./apidocs/org/jdbi/v3/core/extension/ExtensionMetadata.ExtensionHandlerInvoker.html" target="_blank" rel="noopener">ExtensionHandlerInvoker</a> instances for all methods
on the extension type that is represents. An extension handler invoker binds the actual extension handler instance to a specific configuration object (and the
config customizers applied to that configuration object).</p>
</div>
<div class="paragraph">
<p>The main use case is within an extension type implementation class as it requires a <a href="./apidocs/org/jdbi/v3/core/extension/HandleSupplier.html" target="_blank" rel="noopener">HandlerSupplier</a>
instance, which is only available through the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html#attach(java.lang.Class,org.jdbi.v3.core.extension.HandleSupplier)" target="_blank" rel="noopener">ExtensionFactory#attach()</a> method. By
creating extension handler invokers and metadata manually, an implementation can sidestep all the proxy logic and directly wire up method invocation or redirect
invocations between methods. The <a href="#generator">jdbi SQL object generator</a> uses this mechanism to create implementation classes that do not need the java proxy
logic (which is problematic with <a href="https://docs.oracle.com/en/graalvm/enterprise/21/docs/reference-manual/native-image/DynamicProxy/" target="_blank" rel="noopener">GraalVM</a>).</p>
</div>
<div class="paragraph">
<p>This is an example of creating and calling an extension handler invoker directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Test</span>
<span class="directive">public</span> <span class="type">void</span> testIdOne() {
    Something idOne = jdbi.withExtension(ExtensionType.class, ExtensionType::getIdOne);
    assertThat(idOne).isEqualTo(<span class="keyword">new</span> Something(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">apple</span><span class="delimiter">&quot;</span></span>));
}

<span class="type">interface</span> <span class="class">ExtensionType</span> {

    Something getSomething(<span class="type">int</span> id, <span class="predefined-type">String</span> name);

    Something getIdOne();  <i class="conum" data-value="1"></i><b>(1)</b>
}

<span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">TestExtensionFactory</span> <span class="directive">implements</span> ExtensionFactory {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> accepts(<span class="predefined-type">Class</span>&lt;?&gt; extensionType) {
        <span class="keyword">return</span> extensionType == ExtensionType.class;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> &lt;E&gt; E attach(<span class="predefined-type">Class</span>&lt;E&gt; extensionType, HandleSupplier handleSupplier) {

        ExtensionMetadata extensionMetadata = handleSupplier.getConfig() <i class="conum" data-value="2"></i><b>(2)</b>
                .get(Extensions.class).findMetadata(extensionType, <span class="local-variable">this</span>);

        <span class="keyword">return</span> extensionType.cast(<span class="keyword">new</span> ExtensionTypeImpl(extensionMetadata, handleSupplier)); <i class="conum" data-value="3"></i><b>(3)</b>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;FactoryFlag&gt; getFactoryFlags() {
        <span class="keyword">return</span> <span class="predefined-type">EnumSet</span>.of(DONT_USE_PROXY); <i class="conum" data-value="4"></i><b>(4)</b>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;ExtensionHandlerFactory&gt; getExtensionHandlerFactories(ConfigRegistry config) {
        <span class="keyword">return</span> <span class="predefined-type">Collections</span>.singleton(<span class="keyword">new</span> TestExtensionHandlerFactory()); <i class="conum" data-value="5"></i><b>(5)</b>
    }
}

<span class="directive">public</span> <span class="directive">static</span> <span class="type">class</span> <span class="class">TestExtensionHandlerFactory</span> <span class="directive">implements</span> ExtensionHandlerFactory {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> accepts(<span class="predefined-type">Class</span>&lt;?&gt; extensionType, <span class="predefined-type">Method</span> method) {
        <span class="keyword">return</span> method.getName().equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">getSomething</span><span class="delimiter">&quot;</span></span>);  <i class="conum" data-value="6"></i><b>(6)</b>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Optional&lt;ExtensionHandler&gt; createExtensionHandler(<span class="predefined-type">Class</span>&lt;?&gt; extensionType, <span class="predefined-type">Method</span> method) {
        <span class="keyword">return</span> Optional.of((handleSupplier, target, args) -&gt; <span class="keyword">new</span> Something((<span class="type">int</span>) args[<span class="integer">0</span>], (<span class="predefined-type">String</span>) args[<span class="integer">1</span>]));
    }
}

<span class="directive">static</span> <span class="type">class</span> <span class="class">ExtensionTypeImpl</span> <span class="directive">implements</span> ExtensionType {

    <span class="directive">private</span> <span class="directive">final</span> ExtensionHandlerInvoker getSomethingInvoker;

    <span class="directive">private</span> ExtensionTypeImpl(ExtensionMetadata extensionMetadata, HandleSupplier handleSupplier) {

        ConfigRegistry config = handleSupplier.getConfig();
        <span class="local-variable">this</span>.getSomethingInvoker = extensionMetadata.createExtensionHandlerInvoker(<span class="local-variable">this</span>,
                JdbiClassUtils.methodLookup(ExtensionType.class, <span class="string"><span class="delimiter">&quot;</span><span class="content">getSomething</span><span class="delimiter">&quot;</span></span>, <span class="type">int</span>.class, <span class="predefined-type">String</span>.class), <i class="conum" data-value="7"></i><b>(7)</b>
                handleSupplier, config);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Something getSomething(<span class="type">int</span> id, <span class="predefined-type">String</span> name) {
        <span class="keyword">return</span> (Something) getSomethingInvoker.invoke(id, name);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Something getIdOne() {
        <span class="keyword">return</span> (Something) getSomethingInvoker.invoke(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">apple</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="8"></i><b>(8)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>getIdOne</code> method takes no parameters and returns a constant <code>Something</code> object</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The extension factory retrieves the metadata for the <code>ExtensionType</code> class. This call is usually done by the extension framework but can be done manually
when implementing the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionFactory.html#attach(java.lang.Class,org.jdbi.v3.core.extension.HandleSupplier)" target="_blank" rel="noopener">ExtensionFactory#attach()</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The extension factory returns an implementation of the extension type.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The extension factory requests that the framework returns the implementation as is and not wrap it into extension handlers.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The extension factory adds an extension handler factory that provides the actual implementation.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The extension handler factory only accepts the <code>getSomething</code> method, it does <strong>not</strong> create an extension handler for <code>getIdOne</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The extension type uses the metadata object to create an extension handler invoker for the <code>getSomething</code> method. This is handled by the custom extension
handler factory.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The <code>getIdOne</code> method now invokes the extension handler for the <code>getSomething</code> method and passes constant values to the
<a href="./apidocs/org/jdbi/v3/core/extension/ExtensionMetadata.ExtensionHandlerInvoker.html#invoke(java.lang.Object%2E%2E%2E)" target="_blank" rel="noopener">ExtensionHandlerInvoker#invoke()</a> method.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_topics_2"><a class="anchor" href="#_advanced_topics_2"></a><a class="link" href="#_advanced_topics_2">19. Advanced Topics</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_high_availability"><a class="anchor" href="#_high_availability"></a><a class="link" href="#_high_availability">19.1. High Availability</a></h3>
<div class="paragraph">
<p>Jdbi can be combined with connection pools and high-availability features in your database driver.
We&#8217;ve used <a href="https://github.com/brettwooldridge/HikariCP" target="_blank" rel="noopener">HikariCP</a> in combination
with the <a href="https://jdbc.postgresql.org/documentation/head/connect.html" target="_blank" rel="noopener">PgJDBC connection load balancing</a>
features with good success.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">PGSimpleDataSource ds = <span class="keyword">new</span> PGSimpleDataSource();
ds.setServerName(<span class="string"><span class="delimiter">&quot;</span><span class="content">host1,host2,host3</span><span class="delimiter">&quot;</span></span>);
ds.setLoadBalanceHosts(<span class="predefined-constant">true</span>);

HikariConfig hc = <span class="keyword">new</span> HikariConfig();
hc.setDataSource(ds);
hc.setMaximumPoolSize(<span class="integer">6</span>);

Jdbi jdbi = Jdbi.create(<span class="keyword">new</span> HikariDataSource(hc)).installPlugin(<span class="keyword">new</span> PostgresPlugin());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each Jdbi may be backed by a pool of any number of hosts, but the connections should all be alike.
Exactly which parameters must stay the same and which may vary depends on your database and driver.</p>
</div>
<div class="paragraph">
<p>If you want to have two separate pools, for example a read-only set that connects to read replicas
and a smaller pool of writers that go only to a single host, you currently should have separate
<a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> instances each pointed at a separate <code>DataSource</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="compiling_with_parameter_names"><a class="anchor" href="#compiling_with_parameter_names"></a><a class="link" href="#compiling_with_parameter_names">19.2. Compiling with Parameter Names</a></h3>
<div class="paragraph">
<p>By default, the Java compiler does not write parameter names of constructors and
methods to class files. At runtime, using reflection to find  parameter names
will return values like "arg0", "arg1", etc.</p>
</div>
<div class="paragraph">
<p>Out of the box, Jdbi uses annotations to name parameters, e.g.:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ConstructorMapper</code> uses the <code>@ConstructorProperties</code> annotation.</p>
</li>
<li>
<p>SQL Object method arguments use the <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/Bind.html" target="_blank" rel="noopener">@Bind</a> annotation.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
<span class="type">void</span> insert(<span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>) <span class="type">long</span> id, <span class="annotation">@Bind</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> name);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you compile your code with the <code>-parameters</code> compiler flag, then the need for
these annotations is removed&#8201;&#8212;&#8201;Jdbi automatically uses the method parameter name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@SqlUpdate</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO users (id, name) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
<span class="type">void</span> insert(<span class="type">long</span> id, <span class="predefined-type">String</span> name);</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_maven_setup"><a class="anchor" href="#_maven_setup"></a><a class="link" href="#_maven_setup">19.2.1. Maven Setup</a></h4>
<div class="paragraph">
<p>Configure the <code>maven-compiler-plugin</code> in your POM:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
  <span class="tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/groupId&gt;</span>
  <span class="tag">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="tag">&lt;/artifactId&gt;</span>
  <span class="tag">&lt;configuration&gt;</span>
    <span class="tag">&lt;compilerArgs&gt;</span>
      <span class="tag">&lt;arg&gt;</span>-parameters<span class="tag">&lt;/arg&gt;</span>
    <span class="tag">&lt;/compilerArgs&gt;</span>
  <span class="tag">&lt;/configuration&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_intellij_idea_setup"><a class="anchor" href="#_intellij_idea_setup"></a><a class="link" href="#_intellij_idea_setup">19.2.2. IntelliJ IDEA setup</a></h4>
<div class="ulist">
<ul>
<li>
<p>File &#8594; Settings</p>
</li>
<li>
<p>Build, Execution, Deployment &#8594; Compiler &#8594; Java Compiler</p>
</li>
<li>
<p>Additional command-line parameters: <code>-parameters</code></p>
</li>
<li>
<p>Click Apply, then OK.</p>
</li>
<li>
<p>Build &#8594; Rebuild Project</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_eclipse_setup"><a class="anchor" href="#_eclipse_setup"></a><a class="link" href="#_eclipse_setup">19.2.3. Eclipse Setup</a></h4>
<div class="ulist">
<ul>
<li>
<p>Window &#8594; Preferences</p>
</li>
<li>
<p>Java &#8594; Compiler</p>
</li>
<li>
<p>Under "Classfile Generation," check the option "Store information about
method parameters (usable via reflection)."</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_working_with_generic_types"><a class="anchor" href="#_working_with_generic_types"></a><a class="link" href="#_working_with_generic_types">19.3. Working with Generic Types</a></h3>
<div class="paragraph">
<p>Jdbi provides utility classes to make it easier to work with Java generic types.</p>
</div>
<div class="sect3">
<h4 id="_generictype"><a class="anchor" href="#_generictype"></a><a class="link" href="#_generictype">19.3.1. GenericType</a></h4>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/core/generic/GenericType.html" target="_blank" rel="noopener">GenericType</a> represents a generic
type signature that can be passed around in a type-safe way.</p>
</div>
<div class="paragraph">
<p>Create a generic type reference by instantiating an anonymous inner class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">new</span> GenericType&lt;Optional&lt;<span class="predefined-type">String</span>&gt;&gt;() {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This type reference can be passed to any Jdbi method that accepts a
<code>GenericType&lt;T&gt;</code>, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;Optional&lt;<span class="predefined-type">String</span>&gt;&gt; middleNames = handle
    .select(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT middle_name FROM contacts</span><span class="delimiter">&quot;</span></span>)
    .mapTo(<span class="keyword">new</span> GenericType&lt;Optional&lt;<span class="predefined-type">String</span>&gt;&gt;() {})
    .list();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>GenericType.getType()</code> returns the raw
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Type.html" target="_blank" rel="noopener">java.lang.reflect.Type</a> object used
to represent generics in Java.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_generictypes_helper"><a class="anchor" href="#_the_generictypes_helper"></a><a class="link" href="#_the_generictypes_helper">19.3.2. The GenericTypes helper</a></h4>
<div class="paragraph">
<p><a href="./apidocs/org/jdbi/v3/core/generic/GenericTypes.html" target="_blank" rel="noopener">GenericTypes</a> provides methods
for working with Java generic types signatures.</p>
</div>
<div class="paragraph">
<p>All methods in <code>GenericTypes</code> operate in terms of <code>java.lang.reflect.Type</code>.</p>
</div>
<div class="paragraph">
<p>The <code>getErasedType(Type)</code> method accepts a <code>Type</code> and returns the raw <code>Class</code>
for that type, with any generic parameters erased:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Type</span> listOfInteger = <span class="keyword">new</span> GenericType&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt;&gt;() {}.getType();
GenericTypes.getErasedType(listOfInteger); <span class="comment">// =&gt; List.class</span>

GenericTypes.getErasedType(<span class="predefined-type">String</span>.class); <span class="comment">// =&gt; String.class</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>resolveType(Type, Type)</code> method takes a generic type, and a context type in
which to resolve it.</p>
</div>
<div class="paragraph">
<p>For example, given the type variable <code>T</code> from <code>Optional&lt;T&gt;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Type</span> t = Optional.class.getTypeParameters()[<span class="integer">0</span>];</code></pre>
</div>
</div>
<div class="paragraph">
<p>And given the context type <code>Optional&lt;String&gt;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Type</span> optionalOfString = <span class="keyword">new</span> GenericType&lt;Optional&lt;<span class="predefined-type">String</span>&gt;&gt;() {}.getType();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>resolveType()</code> method answers the question: "what is type T, in the context
of type Optional&lt;String&gt;?"</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GenericTypes.resolveType(t, optionalOfString);
<span class="comment">// =&gt; String.class</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This scenario of resolving the first type parameter of some generic supertype is
so common that we made a separate method for it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GenericTypes.findGenericParameter(optionalOfString, Optional.class);
<span class="comment">// =&gt; Optional.of(String.class)</span>

<span class="predefined-type">Type</span> listOfInteger = <span class="keyword">new</span> GenericType&lt;<span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt;&gt;() {}.getType();
GenericTypes.findGenericParameter(listOfInteger, <span class="predefined-type">Collection</span>.class);
<span class="comment">// =&gt; Optional.of(Integer.class)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this method will return <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html#empty--" target="_blank" rel="noopener">Optional.empty()</a> if the type parameter
cannot be resolved, or the types have nothing to do with each other:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GenericTypes.findGenericParameter(optionalOfString, <span class="predefined-type">List</span>.class);
<span class="comment">// =&gt; Optional.empty();</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_namedargumentfinder"><a class="anchor" href="#_namedargumentfinder"></a><a class="link" href="#_namedargumentfinder">19.4. NamedArgumentFinder</a></h3>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/argument/NamedArgumentFinder" target="_blank" rel="noopener">NamedArgumentFinder</a>
interface, as its name suggests, finds arguments by name from some source.
Typically, a single <code>NamedArgumentFinder</code> instance will provide arguments for
several names.</p>
</div>
<div class="paragraph">
<p>In cases where neither <code>bindBean()</code>, <code>bindFields()</code>, <code>bindMethods()</code>, nor
<code>bindMap()</code> are a good fit, you can implement your own <code>NamedArgumentFinder</code> and
bind that, instead of extracting and binding each argument individually.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Cache cache = ... <span class="comment">// e.g. Guava Cache</span>
NamedArgumentFinder cacheFinder = (name, ctx) -&gt;
    Optional.ofNullable(cache.getIfPresent(name))
            .map(value -&gt; ctx.findArgumentFor(<span class="predefined-type">Object</span>.class, value));

stmt.bindNamedArgumentFinder(cacheFinder);</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Under the hood, the
<a href="./apidocs/org/jdbi/v3/core/statement/SqlStatement.html#bindBean-java.lang.Object-" target="_blank" rel="noopener">SqlStatement.bindBean()</a>,
<a href="./apidocs/org/jdbi/v3/core/statement/SqlStatement.html#bindMethods-java.lang.Object-" target="_blank" rel="noopener">SqlStatement.bindMethods()</a>,
<a href="./apidocs/org/jdbi/v3/core/statement/SqlStatement.html#bindFields-java.lang.Object-" target="_blank" rel="noopener">SqlStatement.bindFields()</a>,
and
<a href="./apidocs/org/jdbi/v3/core/statement/SqlStatement.html#bindMap-java.util.Map-" target="_blank" rel="noopener">SqlStatement.bindMap()</a>
methods are just creating and binding custom implementations of
<code>NamedArgumentFinder</code> for beans, methods, fields, and maps, respectively.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_jdbiconfig"><a class="anchor" href="#_jdbiconfig"></a><a class="link" href="#_jdbiconfig">19.5. JdbiConfig</a></h3>
<div class="paragraph">
<p>Configuration is managed by the
<a href="./apidocs/org/jdbi/v3/core/config/ConfigRegistry.html" target="_blank" rel="noopener">ConfigRegistry</a> class.
Each Jdbi object that represents a distinct database context (for
example, <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> itself, a
<a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> instance, or an attached
<a href="./apidocs/org/jdbi/v3/sqlobject/SqlObject.html" target="_blank" rel="noopener">SqlObject</a> class) has a
separate config registry instance.</p>
</div>
<div class="paragraph">
<p>A context implements the
<a href="./apidocs/org/jdbi/v3/core/config/Configurable.html" target="_blank" rel="noopener">Configurable</a> interface
which allows modification of its configuration as well as retrieving
the current context&#8217;s configuration for use by Jdbi core or
extensions.</p>
</div>
<div class="paragraph">
<p>When a new context is created, it inherits a copy of its parent
configuration at the time of creation - further modifications to the
original will not affect already created configuration contexts.
Configuration context copies happen when creating a
<a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> from
<a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a>, when opening a
<a href="./apidocs/org/jdbi/v3/core/statement/SqlStatement.html" target="_blank" rel="noopener">SqlStatement</a> from
the Handle, and when attaching or creating an on-demand extension such
as <a href="./apidocs/org/jdbi/v3/sqlobject/SqlObject.html" target="_blank" rel="noopener">SqlObject</a>.</p>
</div>
<div class="paragraph">
<p>The configuration itself is stored in implementations of the
<a href="./apidocs/org/jdbi/v3/core/config/JdbiConfig.html" target="_blank" rel="noopener">JdbiConfig</a> interface.
Each implementation must adhere to the contract of the interface; in
particular it must have a public no-argument constructor that provides
useful defaults and an implementation of the
<a href="./apidocs/org/jdbi/v3/core/config/JdbiConfig.html#createCopy()" target="_blank" rel="noopener">JdbiConfig#createCopy</a>
method that is invoked when a configuration registry is cloned.</p>
</div>
<div class="paragraph">
<p>Configuration should be set on a context before that context is used,
and not changed later. Some configuration classes may be thread-safe but most are
not. Configuration objects should be implemented so that they are cheap to copy,
for example the base ones use copy-on-write collections.</p>
</div>
<div class="paragraph">
<p>Many of Jdbi&#8217;s core features, for example argument or mapper
registries, are simply implementations of
<a href="./apidocs/org/jdbi/v3/core/config/JdbiConfig.html" target="_blank" rel="noopener">JdbiConfig</a> that store the
registered mappings for later use during query execution.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ExampleConfig</span> <span class="directive">implements</span> JdbiConfig&lt;ExampleConfig&gt; {

    <span class="directive">private</span> <span class="predefined-type">String</span> color;
    <span class="directive">private</span> <span class="type">int</span> number;

    <span class="directive">public</span> ExampleConfig() {
        color = <span class="string"><span class="delimiter">&quot;</span><span class="content">purple</span><span class="delimiter">&quot;</span></span>;
        number = <span class="integer">42</span>;
    }

    <span class="directive">private</span> ExampleConfig(ExampleConfig other) {
        <span class="local-variable">this</span>.color = other.color;
        <span class="local-variable">this</span>.number = other.number;
    }

    <span class="directive">public</span> ExampleConfig setColor(<span class="predefined-type">String</span> color) {
        <span class="local-variable">this</span>.color = color;
        <span class="keyword">return</span> <span class="local-variable">this</span>;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getColor() {
        <span class="keyword">return</span> color;
    }

    <span class="directive">public</span> ExampleConfig setNumber(<span class="type">int</span> number) {
        <span class="local-variable">this</span>.number = number;
        <span class="keyword">return</span> <span class="local-variable">this</span>;
    }

    <span class="directive">public</span> <span class="type">int</span> getNumber() {
        <span class="keyword">return</span> number;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> ExampleConfig createCopy() {
        <span class="keyword">return</span> <span class="keyword">new</span> ExampleConfig(<span class="local-variable">this</span>);
    }

}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_creating_a_custom_jdbiconfig_type"><a class="anchor" href="#_creating_a_custom_jdbiconfig_type"></a><a class="link" href="#_creating_a_custom_jdbiconfig_type">19.5.1. Creating a custom JdbiConfig type</a></h4>
<div class="ulist">
<ul>
<li>
<p>Create a public class that implements JdbiConfig.</p>
</li>
<li>
<p>Add a public, no-argument constructor</p>
</li>
<li>
<p>Add a private, copy constructor.</p>
</li>
<li>
<p>Implement <code>createCopy()</code> to call the copy constructor.</p>
</li>
<li>
<p>Add config properties, and provide sane defaults for each property.</p>
</li>
<li>
<p>Ensure that all config properties get copied to the new instance in the copy
constructor.</p>
</li>
<li>
<p>Override <code>setConfig(ConfigRegistry)</code> if your config class wants to be able to
use other config classes in the registry. E.g. RowMappers registry delegates
to ColumnMappers registry, if it does not have a mapper registered for a given
type.</p>
</li>
<li>
<p>Use that configuration object from other classes that are interested in it.</p>
<div class="ulist">
<ul>
<li>
<p>e.g. BeanMapper, FieldMapper, and ConstructorMapper all use the
ReflectionMappers config class to keep common configuration.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jdbiplugin"><a class="anchor" href="#_jdbiplugin"></a><a class="link" href="#_jdbiplugin">19.6. JdbiPlugin</a></h3>
<div class="paragraph">
<p>JdbiPlugin can be used to bundle bulk configuration.
Plugins may be installed explicitly via <code>Jdbi.installPlugin(JdbiPlugin)</code>, or
may be installed automagically from the classpath using the ServiceLoader mechanism
via <code>installPlugins()</code>.</p>
</div>
<div class="paragraph">
<p>Jars may provide a file in <code>META-INF/services/org.jdbi.v3.core.spi.JdbiPlugin</code>
containing the fully qualified class name of your plugin.</p>
</div>
<div class="paragraph">
<p>In general, Jdbi&#8217;s separate artifacts each provide a single relevant plugin (e.g. <code>jdbi3-sqlite</code>),
and such modules will be auto-loadable. Modules that provide no (e.g. <code>jdbi3-commons-text</code>)
or multiple (e.g. <code>jdbi3-core</code>) plugins typically will not be.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The developers encourage you to install plugins explicitly.  Code with declared dependencies
on the module it uses is more robust to refactoring and provides useful data
for static analysis tools about what code is or is not used.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_statementcontext"><a class="anchor" href="#_statementcontext"></a><a class="link" href="#_statementcontext">19.7. StatementContext</a></h3>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/statement/StatementContext.html" target="_blank" rel="noopener">StatementContext</a> class holds the state for all <a href="#_statement_types">statements</a>. It is a stateful object that should not be shared between threads. It may be used by different threads as long as this happens sequentially.</p>
</div>
<div class="paragraph">
<p>The statement context object is passed into most user extension points, e.g. <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper</a>, <a href="./apidocs/org/jdbi/v3/core/mapper/ColumnMapper.html" target="_blank" rel="noopener">ColumnMapper</a>, or <a href="./apidocs/org/jdbi/v3/core/collector/CollectorFactory.html" target="_blank" rel="noopener">CollectorFactory</a>.</p>
</div>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/statement/StatementContext.html" target="_blank" rel="noopener">StatementContext</a> is not intended to be extended and extension points should use it to get access to other parts of the system (especially the config registry). They rarely need to make changes to it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_templateengine"><a class="anchor" href="#_templateengine"></a><a class="link" href="#_templateengine">19.8. TemplateEngine</a></h3>
<div class="paragraph">
<p>Jdbi uses a <a href="./apidocs/org/jdbi/v3/core/statement/TemplateEngine.html" target="_blank" rel="noopener">TemplateEngine</a>
implementation to render templates into SQL. Template engines take a SQL
template string and the <code>StatementContext</code> as input, and produce a parseable
SQL string as output.</p>
</div>
<div class="paragraph">
<p>Out of the box, Jdbi is configured to use <a href="./apidocs/org/jdbi/v3/core/statement/DefinedAttributeTemplateEngine.html" target="_blank" rel="noopener">DefinedAttributeTemplateEngine</a>, which replaces angle-bracked tokens like <code>&lt;name&gt;</code> in SQL statements with
the string value of the named attribute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> tableName = <span class="string"><span class="delimiter">&quot;</span><span class="content">customers</span><span class="delimiter">&quot;</span></span>;
<span class="predefined-type">Class</span>&lt;?&gt; entityClass = Customer.class;

handle.createQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT &lt;columns&gt; FROM &lt;table&gt;</span><span class="delimiter">&quot;</span></span>)
      .define(<span class="string"><span class="delimiter">&quot;</span><span class="content">table</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">customers</span><span class="delimiter">&quot;</span></span>)
      .defineList(<span class="string"><span class="delimiter">&quot;</span><span class="content">columns</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)
      .mapToMap()
      .list() <span class="comment">// =&gt; &quot;SELECT id, name FROM customers&quot;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>defineList</code> method defines a list of elements as the comma-separated
splice of String values of the individual elements. In the above example,
the <code>columns</code> attribute is defined as <code>"id, name"</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Jdbi supports custom template engines through the <a href="./apidocs/org/jdbi/v3/core/statement/TemplateEngine.html" target="_blank" rel="noopener">TemplateEngine</a>
interface. By calling <a href="./apidocs/org/jdbi/v3/core/config/Configurable.html#setTemplateEngine(org.jdbi.v3.core.statement.TemplateEngine)" target="_blank" rel="noopener">Configurable#setTemplateEngine()</a> method on the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a>, <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a>, or any SQL statement like <a href="./apidocs/org/jdbi/v3/core/statement/Update.html" target="_blank" rel="noopener">Update</a> or <a href="./apidocs/org/jdbi/v3/core/statement/Query.html" target="_blank" rel="noopener">Query</a>, the template engine used to render SQL can be changed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">TemplateEngine templateEngine = (template, ctx) -&gt; {
  ...
};

jdbi.setTemplateEngine(templateEngine);</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Jdbi also provides <a href="./apidocs/org/jdbi/v3/stringtemplate4/StringTemplateEngine.html" target="_blank" rel="noopener">StringTemplateEngine</a>,
which renders templates using the <a href="https://www.stringtemplate.org/" target="_blank" rel="noopener">StringTemplate library</a>. See <a href="#stringtemplate4">StringTemplate 4</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Template engines interact with the SQL template caching. A template engine may implement the <a href="./apidocs/org/jdbi/v3/core/statement/TemplateEngine.html#parse(java.lang.String,org.jdbi.v3.core.config.ConfigRegistry)" target="_blank" rel="noopener">TemplateEngine#parse()</a> methods to create an intermediary representation of a template that can be used to render a template faster. The output of this method will be cached. Depending on the implementation, defined attributes may be resolved at parse time and not at render time.</p>
</div>
<div class="paragraph">
<p>The most commonly used template engines (<a href="./apidocs/org/jdbi/v3/core/statement/DefinedAttributeTemplateEngine.html" target="_blank" rel="noopener">DefinedAttributeTemplateEngine</a> and <a href="./apidocs/org/jdbi/v3/stringtemplate4/StringTemplateEngine.html" target="_blank" rel="noopener">StringTemplateEngine</a> do <strong>not</strong> support caching).</p>
</div>
</div>
<div class="sect2">
<h3 id="_sqlparser"><a class="anchor" href="#_sqlparser"></a><a class="link" href="#_sqlparser">19.9. SqlParser</a></h3>
<div class="paragraph">
<p>After the SQL template has been rendered, Jdbi uses a <a href="./apidocs/org/jdbi/v3/core/statement/SqlParser.html" target="_blank" rel="noopener">SqlParser</a> to parse out any named parameters from the SQL statement. This Produces a <a href="./apidocs/org/jdbi/v3/core/statement/ParsedSql.html" target="_blank" rel="noopener">ParsedSql</a> object, which
contains all the information Jdbi needs to bind parameters and execute the SQL statement.</p>
</div>
<div class="paragraph">
<p>Out of the box, Jdbi is configured to use <a href="./apidocs/org/jdbi/v3/core/statement/ColonPrefixSqlParser.html" target="_blank" rel="noopener">ColonPrefixSqlParser</a>, which
recognizes colon-prefixed named parameters, e.g. <code>:name</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO characters (id, name) VALUES (:id, :name)</span><span class="delimiter">&quot;</span></span>)
      .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">1</span>)
      .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Dolores Abernathy</span><span class="delimiter">&quot;</span></span>)
      .execute();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Jdbi also provides <a href="./apidocs/org/jdbi/v3/core/statement/HashPrefixSqlParser.html" target="_blank" rel="noopener">HashPrefixSqlParser</a>, which recognizes hash-prefixed
parameters, e.g. <code>#hashtag</code>. Other custom parsers implement the <a href="./apidocs/org/jdbi/v3/core/statement/SqlParser.html" target="_blank" rel="noopener">SqlParser</a>
interface.</p>
</div>
<div class="paragraph">
<p>By calling <a href="./apidocs/org/jdbi/v3/core/config/Configurable.html#setSqlParser(org.jdbi.v3.core.statement.SqlParser)" target="_blank" rel="noopener">Configurable#setSqlParser()</a> method on the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a>, <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a>, or any SQL statement like <a href="./apidocs/org/jdbi/v3/core/statement/Update.html" target="_blank" rel="noopener">Update</a> or <a href="./apidocs/org/jdbi/v3/core/statement/Query.html" target="_blank" rel="noopener">Query</a>, the parser used to define named arguments can be changed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">handle.setSqlParser(<span class="keyword">new</span> HashPrefixSqlParser())
      .createUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">INSERT INTO characters (id, name) VALUES (#id, #name)</span><span class="delimiter">&quot;</span></span>)
      .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, <span class="integer">2</span>)
      .bind(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Teddy Flood</span><span class="delimiter">&quot;</span></span>)
      .execute();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default parsers recognize any Java identifier and additionally the dot and dash (<code>.</code> and <code>-</code>) as a valid characters in a parameter or attribute name. Even some strange cases like emoji are allowed, although the Jdbi authors encourage appropriate discretion 🧐.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The default parsers try to ignore parameter-like constructions inside of string literals,
since JDBC drivers wouldn&#8217;t let you bind parameters there anyway.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_sqllogger"><a class="anchor" href="#_sqllogger"></a><a class="link" href="#_sqllogger">19.10. SqlLogger</a></h3>
<div class="paragraph">
<p>The <a href="./apidocs/org/jdbi/v3/core/statement/SqlLogger.html" target="_blank" rel="noopener">SqlLogger</a> interface
is called before and after executing each statement,
and given the current <code>StatementContext</code>, to log any relevant information desired:
mainly the query in various compilation stages,
attributes and bindings, and important timestamps.</p>
</div>
<div class="paragraph">
<p>There&#8217;s a simple <a href="./apidocs/org/jdbi/v3/core/statement/Slf4JSqlLogger.html" target="_blank" rel="noopener">Slf4JSqlLogger</a>
implementation that logs all executed statements for debugging.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resultproducer"><a class="anchor" href="#_resultproducer"></a><a class="link" href="#_resultproducer">19.11. ResultProducer</a></h3>
<div class="paragraph">
<p>A <strong>ResultProducer</strong> takes a lazily supplied <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/PreparedStatement.html" target="_blank" rel="noopener">PreparedStatement</a> and
produces a result.  The most common producer path, <strong>execute()</strong>,
retrieves the <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/ResultSet.html" target="_blank" rel="noopener">ResultSet</a> over the query results and then uses a
<strong>ResultSetScanner</strong> or higher level mapper to produce results.</p>
</div>
<div class="paragraph">
<p>An example alternate use is to just return the number of rows modified,
as in an UPDATE or INSERT statement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">static</span> ResultProducer&lt;<span class="predefined-type">Integer</span>&gt; returningUpdateCount() {
    <span class="keyword">return</span> (statementSupplier, ctx) -&gt; {
        <span class="keyword">try</span> {
            <span class="keyword">return</span> statementSupplier.get().getUpdateCount();
        } <span class="keyword">finally</span> {
            ctx.close();
        }
    };
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you acquire the lazy statement, you are responsible for ensuring
that the context is closed eventually to release database resources.</p>
</div>
<div class="paragraph">
<p>Most users will not need to implement the <strong>ResultProducer</strong> interface.</p>
</div>
</div>
<div class="sect2">
<h3 id="generator"><a class="anchor" href="#generator"></a><a class="link" href="#generator">19.12. Jdbi SQL object code generator</a></h3>
<div class="paragraph">
<p>Jdbi includes an experimental SqlObject code generator.  If you
include the <code>jdbi3-generator</code> artifact as an annotation processor and
annotate your SqlObject definitions with <code>@GenerateSqlObject</code>, the
generator will produce an implementing class and avoids using
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Proxy.html" target="_blank" rel="noopener">Java proxy</a> instances.
This may be useful for <code>graal-native</code> compilation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_handlecallbackdecorator"><a class="anchor" href="#_handlecallbackdecorator"></a><a class="link" href="#_handlecallbackdecorator">19.13. HandleCallbackDecorator</a></h3>
<div class="paragraph">
<p>Jdbi allows specifying a decorator that can be applied to all callbacks passed to
<a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useHandle(org.jdbi.v3.core.HandleConsumer)" target="_blank" rel="noopener">useHandle</a>,
<a href="./apidocs/org/jdbi/v3/core/Jdbi.html#withHandle(org.jdbi.v3.core.HandleCallback)" target="_blank" rel="noopener">withHandle</a>,
<a href="./apidocs/org/jdbi/v3/core/Jdbi.html#useTransaction(org.jdbi.v3.core.HandleConsumer)" target="_blank" rel="noopener">useTransaction</a>,
or <a href="./apidocs/org/jdbi/v3/core/Jdbi.html#inTransaction(org.jdbi.v3.core.HandleCallback)" target="_blank" rel="noopener">inTransaction</a>.
This is for use-cases where you need to perform an action on all callbacks used in
Jdbi. For instance, you might want to have global retries whether a transaction is used
or not. Jdbi already provides retry handlers for transactions, but you might want to retry auto-commit
(non-transaction) queries as well. E.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">ExampleJdbiPlugin</span>
        <span class="directive">implements</span> JdbiPlugin, HandleCallbackDecorator
{
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> customizeJdbi(Jdbi jdbi)
    {
        jdbi.setHandleCallbackDecorator(<span class="local-variable">this</span>);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> &lt;R, X <span class="directive">extends</span> <span class="exception">Exception</span>&gt; HandleCallback&lt;R, X&gt; decorate(HandleCallback&lt;R, X&gt; callback)
    {
        <span class="keyword">return</span> handle -&gt; {
            <span class="keyword">try</span> {
                <span class="keyword">if</span> (handle.getConnection().getAutoCommit()) {
                    <span class="comment">// do retries for auto-commit</span>
                    <span class="keyword">return</span> withRetry(handle, callback);
                }
            }
            <span class="keyword">catch</span> (<span class="exception">SQLException</span> e) {
                <span class="keyword">throw</span> <span class="keyword">new</span> ConnectionException(e);
            }

            <span class="comment">// all others get standard behavior</span>
            <span class="keyword">return</span> callback.withHandle(handle);
        };
    }

    <span class="directive">private</span> &lt;R, X <span class="directive">extends</span> <span class="exception">Exception</span>&gt; R withRetry(Handle handle, HandleCallback&lt;R, X&gt; callback)
            <span class="directive">throws</span> X
    {
        <span class="keyword">while</span> (<span class="predefined-constant">true</span>) {
            <span class="keyword">try</span> {
                <span class="keyword">return</span> callback.withHandle(handle);
            }
            <span class="keyword">catch</span> (<span class="exception">Exception</span> last) {
                <span class="comment">// custom auto-commit retry behavior goes here</span>
            }
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendix"><a class="anchor" href="#_appendix"></a><a class="link" href="#_appendix">20. Appendix</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_best_practices"><a class="anchor" href="#_best_practices"></a><a class="link" href="#_best_practices">20.1. Best Practices</a></h3>
<div class="ulist">
<ul>
<li>
<p>Test your SQL Objects (DAOs) against real databases when possible.
Jdbi tries to be defensive and fail eagerly when you hold it wrong.</p>
</li>
<li>
<p>Use the <code>-parameters</code> compiler flag to avoid all those
<code>@Bind("foo") String foo</code> redundant qualifiers in SQL Object method
parameters.  See <a href="#compiling_with_parameter_names">Compiling with Parameter Names</a>.</p>
</li>
<li>
<p>Use a profiler! The true root cause of performance problems can often be a
surprise. Measure first, <em>then</em> tune for performance. And then measure again
to be sure it made a difference.</p>
</li>
<li>
<p>Don&#8217;t forget to bring a towel!</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_api_reference"><a class="anchor" href="#_api_reference"></a><a class="link" href="#_api_reference">20.2. API Reference</a></h3>
<div class="ulist">
<ul>
<li>
<p><a href="apidocs/index.html" target="_blank" rel="noopener">Javadoc</a></p>
</li>
<li>
<p><a href="apidocs-kotlin/jdbi3-kotlin/index.html" target="_blank" rel="noopener">jdbi3-kotlin</a></p>
</li>
<li>
<p><a href="apidocs-kotlin/jdbi3-kotlin-sqlobject/index.html" target="_blank" rel="noopener">jdbi3-kotlin-sqlobject</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_related_projects"><a class="anchor" href="#_related_projects"></a><a class="link" href="#_related_projects">20.3. Related Projects</a></h3>
<div class="paragraph">
<p><a href="https://github.com/opentable/otj-pg-embedded" target="_blank" rel="noopener">Embedded Postgres</a>
makes testing against a real database quick and easy.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/arteam/dropwizard-jdbi3" target="_blank" rel="noopener">dropwizard-jdbi3</a>
provides integration with DropWizard.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/arteam/metrics-jdbi3" target="_blank" rel="noopener">metrics-jdbi3</a>
instruments using DropWizard-Metrics to emit statement timing statistics.</p>
</div>
<div class="paragraph">
<p>Do you know of a project related to Jdbi? Send us an issue, and we&#8217;ll add a link
here!</p>
</div>
</div>
<div class="sect2">
<h3 id="_upgrading_from_v2_to_v3"><a class="anchor" href="#_upgrading_from_v2_to_v3"></a><a class="link" href="#_upgrading_from_v2_to_v3">20.4. Upgrading from v2 to v3</a></h3>
<div class="paragraph">
<p>Already using Jdbi v2?</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a quick summary of differences to help you upgrade:</p>
</div>
<div class="paragraph">
<p>General:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maven artifacts renamed and split out:</p>
</li>
<li>
<p>Old: <code>org.jdbi:jdbi</code></p>
</li>
<li>
<p>New: <code>org.jdbi:jdbi3-core</code>, <code>org.jdbi:jdbi3-sqlobject</code>, etc.</p>
</li>
<li>
<p>Root package renamed: <code>org.skife.jdbi.v2</code> &#8594; <code>org.jdbi.v3</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Core API:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DBI</code>, <code>IDBI</code> &#8594; <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a></p>
<div class="ulist">
<ul>
<li>
<p>Instantiate with <code>Jdbi.create()</code> factory methods instead of constructors.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>DBIException</code> &#8594; <code>JdbiException</code></p>
</li>
<li>
<p><code>Handle.select(String, &#8230;&#8203;)</code> now returns a <a href="./apidocs/org/jdbi/v3/core/statement/Query.html" target="_blank" rel="noopener">Query</a> for further method
chaining, instead of a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/List.html" target="_blank" rel="noopener">List&lt;Map&lt;String, Object&gt;&gt;</a>. Call
<code>Handle.select(sql, &#8230;&#8203;).mapToMap().list()</code> for the same effect as v2.</p>
</li>
<li>
<p><code>Handle.insert()</code> and <code>Handle.update()</code> have been coalesced into
<code>Handle.execute()</code>.</p>
</li>
<li>
<p><code>ArgumentFactory</code> is no longer generic.</p>
</li>
<li>
<p><code>AbstractArgumentFactory</code> is a generic implementation of <code>ArgumentFactory</code>
for factories that handle a single argument type.</p>
</li>
<li>
<p>Argument and mapper factories now operate in terms of
<code>java.lang.reflect.Type</code> instead of <code>java.lang.Class</code>. This allows Jdbi to
handle arguments and mappers for generic types.</p>
</li>
<li>
<p>Argument and mapper factories now have a single <code>build()</code> method that returns
an <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html" target="_blank" rel="noopener">Optional</a>, instead of separate <code>accepts()</code> and <code>build()</code> methods.</p>
</li>
<li>
<p><code>ResultSetMapper</code> &#8594; <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapper.html" target="_blank" rel="noopener">RowMapper</a>. The row index parameter was also removed
from <code>RowMapper</code>--the current row number can be retrieved directly from the
<code>ResultSet</code>.</p>
</li>
<li>
<p><code>ResultColumnMapper</code> &#8594; <a href="./apidocs/org/jdbi/v3/core/mapper/ColumnMapper.html" target="_blank" rel="noopener">ColumnMapper</a></p>
</li>
<li>
<p><code>ResultSetMapperFactory</code> &#8594; <a href="./apidocs/org/jdbi/v3/core/mapper/RowMapperFactory.html" target="_blank" rel="noopener">RowMapperFactory</a></p>
</li>
<li>
<p><code>ResultColumnMapperFactory</code> &#8594; <a href="./apidocs/org/jdbi/v3/core/mapper/ColumnMapperFactory.html" target="_blank" rel="noopener">ColumnMapperFactory</a></p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/core/statement/Query.html" target="_blank" rel="noopener">Query</a> no longer maps to <code>Map&lt;String, Object&gt;</code> by default. Call
<code>Query.mapToMap()</code>, <code>.mapToBean(type)</code>, <code>.map(mapper)</code> or <code>.mapTo(type)</code>.</p>
</li>
<li>
<p><code>ResultBearing&lt;T&gt;</code> was refactored into <code>ResultBearing</code> (no generic parameter)
and <code>ResultIterable&lt;T&gt;</code>. Call <code>.mapTo(type)</code> to get a <code>ResultIterable&lt;T&gt;</code>.</p>
</li>
<li>
<p><code>TransactionConsumer</code> and <code>TransactionCallback</code> only take a <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> now&#8212;&#8203;the
<code>TransactionStatus</code> argument is removed. Just rollback the handle now.</p>
</li>
<li>
<p><code>TransactionStatus</code> class removed.</p>
</li>
<li>
<p><code>CallbackFailedException</code> class removed. The functional interfaces like
<code>HandleConsumer</code>, <code>HandleCallback</code>, <code>TransactionCallback</code>, etc. can now throw
any exception type. Methods like <code>Jdbi.inTransaction</code> that take these
callbacks use exception transparency to throw only the exception thrown by
the callback. If your callback throws no checked exceptions, you don&#8217;t need
a try/catch block.</p>
</li>
<li>
<p><code>StatementLocator</code> interface removed from core. All core statements expect to
receive the actual SQL string now. A similar concept, <code>SqlLocator</code> was added
but is specific to SQL Object.</p>
</li>
<li>
<p><code>StatementRewriter</code> refactored into <a href="./apidocs/org/jdbi/v3/core/statement/TemplateEngine.html" target="_blank" rel="noopener">TemplateEngine</a>, and <a href="./apidocs/org/jdbi/v3/core/statement/SqlParser.html" target="_blank" rel="noopener">SqlParser</a>.</p>
</li>
<li>
<p>StringTemplate no longer required to process <code>&lt;name&gt;</code>-style tokens in SQL.</p>
</li>
<li>
<p>Custom SqlParser implementations must now provide a way to transform raw
parameter names to names that will be properly parsed out as named params.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>SQL Object API:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SQL Object support is not installed by default. It must be added as a
separate dependency, and the plugin installed into the <a href="./apidocs/org/jdbi/v3/core/Jdbi.html" target="_blank" rel="noopener">Jdbi</a> object:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Jdbi jdbi = Jdbi.create(...);
jdbi.installPlugin(<span class="keyword">new</span> SqlObjectPlugin());</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>SQL Object types in v3 must be public interfaces&#8212;&#8203;no classes. Method return
types must likewise be public. This is due to SQL Object implementation
switching from CGLIB to <code>java.lang.reflect.Proxy</code>, which only supports
interfaces.</p>
</li>
<li>
<p><code>GetHandle</code> &#8594; <code>SqlObject</code></p>
</li>
<li>
<p><code>SqlLocator</code> replaces <code>StatementLocator</code>, and only applies to SQL Objects.</p>
</li>
<li>
<p><code>@RegisterMapper</code> divided into <a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterRowMapper.html" target="_blank" rel="noopener">@RegisterRowMapper</a> and
<a href="./apidocs/org/jdbi/v3/sqlobject/config/RegisterColumnMapper.html" target="_blank" rel="noopener">@RegisterColumnMapper</a>.</p>
</li>
<li>
<p><a href="./apidocs/org/jdbi/v3/sqlobject/customizer/Bind.html" target="_blank" rel="noopener">@Bind</a> annotations on SQL Object method parameters can be made optional,
by compiling your code with the <code>-parameters</code> compiler flag enabled.</p>
</li>
<li>
<p><code>@BindIn</code> &#8594; <a href="./apidocs/org/jdbi/v3/sqlobject/customizer/BindList.html" target="_blank" rel="noopener">@BindList</a>, and no longer requires StringTemplate</p>
</li>
<li>
<p>On-demand SQL objects don&#8217;t play well with methods that return <code>Iterable</code>
or <code>FluentIterable</code>. On-demand objects strictly close the handle after each
method call, and no longer "hold the door open" for you to finish consuming
the interable as they did in v2. This forecloses a major source of connection
leaks.</p>
</li>
<li>
<p>SQL Objects are no longer closeable&#8201;&#8212;&#8201;they are either on-demand, or their
lifecycle is tied to the lifecycle of the <a href="./apidocs/org/jdbi/v3/core/Handle.html" target="_blank" rel="noopener">Handle</a> they are attached to.</p>
</li>
<li>
<p><code>@BindAnnotation</code> meta-annotation removed. Use
<code>@SqlStatementCustomizingAnnotation</code> instead.</p>
</li>
<li>
<p><code>@SingleValueResult</code> &#8594; <a href="./apidocs/org/jdbi/v3/sqlobject/SingleValue.html" target="_blank" rel="noopener">@SingleValue</a>. The annotation may be used for method
return types, or on <a href="./apidocs/org/jdbi/v3/sqlobject/statement/SqlBatch.html" target="_blank" rel="noopener">@SqlBatch</a> parameters.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 3.41.3-SNAPSHOT<br>
Last updated 09/25/2023 12:30 -0700
</div>
</div>
</body>
</html>